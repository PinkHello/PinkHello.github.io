<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PinkHello</title><link>https://pinkhello.me/</link><description>Recent content on PinkHello</description><generator>Hugo -- gohugo.io</generator><language>zh</language><copyright>PinkHello, All Rights Reserved</copyright><lastBuildDate>Fri, 11 Jun 2021 09:10:14 +0800</lastBuildDate><atom:link href="https://pinkhello.me/index.xml" rel="self" type="application/rss+xml"/><item><title>12 èŠèŠè™è Chat</title><link>https://pinkhello.me/posts/12-%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0chat/</link><pubDate>Fri, 11 Jun 2021 09:10:14 +0800</pubDate><guid>https://pinkhello.me/posts/12-%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0chat/</guid><description>PinkHello https://pinkhello.me/posts/12-%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0chat/ -&lt;hr>
&lt;p>title: è€å¸æœºèŠèŠBatChat
date: 2021-01-31 21:37:07
tags:&lt;/p>
&lt;ul>
&lt;li>BatChat/åŠ å¯†èŠå¤©&lt;/li>
&lt;/ul>
&lt;hr>
&lt;!-- raw HTML omitted -->
&lt;p>ä»Šå¤©ï¼Œåœ¨æµè§ˆ&lt;code>å°ä¼—è½¯ä»¶&lt;/code>çš„æ—¶å€™ï¼Œçªç„¶çœ‹è§ä¸€ä¸ªæ—©æœŸå°ç¼–çš„æ¨å¹¿ï½ï½ï½è™è APPï¼Œè”æƒ³åˆ°ä¹‹å‰æ–°é—»ä¸­çœ‹åˆ°çš„æœ‰ä¸ªè´©å–ä¸ªäººä¿¡æ¯çš„äººè¯´åœ¨è™è APPä¸Šï¼Œå‹¾èµ·äº†æˆ‘çš„å¥½å¥‡å¿ƒï¼Œä½œä¸ºä¸€ä¸ªç¨‹åºğŸ¶ï¼Œé»˜é»˜çš„æƒ³æ¢ç©¶ä¸€ä¸‹è¿™ä¸ªè™è APPç©çš„ä»€ä¹ˆå¥—è·¯ã€‚&lt;/p>
&lt;h1 id="ä»€ä¹ˆæ˜¯è™è batchat">ä»€ä¹ˆæ˜¯è™è ï¼ˆBatChatï¼‰&lt;/h1>
&lt;p>ä¸€æ¬¾å…è´¹çš„ç«¯åˆ°ç«¯åŠ å¯†çš„è™è APPï¼Œéšæ—¶ç•…èŠï¼
åº”ç”¨ IOSã€Android
&lt;a href="https://batchat.com">https://batchat.com&lt;/a>&lt;/p>
&lt;h1 id="å®ƒçš„ç‰¹æ€§">å®ƒçš„ç‰¹æ€§&lt;/h1>
&lt;ul>
&lt;li>å®‰å…¨ ï½œ ç•…èŠæ—¶ã€ç«¯åˆ°ç«¯åŠ å¯†ï¼ˆæ‰€æœ‰æ¶ˆæ¯ç»è¿‡ç«¯åˆ°ç«¯åŠ å¯†ï¼Œä»»ä½•èŠå¤©è®°å½•ä¸è¿›è¡Œäº‘å­˜å‚¨ï¼Œè®©ä½ çš„ä¿¡æ¯æƒ³è±¡ä¸­æ›´å®‰å…¨ï¼‰&lt;/li>
&lt;li>éšç§ ï½œ ç•…èŠæ—¶ã€åŒå‘æ’¤å›ï¼ˆèŠå¤©è®°å½•ä¸€é”®åŒå‘æ’¤å›ï¼ŒåŒæ—¶åˆ é™¤ä½ å’Œå¯¹æ–¹è®¾å¤‡ä¸Šæ‰€æœ‰çš„èŠå¤©è®°å½•ï¼Œæ’¤å›æ•°æ®å¤šæ¬¡è¦†ç›–åˆ é™¤ã€ä¸å¯æ¢å¤ã€ä¿è¯åŒæ–¹çš„éšç§å®‰å…¨ï¼‰&lt;/li>
&lt;li>åŒ¿åç¾¤èŠ ï½œ å¼€å¯åŒ¿åç¾¤èŠï¼Œç¾¤é‡Œé¢çš„æ¯ä¸€ä¸ªæˆå‘˜éƒ½å¯ä»¥&amp;quot;å˜èº«&amp;quot;ï¼Œéšè—çœŸå®èº«ä»½ï¼Œç¾¤å†…ä¸å—èº«ä»½çº¦æŸ&lt;/li>
&lt;/ul>
&lt;h1 id="ä»€ä¹ˆæ˜¯ç«¯åˆ°ç«¯åŠ å¯†">ä»€ä¹ˆæ˜¯ç«¯åˆ°ç«¯åŠ å¯†ï¼Ÿ&lt;/h1>
&lt;p>ç«¯åˆ°ç«¯åŠ å¯†æ˜¯åœ¨æºç»“ç‚¹å’Œç›®çš„ç»“ç‚¹ä¸­å¯¹ä¼ é€çš„æ•°æ®è¿›è¡ŒåŠ å¯†å’Œè§£å¯†ï¼Œ å› æ­¤æ•°æ®çš„å®‰å…¨æ€§ä¸ä¼šå› ä¸­é—´ç»“ç‚¹çš„ä¸å¯é è€Œå—åˆ°å½±å“ã€‚&lt;code> è™è APPçš„æ‰€æœ‰æ•°æ®éƒ½é€šè¿‡ç”¨æˆ·ç«¯ç”Ÿæˆçš„ç§é’¥è¿›è¡ŒåŠ å¯†åå†å‘é€ï¼Œä»»ä½•ç¬¬ä¸‰æ–¹åŒ…æ‹¬å¼€å‘è€…éƒ½ä¸èƒ½è§£å¼€æ­¤æ•°æ®&lt;/code>.&lt;/p>
&lt;h1 id="è™è appé‡‡ç”¨çš„å®‰å…¨å±‚çº§">è™è APPé‡‡ç”¨çš„å®‰å…¨å±‚çº§ï¼Ÿ&lt;/h1>
&lt;ul>
&lt;li>
&lt;p>é€šé“åŠ å¯†
é€šé“åŠ å¯†ä¸­é‡‡ç”¨äº†å“ªäº›åŠ å¯†ç®—æ³•ï¼Ÿ
é€šé“åŠ å¯†ä¸­ä½¿ç”¨åˆ°çš„ RSA, ECDHE, AES256_CBC, SHA256, SHA1ç­‰ç­‰(å¦‚ä¸‹å›¾)ã€‚&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E9%80%9A%E9%81%93%E5%8A%A0%E5%AF%86.png" alt="é€šé“åŠ å¯†">
æ­¥éª¤:&lt;/p>
&lt;ul>
&lt;li>(1. å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å…ˆäº§ç”Ÿéšæœºæ•°&lt;/li>
&lt;li>(2. æœåŠ¡å™¨ä¸‹å‘éšæœºæ•°ã€‚&lt;/li>
&lt;li>(3. å®¢æˆ·ç«¯ç”¨ RSA å¯¹å®¢æˆ·ç«¯éšæœºæ•°è¿›è¡ŒåŠ å¯†ï¼Œå¹¶å‘é€ç»™æœåŠ¡å™¨ã€‚&lt;/li>
&lt;li>(4. æœåŠ¡å™¨ç”¨ RSA è§£å¯†å®¢æˆ·ç«¯éšæœºæ•°ï¼ˆä½¿ç”¨ RSA çš„ç›®çš„æ˜¯é˜²æ­¢ä¸­é—´äººæ”»å‡»ï¼‰ã€‚&lt;/li>
&lt;li>(5. å®¢æˆ·ç«¯ï¼ŒæœåŠ¡å™¨ç”¨è‡ªå·±çš„éšæœºæ•°åŠ ä¸Šå¯¹æ–¹çš„éšæœºæ•°ç”Ÿæˆä¸´æ—¶å¯†é’¥ TempKey å’Œä¸´æ—¶åç§»é‡ TempIV (æ­¤æ—¶åŒæ–¹å‡æŒæœ‰ç›¸åŒçš„ TempKeyå’ŒTempIV)ã€‚&lt;/li>
&lt;li>(6. å®¢æˆ·ç«¯æœåŠ¡å™¨å‡ä½¿ç”¨ ECDHE ç”Ÿæˆå„è‡ªçš„å…¬ç§é’¥å¯¹ã€‚&lt;/li>
&lt;li>(7. å®¢æˆ·ç«¯ç”¨ TempKey, TempIV å¯¹è‡ªå·±çš„ ECDHE å…¬é’¥è¿›è¡ŒåŠ å¯†ï¼Œå¹¶å°†å¯†æ–‡å‘é€ç»™æœåŠ¡å™¨ã€‚&lt;/li>
&lt;li>(8. æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„ ECDHE å…¬é’¥å¯†æ–‡ï¼Œå¹¶è§£å¯†ã€‚&lt;/li>
&lt;li>(9. æœåŠ¡å™¨ä½¿ç”¨ TempKey, TempIV å¯¹è‡ªå·±çš„ ECDHE å…¬é’¥è¿›è¡ŒåŠ å¯†ï¼Œå¹¶ä½¿ç”¨ RSA å¯¹ ECDHEã€‚&lt;/li>
&lt;li>(10. æœåŠ¡å™¨ä½¿ç”¨ ECDHE ç®—æ³•ï¼Œä½¿ç”¨å®¢æˆ·ç«¯ ECDHE å…¬é’¥æ˜æ–‡+æœåŠ¡å™¨ ECDHE ç§é’¥æ˜æ–‡ç”ŸæˆShareKeyã€‚&lt;/li>
&lt;li>(11. å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„ ECDHE å…¬é’¥å¯†æ–‡å’Œç­¾åï¼Œç„¶åè¿›è¡Œè§£å¯†å’ŒéªŒè¯ç­¾åï¼Œå¦‚æœæ²¡æœ‰é—®é¢˜ï¼Œå°±ä½¿ç”¨å®¢æˆ·ç«¯ ECDHE ç§é’¥æ˜æ–‡+æœåŠ¡å™¨ECDHE å…¬é’¥æ˜æ–‡ç”Ÿæˆ ShareKeyã€‚&lt;/li>
&lt;li>(12. æœåŠ¡å™¨åˆå§‹åŒ–å„ä¸ªå‚æ•°ï¼Œä¸‹å‘ç»™å®¢æˆ·ç«¯,å‚æ•°åŒ…å«ï¼š
&lt;ul>
&lt;li>
&lt;p>AuthKeyIDï¼š æœåŠ¡å™¨éšæœºç”Ÿæˆçš„å®¢æˆ·ç«¯ä¸´æ—¶æ ‡è¯†ç¬¦&lt;/p>
&lt;/li>
&lt;li>
&lt;p>MsgKeyï¼š ç”± ShareKey, AuthkeyID, MsgID, SessionID, Salt, SeqNo ä»¥åŠçœŸå®çš„æ¶ˆæ¯å†…å®¹ç›¸åŠ åè¿›è¡Œ Sha256 åçš„å€¼&lt;/p>
&lt;blockquote>
&lt;p>æœ¬å‚æ•°ç”¨äºï¼š&lt;/p>
&lt;blockquote>
&lt;p>(a. è¿›è¡Œé˜²æ­¢æ•°æ®ç¯¡æ”¹çš„éªŒè¯&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>(b. ä¸ ShareKey ä¸€èµ·ä½¿ç”¨ï¼Œç”Ÿæˆ Aes256 key, IVï¼Œç”¨æ¥å¯¹å„æ¡æ¶ˆæ¯è¿›è¡ŒåŠ å¯†ã€‚&lt;/p>
&lt;/blockquote>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>MsgIDï¼šæ—¶é—´ç›¸å…³çš„æ¶ˆæ¯ IDï¼Œç”¨äºé˜²æ­¢é‡æ”¾å’Œå»é‡ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>SessionIDï¼šæ¯æ¬¡ç™»å½•å”¯ä¸€çš„ä¼šè¯ IDã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Saltï¼šæ¯æ¬¡ç™»å½•å”¯ä¸€çš„ç›å€¼ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>SeqNoï¼šç”¨äºé˜²æ­¢é‡æ”¾ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>(13. åç»­æ¯æ¡æ¶ˆæ¯å‡ä¼šæœ‰ä¸åŒçš„ MsgID, SessionID, Salt, SeqNo å’ŒçœŸå®çš„æ¶ˆæ¯å†…å®¹ï¼›è¿™äº›å˜åŒ–çš„å€¼ä¼šå¯¼è‡´ MsgKey æ¯æ¬¡éƒ½ä¸åŒã€‚ è¿™ä¸ªæ¯æ¬¡éƒ½ ä¸åŒçš„ MsgKey åŠ ä¸Š ShareKey å¯ä»¥ä¸ºæ¯ä¸€æ¡æ¶ˆæ¯ç”Ÿæˆå¯¹åº”çš„ 32 å­—èŠ‚å¯†é’¥å’Œåç§»é‡ã€‚&lt;/li>
&lt;li>(14. ShareKey ä¼šè¿‡æœŸï¼Œè¿‡æœŸåéœ€è¦é‡æ–°è¿›è¡Œå¯†é’¥åå•†ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>å†…å®¹åŠ å¯†&lt;/p>
&lt;ul>
&lt;li>(1. ç”¨æˆ·ç”Ÿæˆ ECDHE å…¬ç§é’¥ï¼Œä¿å­˜åœ¨æœ¬åœ°ã€‚&lt;/li>
&lt;li>(2. å°†å…¬é’¥å‘é€åˆ°æœåŠ¡å™¨ï¼Œç§é’¥ä¿å­˜åœ¨æœ¬åœ°ã€‚&lt;/li>
&lt;li>(3. ç”¨æˆ·ç™»å½•ï¼Œè·å–æ‰€æœ‰å¥½å‹ä¿¡æ¯çš„æ›´æ–°ï¼ŒåŒ…å«æ¯ä¸ªå¥½å‹çš„å…¬é’¥ã€‚&lt;/li>
&lt;li>(4. å‘é€æ¶ˆæ¯ï¼Œå’Œæ¥æ”¶æ¶ˆæ¯æ—¶å‡é‡‡ç”¨è‡ªå·±çš„ç§é’¥+å¯¹æ–¹çš„å…¬é’¥ç”Ÿæˆ ShareKeyã€‚&lt;/li>
&lt;li>(5. ä½¿ç”¨ ShareKey ç”Ÿæˆ AES256 çš„å¯†é’¥ï¼Œè¿›è¡ŒåŠ å¯†å’Œè§£å¯†ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86.png" alt="å†…å®¹åŠ å¯†">&lt;/p>
&lt;p>è™è  åŒæ£˜è½®ç®—æ³• å¦‚ä¸‹ï¼š
Alice(A)å‘é€çš„æ¶ˆæ¯ä¼ é€äº†å¥¹çš„æ–°å…¬é’¥ã€‚ æœ€ç»ˆï¼ŒBob(B)å°†æ”¶åˆ°ä»¥ä¸‹æ¶ˆæ¯ä¹‹ä¸€ï¼Œå¹¶æ‰§è¡Œç¬¬äºŒä¸ªDHæ£˜è½®æ­¥éª¤ï¼› åœ¨æ¯ä¸ªDHæ£˜è½®æ­¥éª¤ä¸­ç”Ÿæˆçš„DH è¾“å‡ºç”¨äºå¯¼å‡ºæ–°çš„å‘é€å’Œæ¥æ”¶é“¾å¯†é’¥ã€‚å½“å„æ–¹è½®æµæ‰§è¡ŒDHæ£˜è½®æ­¥éª¤æ—¶ï¼Œä»–ä»¬è½®æµå¼•å…¥æ–°çš„å‘é€é“¾ï¼Œä¾æ­¤ç±»æ¨ã€‚&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E5%8F%8C%E6%A3%98%E8%BD%AE%E7%AE%97%E6%B3%95.png" alt="åŒæ£˜è½®ç®—æ³•">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æœåŠ¡å™¨æ•°æ®åº“å®‰å…¨&lt;/p>
&lt;ul>
&lt;li>(1. æ•°æ®åº“æœ‰ç­¾åå­—æ®µã€‚&lt;/li>
&lt;li>(2. æœåŠ¡å™¨ä¸Šç”Ÿæˆ ECDSA å…¬ç§é’¥ã€‚&lt;/li>
&lt;li>(3. æœåŠ¡å™¨ä»£ç ä¸­å¯¹æ•°æ®åº“æ•æ„Ÿå­—æ®µï¼Œæ¯”å¦‚ï¼špassword, userID, friend ç­‰åšå¢åˆ æ”¹æ“ä½œæ—¶å‡é€šè¿‡ ECDSA ç”Ÿæˆç­¾åï¼Œå¹¶æ›´æ–°åˆ°ç­¾åå­—æ®µã€‚&lt;/li>
&lt;li>(4. æœåŠ¡å™¨ä»£ç å¯¹ password, userID, friend ç­‰æ•°æ®è¿›è¡Œè¯»å–ï¼Œåˆ¤æ–­ç­‰æ“ä½œæ—¶è¿›è¡Œ ECDSAéªŒè¯ç­¾åï¼Œåªæœ‰é€šè¿‡éªŒè¯æ‰èƒ½è¿›è¡Œåç»­æµç¨‹ï¼Œå¦åˆ™ ç»™å®¢æˆ·ç«¯æŠ¥é”™ã€‚&lt;/li>
&lt;li>(5. æœåŠ¡ç«¯ç¨‹åºè¿›è¡ŒåŠ å¯†å’Œç­¾åä¿æŠ¤ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h1 id="å¥½äº†ä¸Šé¢çš„éƒ½æ˜¯æ‘˜è‡ª-batchat-å®˜ç½‘ä»‹ç»ç°åœ¨è¿›å…¥æ­£é¢˜">å¥½äº†ï¼Œä¸Šé¢çš„éƒ½æ˜¯æ‘˜è‡ª BatChat å®˜ç½‘ä»‹ç»ï¼ç°åœ¨è¿›å…¥æ­£é¢˜ï¼&lt;/h1>
&lt;p>å…ˆæ¥ä¸€ä¸ªé‡ç£…&lt;/p>
&lt;blockquote>
&lt;p>ã€Šç½‘ç»œå®‰å…¨æ³•ã€‹ ç¬¬äºŒåä¸€æ¡è§„å®šï¼Œç½‘ç»œè¿è¥è€…åº”å½“æŒ‰ç…§ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤åˆ¶åº¦çš„è¦æ±‚,å±¥è¡Œå®‰å…¨ä¿æŠ¤ä¹‰åŠ¡,ä¿éšœç½‘ç»œå…å—å¹²æ‰°ã€ç ´åæˆ–è€…æœªç»æˆæƒçš„è®¿é—®,é˜²æ­¢ç½‘ç»œæ•°æ®æ³„éœ²æˆ–è€…è¢«çªƒå–ã€ç¯¡æ”¹ã€‚ç½‘ç»œè¿è¥è€…çš„å®‰å…¨ä¹‰åŠ¡åŒ…æ‹¬é‡‡å–ç›‘æµ‹ã€è®°å½•ç½‘ç»œè¿è¡ŒçŠ¶æ€ã€ç½‘ç»œå®‰å…¨äº‹ä»¶çš„æŠ€æœ¯æªæ–½,å¹¶æŒ‰ç…§è§„å®šç•™å­˜ç›¸å…³çš„ç½‘ç»œæ—¥å¿—ä¸å°‘äºå…­ä¸ªæœˆã€‚&lt;/p>
&lt;/blockquote>
&lt;p>å˜¿å˜¿ ï¼ŒæŒ‰ç…§å°å¼Ÿçš„ç†è§£ï¼Œ&lt;code>BatChat&lt;/code> å·ç§°ç«¯åˆ°ç«¯åŠ å¯†ï¼Œé‚£ä¹ˆä¿¡æ¯åŠ å¯†å’Œå›½å†…å¤‡æ¡ˆæ˜æ˜¾å†²çªäº†ï¼Œæ‰€ä»¥è¦ä¹ˆè¿™å…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯å‡çš„ï¼Œè¦ä¹ˆå°±æ˜¯åœ¨è¿&lt;code>æ³•&lt;/code>çš„è¾¹ç¼˜ç–¯ç‹‚è¯•æ¢ã€‚&lt;/p>
&lt;p>æ­£å› ä¸ºçœ‹åˆ°è¿™äº›ï¼Œæ‰€ä»¥å°å¼Ÿé»˜é»˜çš„ &lt;code>Download&lt;/code> äº†ä¸‹æ¥, ç„¶åé»˜é»˜çš„ &lt;code>Install&lt;/code>, ç„¶åé»˜é»˜çš„æ³¨å†Œç™»å½•è¿›å…¥äº† ğŸ˜¯ ğŸ’ ï½ï½ï½ï½&lt;/p>
&lt;p>è¿›å…¥æ˜¯åŸºç¡€TabåŠŸèƒ½èœå•&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/app-%E6%88%91%E7%9A%84.png" alt="app">&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/app-%E8%81%94%E7%B3%BB%E4%BA%BA.jpeg" alt="app">&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/app-%E8%9D%99%E8%9D%A0%E6%88%91%E7%9A%84.png" alt="app">&lt;/p>
&lt;p>è¿›å…¥ç¬é—´çš„å†…å®¹ï¼Œæˆ‘å‘µå‘µå’¯ï½ï½&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E7%9E%AC%E9%97%B4-%E8%BF%9D%E8%A7%84.jpeg" alt="app">&lt;/p>
&lt;p>æœ‰æ²¡æœ‰çœ‹å‡ºæ¥ä»€ä¹ˆï¼Œäººè„¸è¯†åˆ«è‡ªåŠ¨è¯†åˆ«é€ å‡ï¼ˆé»‘ç°äº§ä¸šé“¾ï¼‰&lt;/p>
&lt;p>ä¸‹é¢æ˜¯æˆ‘çš„ä¸€äº›æˆªå›¾ï¼Œä½ ä»¬è‡ªå·±çœ‹å’¯&lt;/p>
&lt;ul>
&lt;li>
&lt;p>æ ‡ç­¾æœç´¢ ç‚¹å‡»æ¢ä¸€ç»„ï¼Œè¿™æ˜¯å®˜æ–¹çš„æ¨èçš„ã€‚&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E6%A0%87%E7%AD%BE%E6%90%9C%E7%B4%A21.jpeg" alt="æ ‡ç­¾">&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E6%A0%87%E7%AD%BE%E6%90%9C%E7%B4%A22.jpeg" alt="æ ‡ç­¾">&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E6%A0%87%E7%AD%BE%E6%90%9C%E7%B4%A23.jpeg" alt="æ ‡ç­¾">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æœç´¢æ•æ„Ÿè¯ç¾¤&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E7%BE%A4%E6%90%9C%E7%B4%A2%E6%94%AF%E4%BB%98.jpeg" alt="ç¾¤æœç´¢">&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E7%BE%A4%E6%90%9C%E7%B4%A2%E7%A6%8F%E5%88%A9.jpeg" alt="ç¾¤æœç´¢">&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E7%BE%A4%E6%90%9C%E7%B4%A2%E8%8F%A0%E8%8F%9C%E5%A4%9A.jpeg" alt="ç¾¤æœç´¢">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æˆ‘é»˜é»˜çš„åŠ äº†ä¸€ä¸ªçœ‹ä¼¼æ­£å¸¸çš„ç¾¤ï¼Œè¿›ç¾¤åæˆ‘é£åŒ–äº†ï¼ï¼ï¼ï¼&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E7%BE%A4%E8%BF%9D%E8%A7%84%E5%86%85%E5%AE%B91.jpeg" alt="è¿›ç¾¤ä¿¡æ¯">&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E7%BE%A4%E8%BF%9D%E8%A7%84%E5%86%85%E5%AE%B92.jpeg" alt="è¿›ç¾¤ä¿¡æ¯">&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E8%BF%9D%E8%A7%84%E7%BE%A4%E5%86%85%E5%AE%B95.png" alt="è¿›ç¾¤ä¿¡æ¯">&lt;/p>
&lt;p>ä¸‹é¢æ˜¯é˜²éª—å®˜æ–¹ç¾¤é‡Œçš„&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0Chat/%E5%AE%A3%E4%BC%A0%E7%BE%A4%E8%BF%9D%E8%A7%843.jpeg" alt="è¿›ç¾¤ä¿¡æ¯">&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h1 id="å¥½äº†æ€»ç»“ä¸€ä¸‹batchat">å¥½äº†ï¼Œæ€»ç»“ä¸€ä¸‹BatChatï¼&lt;/h1>
&lt;p>è™è APPèšåˆäº†å“ªäº›äººï¼Ÿ&lt;/p>
&lt;ul>
&lt;li>ç»å¤§éƒ¨åˆ†é»‘ç°äº§ä¸šé“¾ä¸Šä¸‹æ¸¸äººå‘˜ï¼&lt;/li>
&lt;li>æå°éƒ¨åˆ†å°é²œçš„å°ç™½&lt;/li>
&lt;li>å½“ç„¶å› ä¸ºé™Œç”ŸäººèŠå¤©ï¼Œæˆ‘èƒ½è¿›å…¥çš„åªæœ‰ç¾¤æœç´¢ï¼Œåº”è¯¥è¿˜æœ‰æ›´æ·±çš„ã€‚&lt;/li>
&lt;/ul>
&lt;p>å½“ç„¶ä¸ªäººè®¤ä¸ºï¼Œæ­¤å¹³å°ç«Ÿç„¶èƒ½è¿è¡Œåˆ°ç°åœ¨ï¼Œåé¢æƒ³è±¡çš„ç©ºé—´å¾ˆå¤§å•Š&lt;/p>
&lt;p>è¡¥ä¸ªåˆ€ï¼ŒçŸ¥ä¹ä¸“æ  &lt;a href="https://zhuanlan.zhihu.com/p/158261618">https://zhuanlan.zhihu.com/p/158261618&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>è¿™å°¼ç›å°±æ˜¯ä¸ºé»‘ç°äº§ä¸šæ­å»ºèšåˆå¹³å°å•Šï¼è™½è¯´ä½ ä¸æƒ³ï¼Œä½†æ˜¯å°±å®£ä¼ çš„ç«¯åˆ°ç«¯åŠ å¯†ä»¥åŠæ¶ˆæ¯æ’¤å›ï¼Œè¿™ä¸ªä¸æ­£æ˜¯ä»–ä»¬åœ¨æ„çš„ä¹ˆï¼Ÿ
å½“ç„¶æŸè…¾ä¹Ÿå®£ç§°ä¸å­˜å‚¨**å•¥çš„ï¼Ÿä½ ä¿¡ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;p>ç°åœ¨æˆ‘è¦éƒ‘é‡å£°æ˜ï¼šæˆ‘é»˜é»˜çš„åˆ é™¤äº†æ­¤æ¬¾APPï¼ï¼ï¼&lt;/p>
- https://pinkhello.me/posts/12-%E8%81%8A%E8%81%8A%E8%9D%99%E8%9D%A0chat/ - PinkHello, All Rights Reserved</description></item><item><title>RocketMQæºç é˜…è¯» NameServer</title><link>https://pinkhello.me/posts/rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-nameserver/</link><pubDate>Tue, 25 May 2021 19:00:00 +0800</pubDate><guid>https://pinkhello.me/posts/rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-nameserver/</guid><description>PinkHello https://pinkhello.me/posts/rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-nameserver/ -&lt;h1 id="nameserver-è§’è‰²">NameServer è§’è‰²&lt;/h1>
&lt;p>&lt;code>NameSever&lt;/code> åœ¨ &lt;code>RocketMQ&lt;/code> èµ·åˆ°é‡è¦çš„è§’è‰²ï¼Œæ‰¿æ‹…ç€è·¯ç”±ç®¡ç†ã€æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚&lt;/p>
&lt;ul>
&lt;li>æ¥æ”¶ &lt;code>Broker&lt;/code> çš„è¯·æ±‚æ³¨å†Œ &lt;code>Broker&lt;/code> è·¯ç”±ä¿¡æ¯&lt;/li>
&lt;li>æ¥æ”¶ &lt;code>Client&lt;/code> è¯·æ±‚æ ¹æ®æŸä¸ª &lt;code>topic&lt;/code> è·å–æ‰€æœ‰åˆ° &lt;code>broker&lt;/code> çš„è·¯ç”±ä¿¡æ¯&lt;/li>
&lt;/ul>
&lt;h1 id="namesrv-æ ¸å¿ƒç±»">NameSrv æ ¸å¿ƒç±»&lt;/h1>
&lt;ul>
&lt;li>&lt;code>NamesrvStartup&lt;/code>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">NamesrvStartup&lt;/span> {
&lt;span style="color:#228b22">//...
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> NamesrvController &lt;span style="color:#008b45">main0&lt;/span>(String[] args) {
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
NamesrvController controller = createNamesrvController(args);
&lt;span style="color:#228b22">//å¯åŠ¨ NamesrvController
&lt;/span>&lt;span style="color:#228b22">&lt;/span> start(controller);
String tip = &lt;span style="color:#cd5555">&amp;#34;The Name Server boot success. serializeType=&amp;#34;&lt;/span> + RemotingCommand.&lt;span style="color:#658b00">getSerializeTypeConfigInThisServer&lt;/span>();
log.&lt;span style="color:#658b00">info&lt;/span>(tip);
System.&lt;span style="color:#658b00">out&lt;/span>.&lt;span style="color:#658b00">printf&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;%s%n&amp;#34;&lt;/span>, tip);
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> controller;
} &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (Throwable e) {
e.&lt;span style="color:#658b00">printStackTrace&lt;/span>();
System.&lt;span style="color:#658b00">exit&lt;/span>(-1);
}
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>;
}
&lt;span style="color:#228b22">//...
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#228b22">/**
&lt;/span>&lt;span style="color:#228b22"> * å¯åŠ¨ NamesrvController
&lt;/span>&lt;span style="color:#228b22"> * @param controller
&lt;/span>&lt;span style="color:#228b22"> * @return
&lt;/span>&lt;span style="color:#228b22"> * @throws Exception
&lt;/span>&lt;span style="color:#228b22"> */&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> NamesrvController &lt;span style="color:#008b45">start&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> NamesrvController controller) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> Exception {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">null&lt;/span> == controller) {
&lt;span style="color:#8b008b;font-weight:bold">throw&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> IllegalArgumentException(&lt;span style="color:#cd5555">&amp;#34;NamesrvController is null&amp;#34;&lt;/span>);
}
&lt;span style="color:#228b22">// NamesrvController åˆå§‹åŒ–
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">boolean&lt;/span> initResult = controller.&lt;span style="color:#658b00">initialize&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (!initResult) {
controller.&lt;span style="color:#658b00">shutdown&lt;/span>();
System.&lt;span style="color:#658b00">exit&lt;/span>(-3);
}
&lt;span style="color:#228b22">// å¯åŠ¨åçš„é’©å­
&lt;/span>&lt;span style="color:#228b22">&lt;/span> Runtime.&lt;span style="color:#658b00">getRuntime&lt;/span>().&lt;span style="color:#658b00">addShutdownHook&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ShutdownHookThread(log, &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Callable&amp;lt;Void&amp;gt;() {
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> Void &lt;span style="color:#008b45">call&lt;/span>() &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> Exception {
controller.&lt;span style="color:#658b00">shutdown&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>;
}
}));
controller.&lt;span style="color:#658b00">start&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> controller;
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;code>NamesrvController&lt;/code>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">NamesrvController&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">boolean&lt;/span> &lt;span style="color:#008b45">initialize&lt;/span>() {
&lt;span style="color:#228b22">//ä»é…ç½®æ–‡ä»¶ä»¥åŠä¸€ç³»åˆ—çš„é…ç½®ä¸­ï¼Œæå–é…ç½®æ”¾å…¥åˆ° Config Manager
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">kvConfigManager&lt;/span>.&lt;span style="color:#658b00">load&lt;/span>();
&lt;span style="color:#228b22">//åˆ›å»º Netty é€šä¿¡ Server
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">remotingServer&lt;/span> = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> NettyRemotingServer(&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">nettyServerConfig&lt;/span>, &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">brokerHousekeepingService&lt;/span>);
&lt;span style="color:#228b22">//åˆ›å»ºçº¿ç¨‹æ± 
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">remotingExecutor&lt;/span> =
Executors.&lt;span style="color:#658b00">newFixedThreadPool&lt;/span>(nettyServerConfig.&lt;span style="color:#658b00">getServerWorkerThreads&lt;/span>(), &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ThreadFactoryImpl(&lt;span style="color:#cd5555">&amp;#34;RemotingExecutorThread_&amp;#34;&lt;/span>));
&lt;span style="color:#228b22">// æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">registerProcessor&lt;/span>();
&lt;span style="color:#228b22">//æ‰«æbroker &amp;amp; ç§»é™¤ä¸å­˜æ´»çš„broker é—´éš” 10s æ‰§è¡Œ
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">scheduledExecutorService&lt;/span>.&lt;span style="color:#658b00">scheduleAtFixedRate&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Runnable() {
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">run&lt;/span>() {
NamesrvController.&lt;span style="color:#658b00">this&lt;/span>.&lt;span style="color:#658b00">routeInfoManager&lt;/span>.&lt;span style="color:#658b00">scanNotActiveBroker&lt;/span>();
}
}, 5, 10, TimeUnit.&lt;span style="color:#658b00">SECONDS&lt;/span>);
&lt;span style="color:#228b22">//é—´éš” 10 min ä¸­, æ‰“å°é…ç½®
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">scheduledExecutorService&lt;/span>.&lt;span style="color:#658b00">scheduleAtFixedRate&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Runnable() {
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">run&lt;/span>() {
NamesrvController.&lt;span style="color:#658b00">this&lt;/span>.&lt;span style="color:#658b00">kvConfigManager&lt;/span>.&lt;span style="color:#658b00">printAllPeriodically&lt;/span>();
}
}, 1, 10, TimeUnit.&lt;span style="color:#658b00">MINUTES&lt;/span>);
&lt;span style="color:#228b22">//todo ....SSL çš„ä»£ç ï¼Œå¿½ç•¥
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>;
}
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">registerProcessor&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (namesrvConfig.&lt;span style="color:#658b00">isClusterTest&lt;/span>()) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">remotingServer&lt;/span>.&lt;span style="color:#658b00">registerDefaultProcessor&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ClusterTestRequestProcessor(&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>, namesrvConfig.&lt;span style="color:#658b00">getProductEnvName&lt;/span>()),
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">remotingExecutor&lt;/span>);
} &lt;span style="color:#8b008b;font-weight:bold">else&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">remotingServer&lt;/span>.&lt;span style="color:#658b00">registerDefaultProcessor&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> DefaultRequestProcessor(&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>), &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">remotingExecutor&lt;/span>);
}
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;code>KvConfigManager&lt;/code>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">KVConfigManager&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> ReadWriteLock lock = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ReentrantReadWriteLock();
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> HashMap&amp;lt;String&lt;span style="color:#228b22">/* Namespace */&lt;/span>, HashMap&amp;lt;String&lt;span style="color:#228b22">/* Key */&lt;/span>, String&lt;span style="color:#228b22">/* Value */&lt;/span>&amp;gt;&amp;gt; configTable =
&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> HashMap&amp;lt;String, HashMap&amp;lt;String, String&amp;gt;&amp;gt;();
&lt;span style="color:#228b22">//.....
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">load&lt;/span>() {
String content = &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
content = MixAll.&lt;span style="color:#658b00">file2String&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">namesrvController&lt;/span>.&lt;span style="color:#658b00">getNamesrvConfig&lt;/span>().&lt;span style="color:#658b00">getKvConfigPath&lt;/span>());
} &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (IOException e) {
log.&lt;span style="color:#658b00">warn&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;Load KV config table exception&amp;#34;&lt;/span>, e);
}
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (content != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>) {
KVConfigSerializeWrapper kvConfigSerializeWrapper =
KVConfigSerializeWrapper.&lt;span style="color:#658b00">fromJson&lt;/span>(content, KVConfigSerializeWrapper.&lt;span style="color:#658b00">class&lt;/span>);
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">null&lt;/span> != kvConfigSerializeWrapper) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">configTable&lt;/span>.&lt;span style="color:#658b00">putAll&lt;/span>(kvConfigSerializeWrapper.&lt;span style="color:#658b00">getConfigTable&lt;/span>());
log.&lt;span style="color:#658b00">info&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;load KV config table OK&amp;#34;&lt;/span>);
}
}
}
&lt;span style="color:#228b22">//..... å…¶ä»–ä»£ç çœç•¥
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#228b22">// å‘¨æœŸæ‰“å°é…ç½®çš„
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">printAllPeriodically&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">lock&lt;/span>.&lt;span style="color:#658b00">readLock&lt;/span>().&lt;span style="color:#658b00">lockInterruptibly&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
log.&lt;span style="color:#658b00">info&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;--------------------------------------------------------&amp;#34;&lt;/span>);
{
log.&lt;span style="color:#658b00">info&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;configTable SIZE: {}&amp;#34;&lt;/span>, &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">configTable&lt;/span>.&lt;span style="color:#658b00">size&lt;/span>());
Iterator&amp;lt;Entry&amp;lt;String, HashMap&amp;lt;String, String&amp;gt;&amp;gt;&amp;gt; it =
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">configTable&lt;/span>.&lt;span style="color:#658b00">entrySet&lt;/span>().&lt;span style="color:#658b00">iterator&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">while&lt;/span> (it.&lt;span style="color:#658b00">hasNext&lt;/span>()) {
Entry&amp;lt;String, HashMap&amp;lt;String, String&amp;gt;&amp;gt; next = it.&lt;span style="color:#658b00">next&lt;/span>();
Iterator&amp;lt;Entry&amp;lt;String, String&amp;gt;&amp;gt; itSub = next.&lt;span style="color:#658b00">getValue&lt;/span>().&lt;span style="color:#658b00">entrySet&lt;/span>().&lt;span style="color:#658b00">iterator&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">while&lt;/span> (itSub.&lt;span style="color:#658b00">hasNext&lt;/span>()) {
Entry&amp;lt;String, String&amp;gt; nextSub = itSub.&lt;span style="color:#658b00">next&lt;/span>();
log.&lt;span style="color:#658b00">info&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;configTable NS: {} Key: {} Value: {}&amp;#34;&lt;/span>, next.&lt;span style="color:#658b00">getKey&lt;/span>(), nextSub.&lt;span style="color:#658b00">getKey&lt;/span>(),
nextSub.&lt;span style="color:#658b00">getValue&lt;/span>());
}
}
}
} &lt;span style="color:#8b008b;font-weight:bold">finally&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">lock&lt;/span>.&lt;span style="color:#658b00">readLock&lt;/span>().&lt;span style="color:#658b00">unlock&lt;/span>();
}
} &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (InterruptedException e) {
log.&lt;span style="color:#658b00">error&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;printAllPeriodically InterruptedException&amp;#34;&lt;/span>, e);
}
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;code>RouteInfoManager&lt;/code>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">RouteInfoManager&lt;/span> {
&lt;span style="color:#228b22">//è¯»å†™é”
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> ReadWriteLock lock = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ReentrantReadWriteLock();
&lt;span style="color:#228b22">// Topic å’Œ é˜Ÿåˆ—ä¿¡æ¯
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> HashMap&amp;lt;String&lt;span style="color:#228b22">/* topic */&lt;/span>, List&amp;lt;QueueData&amp;gt;&amp;gt; topicQueueTable;
&lt;span style="color:#228b22">// BrokerName å’Œ ä»¥ BrokerName ä¸ºå•ä½çš„ Brokeré›†åˆ
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> HashMap&amp;lt;String&lt;span style="color:#228b22">/* brokerName */&lt;/span>, BrokerData&amp;gt; brokerAddrTable;
&lt;span style="color:#228b22">// é›†ç¾¤ ä»¥åŠ å±äºè¯¥é›†ç¾¤çš„ brokerName åˆ—è¡¨
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> HashMap&amp;lt;String&lt;span style="color:#228b22">/* clusterName */&lt;/span>, Set&amp;lt;String&lt;span style="color:#228b22">/* brokerName */&lt;/span>&amp;gt;&amp;gt; clusterAddrTable;
&lt;span style="color:#228b22">// å­˜æ´»çš„ broker åœ°å€åˆ—è¡¨
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> HashMap&amp;lt;String&lt;span style="color:#228b22">/* brokerAddr */&lt;/span>, BrokerLiveInfo&amp;gt; brokerLiveTable;
&lt;span style="color:#228b22">// broker å¯¹åº”çš„ filter server åˆ—è¡¨
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> HashMap&amp;lt;String&lt;span style="color:#228b22">/* brokerAddr */&lt;/span>, List&amp;lt;String&amp;gt;&lt;span style="color:#228b22">/* Filter Server */&lt;/span>&amp;gt; filterServerTable;
&lt;span style="color:#228b22">//...... å…¨éƒ¨æ˜¯å…³äºä¸Šé¢è¿™äº›ç¼“å­˜æ•°æ®çš„ä¿®æ”¹æ›´æ–°ç­‰ç­‰ä»£ç 
&lt;/span>&lt;span style="color:#228b22">&lt;/span>
&lt;span style="color:#228b22">//é¢å¤–çš„æ‰«ææ¸…ç†æ–¹æ³•
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">scanNotActiveBroker&lt;/span>() {
Iterator&amp;lt;Entry&amp;lt;String, BrokerLiveInfo&amp;gt;&amp;gt; it = &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">brokerLiveTable&lt;/span>.&lt;span style="color:#658b00">entrySet&lt;/span>().&lt;span style="color:#658b00">iterator&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">while&lt;/span> (it.&lt;span style="color:#658b00">hasNext&lt;/span>()) {
Entry&amp;lt;String, BrokerLiveInfo&amp;gt; next = it.&lt;span style="color:#658b00">next&lt;/span>();
&lt;span style="color:#00688b;font-weight:bold">long&lt;/span> last = next.&lt;span style="color:#658b00">getValue&lt;/span>().&lt;span style="color:#658b00">getLastUpdateTimestamp&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> ((last + BROKER_CHANNEL_EXPIRED_TIME) &amp;lt; System.&lt;span style="color:#658b00">currentTimeMillis&lt;/span>()) {
RemotingUtil.&lt;span style="color:#658b00">closeChannel&lt;/span>(next.&lt;span style="color:#658b00">getValue&lt;/span>().&lt;span style="color:#658b00">getChannel&lt;/span>());
it.&lt;span style="color:#658b00">remove&lt;/span>();
log.&lt;span style="color:#658b00">warn&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;The broker channel expired, {} {}ms&amp;#34;&lt;/span>, next.&lt;span style="color:#658b00">getKey&lt;/span>(), BROKER_CHANNEL_EXPIRED_TIME);
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">onChannelDestroy&lt;/span>(next.&lt;span style="color:#658b00">getKey&lt;/span>(), next.&lt;span style="color:#658b00">getValue&lt;/span>().&lt;span style="color:#658b00">getChannel&lt;/span>());
}
}
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;code>DefaultRequestProcessor&lt;/code>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">DefaultRequestProcessor&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">extends&lt;/span> AsyncNettyRequestProcessor &lt;span style="color:#8b008b;font-weight:bold">implements&lt;/span> NettyRequestProcessor {
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> RemotingCommand &lt;span style="color:#008b45">processRequest&lt;/span>(ChannelHandlerContext ctx,
RemotingCommand request) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> RemotingCommandException {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (ctx != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>) {
log.&lt;span style="color:#658b00">debug&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;receive request, {} {} {}&amp;#34;&lt;/span>,
request.&lt;span style="color:#658b00">getCode&lt;/span>(),
RemotingHelper.&lt;span style="color:#658b00">parseChannelRemoteAddr&lt;/span>(ctx.&lt;span style="color:#658b00">channel&lt;/span>()),
request);
}
&lt;span style="color:#8b008b;font-weight:bold">switch&lt;/span> (request.&lt;span style="color:#658b00">getCode&lt;/span>()) {
&lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">PUT_KV_CONFIG&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">putKVConfig&lt;/span>(ctx, request); &lt;span style="color:#228b22">// KvConfigManager å­˜æ”¾é…ç½®å¹¶æŒä¹…åŒ–
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">GET_KV_CONFIG&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">getKVConfig&lt;/span>(ctx, request); &lt;span style="color:#228b22">// KvConfigManager æŸ¥è¯¢é…ç½®
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">DELETE_KV_CONFIG&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">deleteKVConfig&lt;/span>(ctx, request); &lt;span style="color:#228b22">// KvConfigManager åˆ é™¤é…ç½®
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">QUERY_DATA_VERSION&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> queryBrokerTopicConfig(ctx, request); &lt;span style="color:#228b22">// æŸ¥è¯¢æ•°æ®çš„ç‰ˆæœ¬ä¿¡æ¯
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">REGISTER_BROKER&lt;/span>:
Version brokerVersion = MQVersion.&lt;span style="color:#658b00">value2Version&lt;/span>(request.&lt;span style="color:#658b00">getVersion&lt;/span>());
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (brokerVersion.&lt;span style="color:#658b00">ordinal&lt;/span>() &amp;gt;= MQVersion.&lt;span style="color:#658b00">Version&lt;/span>.&lt;span style="color:#658b00">V3_0_11&lt;/span>.&lt;span style="color:#658b00">ordinal&lt;/span>()) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">registerBrokerWithFilterServer&lt;/span>(ctx, request); &lt;span style="color:#228b22">// æ³¨å†Œ broker
&lt;/span>&lt;span style="color:#228b22">&lt;/span> } &lt;span style="color:#8b008b;font-weight:bold">else&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">registerBroker&lt;/span>(ctx, request);
}
&lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">UNREGISTER_BROKER&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">unregisterBroker&lt;/span>(ctx, request); &lt;span style="color:#228b22">// è§£é™¤æ³¨å†Œ broker
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">GET_ROUTEINFO_BY_TOPIC&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">getRouteInfoByTopic&lt;/span>(ctx, request); &lt;span style="color:#228b22">// æ ¹æ®topic è·å– routeinfo
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">GET_BROKER_CLUSTER_INFO&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">getBrokerClusterInfo&lt;/span>(ctx, request); &lt;span style="color:#228b22">//è·å– broker ä¿¡æ¯
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">WIPE_WRITE_PERM_OF_BROKER&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">wipeWritePermOfBroker&lt;/span>(ctx, request); &lt;span style="color:#228b22">// è·å– offset ä¿¡æ¯
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">GET_ALL_TOPIC_LIST_FROM_NAMESERVER&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> getAllTopicListFromNameserver(ctx, request); &lt;span style="color:#228b22">// è·å–æ‰€æœ‰çš„ topic åˆ—è¡¨
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">DELETE_TOPIC_IN_NAMESRV&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> deleteTopicInNamesrv(ctx, request); &lt;span style="color:#228b22">// åˆ é™¤
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">GET_KVLIST_BY_NAMESPACE&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">getKVListByNamespace&lt;/span>(ctx, request); &lt;span style="color:#228b22">// è·å– kvlist
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">GET_TOPICS_BY_CLUSTER&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">getTopicsByCluster&lt;/span>(ctx, request); &lt;span style="color:#228b22">// æ ¹æ® cluster è·å– topic åˆ—è¡¨
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">GET_SYSTEM_TOPIC_LIST_FROM_NS&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">getSystemTopicListFromNs&lt;/span>(ctx, request);
&lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">GET_UNIT_TOPIC_LIST&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">getUnitTopicList&lt;/span>(ctx, request);
&lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">GET_HAS_UNIT_SUB_TOPIC_LIST&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">getHasUnitSubTopicList&lt;/span>(ctx, request);
&lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">getHasUnitSubUnUnitTopicList&lt;/span>(ctx, request);
&lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">UPDATE_NAMESRV_CONFIG&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">updateConfig&lt;/span>(ctx, request); &lt;span style="color:#228b22">// æ›´æ–° namesrv é…ç½®
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RequestCode.&lt;span style="color:#658b00">GET_NAMESRV_CONFIG&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">getConfig&lt;/span>(ctx, request); &lt;span style="color:#228b22">// è·å– namesrv é…ç½®
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">default&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">break&lt;/span>;
}
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>;
}
&lt;span style="color:#228b22">//...... å…¶ä»–ä»£ç çœç•¥.....
&lt;/span>&lt;span style="color:#228b22">&lt;/span>}
&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="namesrv-å¯åŠ¨æµç¨‹">NameSrv å¯åŠ¨æµç¨‹&lt;/h1>
&lt;p>&lt;img src="https://pinkhello.me/rocketmq/rocketmq-namesrv.jpg" alt="rocketmq_namesrv">&lt;/p>
&lt;ul>
&lt;li>å…¥å£ä» &lt;code>NamesrvStartup#main0&lt;/code> å¯åŠ¨è¿›å…¥, åˆ›å»ºäº†ä¸€ä¸ª æ ¸å¿ƒç±» &lt;code>NamesrvController&lt;/code> å®ä¾‹, &lt;code>NamesrvController#createNamesrvController&lt;/code> å¼€å¯äº†é…ç½®å‚æ•°ã€ç½‘ç»œå‚æ•°çš„é…ç½®&lt;/li>
&lt;li>ç¬¬äºŒæ­¥ï¼Œä» &lt;code>start&lt;/code> æ–¹æ³•å¼€å¯ è°ƒç”¨ &lt;code>NamesrvController#initialize&lt;/code> æ–¹æ³•&lt;/li>
&lt;li>
&lt;ul>
&lt;li>&lt;code>KvConfigManager#load&lt;/code> ä»é…ç½®é‡Œé¢æå–é…ç½®åˆå¹¶é…ç½®åˆ°å†…å­˜ä¸­&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;ul>
&lt;li>æ„å»ºäº† &lt;code>NettyRemotingServer&lt;/code> å®ä¾‹&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ç¬¬6æ­¥ æ³¨å†ŒæŒ‡ä»¤å¤„ç†å™¨ï¼Œç”¨äºä»ç½‘ç»œæ¥æ”¶åˆ°çš„æŒ‡ä»¤ï¼Œå¼‚æ­¥åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œä¸šåŠ¡&lt;/li>
&lt;li>ç¬¬7ã€8æ­¥ å®šæ—¶å™¨è¿›è¡Œæ‰«ææ£€æŸ¥å’Œç§»é™¤éæ´»çš„æœ‰é—®é¢˜çš„ broker&lt;/li>
&lt;li>ç¬¬9ã€10æ­¥ å®šæœŸæ‰“å°é…ç½®&lt;/li>
&lt;li>æœ€åæ˜¯ &lt;code>start&lt;/code> æ–¹æ³•&lt;/li>
&lt;li>
&lt;ul>
&lt;li>å¼€å¯äº† &lt;code>netty romting server&lt;/code> å¼€å¯ &lt;code>netty&lt;/code> æœåŠ¡ç›‘å¬&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;ul>
&lt;li>å¼€å¯ &lt;code>fileWatchService&lt;/code> ç›‘å¬&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
- https://pinkhello.me/posts/rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-nameserver/ - PinkHello, All Rights Reserved</description></item><item><title>RocketMQæºç é˜…è¯» é€šä¿¡ç»„ä»¶</title><link>https://pinkhello.me/posts/rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E9%80%9A%E4%BF%A1%E7%BB%84%E4%BB%B6/</link><pubDate>Sat, 22 May 2021 16:09:45 +0800</pubDate><guid>https://pinkhello.me/posts/rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E9%80%9A%E4%BF%A1%E7%BB%84%E4%BB%B6/</guid><description>PinkHello https://pinkhello.me/posts/rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E9%80%9A%E4%BF%A1%E7%BB%84%E4%BB%B6/ -&lt;h1 id="rocketmq-æ ¸å¿ƒåŸºçŸ³">RocketMQ æ ¸å¿ƒåŸºçŸ³&lt;/h1>
&lt;p>å‰é¢å·²ç»ä»‹ç»äº† &lt;code>RocketMQ&lt;/code> çš„åŸºæœ¬çš„æ¦‚å¿µå’Œç»„ä»¶ã€‚ä»Šå¤©æˆ‘ä»¬å¼€å¯çœŸæ­£çš„æºç çš„é˜…è¯»è¯—ç¯‡, &lt;code>RocketMQ&lt;/code> æ¶ˆæ¯ç³»å„ä¸ªç»„ä»¶ &lt;code>Producer&lt;/code>ã€&lt;code>Consumer&lt;/code>ã€&lt;code>Broker&lt;/code>ã€&lt;code>NameSrv&lt;/code> é€šé€šç¦»ä¸å¼€äº¤äº’ï¼Œé‚£æ˜¯ä½¿ç”¨çš„ä»€ä¹ˆäº¤äº’çš„å‘¢ã€‚ç­”æ¡ˆæ˜¯TCPé•¿é“¾æ¥ã€‚
è€Œ &lt;code>RocketMQ&lt;/code> å¼€æºä»£ç å†…éƒ¨ï¼Œå¯¹é€šä¿¡ç›¸å…³çš„è¿›è¡Œäº†ä¸€æ¬¡å°è£…ï¼Œéƒ½åœ¨ rocketmq-remoting æ¨¡å—ä¸‹ï¼Œè¿™ä¸ªæ¨¡å—è¢«å…¶ä»– &lt;code>client&lt;/code>ã€&lt;code>broker&lt;/code>ã€&lt;code>namesrv&lt;/code> åº”ç”¨ã€‚&lt;/p>
&lt;p>ç›´æ¥å…ˆè¯´ &lt;code>remoting&lt;/code> çš„å®ç°æ˜¯åŸºäº &lt;code>netty&lt;/code> åšäº†å°è£…ã€å¯åŠ¨äº†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œæ”¯æŒä¸‰ç§æ¶ˆæ¯çš„å‘é€æ–¹å¼:&lt;/p>
&lt;ul>
&lt;li>åŒæ­¥å‘é€&lt;/li>
&lt;li>å•å‘å‘é€ (ä¸éœ€è¦å…³æ³¨å“åº”)&lt;/li>
&lt;li>å¼‚æ­¥å‘é€&lt;/li>
&lt;/ul>
&lt;p>ä¸‹å›¾ä¸ºå¼‚æ­¥é€šä¿¡æµç¨‹
&lt;img src="https://pinkhello.me/rocketmq/rocketmq_remoting.png" alt="rocketmq_remoting">&lt;/p>
&lt;h1 id="remoting-åŒ…ä¸‹çš„æ ¸å¿ƒæ¥å£ä½“ç³»">remoting åŒ…ä¸‹çš„æ ¸å¿ƒæ¥å£ä½“ç³»&lt;/h1>
&lt;p>&lt;img src="https://pinkhello.me/rocketmq/package-remoting-uml.png" alt="remoting uml">&lt;/p>
&lt;h2 id="æ¥å£-remotingservice">æ¥å£ RemotingService&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">interface&lt;/span> &lt;span style="color:#008b45;font-weight:bold">RemotingService&lt;/span> {
&lt;span style="color:#228b22">// å¼€å¯
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">start&lt;/span>();
&lt;span style="color:#228b22">// å…³é—­
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">shutdown&lt;/span>();
&lt;span style="color:#228b22">// æ³¨å†Œ RPCHook
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">registerRPCHook&lt;/span>(RPCHook rpcHook);
}
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ¥å£-remotingserver">æ¥å£ RemotingServer&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">interface&lt;/span> &lt;span style="color:#008b45;font-weight:bold">RemotingServer&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">extends&lt;/span> RemotingService {
&lt;span style="color:#228b22">// æ³¨å†Œè¯·æ±‚ç±»å‹çš„å¤„ç†å™¨ ã€common æ¨¡å—çš„ org.apache.rocketmq.common.protocol.RequestCode]
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">registerProcessor&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> requestCode, &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> NettyRequestProcessor processor,
&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> ExecutorService executor);
&lt;span style="color:#228b22">// æ³¨å†Œé»˜è®¤çš„å¤„ç†å™¨
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">registerDefaultProcessor&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> NettyRequestProcessor processor, &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> ExecutorService executor);
&lt;span style="color:#228b22">// æœ¬åœ°çš„ç«¯å£
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> &lt;span style="color:#008b45">localListenPort&lt;/span>();
&lt;span style="color:#228b22">// æ ¹æ® requestCode è·å–å¤„ç†å™¨å’Œä¸šåŠ¡çº¿ç¨‹æ± 
&lt;/span>&lt;span style="color:#228b22">&lt;/span> Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt; &lt;span style="color:#008b45">getProcessorPair&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> requestCode);
&lt;span style="color:#228b22">// åŒæ­¥å‘é€
&lt;/span>&lt;span style="color:#228b22">&lt;/span> RemotingCommand &lt;span style="color:#008b45">invokeSync&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> Channel channel, &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> RemotingCommand request,
&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> &lt;span style="color:#00688b;font-weight:bold">long&lt;/span> timeoutMillis) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> InterruptedException, RemotingSendRequestException,
RemotingTimeoutException;
&lt;span style="color:#228b22">// å¼‚æ­¥å‘é€
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">invokeAsync&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> Channel channel, &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> RemotingCommand request, &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> &lt;span style="color:#00688b;font-weight:bold">long&lt;/span> timeoutMillis,
&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> InvokeCallback invokeCallback) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> InterruptedException,
RemotingTooMuchRequestException, RemotingTimeoutException, RemotingSendRequestException;
&lt;span style="color:#228b22">// å•å‘å‘é€
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">invokeOneway&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> Channel channel, &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> RemotingCommand request, &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> &lt;span style="color:#00688b;font-weight:bold">long&lt;/span> timeoutMillis)
&lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> InterruptedException, RemotingTooMuchRequestException, RemotingTimeoutException,
RemotingSendRequestException;
}
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å®ç°-nettyremotingserver">å®ç° NettyRemotingServer&lt;/h2>
&lt;p>è¿™è¾¹é€‰æ‹©æ€§çš„è¿›è¡Œæ‘˜å–è®°å½•æè¿°å•Š&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">NettyRemotingServer&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">extends&lt;/span> NettyRemotingAbstract &lt;span style="color:#8b008b;font-weight:bold">implements&lt;/span> RemotingServer {
&lt;span style="color:#228b22">// todo æ­¤å¤„ä»£ç çœç•¥å·...
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#228b22">// æ„é€ 
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#008b45">NettyRemotingServer&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> NettyServerConfig nettyServerConfig,
&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> ChannelEventListener channelEventListener) {
&lt;span style="color:#228b22">//è°ƒç”¨ NettyRemotingAbstract çš„æ„é€ åˆå§‹åŒ–ç›¸å…³é…ç½®
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">super&lt;/span>(nettyServerConfig.&lt;span style="color:#658b00">getServerOnewaySemaphoreValue&lt;/span>(), nettyServerConfig.&lt;span style="color:#658b00">getServerAsyncSemaphoreValue&lt;/span>());
&lt;span style="color:#228b22">//å¼€å¯ä¸€ä¸ªServerBootstrap
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">serverBootstrap&lt;/span> = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ServerBootstrap();
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">nettyServerConfig&lt;/span> = nettyServerConfig;
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">channelEventListener&lt;/span> = channelEventListener;
&lt;span style="color:#228b22">//é»˜è®¤çš„ React
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> publicThreadNums = nettyServerConfig.&lt;span style="color:#658b00">getServerCallbackExecutorThreads&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (publicThreadNums &amp;lt;= 0) {
publicThreadNums = 4;
}
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">publicExecutor&lt;/span> = Executors.&lt;span style="color:#658b00">newFixedThreadPool&lt;/span>(publicThreadNums, &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ThreadFactory() {
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> AtomicInteger threadIndex = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> AtomicInteger(0);
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> Thread &lt;span style="color:#008b45">newThread&lt;/span>(Runnable r) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Thread(r, &lt;span style="color:#cd5555">&amp;#34;NettyServerPublicExecutor_&amp;#34;&lt;/span> + &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">threadIndex&lt;/span>.&lt;span style="color:#658b00">incrementAndGet&lt;/span>());
}
});
&lt;span style="color:#228b22">//æ ¹æ®ç³»ç»Ÿç¯å¢ƒæˆ–æŒ‡çš„é…ç½®é€‰æ‹©ä½¿ç”¨ Epoll è¿˜æ˜¯ Nio æ¨¡å¼
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (useEpoll()) {
&lt;span style="color:#228b22">//æ„å»º EventLoopGroup åªæœ‰1ä¸ªçº¿ç¨‹
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">eventLoopGroupBoss&lt;/span> = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> EpollEventLoopGroup(1, &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ThreadFactory() {
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> AtomicInteger threadIndex = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> AtomicInteger(0);
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> Thread &lt;span style="color:#008b45">newThread&lt;/span>(Runnable r) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Thread(r, String.&lt;span style="color:#658b00">format&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;NettyEPOLLBoss_%d&amp;#34;&lt;/span>, &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">threadIndex&lt;/span>.&lt;span style="color:#658b00">incrementAndGet&lt;/span>()));
}
});
&lt;span style="color:#228b22">//æ„å»º eventLoopGroupSelector
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">eventLoopGroupSelector&lt;/span> = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> EpollEventLoopGroup(nettyServerConfig.&lt;span style="color:#658b00">getServerSelectorThreads&lt;/span>(), &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ThreadFactory() {
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> AtomicInteger threadIndex = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> AtomicInteger(0);
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> threadTotal = nettyServerConfig.&lt;span style="color:#658b00">getServerSelectorThreads&lt;/span>();
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> Thread &lt;span style="color:#008b45">newThread&lt;/span>(Runnable r) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Thread(r, String.&lt;span style="color:#658b00">format&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;NettyServerEPOLLSelector_%d_%d&amp;#34;&lt;/span>, threadTotal, &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">threadIndex&lt;/span>.&lt;span style="color:#658b00">incrementAndGet&lt;/span>()));
}
});
} &lt;span style="color:#8b008b;font-weight:bold">else&lt;/span> {
&lt;span style="color:#228b22">// todo æ­¤å¤„ä»£ç çœç•¥å·...
&lt;/span>&lt;span style="color:#228b22">&lt;/span> }
&lt;span style="color:#228b22">//å¤¹åœ¨SSLä¸Šä¸‹æ–‡
&lt;/span>&lt;span style="color:#228b22">&lt;/span> loadSslContext();
}
&lt;span style="color:#228b22">//todo æ­¤å¤„ä»£ç çœç•¥å·...
&lt;/span>&lt;span style="color:#228b22">&lt;/span>
&lt;span style="color:#228b22">// æ ¸å¿ƒçš„ å¯åŠ¨æ–¹æ³•
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">start&lt;/span>() {
&lt;span style="color:#228b22">//æ„å»º Workerçº¿ç¨‹ï¼Œæ ¹æ®é…ç½®
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">defaultEventExecutorGroup&lt;/span> = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> DefaultEventExecutorGroup(
nettyServerConfig.&lt;span style="color:#658b00">getServerWorkerThreads&lt;/span>(),
&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ThreadFactory() {
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> AtomicInteger threadIndex = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> AtomicInteger(0);
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> Thread &lt;span style="color:#008b45">newThread&lt;/span>(Runnable r) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Thread(r, &lt;span style="color:#cd5555">&amp;#34;NettyServerCodecThread_&amp;#34;&lt;/span> + &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">threadIndex&lt;/span>.&lt;span style="color:#658b00">incrementAndGet&lt;/span>());
}
});
&lt;span style="color:#228b22">// å‡†å¤‡å…±äº«å¼çš„Hanlders åŒ…å«äº†SSL ã€ç¼–è§£ç ã€è¿æ¥ç®¡ç†ã€ä¸šåŠ¡handler
&lt;/span>&lt;span style="color:#228b22">&lt;/span> prepareSharableHandlers();
&lt;span style="color:#228b22">//å¼€å¯ä¸€ä¸ª Netty Server
&lt;/span>&lt;span style="color:#228b22">&lt;/span> ServerBootstrap childHandler =
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">serverBootstrap&lt;/span>.&lt;span style="color:#658b00">group&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">eventLoopGroupBoss&lt;/span>, &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">eventLoopGroupSelector&lt;/span>)
.&lt;span style="color:#658b00">channel&lt;/span>(useEpoll() ? EpollServerSocketChannel.&lt;span style="color:#658b00">class&lt;/span> : NioServerSocketChannel.&lt;span style="color:#658b00">class&lt;/span>)
.&lt;span style="color:#658b00">option&lt;/span>(ChannelOption.&lt;span style="color:#658b00">SO_BACKLOG&lt;/span>, 1024)
.&lt;span style="color:#658b00">option&lt;/span>(ChannelOption.&lt;span style="color:#658b00">SO_REUSEADDR&lt;/span>, &lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>)
.&lt;span style="color:#658b00">option&lt;/span>(ChannelOption.&lt;span style="color:#658b00">SO_KEEPALIVE&lt;/span>, &lt;span style="color:#8b008b;font-weight:bold">false&lt;/span>)
.&lt;span style="color:#658b00">childOption&lt;/span>(ChannelOption.&lt;span style="color:#658b00">TCP_NODELAY&lt;/span>, &lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>)
.&lt;span style="color:#658b00">childOption&lt;/span>(ChannelOption.&lt;span style="color:#658b00">SO_SNDBUF&lt;/span>, nettyServerConfig.&lt;span style="color:#658b00">getServerSocketSndBufSize&lt;/span>())
.&lt;span style="color:#658b00">childOption&lt;/span>(ChannelOption.&lt;span style="color:#658b00">SO_RCVBUF&lt;/span>, nettyServerConfig.&lt;span style="color:#658b00">getServerSocketRcvBufSize&lt;/span>())
.&lt;span style="color:#658b00">localAddress&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> InetSocketAddress(&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">nettyServerConfig&lt;/span>.&lt;span style="color:#658b00">getListenPort&lt;/span>()))
.&lt;span style="color:#658b00">childHandler&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ChannelInitializer&amp;lt;SocketChannel&amp;gt;() {
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">initChannel&lt;/span>(SocketChannel ch) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> Exception {
ch.&lt;span style="color:#658b00">pipeline&lt;/span>()
.&lt;span style="color:#658b00">addLast&lt;/span>(defaultEventExecutorGroup, HANDSHAKE_HANDLER_NAME, handshakeHandler)
.&lt;span style="color:#658b00">addLast&lt;/span>(defaultEventExecutorGroup,
encoder,
&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> NettyDecoder(),
&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> IdleStateHandler(0, 0, nettyServerConfig.&lt;span style="color:#658b00">getServerChannelMaxIdleTimeSeconds&lt;/span>()),
connectionManageHandler,
serverHandler
);
}
});
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (nettyServerConfig.&lt;span style="color:#658b00">isServerPooledByteBufAllocatorEnable&lt;/span>()) {
childHandler.&lt;span style="color:#658b00">childOption&lt;/span>(ChannelOption.&lt;span style="color:#658b00">ALLOCATOR&lt;/span>, PooledByteBufAllocator.&lt;span style="color:#658b00">DEFAULT&lt;/span>);
}
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
&lt;span style="color:#228b22">// å¼€å¯ä¸€ä¸ª Netty Server
&lt;/span>&lt;span style="color:#228b22">&lt;/span> ChannelFuture sync = &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">serverBootstrap&lt;/span>.&lt;span style="color:#658b00">bind&lt;/span>().&lt;span style="color:#658b00">sync&lt;/span>();
InetSocketAddress addr = (InetSocketAddress) sync.&lt;span style="color:#658b00">channel&lt;/span>().&lt;span style="color:#658b00">localAddress&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">port&lt;/span> = addr.&lt;span style="color:#658b00">getPort&lt;/span>();
} &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (InterruptedException e1) {
&lt;span style="color:#8b008b;font-weight:bold">throw&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> RuntimeException(&lt;span style="color:#cd5555">&amp;#34;this.serverBootstrap.bind().sync() InterruptedException&amp;#34;&lt;/span>, e1);
}
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">channelEventListener&lt;/span> != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">nettyEventExecutor&lt;/span>.&lt;span style="color:#658b00">start&lt;/span>();
}
&lt;span style="color:#228b22">// å¼€å¯æ‰«æ ResponseTable çš„æ£€æŸ¥çº¿ç¨‹
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">timer&lt;/span>.&lt;span style="color:#658b00">scheduleAtFixedRate&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> TimerTask() {
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">run&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
NettyRemotingServer.&lt;span style="color:#658b00">this&lt;/span>.&lt;span style="color:#658b00">scanResponseTable&lt;/span>();
} &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (Throwable e) {
log.&lt;span style="color:#658b00">error&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;scanResponseTable exception&amp;#34;&lt;/span>, e);
}
}
}, 1000 * 3, 1000);
}
&lt;span style="color:#228b22">//todo æ­¤å¤„ä»£ç çœç•¥å·...
&lt;/span>&lt;span style="color:#228b22">&lt;/span>
&lt;span style="color:#228b22">// è¿™ä¸ªæ˜¯æ ¸å¿ƒä»£ç 
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#707a7c">@ChannelHandler.Sharable&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">NettyServerHandler&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">extends&lt;/span> SimpleChannelInboundHandler&amp;lt;RemotingCommand&amp;gt; {
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">protected&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">channelRead0&lt;/span>(ChannelHandlerContext ctx, RemotingCommand msg) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> Exception {
&lt;span style="color:#228b22">// è°ƒç”¨æ¶ˆæ¯å¤„ç†çš„æ–¹æ³• è¿™ä¸ªæ–¹æ³• åœ¨ NettyRemotingAbstract ç±»å†…ä¸Š
&lt;/span>&lt;span style="color:#228b22">&lt;/span> processMessageReceived(ctx, msg);
}
}
&lt;span style="color:#228b22">//todo æ­¤å¤„ä»£ç çœç•¥å·...
&lt;/span>&lt;span style="color:#228b22">&lt;/span>}
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">abstract&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">NettyRemotingAbstract&lt;/span> {
&lt;span style="color:#228b22">// æ ¹æ®æ¶ˆæ¯çš„ç±»å‹è¿›è¡Œå¤„ç†ï¼Œæ˜¯è¯·æ±‚è¿˜æ˜¯å“åº”çš„CMD
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">processMessageReceived&lt;/span>(ChannelHandlerContext ctx, RemotingCommand msg) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> Exception {
&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> RemotingCommand cmd = msg;
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (cmd != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>) {
&lt;span style="color:#8b008b;font-weight:bold">switch&lt;/span> (cmd.&lt;span style="color:#658b00">getType&lt;/span>()) {
&lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> REQUEST_COMMAND:
&lt;span style="color:#228b22">//å¤„ç†è¯·æ±‚æŒ‡ä»¤
&lt;/span>&lt;span style="color:#228b22">&lt;/span> processRequestCommand(ctx, cmd);
&lt;span style="color:#8b008b;font-weight:bold">break&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> RESPONSE_COMMAND:
&lt;span style="color:#228b22">//å¤„ç†å“åº”æŒ‡ä»¤
&lt;/span>&lt;span style="color:#228b22">&lt;/span> processResponseCommand(ctx, cmd);
&lt;span style="color:#8b008b;font-weight:bold">break&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">default&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">break&lt;/span>;
}
}
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¥½äº†ï¼Œåˆ°ç°åœ¨æˆ‘ä»¬å¤§ä½“çš„ remoting server ç«¯çš„å¤§ä½“çš„å…¥å£å’Œæ ¸å¿ƒå¤„ç†æ–¹æ³•å·®ä¸å¤šäº†ï¼Œåé¢è¡¥å……ä¸€ä¸‹ RocketMQ Netty Reactor å¤šçº¿ç¨‹çš„è®¾è®¡&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/rocketmq/rocketmq_reactor_thread.png" alt="rocketmq_reactor_thread">&lt;/p>
&lt;p>ç®€å•æ¦‚æ‹¬ï¼š &lt;code>1-N-M1-M2&lt;/code> æ¨¡å‹&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">çº¿ç¨‹æ•°&lt;/th>
&lt;th style="text-align:left">çº¿ç¨‹å&lt;/th>
&lt;th style="text-align:left">çº¿ç¨‹å…·ä½“è¯´æ˜&lt;/th>
&lt;th style="text-align:left">ä»£ç é»˜è®¤å€¼&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">1&lt;/td>
&lt;td style="text-align:left">NettyBoss_%d&lt;/td>
&lt;td style="text-align:left">Reactorä¸»çº¿ç¨‹&lt;/td>
&lt;td style="text-align:left">1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">N&lt;/td>
&lt;td style="text-align:left">NettyServerEPOLLSelector_%d_%d&lt;/td>
&lt;td style="text-align:left">Reactorçº¿ç¨‹æ± &lt;/td>
&lt;td style="text-align:left">3&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">M1&lt;/td>
&lt;td style="text-align:left">NettyServerCodecThread_%d&lt;/td>
&lt;td style="text-align:left">Workerçº¿ç¨‹æ± &lt;/td>
&lt;td style="text-align:left">8&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">M2&lt;/td>
&lt;td style="text-align:left">RemotingExecutorThread_%d&lt;/td>
&lt;td style="text-align:left">ä¸šåŠ¡&lt;code>processor&lt;/code>å¤„ç†çº¿ç¨‹æ± &lt;/td>
&lt;td style="text-align:left">8&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ul>
&lt;li>[Reactorä¸»çº¿ç¨‹] &lt;code>1&lt;/code>, ä¸€ä¸ª &lt;code>Reactorä¸»çº¿ç¨‹&lt;/code>(&lt;code>eventLoopGroupBoss&lt;/code>) è´Ÿè´£ç›‘å¬ &lt;code>TCP&lt;/code>ç½‘ç»œé“¾æ¥è¯·æ±‚ï¼Œå»ºç«‹å¥½é“¾æ¥ï¼Œåˆ›å»º&lt;code>SocketChannel&lt;/code>ã€å¹¶æ³¨å†Œåˆ°&lt;code>selector&lt;/code>ä¸Šã€‚&lt;/li>
&lt;li>[Reactorçº¿ç¨‹æ± ] &lt;code>N=3&lt;/code>, &lt;code>RocketMQ&lt;/code> æ ¹æ®&lt;code>OSæˆ–è€…é…ç½®&lt;/code>é€‰æ‹©&lt;code>NIO&lt;/code>è¿˜æ˜¯&lt;code>Epoll&lt;/code>ï¼Œç„¶åç›‘å¬çœŸæ­£çš„ç½‘ç»œæ•°æ®ã€‚åé¢æ‹¿åˆ°æ•°æ®åï¼Œä¸¢ç»™ &lt;code>Reactorçº¿ç¨‹æ± &lt;/code> (&lt;code>eventLoopGroupSelector&lt;/code>),&lt;/li>
&lt;li>[Workerçº¿ç¨‹æ± ] &lt;code>M1=8&lt;/code>, åœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘ä¹‹å‰çš„ &lt;code>SSLéªŒè¯&lt;/code>ã€&lt;code>ç¼–è§£ç &lt;/code>ã€&lt;code>ç©ºé—²æ£€æŸ¥&lt;/code>ã€&lt;code>ç½‘ç»œè¿æ¥ç®¡ç†&lt;/code>ç­‰ç­‰ï¼Œè¿™äº›å·¥ä½œäº¤ç»™äº† &lt;code>defaultEventExecutorGroup&lt;/code>&lt;/li>
&lt;li>[ä¸šåŠ¡&lt;code>processor&lt;/code>å¤„ç†çº¿ç¨‹æ± ] &lt;code>M2=8&lt;/code>, å¤„ç†ä¸šåŠ¡æ“ä½œçš„æ”¾åœ¨äº†ä¸šåŠ¡çº¿ç¨‹æ± æ¥æ‰§è¡Œï¼Œæ ¹æ® &lt;code>RemotingCommand&lt;/code> çš„&lt;code>ä¸šåŠ¡ç  code&lt;/code> åœ¨ &lt;code>processorTable&lt;/code> ç¼“å­˜ä¸­è·å–åˆ°å¯¹åº”çš„ &lt;code>processor&lt;/code>, ç„¶åå°è£…æˆ&lt;code>Taskä»»åŠ¡&lt;/code>ï¼Œæäº¤ç»™&lt;code>ä¸šåŠ¡processor&lt;/code>å¤„ç†çº¿ç¨‹æ± æ¥æ‰§è¡Œ (eg: &lt;code>sendMessageExecutor&lt;/code>,æ¶ˆæ¯å‘é€ä¸ºä¾‹)&lt;/li>
&lt;/ul>
&lt;p>å¤‡æ³¨: ç‰¹åˆ«è¦è¯´æ˜ ä¸šåŠ¡&lt;code>processor&lt;/code>å¤„ç†çº¿ç¨‹æ±  ä¸ä¸€å®šæ˜¯&lt;code>8&lt;/code>,å…·ä½“çœ‹ä»£ç :&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">NettyRemotingServer&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">extends&lt;/span> NettyRemotingAbstract &lt;span style="color:#8b008b;font-weight:bold">implements&lt;/span> RemotingServer{
&lt;span style="color:#228b22">//todo .....
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#228b22">//æ³¨å†ŒProcessorï¼Œä¸€èˆ¬ executor ï¼= null
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">registerProcessor&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> requestCode, NettyRequestProcessor processor, ExecutorService executor) {
ExecutorService executorThis = executor;
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">null&lt;/span> == executor) {
executorThis = &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">publicExecutor&lt;/span>;
}
Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt; pair = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt;(processor, executorThis);
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">processorTable&lt;/span>.&lt;span style="color:#658b00">put&lt;/span>(requestCode, pair);
}
&lt;span style="color:#228b22">//æ³¨å†Œé»˜è®¤çš„Processorï¼Œä¸€èˆ¬ executor ï¼= null
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">registerDefaultProcessor&lt;/span>(NettyRequestProcessor processor, ExecutorService executor) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">defaultRequestProcessor&lt;/span> = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Pair&amp;lt;NettyRequestProcessor, ExecutorService&amp;gt;(processor, executor);
}
&lt;span style="color:#228b22">//todo .....
&lt;/span>&lt;span style="color:#228b22">&lt;/span>}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™è¾¹ç»“åˆç†è§£å·®ä¸å¤šäº†ã€‚&lt;/p>
&lt;h1 id="remotingcommand">RemotingCommand&lt;/h1>
&lt;p>ä¸Šé¢çœ‹è§äº†åœ¨å¤„ç†æ¶ˆæ¯çš„æ—¶å€™ä¸€ä¸ªå¾ˆæ ¸å¿ƒçš„ç±» ä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±» org.apache.rocketmq.remoting.protocol.RemotingCommand&lt;/p>
&lt;p>å®ƒå…¶å®æ˜¯ rocketmqçš„æŒ‡ä»¤åè®®&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Headerå­—æ®µ&lt;/th>
&lt;th>ç±»å‹&lt;/th>
&lt;th>Requestè¯´æ˜&lt;/th>
&lt;th>Responseè¯´æ˜&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>code&lt;/td>
&lt;td>int&lt;/td>
&lt;td>è¯·æ±‚æ“ä½œç ï¼Œåº”ç­”æ–¹æ ¹æ®ä¸åŒçš„è¯·æ±‚ç è¿›è¡Œä¸åŒçš„ä¸šåŠ¡å¤„ç†&lt;/td>
&lt;td>åº”ç­”å“åº”ç ã€‚0è¡¨ç¤ºæˆåŠŸï¼Œé0åˆ™è¡¨ç¤ºå„ç§é”™è¯¯&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>language&lt;/td>
&lt;td>LanguageCode&lt;/td>
&lt;td>è¯·æ±‚æ–¹å®ç°çš„è¯­è¨€&lt;/td>
&lt;td>åº”ç­”æ–¹å®ç°çš„è¯­è¨€&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>version&lt;/td>
&lt;td>int&lt;/td>
&lt;td>è¯·æ±‚æ–¹ç¨‹åºçš„ç‰ˆæœ¬&lt;/td>
&lt;td>åº”ç­”æ–¹ç¨‹åºçš„ç‰ˆæœ¬&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>opaque&lt;/td>
&lt;td>int&lt;/td>
&lt;td>ç›¸å½“äºrequestIdï¼Œåœ¨åŒä¸€ä¸ªè¿æ¥ä¸Šçš„ä¸åŒè¯·æ±‚æ ‡è¯†ç ï¼Œä¸å“åº”æ¶ˆæ¯ä¸­çš„ç›¸å¯¹åº”&lt;/td>
&lt;td>åº”ç­”ä¸åšä¿®æ”¹ç›´æ¥è¿”å›&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>flag&lt;/td>
&lt;td>int&lt;/td>
&lt;td>åŒºåˆ†æ˜¯æ™®é€šRPCè¿˜æ˜¯onewayRPCå¾—æ ‡å¿—&lt;/td>
&lt;td>åŒºåˆ†æ˜¯æ™®é€šRPCè¿˜æ˜¯onewayRPCå¾—æ ‡å¿—&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>remark&lt;/td>
&lt;td>String&lt;/td>
&lt;td>ä¼ è¾“è‡ªå®šä¹‰æ–‡æœ¬ä¿¡æ¯&lt;/td>
&lt;td>ä¼ è¾“è‡ªå®šä¹‰æ–‡æœ¬ä¿¡æ¯&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>extFields&lt;/td>
&lt;td>HashMap&amp;lt;String, String&amp;gt;&lt;/td>
&lt;td>è¯·æ±‚è‡ªå®šä¹‰æ‰©å±•ä¿¡æ¯&lt;/td>
&lt;td>å“åº”è‡ªå®šä¹‰æ‰©å±•ä¿¡æ¯&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>åè®®ç¼–ç åçš„æ ·å­
&lt;img src="https://pinkhello.me/rocketmq/rocketmq_protocol_length.png" alt="rocketmq_protocol_length">&lt;/p>
&lt;p>4ä¸ªéƒ¨åˆ†:&lt;/p>
&lt;ul>
&lt;li>æ¶ˆæ¯é•¿åº¦: æ€»é•¿åº¦, 4 ä¸ªå­—èŠ‚å­˜å‚¨, int ç±»å‹&lt;/li>
&lt;li>åºåˆ—è¯ç±»å‹&amp;amp;æ¶ˆæ¯å¤´é•¿åº¦: int ç±»å‹, ç¬¬ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºåºåˆ—åŒ–ç±»å‹, åé¢ä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºæ¶ˆæ¯å¤´é•¿åº¦&lt;/li>
&lt;li>æ¶ˆæ¯å¤´æ•°æ®: ç»è¿‡åºåˆ—åŒ–åçš„æ¶ˆæ¯å¤´&lt;/li>
&lt;li>æ¶ˆæ¯ä¸»ä½“æ•°æ®: æ¶ˆæ¯ä¸»ä½“çš„äºŒè¿›åˆ¶å­—èŠ‚æ•°æ®&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">RemotingCommand&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String SERIALIZE_TYPE_PROPERTY = &lt;span style="color:#cd5555">&amp;#34;rocketmq.serialize.type&amp;#34;&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String SERIALIZE_TYPE_ENV = &lt;span style="color:#cd5555">&amp;#34;ROCKETMQ_SERIALIZE_TYPE&amp;#34;&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String REMOTING_VERSION_KEY = &lt;span style="color:#cd5555">&amp;#34;rocketmq.remoting.version&amp;#34;&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> InternalLogger log = InternalLoggerFactory.&lt;span style="color:#658b00">getLogger&lt;/span>(RemotingHelper.&lt;span style="color:#658b00">ROCKETMQ_REMOTING&lt;/span>);
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> RPC_TYPE = 0; &lt;span style="color:#228b22">// 0, REQUEST_COMMAND
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> RPC_ONEWAY = 1; &lt;span style="color:#228b22">// 0, RPC
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> Map&amp;lt;Class&amp;lt;? &lt;span style="color:#8b008b;font-weight:bold">extends&lt;/span> CommandCustomHeader&amp;gt;, Field[]&amp;gt; CLASS_HASH_MAP =
&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> HashMap&amp;lt;Class&amp;lt;? &lt;span style="color:#8b008b;font-weight:bold">extends&lt;/span> CommandCustomHeader&amp;gt;, Field[]&amp;gt;();
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> Map&amp;lt;Class, String&amp;gt; CANONICAL_NAME_CACHE = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> HashMap&amp;lt;Class, String&amp;gt;();
&lt;span style="color:#228b22">// 1, Oneway
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#228b22">// 1, RESPONSE_COMMAND
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> Map&amp;lt;Field, Boolean&amp;gt; NULLABLE_FIELD_CACHE = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> HashMap&amp;lt;Field, Boolean&amp;gt;();
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String STRING_CANONICAL_NAME = String.&lt;span style="color:#658b00">class&lt;/span>.&lt;span style="color:#658b00">getCanonicalName&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String DOUBLE_CANONICAL_NAME_1 = Double.&lt;span style="color:#658b00">class&lt;/span>.&lt;span style="color:#658b00">getCanonicalName&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String DOUBLE_CANONICAL_NAME_2 = &lt;span style="color:#00688b;font-weight:bold">double&lt;/span>.&lt;span style="color:#658b00">class&lt;/span>.&lt;span style="color:#658b00">getCanonicalName&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String INTEGER_CANONICAL_NAME_1 = Integer.&lt;span style="color:#658b00">class&lt;/span>.&lt;span style="color:#658b00">getCanonicalName&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String INTEGER_CANONICAL_NAME_2 = &lt;span style="color:#00688b;font-weight:bold">int&lt;/span>.&lt;span style="color:#658b00">class&lt;/span>.&lt;span style="color:#658b00">getCanonicalName&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String LONG_CANONICAL_NAME_1 = Long.&lt;span style="color:#658b00">class&lt;/span>.&lt;span style="color:#658b00">getCanonicalName&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String LONG_CANONICAL_NAME_2 = &lt;span style="color:#00688b;font-weight:bold">long&lt;/span>.&lt;span style="color:#658b00">class&lt;/span>.&lt;span style="color:#658b00">getCanonicalName&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String BOOLEAN_CANONICAL_NAME_1 = Boolean.&lt;span style="color:#658b00">class&lt;/span>.&lt;span style="color:#658b00">getCanonicalName&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String BOOLEAN_CANONICAL_NAME_2 = &lt;span style="color:#00688b;font-weight:bold">boolean&lt;/span>.&lt;span style="color:#658b00">class&lt;/span>.&lt;span style="color:#658b00">getCanonicalName&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">volatile&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> configVersion = -1;
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> AtomicInteger requestId = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> AtomicInteger(0);
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> SerializeType serializeTypeConfigInThisServer = SerializeType.&lt;span style="color:#658b00">JSON&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String protocol = System.&lt;span style="color:#658b00">getProperty&lt;/span>(SERIALIZE_TYPE_PROPERTY, System.&lt;span style="color:#658b00">getenv&lt;/span>(SERIALIZE_TYPE_ENV));
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (!isBlank(protocol)) {
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
serializeTypeConfigInThisServer = SerializeType.&lt;span style="color:#658b00">valueOf&lt;/span>(protocol);
} &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (IllegalArgumentException e) {
&lt;span style="color:#8b008b;font-weight:bold">throw&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> RuntimeException(&lt;span style="color:#cd5555">&amp;#34;parser specified protocol error. protocol=&amp;#34;&lt;/span> + protocol, e);
}
}
}
&lt;span style="color:#228b22">// è¯·æ±‚ç æ“ä½œ
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> code;
&lt;span style="color:#228b22">// è¯­è¨€ç±»å‹
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> LanguageCode language = LanguageCode.&lt;span style="color:#658b00">JAVA&lt;/span>;
&lt;span style="color:#228b22">// ç‰ˆæœ¬
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> version = 0;
&lt;span style="color:#228b22">// requestIdï¼Œæ ‡è®°è¯·æ±‚å“åº”æ˜¯ä¸€ä¸ªæ˜ å°„çš„
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> opaque = requestId.&lt;span style="color:#658b00">getAndIncrement&lt;/span>();
&lt;span style="color:#228b22">// åŒºåˆ†æ˜¯æ™®é€šRPCè¿˜æ˜¯onewayRPCå¾—æ ‡å¿—
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> flag = 0;
&lt;span style="color:#228b22">// ä¼ è¾“è‡ªå®šä¹‰æ–‡æœ¬ä¿¡æ¯
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> String remark;
&lt;span style="color:#228b22">// è¯·æ±‚è‡ªå®šä¹‰æ‰©å±•ä¿¡æ¯
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> HashMap&amp;lt;String, String&amp;gt; extFields;
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">transient&lt;/span> CommandCustomHeader customHeader;
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> SerializeType serializeTypeCurrentRPC = serializeTypeConfigInThisServer;
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">transient&lt;/span> &lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[] body;
&lt;span style="color:#8b008b;font-weight:bold">protected&lt;/span> &lt;span style="color:#008b45">RemotingCommand&lt;/span>() {
}
&lt;span style="color:#228b22">//åˆ›å»º requestCommand
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> RemotingCommand &lt;span style="color:#008b45">createRequestCommand&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> code, CommandCustomHeader customHeader) {
RemotingCommand cmd = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> RemotingCommand();
cmd.&lt;span style="color:#658b00">setCode&lt;/span>(code);
cmd.&lt;span style="color:#658b00">customHeader&lt;/span> = customHeader;
setCmdVersion(cmd);
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> cmd;
}
&lt;span style="color:#228b22">//è®¾ç½®ç¨‹åºç‰ˆæœ¬
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">setCmdVersion&lt;/span>(RemotingCommand cmd) {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (configVersion &amp;gt;= 0) {
cmd.&lt;span style="color:#658b00">setVersion&lt;/span>(configVersion);
} &lt;span style="color:#8b008b;font-weight:bold">else&lt;/span> {
String v = System.&lt;span style="color:#658b00">getProperty&lt;/span>(REMOTING_VERSION_KEY);
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (v != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>) {
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> value = Integer.&lt;span style="color:#658b00">parseInt&lt;/span>(v);
cmd.&lt;span style="color:#658b00">setVersion&lt;/span>(value);
configVersion = value;
}
}
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> RemotingCommand &lt;span style="color:#008b45">createResponseCommand&lt;/span>(Class&amp;lt;? &lt;span style="color:#8b008b;font-weight:bold">extends&lt;/span> CommandCustomHeader&amp;gt; classHeader) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> createResponseCommand(RemotingSysResponseCode.&lt;span style="color:#658b00">SYSTEM_ERROR&lt;/span>, &lt;span style="color:#cd5555">&amp;#34;not set any response code&amp;#34;&lt;/span>, classHeader);
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> RemotingCommand &lt;span style="color:#008b45">createResponseCommand&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> code, String remark,
Class&amp;lt;? &lt;span style="color:#8b008b;font-weight:bold">extends&lt;/span> CommandCustomHeader&amp;gt; classHeader) {
RemotingCommand cmd = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> RemotingCommand();
cmd.&lt;span style="color:#658b00">markResponseType&lt;/span>();
cmd.&lt;span style="color:#658b00">setCode&lt;/span>(code);
cmd.&lt;span style="color:#658b00">setRemark&lt;/span>(remark);
setCmdVersion(cmd);
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (classHeader != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>) {
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
CommandCustomHeader objectHeader = classHeader.&lt;span style="color:#658b00">newInstance&lt;/span>();
cmd.&lt;span style="color:#658b00">customHeader&lt;/span> = objectHeader;
} &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (InstantiationException e) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>;
} &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (IllegalAccessException e) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>;
}
}
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> cmd;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> RemotingCommand &lt;span style="color:#008b45">createResponseCommand&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> code, String remark) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> createResponseCommand(code, remark, &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>);
}
&lt;span style="color:#228b22">//è§£ç 
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> RemotingCommand &lt;span style="color:#008b45">decode&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> &lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[] array) {
ByteBuffer byteBuffer = ByteBuffer.&lt;span style="color:#658b00">wrap&lt;/span>(array);
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> decode(byteBuffer);
}
&lt;span style="color:#228b22">//è§£ç 
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> RemotingCommand &lt;span style="color:#008b45">decode&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> ByteBuffer byteBuffer) {
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> length = byteBuffer.&lt;span style="color:#658b00">limit&lt;/span>();
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> oriHeaderLen = byteBuffer.&lt;span style="color:#658b00">getInt&lt;/span>();
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> headerLength = getHeaderLength(oriHeaderLen);
&lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[] headerData = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> &lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[headerLength];
byteBuffer.&lt;span style="color:#658b00">get&lt;/span>(headerData);
RemotingCommand cmd = headerDecode(headerData, getProtocolType(oriHeaderLen));
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> bodyLength = length - 4 - headerLength;
&lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[] bodyData = &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (bodyLength &amp;gt; 0) {
bodyData = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> &lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[bodyLength];
byteBuffer.&lt;span style="color:#658b00">get&lt;/span>(bodyData);
}
cmd.&lt;span style="color:#658b00">body&lt;/span> = bodyData;
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> cmd;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> &lt;span style="color:#008b45">getHeaderLength&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> length) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> length &amp;amp; 0xFFFFFF;
}
&lt;span style="color:#228b22">//æ¶ˆæ¯å¤´è§£ç 
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> RemotingCommand &lt;span style="color:#008b45">headerDecode&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[] headerData, SerializeType type) {
&lt;span style="color:#8b008b;font-weight:bold">switch&lt;/span> (type) {
&lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> JSON:
RemotingCommand resultJson = RemotingSerializable.&lt;span style="color:#658b00">decode&lt;/span>(headerData, RemotingCommand.&lt;span style="color:#658b00">class&lt;/span>);
resultJson.&lt;span style="color:#658b00">setSerializeTypeCurrentRPC&lt;/span>(type);
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> resultJson;
&lt;span style="color:#8b008b;font-weight:bold">case&lt;/span> ROCKETMQ:
RemotingCommand resultRMQ = RocketMQSerializable.&lt;span style="color:#658b00">rocketMQProtocolDecode&lt;/span>(headerData);
resultRMQ.&lt;span style="color:#658b00">setSerializeTypeCurrentRPC&lt;/span>(type);
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> resultRMQ;
&lt;span style="color:#8b008b;font-weight:bold">default&lt;/span>:
&lt;span style="color:#8b008b;font-weight:bold">break&lt;/span>;
}
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> SerializeType &lt;span style="color:#008b45">getProtocolType&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> source) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> SerializeType.&lt;span style="color:#658b00">valueOf&lt;/span>((&lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>) ((source &amp;gt;&amp;gt; 24) &amp;amp; 0xFF));
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> &lt;span style="color:#008b45">createNewRequestId&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> requestId.&lt;span style="color:#658b00">getAndIncrement&lt;/span>();
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> SerializeType &lt;span style="color:#008b45">getSerializeTypeConfigInThisServer&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> serializeTypeConfigInThisServer;
}
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#00688b;font-weight:bold">boolean&lt;/span> &lt;span style="color:#008b45">isBlank&lt;/span>(String str) {
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> strLen;
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (str == &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span> || (strLen = str.&lt;span style="color:#658b00">length&lt;/span>()) == 0) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>;
}
&lt;span style="color:#8b008b;font-weight:bold">for&lt;/span> (&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> i = 0; i &amp;lt; strLen; i++) {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (!Character.&lt;span style="color:#658b00">isWhitespace&lt;/span>(str.&lt;span style="color:#658b00">charAt&lt;/span>(i))) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">false&lt;/span>;
}
}
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>;
}
&lt;span style="color:#228b22">//è®¾ç½®åè®®ç±»å‹
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[] &lt;span style="color:#008b45">markProtocolType&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> source, SerializeType type) {
&lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[] result = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> &lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[4];
result[0] = type.&lt;span style="color:#658b00">getCode&lt;/span>();
result[1] = (&lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>) ((source &amp;gt;&amp;gt; 16) &amp;amp; 0xFF);
result[2] = (&lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>) ((source &amp;gt;&amp;gt; 8) &amp;amp; 0xFF);
result[3] = (&lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>) (source &amp;amp; 0xFF);
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> result;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">markResponseType&lt;/span>() {
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> bits = 1 &amp;lt;&amp;lt; RPC_TYPE;
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">flag&lt;/span> |= bits;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> CommandCustomHeader &lt;span style="color:#008b45">readCustomHeader&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> customHeader;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">writeCustomHeader&lt;/span>(CommandCustomHeader customHeader) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">customHeader&lt;/span> = customHeader;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> CommandCustomHeader &lt;span style="color:#008b45">decodeCommandCustomHeader&lt;/span>(
Class&amp;lt;? &lt;span style="color:#8b008b;font-weight:bold">extends&lt;/span> CommandCustomHeader&amp;gt; classHeader) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> RemotingCommandException {
CommandCustomHeader objectHeader;
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
objectHeader = classHeader.&lt;span style="color:#658b00">newInstance&lt;/span>();
} &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (InstantiationException e) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>;
} &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (IllegalAccessException e) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>;
}
&lt;span style="color:#228b22">//è§£ç å®šåˆ¶çš„æ‰©å±•ä¿¡æ¯å­—æ®µ
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">extFields&lt;/span> != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>) {
Field[] fields = getClazzFields(classHeader);
&lt;span style="color:#8b008b;font-weight:bold">for&lt;/span> (Field field : fields) {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (!Modifier.&lt;span style="color:#658b00">isStatic&lt;/span>(field.&lt;span style="color:#658b00">getModifiers&lt;/span>())) {
String fieldName = field.&lt;span style="color:#658b00">getName&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (!fieldName.&lt;span style="color:#658b00">startsWith&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;this&amp;#34;&lt;/span>)) {
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
String value = &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">extFields&lt;/span>.&lt;span style="color:#658b00">get&lt;/span>(fieldName);
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">null&lt;/span> == value) {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (!isFieldNullable(field)) {
&lt;span style="color:#8b008b;font-weight:bold">throw&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> RemotingCommandException(&lt;span style="color:#cd5555">&amp;#34;the custom field &amp;lt;&amp;#34;&lt;/span> + fieldName + &lt;span style="color:#cd5555">&amp;#34;&amp;gt; is null&amp;#34;&lt;/span>);
}
&lt;span style="color:#8b008b;font-weight:bold">continue&lt;/span>;
}
field.&lt;span style="color:#658b00">setAccessible&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>);
String type = getCanonicalName(field.&lt;span style="color:#658b00">getType&lt;/span>());
Object valueParsed;
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (type.&lt;span style="color:#658b00">equals&lt;/span>(STRING_CANONICAL_NAME)) {
valueParsed = value;
} &lt;span style="color:#8b008b;font-weight:bold">else&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (type.&lt;span style="color:#658b00">equals&lt;/span>(INTEGER_CANONICAL_NAME_1) || type.&lt;span style="color:#658b00">equals&lt;/span>(INTEGER_CANONICAL_NAME_2)) {
valueParsed = Integer.&lt;span style="color:#658b00">parseInt&lt;/span>(value);
} &lt;span style="color:#8b008b;font-weight:bold">else&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (type.&lt;span style="color:#658b00">equals&lt;/span>(LONG_CANONICAL_NAME_1) || type.&lt;span style="color:#658b00">equals&lt;/span>(LONG_CANONICAL_NAME_2)) {
valueParsed = Long.&lt;span style="color:#658b00">parseLong&lt;/span>(value);
} &lt;span style="color:#8b008b;font-weight:bold">else&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (type.&lt;span style="color:#658b00">equals&lt;/span>(BOOLEAN_CANONICAL_NAME_1) || type.&lt;span style="color:#658b00">equals&lt;/span>(BOOLEAN_CANONICAL_NAME_2)) {
valueParsed = Boolean.&lt;span style="color:#658b00">parseBoolean&lt;/span>(value);
} &lt;span style="color:#8b008b;font-weight:bold">else&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (type.&lt;span style="color:#658b00">equals&lt;/span>(DOUBLE_CANONICAL_NAME_1) || type.&lt;span style="color:#658b00">equals&lt;/span>(DOUBLE_CANONICAL_NAME_2)) {
valueParsed = Double.&lt;span style="color:#658b00">parseDouble&lt;/span>(value);
} &lt;span style="color:#8b008b;font-weight:bold">else&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">throw&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> RemotingCommandException(&lt;span style="color:#cd5555">&amp;#34;the custom field &amp;lt;&amp;#34;&lt;/span> + fieldName + &lt;span style="color:#cd5555">&amp;#34;&amp;gt; type is not supported&amp;#34;&lt;/span>);
}
field.&lt;span style="color:#658b00">set&lt;/span>(objectHeader, valueParsed);
} &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (Throwable e) {
log.&lt;span style="color:#658b00">error&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;Failed field [{}] decoding&amp;#34;&lt;/span>, fieldName, e);
}
}
}
}
objectHeader.&lt;span style="color:#658b00">checkFields&lt;/span>();
}
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> objectHeader;
}
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> Field[] &lt;span style="color:#008b45">getClazzFields&lt;/span>(Class&amp;lt;? &lt;span style="color:#8b008b;font-weight:bold">extends&lt;/span> CommandCustomHeader&amp;gt; classHeader) {
Field[] field = CLASS_HASH_MAP.&lt;span style="color:#658b00">get&lt;/span>(classHeader);
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (field == &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>) {
field = classHeader.&lt;span style="color:#658b00">getDeclaredFields&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">synchronized&lt;/span> (CLASS_HASH_MAP) {
CLASS_HASH_MAP.&lt;span style="color:#658b00">put&lt;/span>(classHeader, field);
}
}
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> field;
}
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#00688b;font-weight:bold">boolean&lt;/span> &lt;span style="color:#008b45">isFieldNullable&lt;/span>(Field field) {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (!NULLABLE_FIELD_CACHE.&lt;span style="color:#658b00">containsKey&lt;/span>(field)) {
Annotation annotation = field.&lt;span style="color:#658b00">getAnnotation&lt;/span>(CFNotNull.&lt;span style="color:#658b00">class&lt;/span>);
&lt;span style="color:#8b008b;font-weight:bold">synchronized&lt;/span> (NULLABLE_FIELD_CACHE) {
NULLABLE_FIELD_CACHE.&lt;span style="color:#658b00">put&lt;/span>(field, annotation == &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>);
}
}
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> NULLABLE_FIELD_CACHE.&lt;span style="color:#658b00">get&lt;/span>(field);
}
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> String &lt;span style="color:#008b45">getCanonicalName&lt;/span>(Class clazz) {
String name = CANONICAL_NAME_CACHE.&lt;span style="color:#658b00">get&lt;/span>(clazz);
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (name == &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>) {
name = clazz.&lt;span style="color:#658b00">getCanonicalName&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">synchronized&lt;/span> (CANONICAL_NAME_CACHE) {
CANONICAL_NAME_CACHE.&lt;span style="color:#658b00">put&lt;/span>(clazz, name);
}
}
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> name;
}
&lt;span style="color:#228b22">// ç¼–ç 
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> ByteBuffer &lt;span style="color:#008b45">encode&lt;/span>() {
&lt;span style="color:#228b22">// 1&amp;gt; header length size
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> length = 4;
&lt;span style="color:#228b22">// 2&amp;gt; header data length
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[] headerData = &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">headerEncode&lt;/span>();
length += headerData.&lt;span style="color:#658b00">length&lt;/span>;
&lt;span style="color:#228b22">// 3&amp;gt; body data length
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">body&lt;/span> != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>) {
length += body.&lt;span style="color:#658b00">length&lt;/span>;
}
ByteBuffer result = ByteBuffer.&lt;span style="color:#658b00">allocate&lt;/span>(4 + length);
&lt;span style="color:#228b22">// length
&lt;/span>&lt;span style="color:#228b22">&lt;/span> result.&lt;span style="color:#658b00">putInt&lt;/span>(length);
&lt;span style="color:#228b22">// header length
&lt;/span>&lt;span style="color:#228b22">&lt;/span> result.&lt;span style="color:#658b00">put&lt;/span>(markProtocolType(headerData.&lt;span style="color:#658b00">length&lt;/span>, serializeTypeCurrentRPC));
&lt;span style="color:#228b22">// header data
&lt;/span>&lt;span style="color:#228b22">&lt;/span> result.&lt;span style="color:#658b00">put&lt;/span>(headerData);
&lt;span style="color:#228b22">// body data;
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">body&lt;/span> != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>) {
result.&lt;span style="color:#658b00">put&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">body&lt;/span>);
}
result.&lt;span style="color:#658b00">flip&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> result;
}
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[] &lt;span style="color:#008b45">headerEncode&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">makeCustomHeaderToNet&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (SerializeType.&lt;span style="color:#658b00">ROCKETMQ&lt;/span> == serializeTypeCurrentRPC) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> RocketMQSerializable.&lt;span style="color:#658b00">rocketMQProtocolEncode&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>);
} &lt;span style="color:#8b008b;font-weight:bold">else&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> RemotingSerializable.&lt;span style="color:#658b00">encode&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>);
}
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">makeCustomHeaderToNet&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">customHeader&lt;/span> != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>) {
Field[] fields = getClazzFields(customHeader.&lt;span style="color:#658b00">getClass&lt;/span>());
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">null&lt;/span> == &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">extFields&lt;/span>) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">extFields&lt;/span> = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> HashMap&amp;lt;String, String&amp;gt;();
}
&lt;span style="color:#8b008b;font-weight:bold">for&lt;/span> (Field field : fields) {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (!Modifier.&lt;span style="color:#658b00">isStatic&lt;/span>(field.&lt;span style="color:#658b00">getModifiers&lt;/span>())) {
String name = field.&lt;span style="color:#658b00">getName&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (!name.&lt;span style="color:#658b00">startsWith&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;this&amp;#34;&lt;/span>)) {
Object value = &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
field.&lt;span style="color:#658b00">setAccessible&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>);
value = field.&lt;span style="color:#658b00">get&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">customHeader&lt;/span>);
} &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (Exception e) {
log.&lt;span style="color:#658b00">error&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;Failed to access field [{}]&amp;#34;&lt;/span>, name, e);
}
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (value != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">extFields&lt;/span>.&lt;span style="color:#658b00">put&lt;/span>(name, value.&lt;span style="color:#658b00">toString&lt;/span>());
}
}
}
}
}
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> ByteBuffer &lt;span style="color:#008b45">encodeHeader&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> encodeHeader(&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">body&lt;/span> != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span> ? &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">body&lt;/span>.&lt;span style="color:#658b00">length&lt;/span> : 0);
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> ByteBuffer &lt;span style="color:#008b45">encodeHeader&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> bodyLength) {
&lt;span style="color:#228b22">// 1&amp;gt; header length size
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> length = 4;
&lt;span style="color:#228b22">// 2&amp;gt; header data length
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[] headerData;
headerData = &lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">headerEncode&lt;/span>();
length += headerData.&lt;span style="color:#658b00">length&lt;/span>;
&lt;span style="color:#228b22">// 3&amp;gt; body data length
&lt;/span>&lt;span style="color:#228b22">&lt;/span> length += bodyLength;
ByteBuffer result = ByteBuffer.&lt;span style="color:#658b00">allocate&lt;/span>(4 + length - bodyLength);
&lt;span style="color:#228b22">// length
&lt;/span>&lt;span style="color:#228b22">&lt;/span> result.&lt;span style="color:#658b00">putInt&lt;/span>(length);
&lt;span style="color:#228b22">// header length
&lt;/span>&lt;span style="color:#228b22">&lt;/span> result.&lt;span style="color:#658b00">put&lt;/span>(markProtocolType(headerData.&lt;span style="color:#658b00">length&lt;/span>, serializeTypeCurrentRPC));
&lt;span style="color:#228b22">// header data
&lt;/span>&lt;span style="color:#228b22">&lt;/span> result.&lt;span style="color:#658b00">put&lt;/span>(headerData);
result.&lt;span style="color:#658b00">flip&lt;/span>();
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> result;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">markOnewayRPC&lt;/span>() {
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> bits = 1 &amp;lt;&amp;lt; RPC_ONEWAY;
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">flag&lt;/span> |= bits;
}
&lt;span style="color:#707a7c">@JSONField&lt;/span>(serialize = &lt;span style="color:#8b008b;font-weight:bold">false&lt;/span>)
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">boolean&lt;/span> &lt;span style="color:#008b45">isOnewayRPC&lt;/span>() {
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> bits = 1 &amp;lt;&amp;lt; RPC_ONEWAY;
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">flag&lt;/span> &amp;amp; bits) == bits;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> &lt;span style="color:#008b45">getCode&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> code;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">setCode&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> code) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">code&lt;/span> = code;
}
&lt;span style="color:#707a7c">@JSONField&lt;/span>(serialize = &lt;span style="color:#8b008b;font-weight:bold">false&lt;/span>)
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> RemotingCommandType &lt;span style="color:#008b45">getType&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">isResponseType&lt;/span>()) {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> RemotingCommandType.&lt;span style="color:#658b00">RESPONSE_COMMAND&lt;/span>;
}
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> RemotingCommandType.&lt;span style="color:#658b00">REQUEST_COMMAND&lt;/span>;
}
&lt;span style="color:#707a7c">@JSONField&lt;/span>(serialize = &lt;span style="color:#8b008b;font-weight:bold">false&lt;/span>)
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">boolean&lt;/span> &lt;span style="color:#008b45">isResponseType&lt;/span>() {
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> bits = 1 &amp;lt;&amp;lt; RPC_TYPE;
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">flag&lt;/span> &amp;amp; bits) == bits;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> LanguageCode &lt;span style="color:#008b45">getLanguage&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> language;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">setLanguage&lt;/span>(LanguageCode language) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">language&lt;/span> = language;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> &lt;span style="color:#008b45">getVersion&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> version;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">setVersion&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> version) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">version&lt;/span> = version;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> &lt;span style="color:#008b45">getOpaque&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> opaque;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">setOpaque&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> opaque) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">opaque&lt;/span> = opaque;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> &lt;span style="color:#008b45">getFlag&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> flag;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">setFlag&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> flag) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">flag&lt;/span> = flag;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> String &lt;span style="color:#008b45">getRemark&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> remark;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">setRemark&lt;/span>(String remark) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">remark&lt;/span> = remark;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[] &lt;span style="color:#008b45">getBody&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> body;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">setBody&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">byte&lt;/span>[] body) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">body&lt;/span> = body;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> HashMap&amp;lt;String, String&amp;gt; &lt;span style="color:#008b45">getExtFields&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> extFields;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">setExtFields&lt;/span>(HashMap&amp;lt;String, String&amp;gt; extFields) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">extFields&lt;/span> = extFields;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">addExtField&lt;/span>(String key, String value) {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (&lt;span style="color:#8b008b;font-weight:bold">null&lt;/span> == extFields) {
extFields = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> HashMap&amp;lt;String, String&amp;gt;();
}
extFields.&lt;span style="color:#658b00">put&lt;/span>(key, value);
}
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> String &lt;span style="color:#008b45">toString&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#cd5555">&amp;#34;RemotingCommand [code=&amp;#34;&lt;/span> + code + &lt;span style="color:#cd5555">&amp;#34;, language=&amp;#34;&lt;/span> + language + &lt;span style="color:#cd5555">&amp;#34;, version=&amp;#34;&lt;/span> + version + &lt;span style="color:#cd5555">&amp;#34;, opaque=&amp;#34;&lt;/span> + opaque + &lt;span style="color:#cd5555">&amp;#34;, flag(B)=&amp;#34;&lt;/span>
+ Integer.&lt;span style="color:#658b00">toBinaryString&lt;/span>(flag) + &lt;span style="color:#cd5555">&amp;#34;, remark=&amp;#34;&lt;/span> + remark + &lt;span style="color:#cd5555">&amp;#34;, extFields=&amp;#34;&lt;/span> + extFields + &lt;span style="color:#cd5555">&amp;#34;, serializeTypeCurrentRPC=&amp;#34;&lt;/span>
+ serializeTypeCurrentRPC + &lt;span style="color:#cd5555">&amp;#34;]&amp;#34;&lt;/span>;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> SerializeType &lt;span style="color:#008b45">getSerializeTypeCurrentRPC&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> serializeTypeCurrentRPC;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">setSerializeTypeCurrentRPC&lt;/span>(SerializeType serializeTypeCurrentRPC) {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">serializeTypeCurrentRPC&lt;/span> = serializeTypeCurrentRPC;
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="æ„Ÿè°¢-">æ„Ÿè°¢ !&lt;/h1>
- https://pinkhello.me/posts/rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E9%80%9A%E4%BF%A1%E7%BB%84%E4%BB%B6/ - PinkHello, All Rights Reserved</description></item><item><title>RocketMQæºç é˜…è¯» å¼€ç¯‡</title><link>https://pinkhello.me/posts/rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%BC%80%E7%AF%87/</link><pubDate>Wed, 19 May 2021 10:02:20 +0800</pubDate><guid>https://pinkhello.me/posts/rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%BC%80%E7%AF%87/</guid><description>PinkHello https://pinkhello.me/posts/rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%BC%80%E7%AF%87/ -&lt;h1 id="rocketmq-æ˜¯ä»€ä¹ˆ">RocketMQ æ˜¯ä»€ä¹ˆ?&lt;/h1>
&lt;p>&lt;a href="http://rocketmq.apache.org/">RocketMQ&lt;/a> æ˜¯ &lt;code>Alibaba&lt;/code> æèµ ç»™ &lt;code>Apache&lt;/code> çš„ä¸€æ¬¾åˆ†å¸ƒå¼ã€é˜Ÿåˆ—æ¨¡å‹çš„å¼€æºæ¶ˆæ¯ä¸­é—´ä»¶ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>Github&lt;/code> &lt;a href="https://github.com/apache/rocketmq">https://github.com/apache/rocketmq&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ä»å®˜ç½‘ä¹Ÿèƒ½çœ‹å‡ºå®ƒçš„ä¸€äº›ç‰¹æ€§:&lt;/p>
&lt;ul>
&lt;li>ä½å»¶è¿Ÿ&lt;/li>
&lt;li>é«˜å¯ç”¨&lt;/li>
&lt;li>ä¸‡äº¿çº§çš„æ¶ˆæ¯æ”¯æŒ&lt;/li>
&lt;li>&amp;hellip;&lt;/li>
&lt;/ul>
&lt;h1 id="rocketmq-åŸºæœ¬æ¦‚å¿µ">&lt;code>RocketMQ&lt;/code> åŸºæœ¬æ¦‚å¿µ&lt;/h1>
&lt;p>&lt;code>RocketMQ&lt;/code> æ˜¯ç”± &lt;code>Producer&lt;/code>ã€&lt;code>Broker&lt;/code>ã€&lt;code>Consumer&lt;/code> ä¸‰éƒ¨åˆ†ç»„æˆ, &lt;code>Producer&lt;/code> è´Ÿè´£ç”Ÿäº§ &lt;code>Message&lt;/code>, &lt;code>Consumer&lt;/code> è´Ÿè´£æ¶ˆè´¹ &lt;code>Message&lt;/code>, &lt;code>Broker&lt;/code> è´Ÿè´£å­˜å‚¨ &lt;code>Message&lt;/code>ã€‚
æ¯ä¸ª &lt;code>Broker&lt;/code> å¯ä»¥å­˜å‚¨å¤šä¸ª &lt;code>Topic&lt;/code> çš„æ¶ˆæ¯, æ¯ä¸ª &lt;code>Topic&lt;/code> çš„æ¶ˆæ¯ä¹Ÿå¯ä»¥åˆ†ç‰‡å­˜å‚¨åœ¨ä¸åŒçš„ &lt;code>Broker&lt;/code> ä¸Šã€‚ &lt;code>Message Queue&lt;/code> ç”¨äºå­˜å‚¨æ¶ˆæ¯çš„ç‰©ç†åœ°å€ï¼Œæ¯ä¸ª &lt;code>Topic&lt;/code> çš„æ¶ˆæ¯åœ°å€å­˜å‚¨äºå¯¹æ­Œ &lt;code>Message Queue&lt;/code> ä¸­ã€‚
&lt;code>Consumer Group&lt;/code> ç”±å¤šä¸ª &lt;code>Consumer&lt;/code> å®ä¾‹ç»„æˆã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>Producer&lt;/code> è´Ÿè´£ç”Ÿäº§æ¶ˆæ¯ï¼ŒåŒæ­¥å‘é€ã€å¼‚æ­¥å‘é€ã€é¡ºåºå‘é€ã€å•å‘å‘é€ã€‚åŒæ­¥å’Œå¼‚æ­¥éœ€è¦ &lt;code>Broker&lt;/code> ç¡®è®¤ä¿¡æ¯ï¼Œå•å‘å‘é€ä¸éœ€è¦ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Consumer&lt;/code> è´Ÿè´£æ¶ˆè´¹æ¶ˆæ¯ï¼Œä¸€èˆ¬å¼‚æ­¥æ¶ˆè´¹ã€‚ä¸€ä¸ªæ¶ˆè´¹è€…ä¼šä» &lt;code>Broker&lt;/code> æ‹‰å–æ¶ˆæ¯ã€‚ï¼ˆæ‹‰å–å¼æ¶ˆè´¹ã€æ¨åŠ¨å¼æ¶ˆè´¹ï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Broker Server&lt;/code> è´Ÿè´£å­˜å‚¨ã€è½¬å‘æ¶ˆæ¯ã€‚ æ¥æ”¶ &lt;code>Producer&lt;/code> å‘é€æ¥çš„æ¶ˆæ¯å¹¶å­˜å‚¨ã€åŒæ—¶ä¸º &lt;code>Consumer&lt;/code> æ‹‰å–è¯·æ±‚åšå‡†å¤‡ã€‚å½“ç„¶ä¹Ÿå­˜å‚¨è¿™æ¶ˆæ¯ç›¸å…³çš„å…ƒæ•°æ®ï¼ˆæ¶ˆè´¹ç»„ã€æ¶ˆè´¹è¿›åº¦åç§»ã€ä¸»é¢˜ã€é˜Ÿåˆ—æ¶ˆæ¯ç­‰ï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Name Server&lt;/code> ä¸ºæ¶ˆæ¯è·¯ç”±çš„æä¾›è€…ã€‚&lt;code>Producer&lt;/code> å’Œ &lt;code>Consumer&lt;/code> èƒ½å¤Ÿé€šè¿‡ å®ƒæŸ¥æ‰¾å„ä¸ª &lt;code>Topic&lt;/code> ç›¸åº”çš„ &lt;code>Broker IP åˆ—è¡¨&lt;/code>ï¼Œå¤šä¸ª &lt;code>Name Server&lt;/code> ç»„æˆé›†ç¾¤ï¼Œç›¸äº’ç‹¬ç«‹ã€æ²¡æœ‰ä¿¡æ¯äº¤æ¢ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Message&lt;/code> æ¶ˆæ¯ç³»ç»Ÿæ‰€ä¼ è¾“ä¿¡æ¯çš„ç‰©ç†è½½ä½“ï¼Œç”Ÿäº§å’Œæ¶ˆè´¹æ•°æ®çš„æœ€å°å•å…ƒï¼Œæ¯æ¡æ¶ˆæ¯å¿…é¡»å±äºä¸€ä¸ª &lt;code>Topic&lt;/code>, &lt;code>RocketMQ&lt;/code> ä¸­æ¯ä¸ªæ¶ˆæ¯æ‹¥æœ‰ä¸€ä¸ªå”¯ä¸€çš„ &lt;code>MessageID&lt;/code>ï¼Œä¸”å¯ä»¥æºå¸¦ä¸šåŠ¡æ ‡è¯†çš„&lt;code>Key&lt;/code>ã€‚ç³»ç»Ÿæä¾›é€šè¿‡ &lt;code>MessageId&lt;/code> å’Œ &lt;code>Key&lt;/code> æŸ¥è¯¢æ¶ˆæ¯çš„åŠŸèƒ½&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Topic&lt;/code> è¡¨ç¤ºä¸€ç±»æ¶ˆæ¯çš„é›†åˆï¼Œæ¯ä¸ª &lt;code>Topic&lt;/code> åŒ…å«è‹¥å¹²æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯æ™ºåªèƒ½å±äºä¸€ä¸ª &lt;code>topic&lt;/code>ï¼Œæ˜¯ &lt;code>RocketMQ&lt;/code> è¿›è¡Œ æ¶ˆæ¯å®šä¹‰çš„åŸºæœ¬å•ä½ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Tag&lt;/code> ä¸ºæ¶ˆæ¯è®¾ç½®çš„æ ‡å¿—ï¼Œç”¨äºåŒä¸€ä¸ª &lt;code>Topic&lt;/code> ä¸‹åŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯ã€‚æ¥è‡ªåŒä¸€ä¸ªä¸šåŠ¡å•å…ƒçš„æ¶ˆæ¯ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœ¨åŒä¸€ä¸ªä¸»é¢˜ä¸‹è®¾ç½®ä¸åŒçš„æ ‡ç­¾ã€‚Tag èƒ½å¤Ÿæœ‰æ•ˆçš„ä¿æŒä»£ç æ¸…æ™°åº¦å’Œè¿è´¯æ€§ï¼Œå¹¶ä¼˜åŒ– &lt;code>RocketMQ&lt;/code> çš„æŸ¥è¯¢ç³»ç»Ÿã€‚ &lt;code>Consumer&lt;/code> å¯ä»¥æ ¹æ® &lt;code>Tag&lt;/code> å®ç°ä¸åŒçš„å­ä¸»é¢˜çš„ä¸åŒæ¶ˆè´¹é€»è¾‘ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Pull Consumer&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Push Consumer&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Producer Group&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Consumer Group&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Clustering&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Broadcasting&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Normal Ordered Message&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>Strictly Ordered Message&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h1 id="rocketmq-éƒ¨ç½²æ¶æ„">&lt;code>RocketMQ&lt;/code> éƒ¨ç½²æ¶æ„&lt;/h1>
&lt;p>&lt;img src="https://pinkhello.me/rocketmq/rocketmq_architecture_3.png" alt="RocketMQéƒ¨ç½²æ¶æ„">&lt;/p>
&lt;ul>
&lt;li>&lt;code>Producer&lt;/code>: æ¶ˆæ¯å‘å¸ƒå†³èµ›ã€æ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ï¼Œ&lt;code>Producer&lt;/code> é€šè¿‡MQçš„è´Ÿè½½å‡è¡¡è«æ¬¾é€‰æ‹©ç›¸åº”çš„ &lt;code>Broker&lt;/code> è¿›è¡Œæ¶ˆæ¯æŠ•é€’ã€‚&lt;/li>
&lt;li>&lt;code>Consumer&lt;/code>: æ¶ˆæ¯æ¶ˆè´¹è§’è‰²ã€æ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ï¼Œæ”¯æŒ&lt;code>Pushæ–¹å¼&lt;/code>ã€&lt;code>Pullæ–¹å¼&lt;/code>å¯¹æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ï¼ŒåŒæ—¶ä¹ŸæŒ‡å‡º&lt;code>é›†ç¾¤æ–¹å¼&lt;/code>å’Œ&lt;code>å¹¿æ’­æ–¹å¼&lt;/code>è¿›è¡Œæ¶ˆè´¹ã€‚&lt;/li>
&lt;li>&lt;code>Name Server&lt;/code>: &lt;code>NameServer&lt;/code> æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„&lt;code>Topicè·¯ç”±æ³¨å†Œä¸­å¿ƒ&lt;/code>ï¼Œå…¶è§’è‰²ç±»ä¼¼Dubboä¸­çš„zookeeperï¼Œæ”¯æŒBrokerçš„åŠ¨æ€æ³¨å†Œä¸å‘ç°ã€‚&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;ul>
&lt;li>&lt;code>Brokerç®¡ç†&lt;/code>ï¼Œ&lt;code>NameServer&lt;/code> æ¥å— &lt;code>Brokeré›†ç¾¤&lt;/code> çš„æ³¨å†Œä¿¡æ¯å¹¶ä¸”ä¿å­˜ä¸‹æ¥ä½œä¸ºè·¯ç”±ä¿¡æ¯çš„åŸºæœ¬æ•°æ®ã€‚ç„¶åæä¾›å¿ƒè·³æ£€æµ‹æœºåˆ¶ï¼Œæ£€æŸ¥&lt;code>Broker&lt;/code>æ˜¯å¦è¿˜å­˜æ´»ï¼›&lt;/li>
&lt;li>&lt;code>è·¯ç”±ä¿¡æ¯ç®¡ç†&lt;/code>, æ¯ä¸ª &lt;code>NameServer&lt;/code> å°†ä¿å­˜å…³äº &lt;code>Broker&lt;/code> é›†ç¾¤çš„æ•´ä¸ªè·¯ç”±ä¿¡æ¯å’Œç”¨äºå®¢æˆ·ç«¯æŸ¥è¯¢çš„é˜Ÿåˆ—ä¿¡æ¯ã€‚ç„¶å&lt;code>Producer&lt;/code>å’Œ&lt;code>Consumer&lt;/code> é€šè¿‡ &lt;code>NameServer&lt;/code>å°±å¯ä»¥çŸ¥é“æ•´ä¸ª&lt;code>Brokeré›†ç¾¤çš„è·¯ç”±ä¿¡æ¯&lt;/code>ï¼Œä»è€Œè¿›è¡Œæ¶ˆæ¯çš„æŠ•é€’å’Œæ¶ˆè´¹ã€‚
&lt;code>NameServer&lt;/code>é€šå¸¸ä¹Ÿæ˜¯é›†ç¾¤çš„æ–¹å¼éƒ¨ç½²ï¼Œå„å®ä¾‹é—´ç›¸äº’ä¸è¿›è¡Œä¿¡æ¯é€šè®¯ã€‚&lt;code>Broker&lt;/code>æ˜¯å‘æ¯ä¸€å°&lt;code>NameServer&lt;/code>æ³¨å†Œè‡ªå·±çš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ª&lt;code>NameServer&lt;/code>å®ä¾‹ä¸Šé¢éƒ½ä¿å­˜ä¸€ä»½å®Œæ•´çš„è·¯ç”±ä¿¡æ¯ã€‚å½“æŸä¸ª&lt;code>NameServer&lt;/code>å› æŸç§åŸå› ä¸‹çº¿äº†ï¼Œ&lt;code>Broker&lt;/code>ä»ç„¶å¯ä»¥å‘å…¶å®ƒ&lt;code>NameServer&lt;/code>åŒæ­¥å…¶è·¯ç”±ä¿¡æ¯ï¼Œ&lt;code>Producer&lt;/code>,&lt;code>Consumer&lt;/code>ä»ç„¶å¯ä»¥åŠ¨æ€æ„ŸçŸ¥&lt;code>Broker&lt;/code>çš„è·¯ç”±çš„ä¿¡æ¯&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>&lt;code>RocketMQ&lt;/code> ç½‘è·¯éƒ¨ç½²ç‰¹ç‚¹:&lt;/p>
&lt;ul>
&lt;li>&lt;code>NameSever&lt;/code> æ˜¯æ— çŠ¶æ€èŠ‚ç‚¹ï¼Œå¯é›†ç¾¤éƒ¨ç½²ï¼ŒèŠ‚ç‚¹ä¹‹é—´æ— ä»»ä½•ä¿¡æ¯åŒæ­¥ã€‚&lt;code>Broker&lt;/code> æ˜¯å‘æ¯ä¸€å°&lt;code>NameServer&lt;/code>æ³¨å†Œè‡ªå·±çš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ª&lt;code>NameServer&lt;/code>å®ä¾‹ä¸Šé¢éƒ½ä¿å­˜ä¸€ä»½å®Œæ•´çš„è·¯ç”±ä¿¡æ¯ã€‚å½“æŸä¸ª&lt;code>NameServer&lt;/code>å› æŸç§åŸå› ä¸‹çº¿äº†ï¼Œ&lt;code>Broker&lt;/code>ä»ç„¶å¯ä»¥å‘å…¶å®ƒ&lt;code>NameServer&lt;/code>åŒæ­¥å…¶è·¯ç”±ä¿¡æ¯ï¼Œ&lt;code>Producer&lt;/code>,&lt;code>Consumer&lt;/code>ä»ç„¶å¯ä»¥åŠ¨æ€æ„ŸçŸ¥&lt;code>Broker&lt;/code>çš„è·¯ç”±çš„ä¿¡æ¯ã€‚&lt;/li>
&lt;li>&lt;code>Broker&lt;/code> éƒ¨ç½²ç›¸å¯¹å¤æ‚ï¼Œ&lt;code>Broker&lt;/code> åˆ†ä¸º &lt;code>Master&lt;/code> ä¸ &lt;code>Slave&lt;/code> ï¼Œä¸€ä¸ª&lt;code>Master&lt;/code>å¯ä»¥å¯¹åº”å¤šä¸ª&lt;code>Slave&lt;/code>ï¼Œä½†æ˜¯ä¸€ä¸ª&lt;code>Slave&lt;/code>åªèƒ½å¯¹åº”ä¸€ä¸ª&lt;code>Master&lt;/code>ï¼Œ&lt;code>Master&lt;/code>ä¸&lt;code>Slave&lt;/code> çš„å¯¹åº”å…³ç³»é€šè¿‡æŒ‡å®šç›¸åŒçš„&lt;code>BrokerName&lt;/code>ï¼Œä¸åŒçš„&lt;code>BrokerId&lt;/code> æ¥å®šä¹‰ï¼Œ&lt;code>BrokerIdä¸º0&lt;/code>è¡¨ç¤º&lt;code>Master&lt;/code>ï¼Œ&lt;code>é0&lt;/code>è¡¨ç¤º&lt;code>Slave&lt;/code>ã€‚&lt;code>Master&lt;/code>ä¹Ÿå¯ä»¥éƒ¨ç½²å¤šä¸ªã€‚æ¯ä¸ª&lt;code>Broker&lt;/code>ä¸&lt;code>NameServer&lt;/code>é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹å»ºç«‹é•¿è¿æ¥ï¼Œå®šæ—¶æ³¨å†Œ&lt;code>Topic&lt;/code>ä¿¡æ¯åˆ°æ‰€æœ‰&lt;code>NameServer&lt;/code>ã€‚ æ³¨æ„ï¼šå½“å‰&lt;code>RocketMQ&lt;/code>ç‰ˆæœ¬åœ¨éƒ¨ç½²æ¶æ„ä¸Šæ”¯æŒ&lt;code>ä¸€Masterå¤šSlave&lt;/code>ï¼Œä½†åªæœ‰&lt;code>BrokerId=1&lt;/code>çš„ä»æœåŠ¡å™¨æ‰ä¼šå‚ä¸æ¶ˆæ¯çš„è¯»è´Ÿè½½ã€‚&lt;/li>
&lt;li>&lt;code>Producer&lt;/code> ä¸ &lt;code>NameServer&lt;/code> é›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆéšæœºé€‰æ‹©ï¼‰å»ºç«‹é•¿è¿æ¥ï¼Œå®šæœŸä»&lt;code>NameServer&lt;/code>è·å–&lt;code>Topicè·¯ç”±ä¿¡æ¯&lt;/code>ï¼Œå¹¶å‘æä¾›&lt;code>Topic&lt;/code>æœåŠ¡çš„&lt;code>Master&lt;/code>å»ºç«‹é•¿è¿æ¥ï¼Œä¸”å®šæ—¶å‘&lt;code>Master&lt;/code>å‘é€å¿ƒè·³ã€‚&lt;code>Producer&lt;/code>å®Œå…¨æ— çŠ¶æ€ï¼Œå¯é›†ç¾¤éƒ¨ç½²ã€‚&lt;/li>
&lt;li>&lt;code>Consumer&lt;/code> ä¸ &lt;code>NameServer&lt;/code> é›†ç¾¤ä¸­çš„å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆéšæœºé€‰æ‹©ï¼‰å»ºç«‹é•¿è¿æ¥ï¼Œå®šæœŸä»&lt;code>NameServe&lt;/code>rè·å–&lt;code>Topicè·¯ç”±ä¿¡æ¯&lt;/code>ï¼Œå¹¶å‘æä¾›&lt;code>Topic&lt;/code>æœåŠ¡çš„&lt;code>Master&lt;/code>ã€&lt;code>Slave&lt;/code>å»ºç«‹é•¿è¿æ¥ï¼Œä¸”å®šæ—¶å‘&lt;code>Master&lt;/code>ã€&lt;code>Slave&lt;/code>å‘é€å¿ƒè·³ã€‚&lt;code>Consumer&lt;/code>æ—¢å¯ä»¥ä»&lt;code>Master&lt;/code>è®¢é˜…æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥ä»&lt;code>Slave&lt;/code>è®¢é˜…æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…åœ¨å‘&lt;code>Master&lt;/code>æ‹‰å–æ¶ˆæ¯æ—¶ï¼Œ&lt;code>Master&lt;/code>æœåŠ¡å™¨ä¼šæ ¹æ®æ‹‰å–åç§»é‡ä¸æœ€å¤§åç§»é‡çš„è·ç¦»ï¼ˆåˆ¤æ–­æ˜¯å¦è¯»è€æ¶ˆæ¯ï¼Œäº§ç”Ÿè¯»&lt;code>I/O&lt;/code>ï¼‰ï¼Œä»¥åŠä»æœåŠ¡å™¨æ˜¯å¦å¯è¯»ç­‰å› ç´ å»ºè®®ä¸‹ä¸€æ¬¡æ˜¯ä»&lt;code>Master&lt;/code>è¿˜æ˜¯&lt;code>Slave&lt;/code>æ‹‰å–ã€‚&lt;/li>
&lt;/ul>
&lt;h1 id="rocketmq--äº‹åŠ¡æ¶ˆæ¯-">&lt;code>RocketMQ&lt;/code> * äº‹åŠ¡æ¶ˆæ¯ *&lt;/h1>
&lt;p>åé¢ä¸“é—¨ä¸€ç« è®²è¿°è¿™ä¸ªäº‹åŠ¡æ¶ˆæ¯&lt;/p>
- https://pinkhello.me/posts/rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%BC%80%E7%AF%87/ - PinkHello, All Rights Reserved</description></item><item><title>11 å‡ ä¸ªå…³äºkafkaçš„çŸ¥è¯†ç‚¹</title><link>https://pinkhello.me/posts/11-%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/</link><pubDate>Wed, 19 May 2021 08:55:19 +0800</pubDate><guid>https://pinkhello.me/posts/11-%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/</guid><description>PinkHello https://pinkhello.me/posts/11-%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/ -&lt;h1 id="è®¤è¯†kafka">è®¤è¯†kafka&lt;/h1>
&lt;p>&lt;code>Kafka&lt;/code> æ˜¯åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿï¼Œ &lt;code>Apache&lt;/code> çš„å­é¡¹ç›®ã€‚æ ‡è¯­ä¹Ÿå˜äº†&amp;quot;åˆ†å¸ƒå¼æµå¹³å°&amp;quot;ï¼Œ
ä¸ä¼ ç»Ÿçš„æ¶ˆæ¯ç³»ç»Ÿä¸åŒç‚¹åœ¨äº&lt;/p>
&lt;ul>
&lt;li>åˆ†å¸ƒå¼çš„ï¼Œæ˜“äºæ‰©å±•&lt;/li>
&lt;li>ä¸ºå‘å¸ƒå’Œè®¢é˜…æä¾›äº†é«˜åå&lt;/li>
&lt;li>æ”¯æŒå¤šè®¢é˜…è€…ï¼Œåœ¨å¤±è´¥çš„æ—¶å€™èƒ½è‡ªåŠ¨å¹³è¡¡æ¶ˆè´¹è€…&lt;/li>
&lt;li>æ¶ˆæ¯çš„æŒä¹…åŒ–&lt;/li>
&lt;/ul>
&lt;h1 id="kafka-çš„æ¶æ„">&lt;code>kafka&lt;/code> çš„æ¶æ„&lt;/h1>
&lt;p>å‡ ç‚¹ï¼Ÿ&lt;/p>
&lt;ul>
&lt;li>&lt;code>Kafka&lt;/code> çš„ &lt;code>Topic&lt;/code> å’Œ &lt;code>Partition&lt;/code> å†…éƒ¨å¦‚ä½•å­˜å‚¨ï¼Ÿ&lt;/li>
&lt;li>ä¸ä¼ ç»Ÿçš„æ¶ˆæ¯ç³»ç»Ÿç›¸æ¯”ï¼Œ &lt;code>Kafka&lt;/code> æ¶ˆè´¹æ¨¡å‹æœ‰å•¥ä¼˜ç‚¹ï¼Ÿ&lt;/li>
&lt;li>&lt;code>Kafka&lt;/code> æ˜¯å¦‚ä½•å®ç°åˆ†å¸ƒå¼æ•°æ®å­˜å‚¨å’Œæ•°æ®çš„è¯»å–ï¼Ÿ&lt;/li>
&lt;/ul>
&lt;h2 id="kafka-æ¶æ„">&lt;code>Kafka&lt;/code> æ¶æ„&lt;/h2>
&lt;p>ä¸€ä¸ª &lt;code>Kafka&lt;/code> é›†ç¾¤ï¼Œå¤šä¸ª &lt;code>Producer&lt;/code> ï¼Œå¤šä¸ª &lt;code>Consumer&lt;/code> ï¼Œå¤šä¸ª &lt;code>Broker&lt;/code> ï¼Œ é€‰ä¸¾ &lt;code>Leader&lt;/code> ä»¥åŠåœ¨ &lt;code>Consumer Group&lt;/code> å‘ç”Ÿå˜åŒ–æ—¶è¿›è¡Œ &lt;code>reblance&lt;/code> ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>Broker&lt;/code> æ¶ˆæ¯ä¸­é—´ä»¶çš„å¤„ç†èŠ‚ç‚¹ï¼Œä¸€ä¸ª &lt;code>Kafka&lt;/code> èŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ª &lt;code>Broker&lt;/code> ï¼Œ ä¸€ä¸ªæˆ–è€…å¤šä¸ª &lt;code>Broker&lt;/code> ç»„æˆ &lt;code>Kafka&lt;/code> é›†ç¾¤&lt;/li>
&lt;li>&lt;code>Topic&lt;/code> &lt;code>Kafka&lt;/code> æ ¹æ® &lt;code>Topic&lt;/code> å¯¹ &lt;code>Message&lt;/code> è¿›è¡Œå½’ç±»ï¼Œå‘å¸ƒåˆ° &lt;code>Kafka&lt;/code> çš„æ¯æ¡ &lt;code>Message&lt;/code> éƒ½è¦æŒ‡å®š &lt;code>Topic&lt;/code>&lt;/li>
&lt;li>&lt;code>Producer&lt;/code> å‘ &lt;code>Broker&lt;/code> å‘ç”Ÿ &lt;code>message&lt;/code>&lt;/li>
&lt;li>&lt;code>Consumer&lt;/code> ä» &lt;code>Broker&lt;/code> è¯»å– &lt;code>message&lt;/code>&lt;/li>
&lt;li>&lt;code>Consumer Group&lt;/code> æ¯ä¸ª Consumer å±äºç‰¹å®šçš„ Groupï¼Œä¸€ä¸ª Message å¯ä»¥å‘é€ç»™ä¸åŒçš„ &lt;code>Consumer Group&lt;/code> ï¼Œä½†æ˜¯åŒä¸€ä¸ª &lt;code>Group&lt;/code> ä¸‹çš„åªæœ‰ä¸€ä¸ª &lt;code>Consumer&lt;/code> èƒ½æ¶ˆè´¹è¯¥ &lt;code>Message&lt;/code>&lt;/li>
&lt;li>&lt;code>Partition&lt;/code> ç‰©ç†æ¦‚å¿µï¼Œä¸€ä¸ª &lt;code>Topic&lt;/code> ä¸‹å¯ä»¥åˆ†ä¸ºå¤šä¸ª &lt;code>Partition&lt;/code>, æ¯ä¸ª &lt;code>Partition&lt;/code> ä¸‹æ˜¯æœ‰åºçš„ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://pinkhello.me/%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/kafka-%E6%A1%86%E6%9E%B6%E5%9B%BE.jpeg" alt="kafka æ¡†æ¶å›¾">
&lt;img src="https://pinkhello.me/%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/kafka-%E6%95%B0%E6%8D%AE%E6%B5%81%E5%90%91.png" alt="kafka æ•°æ®æµå‘">&lt;/p>
&lt;p>ä¸‹é¢æ¥è®²è¿° ä¸Šé¢ä¸ºé—®é¢˜å•Š&lt;/p>
&lt;h2 id="kafka-çš„-topic-å’Œ-partition-å†…éƒ¨å¦‚ä½•å­˜å‚¨">&lt;code>Kafka&lt;/code> çš„ &lt;code>Topic&lt;/code> å’Œ &lt;code>Partition&lt;/code> å†…éƒ¨å¦‚ä½•å­˜å‚¨?&lt;/h2>
&lt;p>&lt;code>Kafka&lt;/code> ä¸ºæ¯ä¸ª &lt;code>Topic&lt;/code> ç»´æŠ¤äº†åˆ†åŒºï¼ˆ &lt;code>Partition&lt;/code> ï¼‰çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ¯ä¸ª &lt;code>Partition&lt;/code> åœ¨ &lt;code>kafka&lt;/code> å­˜å‚¨å±‚ä¸º &lt;code>Append Log&lt;/code>ã€‚ä»»ä½•å‘å¸ƒåˆ°æ­¤ &lt;code>Partition&lt;/code> çš„æ¶ˆæ¯éƒ½ä¼šè¢«è¿½åŠ åˆ° &lt;code>Log&lt;/code> æ–‡ä»¶å°¾éƒ¨ã€‚
åœ¨æ¯ä¸ª &lt;code>Partition&lt;/code> æ¯ä¸ªæ¶ˆæ¯æ˜¯æŒ‰ç…§ &lt;code>Timeline&lt;/code> åˆ†é…åˆ°ä¸€ä¸ªå•è°ƒé€’å¢çš„é¡ºåºç¼–å·çš„ï¼Œå°±æ˜¯æˆ‘ä»¬è¯´çš„ &lt;code>Offset&lt;/code>, &lt;code>Offset&lt;/code> æ˜¯ä¸€ä¸ª &lt;code>long&lt;/code> å‹çš„æ•°å­—ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ª &lt;code>Offset&lt;/code> ç¡®å®šä¸€æ¡åœ¨è¯¥ &lt;code>Partition&lt;/code> ä¸‹çš„å”¯ä¸€æ¶ˆæ¯ã€‚&lt;/p>
&lt;p>è¿™æ ·å°±æœ‰ä¸ªç‰¹æ€§ï¼š &lt;code>Partition&lt;/code> ä¸‹æœ‰åº, &lt;code>Topic&lt;/code> ä¸‹æ— æ³•ä¿è¯æœ‰åºã€‚&lt;/p>
&lt;p>é‚£ä¹ˆï¼Œé—®é¢˜æ¥äº†ï¼Ÿè¿™äº› &lt;code>Message&lt;/code> å¦‚ä½•å‘é€åˆ°å„ä¸ª &lt;code>Partition&lt;/code> çš„å‘¢ï¼Ÿå¦‚ä½•æŒ‡å®šçš„å‘¢ï¼Ÿ&lt;/p>
&lt;ul>
&lt;li>å‘é€è‡³å“ªä¸ª &lt;code>Partition&lt;/code> æ˜¯ç”± ç”Ÿäº§è€…å†³å®šçš„ã€‚&lt;/li>
&lt;li>å¦‚æœæ²¡æœ‰ &lt;code>Key&lt;/code> å€¼ï¼Œåˆ™è½®è¯¢å‘é€&lt;/li>
&lt;li>å¦‚æœæœ‰ &lt;code>key&lt;/code> å€¼ï¼Œå¯¹ &lt;code>key&lt;/code> å€¼è¿›è¡Œ &lt;code>Hash&lt;/code> ï¼Œç„¶åå¯¹åˆ†åŒºæ•°é‡å–ä½™ï¼Œä¿è¯åŒä¸€ä¸ª &lt;code>Key&lt;/code> å€¼çš„ä¼šè·¯ç”±åˆ°åŒä¸€ä¸ª &lt;code>Partition&lt;/code> ã€‚å¦‚æœæƒ³é˜Ÿåˆ—å¼ºé¡ºåºä¸€è‡´ï¼Œå¯ä»¥è®©æ‰€æœ‰çš„æ¶ˆæ¯è®¾ç½®ä¸ºåŒä¸€ä¸ª &lt;code>Key&lt;/code> ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="ä¸ä¼ ç»Ÿçš„æ¶ˆæ¯ç³»ç»Ÿç›¸æ¯”-kafka-æ¶ˆè´¹æ¨¡å‹æœ‰å•¥ä¼˜ç‚¹">ä¸ä¼ ç»Ÿçš„æ¶ˆæ¯ç³»ç»Ÿç›¸æ¯”ï¼Œ &lt;code>Kafka&lt;/code> æ¶ˆè´¹æ¨¡å‹æœ‰å•¥ä¼˜ç‚¹ï¼Ÿ&lt;/h2>
&lt;h3 id="kafka-consumer-æ¶ˆè´¹æ¨¡å‹">&lt;code>Kafka Consumer&lt;/code> æ¶ˆè´¹æ¨¡å‹&lt;/h3>
&lt;p>æ¶ˆæ¯ç”± &lt;code>producer&lt;/code> å‘é€åˆ° &lt;code>Kafka&lt;/code> é›†ç¾¤åï¼Œè¢« &lt;code>Consumer&lt;/code> æ¶ˆè´¹ï¼Œä¸€èˆ¬æ¥è¯´æˆ‘ä»¬çš„æ¶ˆè´¹æ¨¡å‹æœ‰ä¸¤ç§ï¼š &lt;code>Push&lt;/code> æ¨é€æ¨¡å‹ å’Œ &lt;code>Pull&lt;/code> æ‹‰å–æ¨¡å‹&lt;/p>
&lt;p>&lt;code>Push&lt;/code> æ¨é€æ¨¡å‹ï¼š&lt;/p>
&lt;blockquote>
&lt;p>æ¶ˆæ¯ &lt;code>Broker&lt;/code> è®°å½•æ¶ˆè´¹çŠ¶æ€ã€‚æ¶ˆæ¯ &lt;code>Broker&lt;/code> å°†æ¶ˆæ¯æ¨é€ç»™æ¶ˆè´¹è€…åï¼Œè®°å½•è¿™æ¡æ¶ˆæ¯å·²ç»è¢«æ¶ˆè´¹ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼æ— æ³•å¾ˆå¥½çš„ä¿è¯æ¶ˆè´¹å¤„ç†çš„è¯­ä¹‰ã€‚
æ¶ˆæ¯æ¨é€å®Œæˆåï¼Œæ¶ˆè´¹è€…æŒ‚æ‰æˆ–è€…çº¿ç¨‹ Hang ä½ ï¼Œæˆ–è€…ç½‘ç»œåŸå› æœªæ”¶åˆ°ï¼Œä½†æ˜¯ æ¶ˆæ¯ &lt;code>Broker&lt;/code> å°†å…¶æ ‡è®°ä¸ºå·²æ¶ˆè´¹ï¼Œè¿™ä¸ªæ¶ˆæ¯å°†æ°¸è¿œä¸¢å¤±äº†ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œé‡‡ç”¨ &lt;code>Push&lt;/code> ï¼Œæ¶ˆæ¯æ¶ˆè´¹å®Œå…¨ä¾èµ– æ¶ˆæ¯ &lt;code>Broker&lt;/code> æ§åˆ¶ï¼Œä¸€æ—¦ &lt;code>Consumer&lt;/code> å‘ç”Ÿé˜»å¡ï¼Œä¼šå‡ºç°é—®é¢˜ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>Pull&lt;/code> æ‹‰å–æ¨¡å‹ï¼š&lt;/p>
&lt;blockquote>
&lt;p>ç”± &lt;code>Consumer&lt;/code> æ§åˆ¶ &lt;code>Speed&lt;/code> ï¼Œä»¥åŠæ¶ˆè´¹ &lt;code>Offset&lt;/code> ï¼Œ &lt;code>Consumer&lt;/code> å¯ä»¥æŒ‰ç…§ä»»æ„çš„åç§»é‡è¿›è¡Œ &lt;code>Consumer&lt;/code>
&lt;code>Consumer&lt;/code> å¯ä»¥å›æ”¾å·²ç»æ¶ˆè´¹è¿‡çš„æ¶ˆæ¯ï¼Œè¿›è¡Œé‡æ–°å¤„ç†æˆ–è€…æ¶ˆè´¹æœ€è¿‘çš„æ¶ˆæ¯&lt;/p>
&lt;/blockquote>
&lt;h3 id="kafka-çš„ç½‘ç»œæ¨¡å‹">&lt;code>Kafka&lt;/code> çš„ç½‘ç»œæ¨¡å‹&lt;/h3>
&lt;p>&lt;code>Kafka Client&lt;/code> å•çº¿ç¨‹ &lt;code>Selector&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/kafka-client-selector.png" alt="kafka å•çº¿ç¨‹æ¨¡å‹">&lt;/p>
&lt;blockquote>
&lt;p>å¹¶å‘é“¾æ¥æ•°ç›®å°ï¼Œé€»è¾‘ç®€å•ï¼Œæ•°æ®é‡å°ã€‚åœ¨ &lt;code>Kafka Consumer&lt;/code> å’Œ &lt;code>Kafka Producer&lt;/code> éƒ½æ˜¯é‡‡ç”¨çš„ å•çº¿ç¨‹æ¨¡å‹ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>kafka Server&lt;/code> å¤šçº¿ç¨‹ &lt;code>Selector&lt;/code>&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/kafka-server-selector.png" alt="kafka å¤šçº¿ç¨‹æ¨¡å‹">&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>Acceptor&lt;/code> è¿è¡Œäºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œå¯¹äºè¯»å–æ“ä½œçš„çº¿ç¨‹æ± ä¸­çº¿ç¨‹éƒ½æ˜¯åœ¨ &lt;code>selector&lt;/code> æ³¨å†Œ &lt;code>Op_Read&lt;/code> äº‹ä»¶ï¼Œè´Ÿè´£æœåŠ¡ç«¯è¯»å–è¯·æ±‚ã€‚
æˆåŠŸè¯»å–åï¼Œå°†è¯·æ±‚æ”¾å…¥ &lt;code>Message Queue&lt;/code> å…±äº«é˜Ÿåˆ—ä¸­ï¼Œç„¶ååœ¨ å†™æ“ä½œçš„çº¿ç¨‹æ± ä¸­ï¼Œå–å‡ºè¿™ä¸ªè¯·æ±‚ï¼Œå¯¹å…¶è¿›è¡Œé€»è¾‘å¤„ç†ã€‚
å³ä½¿æŸä¸ªçº¿ç¨‹é˜»å¡äº†ï¼Œåé¢è¿˜æœ‰åç»­çš„çº¿ç¨‹ä» &lt;code>Message Queue&lt;/code> å…±äº«é˜Ÿåˆ—é‡Œé¢è·å–è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚
å†™çº¿ç¨‹å¤„ç†å®Œé€»è¾‘åï¼Œç”±äºæ³¨å†Œäº† &lt;code>Op_Write&lt;/code> äº‹ä»¶ï¼Œè¿˜éœ€è¦å‘é€å“åº”ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="kafka-æ˜¯å¦‚ä½•å®ç°åˆ†å¸ƒå¼æ•°æ®å­˜å‚¨å’Œæ•°æ®çš„è¯»å–">&lt;code>Kafka&lt;/code> æ˜¯å¦‚ä½•å®ç°åˆ†å¸ƒå¼æ•°æ®å­˜å‚¨å’Œæ•°æ®çš„è¯»å–ï¼Ÿ&lt;/h2>
&lt;h3 id="kafka-é«˜å¯é çš„åˆ†å¸ƒå¼å­˜å‚¨æ¨¡å‹">&lt;code>Kafka&lt;/code> é«˜å¯é çš„åˆ†å¸ƒå¼å­˜å‚¨æ¨¡å‹&lt;/h3>
&lt;p>ä¸»è¦ä¾é  å‰¯æœ¬ æœºåˆ¶ï¼Œæœ‰äº†å‰¯æœ¬æœºåˆ¶ï¼Œæœºå™¨å®•æœºï¼Œä¹Ÿä¼šæ¢å¤ã€‚&lt;/p>
&lt;h3 id="kafka-é«˜æ€§èƒ½æ—¥å¿—å­˜å‚¨">&lt;code>Kafka&lt;/code> é«˜æ€§èƒ½æ—¥å¿—å­˜å‚¨&lt;/h3>
&lt;p>&lt;img src="https://pinkhello.me/%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/kafka-segement.png" alt="kafka é«˜æ€§èƒ½æ—¥å¿—å­˜å‚¨">
&lt;img src="https://pinkhello.me/%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/kafka-append-log.png" alt="kafka é«˜æ€§èƒ½æ—¥å¿—å­˜å‚¨">&lt;/p>
&lt;p>&lt;code>Kafka&lt;/code> çš„ä¸€ä¸ª &lt;code>Topic&lt;/code> ä¸‹çš„æ‰€æœ‰çš„ &lt;code>Message&lt;/code> éƒ½æ˜¯ä»¥ &lt;code>Partition&lt;/code> çš„æ–¹å¼ï¼Œåˆ†å¸ƒå¼å­˜å‚¨åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šã€‚&lt;/p>
&lt;p>åŒæ—¶åœ¨ kafka æœºå™¨ä¸Šï¼Œæ¯ä¸ª &lt;code>Partition&lt;/code> éƒ½ä¼šå¯¹åº”ä¸€ä¸ªæ—¥å¿—ç›®å½•ï¼Œåœ¨ç›®å½•ä¸‹é¢ä¼šå¯¹åº”å¯¹æ­Œ æ—¥å¿—åˆ†æ®µï¼ˆ&lt;code>LogSegment&lt;/code>ï¼‰ã€‚
LogSegment ç»„æˆ &amp;ldquo;.index&amp;rdquo; ä¸ &amp;ldquo;.log&amp;rdquo; , åˆ†åˆ«è¡¨ç¤º &lt;code>segment&lt;/code> ç´¢å¼•æ–‡ä»¶ å’Œ æ•°æ®æ–‡ä»¶ã€‚
ä¸¤ä¸ªæ–‡ä»¶çš„å‘½åè§„åˆ™: &lt;code>partition&lt;/code> å…¨å±€çš„ç¬¬ä¸€ä¸ª &lt;code>segment&lt;/code> ä» 0 å¼€å§‹ï¼Œåç»­çš„æ¯ä¸ª &lt;code>Segment&lt;/code> æ–‡ä»¶åä¸ºä¸Šä¸€ä¸ª &lt;code>Segment&lt;/code> æ–‡ä»¶æœ€åä¸€æ¡æ¶ˆæ¯çš„ &lt;code>offset&lt;/code> å€¼ã€‚
æ•°å€¼ä¸º 64 ä½ï¼Œ 20 ä½æ•°å­—å­—ç¬¦é•¿åº¦ï¼Œæ²¡æœ‰æ•°å­—ç”¨ 0 å¡«å……ã€‚&lt;/p>
&lt;p>å‡å¦‚æœ‰ 1000 æ¡æ¶ˆæ¯ï¼Œæ¯ä¸ª &lt;code>LogSegment&lt;/code> çš„å¤§å°ä¸º 100ï¼Œé‚£ä¹ˆå±•ç° 900-1000 çš„ç´¢å¼• å’Œ Logï¼š
&lt;img src="https://pinkhello.me/%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/kafka-log.jpg" alt="kafka LogSegment">&lt;/p>
&lt;p>&lt;code>kafka&lt;/code> æ¶ˆæ¯æ•°æ®é‡æ‰“ï¼Œé‡‡ç”¨çš„æ˜¯ &lt;code>ç¨€ç–ç´¢å¼•&lt;/code> çš„æ–¹å¼ï¼ŒåŠ å¿«åæŸ¥è¯¢é€Ÿåº¦ã€‚&lt;/p>
&lt;p>å¦‚ä½•è¯»å–æ•°æ®ï¼Ÿ å¦‚æœæˆ‘ä»¬è¦è¯»å–ç¬¬ 911 æ¡æ•°æ®&lt;/p>
&lt;ul>
&lt;li>å…ˆæ‰¾åˆ°å®ƒå±äºå“ªä¸ªæ®µï¼Ÿ äºŒåˆ†æ³•æŸ¥æ‰¾å±äºæ–‡ä»¶ï¼Œæ‰¾åˆ° 0000900.index å’Œ 0000900.log ä¹‹å&lt;/li>
&lt;li>å»ç´¢å¼•æ–‡ä»¶ 0000900.index æŸ¥æ‰¾ (911-900)=11 è¿™ä¸ªç´¢å¼• æˆ–è€… å°äº11 æœ€è¿‘çš„ç´¢å¼•&lt;/li>
&lt;li>åé¢é€šè¿‡ äºŒåˆ†æ³•æˆ‘ä»¬æ‰¾åˆ°ç´¢å¼• [10,1367]&lt;/li>
&lt;li>ç„¶åé€šè¿‡è¿™æ¡ç´¢å¼•çš„ç‰©ç†ä½ç½® 1367ï¼Œå¼€å§‹å¾€åæ‰¾ï¼ŒçŸ¥é“æ‰¾åˆ° ç¬¬ 911 æ¡æ•°æ®&lt;/li>
&lt;/ul>
&lt;p>&lt;code>ä¸ºä»€ä¹ˆåˆ†åŒºï¼Ÿåªæœ‰ä¸€ä¸ªåˆ†åŒºä¸è¡Œä¹ˆï¼Ÿåˆ†åŒºæ˜¯ä¸ºäº†å¹²å•¥ï¼Ÿé‚£ä¹ˆæ—¥å¿—ä¸ºä»€ä¹ˆè¦åˆ†æ®µå‘¢ï¼Ÿ&lt;/code>&lt;/p>
&lt;h2 id="kafka-çš„å‰¯æœ¬æœºåˆ¶">&lt;code>Kafka&lt;/code> çš„å‰¯æœ¬æœºåˆ¶&lt;/h2>
&lt;p>&lt;code>Kafka&lt;/code> å‰¯æœ¬æœºåˆ¶ä¸º å¤šä¸ªèŠ‚ç‚¹å¯¹å…¶ä»–æœåŠ¡ç«¯èŠ‚ç‚¹çš„ä¸»é¢˜åˆ†åŒºçš„æ—¥å¿—è¿›è¡Œå¤åˆ¶ã€‚å½“é›†ç¾¤æŸä¸ªèŠ‚ç‚¹å‡ºç°é—®é¢˜ï¼Œè®¿é—®è¯¥æ•…éšœèŠ‚ç‚¹çš„è¯·æ±‚å¯ä»¥è¢«è½¬ç§»åˆ°å…¶ä»–æ­£å¸¸çš„èŠ‚ç‚¹ï¼ˆè¿‡ç¨‹è„š &lt;code>reblance&lt;/code> ï¼‰&lt;/p>
&lt;p>&lt;code>kafka&lt;/code> çš„æ¯ä¸ª &lt;code>Topic&lt;/code> çš„æ¯ä¸ª &lt;code>Partition&lt;/code> éƒ½æœ‰ä¸€ä¸ª ä¸»å‰¯æœ¬ä»¥åŠ &lt;code>0-n&lt;/code> ä¸ªå‰¯æœ¬ï¼Œå‰¯æœ¬ä¿æŒä¸ä¸»å‰¯æœ¬çš„æ•°æ®åŒæ­¥ï¼Œå½“ ä¸»å‰¯æœ¬ å‡ºç°æ•…éšœæ—¶ä¼šè¢«æ›¿ä»£ã€‚&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/kafka-partition-replicas.png" alt="kafka é«˜æ€§èƒ½å‰¯æœ¬æœºåˆ¶">&lt;/p>
&lt;p>åœ¨ &lt;code>kafka&lt;/code> ä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„å‰¯æœ¬éƒ½è¢«æ‹¿æ¥ä»£æ›¿ä¸»å‰¯æœ¬çš„ï¼Œæ‰€ä»¥åœ¨ &lt;code>kafka&lt;/code> çš„ &lt;code>leader&lt;/code> èŠ‚ç‚¹ä¸­ç»´æŠ¤è€…ä¸€ä¸ª &lt;code>ISRï¼ˆIn Sync Replicasï¼‰&lt;/code>é›†åˆ
&lt;code>ISR (In Sync Replicas)&lt;/code> å‰¯æœ¬ &lt;code>follower&lt;/code> åŒæ­¥é˜Ÿåˆ—, ç»´æŠ¤ç€æœ‰èµ„æ ¼çš„ &lt;code>follower&lt;/code> çš„èŠ‚ç‚¹&lt;/p>
&lt;ul>
&lt;li>å‰¯æœ¬çš„æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»å’Œ &lt;code>ZK&lt;/code> ä¿æŒé“¾æ¥&lt;/li>
&lt;li>åœ¨åŒæ­¥è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªå‰¯æœ¬ä¸èƒ½è½åä¸»å‰¯æœ¬å¤ªå¤š(å³å‰¯æœ¬æœ€åä¸€æ¡æ¶ˆæ¯çš„ &lt;code>offset&lt;/code> å’Œ &lt;code>leader&lt;/code> å‰¯æœ¬çš„æœ€å¥½ä¸€æ¡æ¶ˆæ¯çš„ &lt;code>offset&lt;/code> ä¹‹é—´çš„å·®å€¼ä¸èƒ½è¶…è¿‡é˜ˆå€¼)
(&lt;code>replica.lag.max.messages&lt;/code>)&lt;/li>
&lt;/ul>
&lt;p>&lt;code>ARï¼ˆAssigned Replicasï¼‰&lt;/code>æ ‡è®°å‰¯æœ¬çš„å…¨é›† ï¼Œ&lt;code>OSR&lt;/code> è¡¨ç¤ºè½åè¢«å‰”é™¤çš„å‰¯æœ¬é›†åˆ&lt;/p>
&lt;p>ISR = leader + æ²¡æœ‰è½åå¤ªå¤šçš„å‰¯æœ¬
AR = OSR + ISR&lt;/p>
&lt;p>&lt;code>HW &amp;amp; LEO&lt;/code>
&lt;code>Follower&lt;/code> å‰¯æœ¬åŒæ­¥è¿‡ç¨‹ä¸­ï¼Œä¸¤ä¸ªæ¦‚å¿µ &lt;code>HW&lt;/code> &lt;code>HighWatermark&lt;/code> å’Œ &lt;code>LEO&lt;/code> &lt;code>Log End Offset&lt;/code>ï¼Œä¸ &lt;code>ISR&lt;/code> ç´§å¯†ç›¸å…³ã€‚&lt;/p>
&lt;p>&lt;code>HW&lt;/code> æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ &lt;code>Offset&lt;/code> ï¼Œå½“ &lt;code>Consumer&lt;/code> å¤„ç†æ¶ˆæ¯çš„æ—¶å€™ï¼Œåªèƒ½ &lt;code>Pull&lt;/code> åˆ° &lt;code>HW&lt;/code> ä¹‹å‰çš„æ¶ˆæ¯ï¼Œ &lt;code>HW&lt;/code> ä¹‹åçš„æ¶ˆæ¯å¯¹ &lt;code>Consumer&lt;/code> ä¸å¯è§ã€‚
ä¹Ÿå°±æ˜¯è¯´ &lt;code>Partition&lt;/code> å¯¹åº”çš„ ISR ä¸­æœ€å°çš„ &lt;code>LEO&lt;/code> ä½œä¸º &lt;code>HW&lt;/code> ï¼Œ &lt;code>Consumer&lt;/code> æœ€å¤šåªèƒ½æ¶ˆè´¹åˆ° &lt;code>HW&lt;/code> æ‰€åœ¨çš„ä½ç½®ï¼Œæ¯ä¸ª &lt;code>Replica&lt;/code> éƒ½æœ‰ &lt;code>HW&lt;/code> ï¼Œ
&lt;code>leader&lt;/code> å’Œ &lt;code>follower&lt;/code> å„è‡ªç»´æŠ¤æ›´æ–°è‡ªå·±çš„ &lt;code>HW&lt;/code> çš„çŠ¶æ€ï¼Œå¯¹äº &lt;code>Leader&lt;/code> æ–°å†™å…¥çš„æ¶ˆæ¯ï¼Œ &lt;code>Consumer&lt;/code> ä¸èƒ½ç«‹åˆ»æ¶ˆè´¹ï¼Œ &lt;code>Leader&lt;/code> ä¼šç­‰å¾…
è¯¥æ¶ˆæ¯è¢«æ‰€æœ‰çš„ &lt;code>ISR&lt;/code> ä¸­çš„ &lt;code>Replicas&lt;/code> åŒæ­¥æ›´æ–° &lt;code>HW&lt;/code> ï¼Œæ­¤æ—¶æ¶ˆæ¯æ‰èƒ½è¢« &lt;code>Consumer&lt;/code> æ¶ˆè´¹ï¼Œè¿™æ ·ä¿è¯äº†å¦‚æœ &lt;code>Leader&lt;/code> å‰¯æœ¬æŸåï¼Œ
è¯¥æ¶ˆæ¯ä»ç„¶å¯ä»¥ä»æ–°é€‰ä¸¾çš„ &lt;code>Leader&lt;/code> è·å–ã€‚&lt;/p>
&lt;p>&lt;code>LEO&lt;/code> æ˜¯æ‰€æœ‰å‰¯éƒ½ä¼šæœ‰çš„ä¸€ä¸ª &lt;code>offset&lt;/code> æ ‡è®°ï¼Œå®ƒæŒ‡å‘è¿½åŠ åˆ°å½“å‰å‰¯æœ¬çš„æœ€åä¸€ä¸ªæ¶ˆæ¯çš„ &lt;code>offset&lt;/code> ï¼Œå½“ç”Ÿäº§è€…å‘ &lt;code>Leader&lt;/code> å‰¯æœ¬è¿½åŠ æ¶ˆæ¯æ—¶å€™ï¼Œ &lt;code>Leader&lt;/code> å‰¯æœ¬çš„ &lt;code>LEO&lt;/code> æ ‡è®°å°±ä¼šé€’å¢ï¼›
å½“ &lt;code>follower&lt;/code> å‰¯æœ¬æˆåŠŸä» &lt;code>leader&lt;/code> å‰¯æœ¬ &lt;code>pull&lt;/code> æ¶ˆæ¯å¹¶æ›´æ–°åˆ°æœ¬åœ°çš„æ—¶å€™ï¼Œ &lt;code>follower&lt;/code> å‰¯æœ¬ä¹Ÿä¼šå¢è‚Œ&lt;/p>
&lt;blockquote>
&lt;p>&lt;code>producer&lt;/code> å‘ &lt;code>leader&lt;/code> å‘é€æ¶ˆæ¯ï¼Œå¯ä»¥é€šè¿‡ &lt;code>request.required.acks&lt;/code> å‚æ•°æ¥è®¾ç½®æ•°æ®å¯é æ€§çº§åˆ«ï¼š&lt;/p>
&lt;ul>
&lt;li>1 é»˜è®¤ï¼Œ &lt;code>producer&lt;/code> åœ¨ &lt;code>ISR&lt;/code> ä¸­çš„ &lt;code>leader&lt;/code> å·²æˆåŠŸæ”¶åˆ°æ•°æ®å¹¶å¾—åˆ°ç¡®è®¤åå‘é€ä¸‹ä¸€æ¡ &lt;code>Message&lt;/code> ã€‚å¦‚æœ &lt;code>Leader&lt;/code> å®•æœºï¼Œä¼šä¸¢å¤±æ•°æ®&lt;/li>
&lt;li>0 &lt;code>producer&lt;/code> æ— éœ€ç­‰å¾…ï¼Œç»§ç»­å‘é€ä¸‹ä¸€æ‰¹æ¶ˆæ¯ï¼Œæ•ˆç‡é«˜ï¼Œä½†æ˜¯æ•°æ®å¯é æ€§ä½&lt;/li>
&lt;li>-1 &lt;code>producer&lt;/code> éœ€è¦ç­‰å¾… &lt;code>ISR&lt;/code> ä¸­æ‰€ä»¥çš„ &lt;code>follower&lt;/code> éƒ½ç¡®è®¤æ¥æ”¶åˆ°æ•°æ®æ‰ç®—å‘é€å®Œæˆã€‚å¯é æ€§é«˜ï¼Œä½†æ˜¯æ²¡æœ‰ä¹Ÿä¸èƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Œæ¯”å¦‚ &lt;code>ISR&lt;/code> é‡Œåªæœ‰ &lt;code>leader&lt;/code> ï¼ˆå…¶ä»–èŠ‚ç‚¹å’Œ &lt;code>ZK&lt;/code> æ–­é“¾ï¼Œæˆ–è€…æ²¡æœ‰è¿½ä¸Šï¼‰ï¼Œè¿™æ ·å°±å˜æˆäº† &lt;code>acks=1&lt;/code> çš„æƒ…å†µ&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h1 id="kafka-åˆ°åº•ä¼šä¸ä¼šä¸¢æ¶ˆæ¯">&lt;code>kafka&lt;/code> åˆ°åº•ä¼šä¸ä¼šä¸¢æ¶ˆæ¯&lt;/h1>
&lt;p>ä¸€ä¸ªæ¶ˆæ¯çš„æµè½¬&lt;/p>
&lt;ul>
&lt;li>&lt;code>Producer&lt;/code> å‘é€ç»™ &lt;code>Kafka Broker&lt;/code>&lt;/li>
&lt;li>&lt;code>kafka Broker&lt;/code> æ¶ˆæ¯åŒæ­¥å’ŒæŒä¹…åŒ–&lt;/li>
&lt;li>&lt;code>Kafka Brokder&lt;/code> å°†æ¶ˆæ¯ä¼ é€’ç»™æ¶ˆè´¹è€…&lt;/li>
&lt;/ul>
&lt;h1 id="å¦‚ä½•ä¼˜é›…çš„ä½¿ç”¨-kafka-consumer">å¦‚ä½•ä¼˜é›…çš„ä½¿ç”¨ Kafka Consumer&lt;/h1>
&lt;p>æ³¨æ„ç‚¹ç­‰ç­‰&amp;hellip;..&lt;/p>
&lt;h1 id="kafka-producer-æµç¨‹è¯¦ç»†">&lt;code>kafka Producer&lt;/code> æµç¨‹è¯¦ç»†&lt;/h1>
&lt;p>&lt;img src="https://pinkhello.me/%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/kafka-producer-flow.png" alt="kafkaProduceræµç¨‹è§£è¯»">
&lt;img src="https://pinkhello.me/%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/kafka-meta-get.png" alt="kafka è·å–å…ƒæ•°æ®">&lt;/p>
- https://pinkhello.me/posts/11-%E5%87%A0%E4%B8%AA%E5%85%B3%E4%BA%8Ekafka%E7%9A%84%E7%9F%A5%E8%AF%86%E7%82%B9/ - PinkHello, All Rights Reserved</description></item><item><title>10 å¤šåŸŸåä¸‹çš„SSH</title><link>https://pinkhello.me/posts/10-%E5%A4%9A%E5%9F%9F%E5%90%8D%E4%B8%8B%E7%9A%84ssh/</link><pubDate>Mon, 10 May 2021 08:52:57 +0800</pubDate><guid>https://pinkhello.me/posts/10-%E5%A4%9A%E5%9F%9F%E5%90%8D%E4%B8%8B%E7%9A%84ssh/</guid><description>PinkHello https://pinkhello.me/posts/10-%E5%A4%9A%E5%9F%9F%E5%90%8D%E4%B8%8B%E7%9A%84ssh/ -&lt;h1 id="å‰è¨€">å‰è¨€&lt;/h1>
&lt;p>æœ‰æ—¶å€™æˆ‘ä»¬ï¼Œæœ‰å¤šä¸ª git è´¦å·ï¼ˆGitlabã€GitHubï¼‰ï¼Œè¿™æ—¶å€™å¦‚æœæ˜¯åŒä¸€ä¸ªè´¦å·ï¼ˆé‚®ç®±æ³¨å†Œï¼‰ï¼Œé‚£ä¸ä¼šæœ‰é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœä¸æ˜¯ç›¸åŒçš„è´¦å·å‘¢ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ SSH KEY åšå…å¯†ç™»å½•æ—¶å€™ï¼Œå¤´ç—›äº†ã€‚&lt;/p>
&lt;p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦é’ˆå¯¹ä¸åŒçš„è´¦å·ï¼Œç”Ÿæˆä¸åŒçš„ SSH Keyï¼Œå¹¶ä¸”é…ç½®ä¸åŒçš„åŸŸåä½¿ç”¨ä¸åŒçš„Key&lt;/p>
&lt;h1 id="ç”Ÿæˆä¸€ä¸ª-ssh-key">ç”Ÿæˆä¸€ä¸ª SSH KEY&lt;/h1>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">ssh-keygen -t rsa -C &lt;span style="color:#cd5555">&amp;#34;username@email.com&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;blockquote>
&lt;p>ä¸€è·¯ Enterï¼Œå¹¶ä¸”åœ¨ç”Ÿæˆæ—¶å€™æŒ‡å®šåå­—ï¼Œï¼ˆä¸æŒ‡å®šåå­—ä¼šä½¿ç”¨é»˜è®¤çš„ï¼‰å¾—åˆ°&lt;/p>
&lt;/blockquote>
&lt;/blockquote>
&lt;pre>&lt;code>id_rsa # ç§é’¥
id_rsa.pub # å…¬é’¥
&lt;/code>&lt;/pre>&lt;h1 id="é‡å¤ä¸Šä¸€ä¸ªæ­¥éª¤ç”Ÿæˆå¤šä¸ª-ç§é’¥å’Œå…¬é’¥">é‡å¤ä¸Šä¸€ä¸ªæ­¥éª¤ï¼Œç”Ÿæˆå¤šä¸ª ç§é’¥å’Œå…¬é’¥&lt;/h1>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">github_id_rsa
github_id_rsa.pub
gitlab_id_rsa
gitlab_id_rsa.pub
&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="é…ç½®ç›¸åº”çš„åŸŸåå¯¹åº”çš„-ssh-key">é…ç½®ç›¸åº”çš„åŸŸåå¯¹åº”çš„ SSH-KEY&lt;/h1>
&lt;ul>
&lt;li>æœ¬åœ°ç›®å½• &lt;code>~/.ssh/&lt;/code> ä¸‹ï¼ŒæŸ¥é˜…æœ‰æ²¡æœ‰ &lt;code>config&lt;/code> æ–‡ä»¶, ä¸å­˜åœ¨å°±æ–°å»º &lt;code>config&lt;/code> æ–‡ä»¶&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">Host github
HostName github.com
User UserName
PreferredAuthentications publickey
IdentityFile ~/.ssh/github_id_rsa
Host gitlab
HostName gitlab.com
User UserName
PreferredAuthentications publickey
IdentityFile ~/.ssh/gitlab_id_rsa
&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="å°†å¯†é’¥æ·»åŠ è¿›å…¥--ssh-agent-ä¸­">å°†å¯†é’¥æ·»åŠ è¿›å…¥ SSH-AGENT ä¸­&lt;/h1>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">ssh-add ~/.ssh/github_id_rsa
ssh-add ~/.ssh/gitlab_id_rsa
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹å¯†é’¥&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">ssh-add -l
&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="å°†ç”Ÿæˆçš„-å…¬é’¥-åŠ å…¥åˆ°å¯¹åº”çš„ç½‘ç«™é‡Œé¢-ssh-key-é…ç½®">å°†ç”Ÿæˆçš„ å…¬é’¥ åŠ å…¥åˆ°å¯¹åº”çš„ç½‘ç«™é‡Œé¢ SSH KEY é…ç½®&lt;/h1>
&lt;p>ä¸‹é¢å°±å¯ä»¥ä½¿ç”¨ &lt;code>git clone git@github.com/****&lt;/code> &lt;code>git clone git@gitlab.com/****&lt;/code>&lt;/p>
&lt;h1 id="å…³äº-mac-ä¸‹-æ¯æ¬¡å¼€æœº-éœ€è¦é‡æ–°-ssh-add-è§£å†³åŠæ³•">å…³äº Mac ä¸‹ æ¯æ¬¡å¼€æœº éœ€è¦é‡æ–° ssh-add è§£å†³åŠæ³•&lt;/h1>
&lt;ul>
&lt;li>æ·»åŠ è‡ªå¯åŠ¨ç¨‹åº&lt;/li>
&lt;li>è¯´ä¸€ä¸ªç®€å•çš„ï¼Œå°† ssh-add ~/.ssh/**id_rsa æ·»åŠ åˆ° .*shrc æ–‡ä»¶é‡Œé¢å»&lt;/li>
&lt;/ul>
- https://pinkhello.me/posts/10-%E5%A4%9A%E5%9F%9F%E5%90%8D%E4%B8%8B%E7%9A%84ssh/ - PinkHello, All Rights Reserved</description></item><item><title>ç®—æ³• Bitmap</title><link>https://pinkhello.me/posts/%E7%AE%97%E6%B3%95-bitmap/</link><pubDate>Wed, 28 Apr 2021 11:59:58 +0800</pubDate><guid>https://pinkhello.me/posts/%E7%AE%97%E6%B3%95-bitmap/</guid><description>PinkHello https://pinkhello.me/posts/%E7%AE%97%E6%B3%95-bitmap/ -&lt;h1 id="bitmap-åŸç†">bitmap åŸç†&lt;/h1>
&lt;p>&lt;code>bitmap&lt;/code>å­—é¢ä¸ºä½å›¾æ˜ å°„, åŸç†æ˜¯ä½¿ç”¨ä¸€ä¸ª bit æ ‡è®°æŸä¸ªå…ƒç´ å¯¹åº”çš„ valueï¼Œè€Œ key å³è¯¥å…ƒç´ ã€‚å› ä¸ºåªæœ‰ä¸€ä¸ª bit æ¥å­˜å‚¨ä¸€ä¸ªæ•°æ®, å› è€Œå¯ä»¥å¤§å¤§çš„èŠ‚çœç©ºé—´ã€‚&lt;/p>
&lt;h2 id="æ•°å€¼æ˜ å°„">æ•°å€¼æ˜ å°„:&lt;/h2>
&lt;p>&lt;img src="https://pinkhello.me/%E7%AE%97%E6%B3%95-Bitmap/bitmap-001.png" alt="æ•°å­—bitmao">&lt;/p>
&lt;blockquote>
&lt;p>å‡å¦‚å¯¹ 0-31 ä¸ªå†…çš„3ä¸ªå…ƒç´ ï¼ˆ10, 17, 28ï¼‰è¿›è¡Œæ’åº,å¯ä»¥é‡‡ç”¨ &lt;code>BitMap&lt;/code> æ–¹æ³•, å¦‚ä¸‹å›¾, å¯¹åº”çš„åŒ…å«çš„ä½ç½®å°†å¯¹åº”çš„å€¼ä» &lt;code>0&lt;/code> å˜æ›´ä¸º &lt;code>1&lt;/code>
å‡å¦‚éœ€è¦è¿›è¡Œæ’åºå’Œæ£€ç´¢ï¼Œåªéœ€è¦ä¾æ¬¡éå†è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œç¢°åˆ° &lt;code>1&lt;/code> çš„æƒ…å†µï¼Œæ•°æ®å­˜åœ¨&lt;/p>
&lt;/blockquote>
&lt;h2 id="å­—ç¬¦ä¸²æ˜ å°„">å­—ç¬¦ä¸²æ˜ å°„:&lt;/h2>
&lt;p>&lt;img src="https://pinkhello.me/%E7%AE%97%E6%B3%95-Bitmap/bitmap-str.png" alt="å­—ç¬¦ä¸²bitmao">&lt;/p>
&lt;blockquote>
&lt;p>å­—ç¬¦ä¸²ä¹Ÿå¯æ˜ å°„ï¼Œåªä¸è¿‡éœ€è¦ç»è¿‡ä¸€ä¸ª&lt;code>Hash&lt;/code>æ­¥éª¤,é€šè¿‡æ˜ å°„å…³ç³»å¯ä»¥åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦å­˜åœ¨ã€‚ä½†æ˜¯å› ä¸º &lt;code>Hash&lt;/code>æ˜¯å°†ä¸ç¡®å®šé•¿åº¦çš„å€¼å˜æ›´ä¸ºç¡®å®šå¤§å°çš„å€¼,å­˜åœ¨&lt;code>Hash&lt;/code>å†²çªæ€§ï¼Œæ‰€ä»¥ä¸€èˆ¬è¦æœ€å¤§åŒ–çš„åˆ¤æ–­ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦çœŸçš„å­˜åœ¨ï¼Œå¯ä»¥å°†è¿™ä¸ªå­—ç¬¦ä¸²ç»è¿‡ä¸åŒçš„&lt;code>Hash&lt;/code>å‡½æ•°æ˜ å°„ä¸åŒçš„ä½ç½®ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="bitmap-çš„-å»ºç«‹æŸ¥æ‰¾æ·»åŠ åˆ é™¤åˆ¤æ–­-åŸç†">bitmap çš„ å»ºç«‹ã€æŸ¥æ‰¾ã€æ·»åŠ ã€åˆ é™¤ã€åˆ¤æ–­ åŸç†&lt;/h2>
&lt;h3 id="å»ºç«‹">å»ºç«‹&lt;/h3>
&lt;p>Bitmap çš„åˆ›å»ºå¯ä»¥ä½¿ç”¨ byte æ•°ç»„ï¼Œ &lt;code>1 byte = 8 bit &lt;/code>(ä¹Ÿå¯ä½¿ç”¨ int æ•°ç»„, &lt;code>1 int = 32 bit&lt;/code>, long æ•°ç»„, &lt;code>1 long = 64 bit&lt;/code>)
ä¹Ÿå°±æ˜¯è¯´åˆ°æœ€åçš„æ•°æ®çš„å¤§å°å»ºç«‹åªéœ€è¦åˆ›å»º æ•°ç»„é•¿åº¦ä¸º
&lt;code>int[ 1 + N/32 ]&lt;/code> &lt;code>byte[ 1 + N/8 ]&lt;/code> &lt;code>long[ 1 + N/64 ]&lt;/code>
å³å¯å­˜å‚¨ï¼Œ&lt;code>N&lt;/code>è¡¨ç¤ºè¦å­˜å‚¨çš„æœ€å¤§çš„å€¼ã€‚&lt;/p>
&lt;p>ä¸‹é¢æˆ‘ä»¬éƒ½ä½¿ç”¨ &lt;code>intæ•°ç»„&lt;/code> è¡¨ç¤º&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">arr[0] è¡¨è¿° 0-31
arr[1] è¡¨è¿° 32-63
arr[2] è¡¨è¿° 64-95
...
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æŸ¥æ‰¾">æŸ¥æ‰¾&lt;/h3>
&lt;p>æŒ‰ç…§ä¸Šé¢ &lt;code>intæ•°ç»„&lt;/code> çš„ä¾‹å­ï¼Œè¦æ‰¾åˆ°ä»»æ„æ•´æ•° &lt;code>M&lt;/code> æ˜ å°„åˆ°æ•°ç»„ä¸Šçš„ä½ç½®ä¸º &lt;code>M / 32&lt;/code> å¾—åˆ°ä¸‹æ ‡,&lt;code>M % 32&lt;/code> å¾—åˆ°å®ƒåœ¨è¿™ä¸ªä¸‹æ ‡å¯¹åº”çš„äºŒè¿›åˆ¶çš„å“ªä¸ªä½ç½®&lt;/p>
&lt;h3 id="æ·»åŠ ">æ·»åŠ &lt;/h3>
&lt;p>æˆ‘ä»¬å°† 5 è¿™ä¸ªæ•°å¯¹åº”çš„å€¼æ”¾å…¥åˆ° bitmap ä¸­
&lt;code>5 / 32 = 0&lt;/code>, &lt;code>5 % 32 = 5&lt;/code> , &lt;code>5&lt;/code> åœ¨ &lt;code>arr[0]&lt;/code> çš„ç¬¬ &lt;code>5&lt;/code> ä¸ªä½ç½®
&lt;img src="https://pinkhello.me/%E7%AE%97%E6%B3%95-Bitmap/bitmap-add.png" alt="bitmao">&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># æƒ³æ’å…¥ä¸€ä¸ªæ•°çš„å€¼ï¼Œåªéœ€è¦å°† 1 å·¦ç§»ä»£è¡¨è¯¥æ•°å­—çš„è¿™ä¸€ä½( M % 32 )ï¼ˆå¤‡æ³¨ï¼šå› ä¸ºæˆ‘è¿™è¾¹æ˜¯ int ç±»å‹ï¼Œæ‰€ä»¥æ˜¯ 32 ä½ï¼‰, ç„¶åä¸åŸæ¥æ•°å­—æŒ‰ä½æˆ–&lt;/span>
arr[0] = arr[0] | (&lt;span style="color:#b452cd">1&lt;/span> &amp;lt;&amp;lt; 5)
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ é™¤">åˆ é™¤&lt;/h3>
&lt;p>&lt;img src="https://pinkhello.me/%E7%AE%97%E6%B3%95-Bitmap/bitmap-remove.png" alt="bitmao">&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># æƒ³æ’å…¥ä¸€ä¸ªæ•°çš„å€¼ï¼Œåªéœ€è¦å°† 1 å·¦ç§»ä»£è¡¨è¯¥æ•°å­—çš„è¿™ä¸€ä½( M % 32 )ï¼ˆå¤‡æ³¨ï¼šå› ä¸ºæˆ‘è¿™è¾¹æ˜¯ int ç±»å‹ï¼Œæ‰€ä»¥æ˜¯ 32 ä½ï¼‰, ç„¶åå–ååä¸åŸæ¥æ•°å­—æŒ‰ä½ä¸ï¼Œåˆ™è¾¾åˆ°æ¸…é™¤ç›®çš„&lt;/span>
arr[0] = arr[0] &amp;amp; (~(&lt;span style="color:#b452cd">1&lt;/span> &amp;lt;&amp;lt; 5))
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ¤æ–­">åˆ¤æ–­&lt;/h3>
&lt;p>å€ŸåŠ© &lt;code>æŸ¥æ‰¾&lt;/code> åšå®šä½ï¼Œç„¶ååˆ¤æ–­ å½“å‰ä½ä¸Šçš„å€¼æ˜¯ &lt;code>0&lt;/code> è¿˜æ˜¯ &lt;code>1&lt;/code> æ¥è¾¾åˆ°åˆ¤æ–­çš„ç›®çš„&lt;/p>
&lt;h1 id="bitmap-åº”ç”¨">bitmap åº”ç”¨&lt;/h1>
&lt;h2 id="å¤§æ•°æ®é‡å¿«é€Ÿæ’åº">å¤§æ•°æ®é‡å¿«é€Ÿæ’åº&lt;/h2>
&lt;h2 id="å¤§æ•°æ®é‡å¿«é€Ÿå»é‡">å¤§æ•°æ®é‡å¿«é€Ÿå»é‡&lt;/h2>
&lt;h2 id="å¤§æ•°æ®é‡å¿«é€ŸæŸ¥æ‰¾">å¤§æ•°æ®é‡å¿«é€ŸæŸ¥æ‰¾&lt;/h2>
&lt;h1 id="bitmap-çš„ç¼ºç‚¹-å’Œ-æ‹“å±•">bitmap çš„ç¼ºç‚¹ å’Œ æ‹“å±•&lt;/h1>
&lt;p>bitmap çš„ç¼ºç‚¹è¿˜æ˜¯æœ‰çš„ :&lt;/p>
&lt;ul>
&lt;li>æ•°æ®ç¢°æ’
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">å­—ç¬¦ä¸²æ˜ å°„åˆ° &lt;span style="color:#cd5555">`&lt;/span>bitmap&lt;span style="color:#cd5555">`&lt;/span>ä¼šæœ‰ç¢°æ’é—®é¢˜.
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>æ•°æ®ç¨€æ¾
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">æ¯”å¦‚è¦å­˜å…¥&lt;span style="color:#cd5555">`&lt;/span>(1,88888888,3333)&lt;span style="color:#cd5555">`&lt;/span>è¿™ä¸‰æ¡æ•°æ®, æˆ‘ä»¬è¦å»ºç«‹&lt;span style="color:#cd5555">`&lt;/span>99999999&lt;span style="color:#cd5555">`&lt;/span>é•¿åº¦çš„ &lt;span style="color:#cd5555">`&lt;/span>bitmap&lt;span style="color:#cd5555">`&lt;/span>,ä½†å®é™…ä¸Šåªå­˜å‚¨äº†3æ¡æ•°æ®,æµªè´¹äº†ç©ºé—´.
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="ç¢°æ’é—®é¢˜-bloom-filterhttpszhwikipediaorgwikie5b883e99a86e8bf87e6bba4e599a8-å’Œ-counting-bloom-filter">(ç¢°æ’é—®é¢˜) &lt;a href="https://zh.wikipedia.org/wiki/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8">Bloom Filter&lt;/a> å’Œ Counting Bloom Filter&lt;/h2>
&lt;blockquote>
&lt;p>å°†ä»»æ„å¤§å°çš„æ•°æ®è½¬æ¢æˆç‰¹å®šå¤§å°çš„æ•°æ®çš„å‡½æ•°.è½¬æ¢åçš„æ•°æ®ç§°ä¸ºå“ˆå¸Œå€¼æˆ–å“ˆå¸Œç¼–ç &lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://pinkhello.me/%E7%AE%97%E6%B3%95-Bitmap/bitmap-hash.png" alt="hash">&lt;/p>
&lt;ul>
&lt;li>å“ˆå¸Œå‡½æ•°æ˜¯å®ç°å“ˆå¸Œè¡¨å’Œå¸ƒéš†è¿‡æ»¤å™¨çš„åŸºç¡€&lt;/li>
&lt;/ul>
&lt;h3 id="bloom-filter">Bloom Filter&lt;/h3>
&lt;p>&lt;img src="https://pinkhello.me/%E7%AE%97%E6%B3%95-Bitmap/bitmap-bloom-filter.png" alt="hash">&lt;/p>
&lt;ul>
&lt;li>&lt;code>K1&lt;/code> ç»è¿‡ &lt;code>3æ¬¡&lt;/code> &lt;code>Hash&lt;/code> è½åœ¨åœ° &lt;code>5&lt;/code>ã€&lt;code>9&lt;/code>ã€&lt;code>10&lt;/code> ä¸Š&lt;/li>
&lt;li>&lt;code>X3&lt;/code> ç»è¿‡ &lt;code>3æ¬¡&lt;/code> &lt;code>Hash&lt;/code> è½åœ¨ &lt;code>9&lt;/code>ã€&lt;code>11&lt;/code>ã€&lt;code>14&lt;/code>&lt;/li>
&lt;li>å¯ä»¥çœ‹å‡ºé‡å ç‚¹åœ¨ &lt;code>9&lt;/code> ä¸Š, æ‰€ä»¥å­˜åœ¨ä¸€å®šçš„è¯¯åˆ¤&lt;/li>
&lt;/ul>
&lt;h3 id="counting-bloom-filter">Counting Bloom Filter&lt;/h3>
&lt;p>&lt;img src="https://pinkhello.me/%E7%AE%97%E6%B3%95-Bitmap/bitmap-counting-bloom-filter.png" alt="hash">&lt;/p>
&lt;ul>
&lt;li>ä¸ºäº†è§£å†³ &lt;code>bloom filter&lt;/code> æ— æ³•åˆ é™¤çš„é—®é¢˜&lt;/li>
&lt;li>æ¯”æ­£å¸¸çš„ &lt;code>bloom filter&lt;/code> åŠ å…¥äº†å¯¹ ä½çš„è®¡æ•°å™¨&lt;/li>
&lt;li>å½“å‘ç”Ÿåˆ é™¤åŠ¨ä½œçš„æ—¶å€™ï¼Œå¯¹åº”ä½ç½®çš„&lt;code>è®¡æ•°å™¨-1&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="ç¨€æ¾é—®é¢˜-roaring-bitmaphttpsgithubcomroaringbitmaproaringbitmap">(ç¨€æ¾é—®é¢˜) &lt;a href="https://github.com/RoaringBitmap/RoaringBitmap">Roaring BitMap&lt;/a>&lt;/h2>
&lt;ul>
&lt;li>&lt;code>RoaringBitmap&lt;/code> ç®—æ³•æ˜¯å°† &lt;code>32&lt;/code> ä½ çš„ int ç±»å‹æ•°æ®åˆ’åˆ†ä½ &lt;code>2^16&lt;/code> ä¸ªæ•°æ®å—ï¼Œæ¯ä¸ªæ•°æ®å¿«å¯¹åº”æ•´æ•°çš„ &lt;code>é«˜16ä½&lt;/code>ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªå®¹å™¨ï¼ˆ&lt;code>Container&lt;/code>ï¼‰æ¥å­˜æ”¾æ•°å€¼çš„ä½16ä½ã€‚&lt;/li>
&lt;li>&lt;code>RoaringBitmap&lt;/code> å°†è¿™äº› &lt;code>Container&lt;/code> ä¿å­˜åœ¨ä¸€ä¸ªåŠ¨æ€æ•°ç»„ä¸­ä½œä¸ºä¸€çº§ç´¢å¼•ã€‚&lt;/li>
&lt;li>&lt;code>RoaringBitmap&lt;/code> çš„ Container åˆ†ç±»æœ‰ Array Container å’Œ Bitmap Containerã€‚ &lt;code>Array Container&lt;/code> å­˜æ”¾ç¨€ç–æ•°æ®, &lt;code>Bitmap Container&lt;/code> å­˜æ”¾ç¨ å¯†æ•°æ® (å¦‚æœä¸€ä¸ª &lt;code>Container&lt;/code> çš„æ•´æ•°æ•°é‡å°äº&lt;code>4096&lt;/code>ï¼Œå°±ç”¨æ•°ç»„å®¹å™¨,è‹¥å¤§äº&lt;code>4096&lt;/code>å°±ç”¨ä½å›¾å®¹å™¨)ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="roaring-bitmap-å­˜å‚¨ç»“æ„">Roaring BitMap å­˜å‚¨ç»“æ„&lt;/h3>
&lt;p>&lt;img src="https://pinkhello.me/%E7%AE%97%E6%B3%95-Bitmap/roaring-bitmap-001.png" alt="Roaring BitMap">&lt;/p>
&lt;ul>
&lt;li>é«˜16ä½ä¸º &lt;code>0000H&lt;/code> çš„ containerï¼Œå­˜å‚¨æœ‰å‰ &lt;code>1000ä¸ª62&lt;/code> çš„å€æ•°ã€‚&lt;/li>
&lt;li>é«˜16ä½ä¸º &lt;code>0001H&lt;/code> çš„ containerï¼Œå­˜å‚¨æœ‰ &lt;code>[2^16, 2^16+100)&lt;/code> åŒºé—´å†…çš„ &lt;code>100&lt;/code> ä¸ªæ•°ã€‚&lt;/li>
&lt;li>é«˜16ä½ä¸º &lt;code>0002H&lt;/code> çš„ containerï¼Œå­˜å‚¨æœ‰ &lt;code>[2Ã—2^16, 3Ã—2^16)&lt;/code> åŒºé—´å†…çš„æ‰€æœ‰å¶æ•°ï¼Œå…±&lt;code>2^15&lt;/code>ä¸ªã€‚&lt;/li>
&lt;/ul>
&lt;p>RoaringBitmap ç»“æ„&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#00688b;font-weight:bold">short&lt;/span>[] keys;
Container[] values;
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> size;
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>æ¯ä¸ª&lt;code>32ä½&lt;/code>çš„æ•´å½¢ï¼Œ&lt;code>é«˜16ä½&lt;/code>ä¼šè¢«ä½œä¸º &lt;code>key&lt;/code> å­˜å‚¨åˆ° &lt;code>short[] keys&lt;/code> ä¸­, &lt;code>ä½16ä½&lt;/code>çœ‹ä½œ&lt;code>value&lt;/code>å­˜å‚¨åˆ° &lt;code>values&lt;/code> ä¸­çš„æŸä¸ª &lt;code>Container&lt;/code> ä¸­&lt;/li>
&lt;li>&lt;code>keys&lt;/code> å’Œ &lt;code>values&lt;/code> é€šè¿‡ä¸‹æ ‡ä¸€ä¸€å¯¹åº”&lt;/li>
&lt;li>&lt;code>keys&lt;/code> æ•°ç»„æ°¸è¿œä¿è¯æœ‰åºï¼Œæ–¹ä¾¿äºŒåˆ†æŸ¥æ‰¾&lt;/li>
&lt;li>&lt;code>size&lt;/code> æ ‡ç¤ºäº†åŒ…å« &lt;code>key-value pair&lt;/code> çš„æ•°é‡(å³ &lt;code>keys&lt;/code> å’Œ &lt;code>values&lt;/code> ä¸­æœ‰æ•ˆæ•°æ®çš„æ•°é‡)&lt;/li>
&lt;/ul>
&lt;h3 id="array-container">Array Container&lt;/h3>
&lt;p>å½“æ¡¶å†…æ•°æ®åŸºæ•° &lt;code>&amp;lt; 4096&lt;/code> çš„æ—¶å€™ï¼Œé‡‡ç”¨å®ƒæ¥å­˜å‚¨, æ•°ç»„åˆå§‹é•¿åº¦ä¼Ÿä¸º &lt;code>4&lt;/code> éšç€æ•°æ®å¢å¤šä¼šå­—æ®µæ‰©å®¹, æœ€å¤§é•¿åº¦ä¸º &lt;code>4096&lt;/code>ã€‚ åœ¨æ ·ä¾‹é€”ä¸­æ˜¯ æ•°ç»„å®¹å™¨çš„ &lt;code>size&lt;/code> éƒ½æ²¡æœ‰è¶…è¿‡ &lt;code>4096&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> DEFAULT_MAX_SIZE = 4096
&lt;span style="color:#00688b;font-weight:bold">short&lt;/span>[] content;
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>ä½16ä½ç›´æ¥å­˜å…¥åˆ° &lt;code>content&lt;/code> ä¸­, å§‹ç»ˆä¿è¯æœ‰åºï¼Œæ–¹ä¾¿äºŒåˆ†æŸ¥æ‰¾ã€‚ä¸”ä¸ä¼šå­˜å‚¨é‡å¤æ•°æ®ã€‚&lt;/li>
&lt;li>å› ä¸ºæ²¡æœ‰æ•°æ®å‹ç¼©ï¼Œé€‚åˆå­˜å‚¨å°‘é‡çš„æ•°æ®&lt;/li>
&lt;/ul>
&lt;h3 id="bitmap-container">Bitmap Container&lt;/h3>
&lt;p>å½“æ¡¶å†…æ•°æ®åŸºæ•° &lt;code>&amp;gt; 4096&lt;/code> çš„æ—¶å€™ï¼Œé‡‡ç”¨å®ƒæ¥å­˜å‚¨. æ˜¯æ™®é€šä½å›¾ã€‚ç”¨å›ºå®šé•¿åº¦çš„ &lt;code>1024&lt;/code> çš„&lt;code>longæ•°ç»„&lt;/code>å¹¶è¡¨ç¤ºï¼Œå³ä½å›¾å¤§å°å›ºå®šä¸º &lt;code>2^16&lt;/code> ä½ (8KB)&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#00688b;font-weight:bold">long&lt;/span>[] bitmap; &lt;span style="color:#228b22">// æ¯ä¸ªbitmapåˆå§‹åŒ–é•¿åº¦éƒ½æ˜¯å›ºå®šçš„ 1024 çš„ long[]
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>æ¯ä¸ª &lt;code>Container&lt;/code> å¤„ç† 16ä½çš„æ•´å½¢æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ &lt;code>0-65535&lt;/code>ã€‚&lt;/li>
&lt;li>æ ¹æ® &lt;code>bitmap&lt;/code> åŸæ¥ï¼Œéœ€è¦å­˜å‚¨ &lt;code>65535 ä¸ªbit&lt;/code> çš„å­˜å‚¨æ•°æ®ï¼Œæ¯ä¸ª &lt;code>æ¯”ç‰¹ä½&lt;/code> ç”¨ &lt;code>1&lt;/code> è¡¨ç¤ºæœ‰, ç”¨ &lt;code>0&lt;/code> è¡¨ç¤ºæ— ã€‚&lt;/li>
&lt;li>&lt;code>æ¯ä¸ª long æœ‰ 64 bit&lt;/code>, éœ€è¦ &lt;code>1024ä¸ª long&lt;/code> æ¥æä¾› &lt;code>65536&lt;/code> ä¸ªbitã€‚(8KB)&lt;/li>
&lt;/ul>
&lt;h3 id="run-container">Run Container&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#00688b;font-weight:bold">short&lt;/span>[] valuesLength; &lt;span style="color:#228b22">//å­˜å‚¨çš„æ˜¯å‹ç¼©åçš„æ•°æ®
&lt;/span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> nbrruns = 0;
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;code>Run Container&lt;/code> ä¸­çš„ &lt;code>Run&lt;/code> æŒ‡çš„æ˜¯ &lt;code>æ¸¸(è¡Œ)ç¨‹é•¿åº¦å‹ç¼©ç®—æ³•&lt;/code>ï¼ˆ&lt;code>Run Length Encoding&lt;/code>ï¼‰ï¼Œå¯¹è¿ç»­æ•°æ®æœ‰æ¯”è¾ƒå¥½çš„å‹ç¼©æ•ˆæœ.
&lt;blockquote>
&lt;p>åŸç†:&lt;/p>
&lt;ul>
&lt;li>å¯¹äºæ•°åˆ— &lt;code>11&lt;/code>, å‹ç¼©ä¸º 11,0&lt;/li>
&lt;li>å¯¹äºæ•°åˆ— &lt;code>11,12,13,14,15&lt;/code>, å‹ç¼©ä¸º &lt;code>11,4&lt;/code>&lt;/li>
&lt;li>å¯¹äºæ•°åˆ— &lt;code>11,12,13,14,15,21,22&lt;/code>, å‹ç¼©ä¸º &lt;code>11,4,21,1&lt;/code>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;/li>
&lt;li>å‹ç¼©ç®—æ³•çš„æ€§èƒ½å’Œæ•°æ®çš„è¿ç»­æ€§å…³ç³»æä¸ºå¯†åˆ‡ï¼Œå¯¹äº&lt;code>è¿ç»­çš„100 short&lt;/code>, å®ƒèƒ½ä» &lt;code>200 bit&lt;/code> å‹ç¼©åˆ° &lt;code>4 bit&lt;/code>,ä½†æ˜¯å¯¹äº &lt;code>å®Œå…¨ä¸è¿ç»­çš„ 100 short&lt;/code>ï¼Œç¼–ç å®Œå &lt;code>200 bit&lt;/code> å˜æˆ &lt;code>400 bit&lt;/code>
&lt;blockquote>
&lt;ul>
&lt;li>æœ€å¥½æƒ…å†µ: åªå­˜åœ¨ä¸€ä¸ªæ•°æ®æˆ–è€…åªå­˜åœ¨ä¸€ä¸²è¿ç»­çš„æ•°å­—, é‚£ä¹ˆåªä¼šå­˜å‚¨ &lt;code>2 ä¸ª short&lt;/code>,å æœ‰ &lt;code>4 bit&lt;/code>&lt;/li>
&lt;li>æœ€åæƒ…å†µ: &lt;code>0-65535&lt;/code> èŒƒå›´å†…å¡«å……æ‰€æœ‰çš„å¥‡æ•°ä½(æˆ–æ‰€æœ‰çš„å¶æ•°ä½), éœ€è¦å­˜å‚¨ &lt;code>65536 ä¸ª short&lt;/code>, &lt;code>128KB&lt;/code>&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;h3 id="æ—¶é—´ç©ºé—´åˆ†æ">æ—¶é—´ç©ºé—´åˆ†æ&lt;/h3>
&lt;p>æ—¶é—´&lt;/p>
&lt;ul>
&lt;li>å¢åˆ æ”¹æŸ¥æ–¹é¢ &lt;code>Bitmap Container&lt;/code>åªæ¶‰åŠä½è¿ç®— O(1)&lt;/li>
&lt;li>&lt;code>Array Container&lt;/code> å’Œ &lt;code>Run Container&lt;/code> éƒ½æ˜¯ &lt;code>äºŒåˆ†æŸ¥æ‰¾&lt;/code> æœ‰åºæ•°ç»„å®šä½å…ƒç´  &lt;code>O(logN)&lt;/code>
ç©ºé—´&lt;/li>
&lt;li>&lt;code>Bitmap Container&lt;/code> æ’å®š &lt;code>8192B&lt;/code>&lt;/li>
&lt;li>&lt;code>Array Container&lt;/code> ç©ºé—´äºåŸºæ•°ï¼ˆcï¼‰æœ‰å…³, &lt;code>(2+2c)B &lt;/code>&lt;/li>
&lt;li>&lt;code>Run Container&lt;/code> ç©ºé—´ä¸å­˜å‚¨çš„ è¿ç»­åºåˆ—æ•°(r) æœ‰å…³, &lt;code>(2+4r)B&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="bitset">BitSet&lt;/h2>
- https://pinkhello.me/posts/%E7%AE%97%E6%B3%95-bitmap/ - PinkHello, All Rights Reserved</description></item><item><title>09 ä½¿ç”¨githookç»Ÿä¸€codestyle</title><link>https://pinkhello.me/posts/09-%E4%BD%BF%E7%94%A8githook%E7%BB%9F%E4%B8%80codestyle/</link><pubDate>Sun, 25 Apr 2021 08:46:52 +0800</pubDate><guid>https://pinkhello.me/posts/09-%E4%BD%BF%E7%94%A8githook%E7%BB%9F%E4%B8%80codestyle/</guid><description>PinkHello https://pinkhello.me/posts/09-%E4%BD%BF%E7%94%A8githook%E7%BB%9F%E4%B8%80codestyle/ -&lt;h1 id="gradle-ä¼˜åŒ–">gradle ä¼˜åŒ–&lt;/h1>
&lt;ul>
&lt;li>build æŒ‡å®š -g cache ç¼“å­˜&lt;/li>
&lt;/ul>
&lt;h1 id="checkstyle-å®è·µ">checkstyle å®è·µ&lt;/h1>
&lt;ul>
&lt;li>åŸºç¡€é•œåƒåŒ…å« &lt;code>checkstyle.xml&lt;/code> æˆ–è€… æ”¾åˆ°è¿œç¨‹å…¶ä»–å¯è¢«æ‹‰å–åˆ°çš„å­˜å‚¨ä»‹è´¨ ï¼Œé˜²æ­¢é¡¹ç›®æˆå‘˜æ”¹åŠ¨&lt;/li>
&lt;li>&lt;code>gitlab-ci&lt;/code> &lt;code>beforeScript&lt;/code> æ ‡ç­¾æ‰§è¡Œå‘½ä»¤ &lt;code>copy /checkstyle.xml&lt;/code> è¿›å…¥é¡¹ç›®ï¼Œ(è¦†ç›–é¡¹ç›®ä¸­å­˜åœ¨çš„).&lt;/li>
&lt;li>&lt;code>gradle&lt;/code> ç¼–è¯‘çš„è¯ å°† &lt;code>maven-publish.gradle&lt;/code> &lt;code>repos.gradle&lt;/code> &lt;code>checkstyle.gradle&lt;/code>(&lt;code>checkstyle&lt;/code> æ’ä»¶é…ç½® ç‰ˆæœ¬ä»¥åŠ &lt;code>configFile&lt;/code>) æŠ½å‡ºæ”¾åˆ°å…¬å…±çš„åœ°æ–¹ï¼Œé˜²æ­¢é¡¹ç›®å›¢é˜Ÿæˆå‘˜æ”¹çš„.&lt;/li>
&lt;li>&lt;code>maven&lt;/code> çš„è¯ï¼Œå¯ä»¥åœ¨å…¬å…±çš„é¡¶çº§ç»§æ‰¿ &lt;code>pom&lt;/code> é‡Œé¢æŒ‡å®šå˜é‡&lt;code>checkstyle.config.location&lt;/code>. &lt;code>mvn checkstyle -Dcheckstyle.config.location=checkstyle.xml&lt;/code>&lt;/li>
&lt;/ul>
&lt;h1 id="git-hook-å®è·µ">git hook å®è·µ&lt;/h1>
&lt;p>æ¯ä¸ªé¡¹ç›®é‡Œé¢ &lt;code>.git/hooks&lt;/code> é‡Œé¢æœ‰å¾ˆå¤šçš„ &lt;code>hook&lt;/code> æ¨¡æ¿&lt;/p>
&lt;p>å®¢æˆ·ç«¯é’©å­åŒ…æ‹¬:&lt;code>pre-commit&lt;/code>ã€&lt;code>prepare-commit-msg&lt;/code>ã€&lt;code>commit-msg&lt;/code>ã€&lt;code>post-commit&lt;/code>ç­‰ï¼Œä¸»è¦ç”¨äºæ§åˆ¶å®¢æˆ·ç«¯gitçš„æäº¤å·¥ä½œæµã€‚&lt;/p>
&lt;p>æœåŠ¡ç«¯é’©å­ï¼š&lt;code>pre-receive&lt;/code>ã€&lt;code>post-receive&lt;/code>ã€&lt;code>update&lt;/code>ï¼Œä¸»è¦åœ¨æœåŠ¡ç«¯æ¥æ”¶æäº¤å¯¹è±¡æ—¶ã€æ¨é€åˆ°æœåŠ¡å™¨ä¹‹å‰è°ƒç”¨ã€‚&lt;/p>
&lt;p>ä»Šå¤©å®è·µçš„æ˜¯ å®¢æˆ·ç«¯é’©å­ï¼Œä¼˜åŒ–å‡å°‘ä¸ç¬¦åˆè§„èŒƒæˆ–è€…ä½è´¨é‡ä»£ç è¿›å…¥ &lt;code>gitflow&lt;/code> æµç¨‹.&lt;/p>
&lt;p>&lt;code>pre-commit&lt;/code> å’Œ &lt;code>commit-msg&lt;/code> æ˜¯ä»Šå¤©çš„ä¸»è§’ï¼Œ&lt;code>pre-commit&lt;/code> æ‰§è¡Œä¸ &lt;code>git add&lt;/code> ä¹‹åï¼Œåœ¨è¿›è¡Œ &lt;code>git commit&lt;/code> ä¹‹å‰è¿›è¡Œçš„æ“ä½œ.
å¯ä»¥ç”¨æ¥è¿›è¡Œ &lt;code>code check&lt;/code> &lt;code>code lint&lt;/code> ç­‰ç­‰, &lt;code>commit-msg&lt;/code> æ‰§è¡Œä¸ &lt;code>git commit&lt;/code> å¸¸ç”¨äºè¡¥å…¨ &lt;code>git commit message&lt;/code> &lt;code>check msg&lt;/code> ç­‰ç­‰
å½“ç„¶è¿˜æœ‰å…¶ä»–éªšæ“ä½œçš„åŠŸèƒ½ï¼Œå¯ä»¥é€šçŸ¥ï¼Œç­‰ç­‰ï¼Œåšå¤šç§è‡ªåŠ¨åŒ–&lt;/p>
&lt;p>ç›®å½•ç»“æ„&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yml" data-lang="yml">project&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">&lt;/span>- .git/..ç­‰ç­‰&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">&lt;/span>- git_hooks&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>-- pre-commit &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># pre-commit action&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>-- commit-msg &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># commit-msg action&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>-- init.sh &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># åˆå§‹åŒ–è„šæœ¬&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>pre-commit&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#1e889b">#!/bin/bash
&lt;/span>&lt;span style="color:#1e889b">&lt;/span>&lt;span style="color:#00688b">workPath&lt;/span>=&lt;span style="color:#8b008b;font-weight:bold">$(&lt;/span>&lt;span style="color:#658b00">pwd&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">)&lt;/span>
&lt;span style="color:#00688b">CHECK_DIR&lt;/span>=&lt;span style="color:#cd5555">${&lt;/span>&lt;span style="color:#00688b">workPath&lt;/span>&lt;span style="color:#cd5555">}&lt;/span>/checks
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> [ ! -d &lt;span style="color:#00688b">$CHECK_DIR&lt;/span> ]
&lt;span style="color:#8b008b;font-weight:bold">then&lt;/span>
mkdir &lt;span style="color:#00688b">$CHECK_DIR&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">fi&lt;/span>
&lt;span style="color:#00688b">DOWNLOAD_PATH&lt;/span>=&lt;span style="color:#cd5555">&amp;#34;http://{download.path}/checkstyle&amp;#34;&lt;/span>
&lt;span style="color:#00688b">CONFIG_CHECK_JAR&lt;/span>=&lt;span style="color:#00688b">$CHECK_DIR&lt;/span>/checkstyle.jar;
&lt;span style="color:#00688b">CONFIG_CHECK_FILE&lt;/span>=&lt;span style="color:#00688b">$CHECK_DIR&lt;/span>/checkstyle.xml;
&lt;span style="color:#00688b">CONFIG_ERROR_FILE&lt;/span>=&lt;span style="color:#00688b">$CHECK_DIR&lt;/span>/checkstyle_errors.xml;
&lt;span style="color:#00688b">CONFIG_ERROR_REPORT_FILE&lt;/span>=&lt;span style="color:#00688b">$CHECK_DIR&lt;/span>/checkstyle_report.xml;
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> [ ! -f &lt;span style="color:#00688b">$CONFIG_CHECK_JAR&lt;/span> ]
&lt;span style="color:#8b008b;font-weight:bold">then&lt;/span>
curl -o &lt;span style="color:#00688b">$CONFIG_CHECK_JAR&lt;/span> &lt;span style="color:#00688b">$DOWNLOAD_PATH&lt;/span>/checkstyle-8.8-all.jar || true;
&lt;span style="color:#8b008b;font-weight:bold">fi&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> [ ! -f &lt;span style="color:#00688b">$CONFIG_CHECK_FILE&lt;/span> ]
&lt;span style="color:#8b008b;font-weight:bold">then&lt;/span>
curl -o &lt;span style="color:#00688b">$CONFIG_CHECK_FILE&lt;/span> &lt;span style="color:#00688b">$DOWNLOAD_PATH&lt;/span>/checkstyle.xml || true;
&lt;span style="color:#8b008b;font-weight:bold">fi&lt;/span>
&lt;span style="color:#00688b">javafiles&lt;/span>=&lt;span style="color:#cd5555">`&lt;/span>git diff --cached --name-only | grep &lt;span style="color:#cd5555">&amp;#39;\.java&amp;#39;&lt;/span>&lt;span style="color:#cd5555">`&lt;/span>;
&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#00688b">$javafiles&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> [ -f &lt;span style="color:#00688b">$CONFIG_ERROR_FILE&lt;/span> ]
&lt;span style="color:#8b008b;font-weight:bold">then&lt;/span>
rm &lt;span style="color:#00688b">$CONFIG_ERROR_FILE&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">fi&lt;/span>
&lt;span style="color:#00688b">CHECK_CMD&lt;/span>=&lt;span style="color:#cd5555">&amp;#34;java -cp &lt;/span>&lt;span style="color:#00688b">$CONFIG_CHECK_JAR&lt;/span>&lt;span style="color:#cd5555"> com.puppycrawl.tools.checkstyle.Main -c &lt;/span>&lt;span style="color:#00688b">$CONFIG_CHECK_FILE&lt;/span>&lt;span style="color:#cd5555"> &lt;/span>&lt;span style="color:#00688b">$javafiles&lt;/span>&lt;span style="color:#cd5555"> -f xml -o &lt;/span>&lt;span style="color:#00688b">$CONFIG_ERROR_FILE&lt;/span>&lt;span style="color:#cd5555">&amp;#34;&lt;/span>;
&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#cd5555">&amp;#34;&lt;/span>&lt;span style="color:#00688b">$CHECK_CMD&lt;/span>&lt;span style="color:#cd5555">&amp;#34;&lt;/span>;
&lt;span style="color:#00688b">$CHECK_CMD&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> [ -f &lt;span style="color:#00688b">$CONFIG_ERROR_FILE&lt;/span> ]
&lt;span style="color:#8b008b;font-weight:bold">then&lt;/span>
&lt;span style="color:#00688b">errorResponse&lt;/span>=&lt;span style="color:#cd5555">`&lt;/span>cat &lt;span style="color:#00688b">$CONFIG_ERROR_FILE&lt;/span> | grep &lt;span style="color:#cd5555">\&amp;lt;&lt;/span>error|head -n 1&lt;span style="color:#cd5555">`&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> [[ &lt;span style="color:#00688b">$errorResponse&lt;/span> == *&lt;span style="color:#cd5555">&amp;#34;error&amp;#34;&lt;/span>* ]]
&lt;span style="color:#8b008b;font-weight:bold">then&lt;/span>
awk &lt;span style="color:#cd5555">&amp;#39;{print;} NR == 1 { print &amp;#34;&amp;lt;?xml-stylesheet xmlns=\&amp;#34;http://www.w3.org/1999/xhtml\&amp;#34; href=\&amp;#34;checkstyle-simple.xsl\&amp;#34; type=\&amp;#34;text/xsl\&amp;#34;?&amp;gt;&amp;#34;}&amp;#39;&lt;/span> &lt;span style="color:#00688b">$CONFIG_ERROR_FILE&lt;/span> &amp;gt; &lt;span style="color:#00688b">$CONFIG_ERROR_REPORT_FILE&lt;/span>;
&lt;span style="color:#658b00">echo&lt;/span> -e &lt;span style="color:#cd5555">&amp;#34;Check your code. Open by Safari or Chrome ( --allow-file-access-from-files ): &lt;/span>&lt;span style="color:#00688b">$CONFIG_ERROR_REPORT_FILE&lt;/span>&lt;span style="color:#cd5555">&amp;#34;&lt;/span>;
open &lt;span style="color:#00688b">$CONFIG_ERROR_REPORT_FILE&lt;/span>
&lt;span style="color:#658b00">exit&lt;/span> &lt;span style="color:#b452cd">1&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">fi&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">fi&lt;/span>
&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#cd5555">&amp;#34;check pass! pre_commit successfully!&amp;#34;&lt;/span>;
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>commit-msg&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#1e889b">#!/bin/sh
&lt;/span>&lt;span style="color:#1e889b">&lt;/span>&lt;span style="color:#228b22"># append CL message ä¿¡æ¯ï¼ˆåŠ å…¥ä½œè€… ä¾‹å­ï¼‰&lt;/span>
&lt;span style="color:#228b22">#name=[PinkHello]&lt;/span>
&lt;span style="color:#228b22">#commit=&amp;#34;$name $(cat $1)&amp;#34;&lt;/span>
&lt;span style="color:#228b22">#echo &amp;#34;$commit&amp;#34; &amp;gt; &amp;#34;$1&amp;#34;&lt;/span>
&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#00688b">$commit&lt;/span>
&lt;span style="color:#00688b">commit&lt;/span>=&lt;span style="color:#cd5555">`&lt;/span>cat &lt;span style="color:#00688b">$1&lt;/span>&lt;span style="color:#cd5555">`&lt;/span>
&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#cd5555">&amp;#34;&lt;/span>&lt;span style="color:#00688b">$commit&lt;/span>&lt;span style="color:#cd5555">&amp;#34;&lt;/span> &amp;gt; &lt;span style="color:#cd5555">&amp;#34;&lt;/span>&lt;span style="color:#00688b">$1&lt;/span>&lt;span style="color:#cd5555">&amp;#34;&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> [[ &lt;span style="color:#00688b">$commit&lt;/span> =~ ^([A-Z]+)-([0-9]+):.*|(Merge.*)|(Revert.*)|(Other.*) ]]
&lt;span style="color:#8b008b;font-weight:bold">then&lt;/span>
&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#cd5555">&amp;#34;commit successful!&amp;#34;&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">else&lt;/span>
&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#cd5555">&amp;#34;\033 Error: the commit message must start with JIRA ticket number \033&amp;#34;&lt;/span>
&lt;span style="color:#658b00">exit&lt;/span> &lt;span style="color:#b452cd">1&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">fi&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>init.sh&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#1e889b">#!/bin/sh
&lt;/span>&lt;span style="color:#1e889b">&lt;/span>&lt;span style="color:#228b22"># å½“å‰ç›®å½•&lt;/span>
&lt;span style="color:#00688b">workPath&lt;/span>=&lt;span style="color:#8b008b;font-weight:bold">$(&lt;/span>&lt;span style="color:#658b00">pwd&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">)&lt;/span>
&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#cd5555">&amp;#34;å½“å‰åˆå§‹åŒ–ç›®å½•&lt;/span>&lt;span style="color:#00688b">$workPath&lt;/span>&lt;span style="color:#cd5555">&amp;#34;&lt;/span>
&lt;span style="color:#228b22"># é“¾æ¥åˆ° .git hooks ç›®å½•é‡Œé¢&lt;/span>
ln -s -f &lt;span style="color:#00688b">$workPath&lt;/span>/pre-commit &lt;span style="color:#00688b">$workPath&lt;/span>/../.git/hooks/pre-commit
ln -s -f &lt;span style="color:#00688b">$workPath&lt;/span>/commit-msg &lt;span style="color:#00688b">$workPath&lt;/span>/../.git/hooks/commit-msg
&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#cd5555">&amp;#34;ln pre-commit commit-msg.....success.&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="google-cr-mr-è§„èŒƒ">google CR MR è§„èŒƒ&lt;/h1>
&lt;p>&lt;a href="https://github.com/google/eng-practices">https://github.com/google/eng-practices&lt;/a>&lt;/p>
&lt;p>&lt;code>CL&lt;/code> è§„èŒƒï¼š&lt;/p>
&lt;ul>
&lt;li>æäº¤æ–°çš„ &lt;code>subject&lt;/code> ï¼Œæ‰æœ‰ç¥ˆä½¿å¥ï¼Œä¸€ä¸ªå‘½ä»¤çš„å½¢å¼è¨€ç®€æ„èµ…çš„è¡¨è¾¾è¿™æ¬¡è¦æ”¹å˜çš„ä»€ä¹ˆï¼Œå¦‚éœ€è¦è¯¦ç»†ä¸Šä¸‹æ–‡ï¼Œå…³è” &lt;code>ticket&lt;/code>ï¼Œåœ¨ &lt;code>body&lt;/code> ä¸­è¯´æ˜&lt;/li>
&lt;li>ç®€åŒ– &lt;code>cl&lt;/code> ï¼Œå°½å¯èƒ½å°ï¼Œä¸è¦ç§¯æ”’ä¸€å † &lt;code>change&lt;/code> ï¼Œä¸€æ¬¡æ€§æäº¤ï¼Œç„¶åå†ä¸€æ¬¡æ€§ &lt;code>MR&lt;/code> ï¼ŒåŠ å¤§äº† &lt;code>review&lt;/code> é£é™©ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;code>MR&lt;/code> è§„èŒƒ&lt;/p>
&lt;ul>
&lt;li>ç´§æ€¥ &lt;code>MR&lt;/code> é€‚å½“æ”¾æ¾&lt;/li>
&lt;li>&lt;code>MR&lt;/code> ä¸èƒ½å¸¦æœ‰è„¾æ°”ï¼Œç›®çš„æ˜¯åŸºäºé—®é¢˜è®¨è®ºï¼Œè§£å†³é—®é¢˜&lt;/li>
&lt;li>é’ˆå¯¹åšçš„å¥½çš„ç»™äºˆè‚¯å®šå’ŒğŸ‘&lt;/li>
&lt;li>&lt;code>LGTM means look good to me &lt;/code>= æœ•çŸ¥é“äº†ï¼&lt;/li>
&lt;li>&lt;code>MR&lt;/code> å†²çªï¼Œè”ç³»å¿…è¦å¼€å‘è€…ä¸€èµ·å‚ä¸å†³å®šé¿å…å‡ºç°ä»£ç ä¸¢å¤±ä¸é”™è¯¯.&lt;/li>
&lt;/ul>
&lt;p>&lt;code>CR&lt;/code> è§„èŒƒ&lt;/p>
&lt;ul>
&lt;li>é€Ÿåº¦å¯ä»¥ç­æ€ä¸€åˆ‡æŠ±æ€¨ï¼Œä¸èƒ½è®© &lt;code>cr&lt;/code> æ—¶é—´è¿‡é•¿&lt;/li>
&lt;li>&lt;code>CR&lt;/code> å‘ç°é—®é¢˜ä¸€å®šè¦è®©å¼€å‘è€…å»ä¿®æ”¹ï¼Œä¸è¦æœ‰ä»¥åå†ä¿®æ”¹çš„æƒ³æ³•ï¼Œè¿™ç§æ–¹å¼å¾€å¾€æ˜¯è®©ç³»ç»Ÿå˜å¾—æ›´å·®çš„åŸå› .&lt;/li>
&lt;/ul>
- https://pinkhello.me/posts/09-%E4%BD%BF%E7%94%A8githook%E7%BB%9F%E4%B8%80codestyle/ - PinkHello, All Rights Reserved</description></item><item><title>æ•°æ®ç»“æ„ä¸ç®—æ³• 01 ä¼˜å…ˆé˜Ÿåˆ—</title><link>https://pinkhello.me/posts/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95-01-%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97/</link><pubDate>Thu, 22 Apr 2021 23:53:53 +0800</pubDate><guid>https://pinkhello.me/posts/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95-01-%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97/</guid><description>PinkHello https://pinkhello.me/posts/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95-01-%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97/ -&lt;h1 id="ä¸ºä»€ä¹ˆéœ€è¦ä¼˜å…ˆé˜Ÿåˆ—">ä¸ºä»€ä¹ˆéœ€è¦ä¼˜å…ˆé˜Ÿåˆ—&lt;/h1>
&lt;p>&lt;code>é˜Ÿåˆ—&lt;/code>æ˜¯ä¸€ç§å…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„ï¼Œæ‰€æœ‰å…ƒç´ ä¼˜å…ˆçº§ä¸€æ ·ï¼Œå®Œå…¨éµå®ˆå…ˆè¿›å…ˆå‡ºçš„è§„åˆ™ã€‚ä½†æ˜¯å¾€å¾€ç°å®æƒ…å†µä¸‹ï¼Œè¿™ç§å…¬å¹³éœ€è¦è¢«æ‰“ç ´ã€‚å®ƒæ˜¯ä¸€ä¸ªåŠ¨æ€å˜åŒ–çš„è¿‡ç¨‹ï¼Œå¯èƒ½æœ‰ä¸€äº›éœ€è¦ä¼˜å…ˆï¼Œä¸€äº›éœ€è¦é™ä½ä¼˜å…ˆçº§ã€‚ä¸”è¿™äº›æ•°æ®æ˜¯ä¸€ä¸ªåŠ¨æ€å˜åŒ–çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥éœ€è¦ç»´ç³»è¿™ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚&lt;/p>
&lt;h1 id="ä¼˜å…ˆé˜Ÿåˆ—çš„å®ç°æ–¹å¼">ä¼˜å…ˆé˜Ÿåˆ—çš„å®ç°æ–¹å¼&lt;/h1>
&lt;h2 id="æ•°ç»„å®ç°">æ•°ç»„å®ç°&lt;/h2>
&lt;h2 id="é“¾è¡¨">é“¾è¡¨&lt;/h2>
- https://pinkhello.me/posts/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95-01-%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97/ - PinkHello, All Rights Reserved</description></item><item><title>08 Gradleå¤šæ¨¡å—é¡¹ç›®æ¨¡æ¿åŒ–</title><link>https://pinkhello.me/posts/08-gradle%E5%A4%9A%E6%A8%A1%E5%9D%97%E9%A1%B9%E7%9B%AE%E6%A8%A1%E6%9D%BF%E5%8C%96/</link><pubDate>Tue, 20 Apr 2021 08:43:21 +0800</pubDate><guid>https://pinkhello.me/posts/08-gradle%E5%A4%9A%E6%A8%A1%E5%9D%97%E9%A1%B9%E7%9B%AE%E6%A8%A1%E6%9D%BF%E5%8C%96/</guid><description>PinkHello https://pinkhello.me/posts/08-gradle%E5%A4%9A%E6%A8%A1%E5%9D%97%E9%A1%B9%E7%9B%AE%E6%A8%A1%E6%9D%BF%E5%8C%96/ -&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>Maven å†—ä½™ï¼Œ Gradle ç®€å•è½»ä¾¿
å…¬å¸åŸæœ‰çš„ CI/CD æµç¨‹ï¼Œå€ŸåŠ© Maven æ’ä»¶ build Docker Image,æ”¹ä¸ºåŸç”Ÿ Docker Runner åŸå§‹æ„å»º&lt;/p>
&lt;h2 id="1å¤šæ¨¡å—é¡¹ç›®">1ã€å¤šæ¨¡å—é¡¹ç›®&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">project&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- app&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- src/main/[java|resources] | src/test/[java|resources] &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># classpath&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- Dockerfile &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># Dockerfile&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- build.gradle &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># APP æ¨¡å— gradle é…ç½®&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- sdk &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># SDK æ¨¡å— å¯æœ‰å¯æ— &lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- src/main/java&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- build.gradle &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># SDK çš„ gradle é…ç½®&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- deploy &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># delpoy é¡¹ç›® æ³¨æ„ checkstyle ç›¸å…³é…ç½®åœ¨è¿™é‡Œé¢&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- checkstyle/**&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#1e889b">**.yml&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- build.gradle &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># é¡¹ç›®é¡¶çº§ gradleé…ç½®&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- gradle&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- wrapper/** &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># gradle é…ç½®ä¿¡æ¯&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- check.gradle &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># pmd &amp;amp; checkstyle&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- repo.gradle &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># ä»“åº“å®šä¹‰&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#228b22"># test.gradle æ”¾è¿™å„¿ï¼Œå°±æ²¡æœ‰é«˜äº®äº† =&amp;gt; æš‚æ—¶ç»´æŠ¤åœ¨ é¡¶å±‚çš„ build.gradle ä¸­ï¼Œå•ç‹¬ç»´æŠ¤ï¼Œä¸è¦å’Œå…¶ä»–é…ç½®æ··åœ¨ä¸€èµ·ã€‚&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- settings.gradle &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># é…ç½®&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- versions-prod.gradle &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># ç‰ˆæœ¬å®šä¹‰&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- versions-dev.gradle &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># ç‰ˆæœ¬å®šä¹‰&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- .gitignore &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># gitå¿½ç•¥æ–‡ä»¶&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- .gitlab-ci.yml &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># CI/CD&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="2project-ä¸‹å„ä¸ªgradleæ–‡ä»¶">2ã€Project ä¸‹å„ä¸ªgradleæ–‡ä»¶&lt;/h2>
&lt;p>Project/versions.gradle å¯ä»¥ç»Ÿä¸€ç‰ˆæœ¬ç®¡ç†&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-groovy" data-lang="groovy">&lt;span style="color:#228b22">//start step
&lt;/span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#00688b;font-weight:bold">def&lt;/span> versions = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Expando()
&lt;span style="color:#00688b;font-weight:bold">def&lt;/span> deps = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Expando()
ext.&lt;span style="color:#658b00">versions&lt;/span> = versions
ext.&lt;span style="color:#658b00">deps&lt;/span> = deps
&lt;span style="color:#228b22">//set versions
&lt;/span>&lt;span style="color:#228b22">&lt;/span>versions.&lt;span style="color:#658b00">springboot&lt;/span> = &lt;span style="color:#cd5555">&amp;#34;2.1.16.RELEASE&amp;#34;&lt;/span>
versions.&lt;span style="color:#658b00">mysql&lt;/span> = &lt;span style="color:#cd5555">&amp;#34;8.0.16&amp;#34;&lt;/span>
versions.&lt;span style="color:#658b00">guava&lt;/span> = &lt;span style="color:#cd5555">&amp;#34;25.1-jre&amp;#34;&lt;/span>
versions.&lt;span style="color:#658b00">httpclient&lt;/span> = &lt;span style="color:#cd5555">&amp;#34;4.5.9&amp;#34;&lt;/span>
versions.&lt;span style="color:#658b00">okhttp3&lt;/span> = &lt;span style="color:#cd5555">&amp;#34;3.8.1&amp;#34;&lt;/span>
versions.&lt;span style="color:#658b00">apm&lt;/span> = &lt;span style="color:#cd5555">&amp;#34;1.7.0&amp;#34;&lt;/span>
versions.&lt;span style="color:#658b00">kotlin&lt;/span> = &lt;span style="color:#cd5555">&amp;#34;1.4.10&amp;#34;&lt;/span>
&lt;span style="color:#228b22">//set dependencies
&lt;/span>&lt;span style="color:#228b22">&lt;/span>
&lt;span style="color:#228b22">// åŸºç¡€å¼€æºåŒ…
&lt;/span>&lt;span style="color:#228b22">&lt;/span>deps.&lt;span style="color:#658b00">mysql&lt;/span> = &lt;span style="color:#cd5555">&amp;#34;mysql:mysql-connector-java:${versions.mysql}&amp;#34;&lt;/span>
deps.&lt;span style="color:#658b00">guava&lt;/span> = &lt;span style="color:#cd5555">&amp;#34;com.google.guava:guava:${versions.guava}&amp;#34;&lt;/span>
deps.&lt;span style="color:#658b00">okhttp3&lt;/span> = &lt;span style="color:#cd5555">&amp;#34;com.squareup.okhttp3:okhttp:${versions.okhttp3}&amp;#34;&lt;/span>
deps.&lt;span style="color:#658b00">apm&lt;/span> = &lt;span style="color:#cd5555">&amp;#34;co.elastic.apm:apm-agent-attach:${versions.apm}&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Project/settings.gradle æ ¹é…ç½®æ–‡ä»¶ï¼Œbuild å¿«ä¸å¿«å…¨é å®ƒ&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-groovy" data-lang="groovy">&lt;span style="color:#228b22">//é…ç½®æ’ä»¶èµ°å›½å†…ä»£ç†
&lt;/span>&lt;span style="color:#228b22">&lt;/span>pluginManagement {
repositories {
maven {
url &lt;span style="color:#cd5555">&amp;#39;https://maven.aliyun.com/repository/gradle-plugin&amp;#39;&lt;/span>
}
gradlePluginPortal()
}
}
rootProject.&lt;span style="color:#658b00">name&lt;/span> = &lt;span style="color:#cd5555">&amp;#39;project-name&amp;#39;&lt;/span>
include &lt;span style="color:#cd5555">&amp;#39;:app&amp;#39;&lt;/span>
include &lt;span style="color:#cd5555">&amp;#39;:sdk&amp;#39;&lt;/span> &lt;span style="color:#228b22">// æ²¡æœ‰SDKæ¨¡å—çš„åŒ–ä¸éœ€è¦è¿™ä¸ª
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Project/build.gradle&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-groovy" data-lang="groovy">buildscript {
ext {
kotlinVersion = &lt;span style="color:#cd5555">&amp;#34;1.4.10&amp;#34;&lt;/span>
springBootVersion = &lt;span style="color:#cd5555">&amp;#39;2.1.16.RELEASE&amp;#39;&lt;/span>
springBootGradleVersion = &lt;span style="color:#cd5555">&amp;#39;2.3.3.RELEASE&amp;#39;&lt;/span>
}
}
plugins {
id &lt;span style="color:#cd5555">&amp;#34;java&amp;#34;&lt;/span>
id &lt;span style="color:#cd5555">&amp;#34;pmd&amp;#34;&lt;/span>
id &lt;span style="color:#cd5555">&amp;#34;checkstyle&amp;#34;&lt;/span>
id &lt;span style="color:#cd5555">&amp;#34;maven-publish&amp;#34;&lt;/span>
id &lt;span style="color:#cd5555">&amp;#34;org.jetbrains.kotlin.jvm&amp;#34;&lt;/span> version &lt;span style="color:#cd5555">&amp;#34;$kotlinVersion&amp;#34;&lt;/span>
id &lt;span style="color:#cd5555">&amp;#34;org.jetbrains.kotlin.plugin.spring&amp;#34;&lt;/span> version &lt;span style="color:#cd5555">&amp;#34;$kotlinVersion&amp;#34;&lt;/span>
id &lt;span style="color:#cd5555">&amp;#34;org.springframework.boot&amp;#34;&lt;/span> version &lt;span style="color:#cd5555">&amp;#34;$springBootVersion&amp;#34;&lt;/span>
id &lt;span style="color:#cd5555">&amp;#34;io.spring.dependency-management&amp;#34;&lt;/span> version &lt;span style="color:#cd5555">&amp;#34;1.0.9.RELEASE&amp;#34;&lt;/span>
}
apply from: file(&lt;span style="color:#cd5555">&amp;#34;versions.gradle&amp;#34;&lt;/span>)
&lt;span style="color:#228b22">// ä¸ºäº†ä¸€å¦‚ä¸åŒçš„ç‰ˆæœ¬ç¯å¢ƒä¸‹çš„ä»£ç é…ç½®
&lt;/span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#00688b;font-weight:bold">def&lt;/span> env = System.&lt;span style="color:#658b00">getProperty&lt;/span>(&lt;span style="color:#cd5555">&amp;#39;env&amp;#39;&lt;/span>) ?: &lt;span style="color:#cd5555">&amp;#39;dev&amp;#39;&lt;/span>
apply from: &lt;span style="color:#cd5555">&amp;#34;${rootDir}/versions-${env}.gradle&amp;#34;&lt;/span>
allprojects {
&lt;span style="color:#228b22">// é…ç½® group
&lt;/span>&lt;span style="color:#228b22">&lt;/span> group &lt;span style="color:#cd5555">&amp;#34;com.XXX.XXX&amp;#34;&lt;/span>
&lt;span style="color:#228b22">//é…ç½®ç‰ˆæœ¬
&lt;/span>&lt;span style="color:#228b22">&lt;/span> version = findProperty &lt;span style="color:#cd5555">&amp;#39;version&amp;#39;&lt;/span> ?: &lt;span style="color:#cd5555">&amp;#39;1.0.0-SNAPSHOT&amp;#39;&lt;/span>
bootJar {
enabled = &lt;span style="color:#8b008b;font-weight:bold">false&lt;/span>
}
apply plugin: &lt;span style="color:#cd5555">&amp;#34;java&amp;#34;&lt;/span>
apply plugin: &lt;span style="color:#cd5555">&amp;#34;idea&amp;#34;&lt;/span>
apply plugin: &lt;span style="color:#cd5555">&amp;#34;maven-publish&amp;#34;&lt;/span>
apply plugin: &lt;span style="color:#cd5555">&amp;#34;org.jetbrains.kotlin.jvm&amp;#34;&lt;/span>
apply plugin: &lt;span style="color:#cd5555">&amp;#34;kotlin-spring&amp;#34;&lt;/span>
apply plugin: &lt;span style="color:#cd5555">&amp;#34;org.springframework.boot&amp;#34;&lt;/span>
apply plugin: &lt;span style="color:#cd5555">&amp;#34;io.spring.dependency-management&amp;#34;&lt;/span>
apply plugin: &lt;span style="color:#cd5555">&amp;#39;jacoco&amp;#39;&lt;/span>
&lt;span style="color:#228b22">//å‡å¦‚ ä½ çš„ mapper.xml æˆ–è€… grovvy å†™åœ¨ src/main/java ï¼Œæ‰“åŒ…éœ€è¦å¤„ç†åˆ° éœ€è¦åŠ å…¥çš„resourcesï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#228b22">// å½“ç„¶å¦‚æœ ä½ çš„ mapper.xml ç›´æ¥åœ¨ src/main/resources é‡Œé¢ ä¸éœ€è¦å¤„ç†ï¼Œå¯ä»¥ç›´æ¥åˆ é™¤
&lt;/span>&lt;span style="color:#228b22">&lt;/span> processResources {
from(&lt;span style="color:#cd5555">&amp;#39;src/main/java&amp;#39;&lt;/span>) {
include &lt;span style="color:#cd5555">&amp;#39;**/*.xml&amp;#39;&lt;/span>
include &lt;span style="color:#cd5555">&amp;#39;**/*.groovy&amp;#39;&lt;/span>
}
}
}
&lt;span style="color:#228b22">// apply from: file(&amp;#34;gradle/repo.gradle&amp;#34;)
&lt;/span>&lt;span style="color:#228b22">// apply from: file(&amp;#34;gradle/check.gradle&amp;#34;)
&lt;/span>&lt;span style="color:#228b22">// apply from: file(&amp;#34;gradle/maven-publish.gradle&amp;#34;)
&lt;/span>&lt;span style="color:#228b22">&lt;/span>apply from: &lt;span style="color:#cd5555">&amp;#39;https://${DownloadPath}/gradle/check-style.gradle&amp;#39;&lt;/span>
apply from: &lt;span style="color:#cd5555">&amp;#39;https://${DownloadPath}/gradle/maven-repo.gradle&amp;#39;&lt;/span>
apply from: &lt;span style="color:#cd5555">&amp;#39;https://${DownloadPath}/gradle/maven-publish.gradle&amp;#39;&lt;/span>
subprojects {
configurations {
provided
}
sourceSets.&lt;span style="color:#658b00">main&lt;/span>.&lt;span style="color:#658b00">compileClasspath&lt;/span> += configurations.&lt;span style="color:#658b00">provided&lt;/span>
sourceSets.&lt;span style="color:#658b00">test&lt;/span>.&lt;span style="color:#658b00">compileClasspath&lt;/span> += configurations.&lt;span style="color:#658b00">provided&lt;/span>
sourceSets.&lt;span style="color:#658b00">test&lt;/span>.&lt;span style="color:#658b00">runtimeClasspath&lt;/span> += configurations.&lt;span style="color:#658b00">provided&lt;/span>
tasks.&lt;span style="color:#658b00">withType&lt;/span>(JavaCompile) {
options.&lt;span style="color:#658b00">encoding&lt;/span> = &lt;span style="color:#cd5555">&amp;#39;UTF-8&amp;#39;&lt;/span>
}
task &lt;span style="color:#008b45">sourceJar&lt;/span>(type: Jar) {
from sourceSets.&lt;span style="color:#658b00">main&lt;/span>.&lt;span style="color:#658b00">allJava&lt;/span>
classifier &lt;span style="color:#cd5555">&amp;#34;sources&amp;#34;&lt;/span>
}
task &lt;span style="color:#008b45">javadocJar&lt;/span>(type: Jar, dependsOn: javadoc) {
from javadoc.&lt;span style="color:#658b00">destinationDir&lt;/span>
}
dependencies {
implementation &lt;span style="color:#cd5555">&amp;#34;com.google.guava:guava:$versions.guava&amp;#34;&lt;/span>
compileOnly &lt;span style="color:#cd5555">&amp;#39;org.projectlombok:lombok:1.18.4&amp;#39;&lt;/span>
annotationProcessor &lt;span style="color:#cd5555">&amp;#39;org.projectlombok:lombok:1.18.4&amp;#39;&lt;/span>
testCompileOnly &lt;span style="color:#cd5555">&amp;#39;org.projectlombok:lombok:1.18.4&amp;#39;&lt;/span>
testAnnotationProcessor &lt;span style="color:#cd5555">&amp;#39;org.projectlombok:lombok:1.18.4&amp;#39;&lt;/span>
testImplementation &lt;span style="color:#cd5555">&amp;#34;org.springframework.boot:spring-boot-starter-test:$springBootVersion&amp;#34;&lt;/span>
testImplementation &lt;span style="color:#cd5555">&amp;#34;org.mockito:mockito-core:2.23.4&amp;#34;&lt;/span>
testImplementation &lt;span style="color:#cd5555">&amp;#39;junit:junit:4.13&amp;#39;&lt;/span>
&lt;span style="color:#228b22">// h2
&lt;/span>&lt;span style="color:#228b22">&lt;/span> testImplementation &lt;span style="color:#cd5555">&amp;#34;com.h2database:h2:1.4.200&amp;#34;&lt;/span>
&lt;span style="color:#228b22">// redis memery
&lt;/span>&lt;span style="color:#228b22">&lt;/span> testImplementation &lt;span style="color:#cd5555">&amp;#34;com.github.kstyrc:embedded-redis:0.6&amp;#34;&lt;/span>
}
&lt;span style="color:#228b22">// jacoco report
&lt;/span>&lt;span style="color:#228b22">&lt;/span> jacocoTestReport {
reports {
xml.&lt;span style="color:#658b00">enabled&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">false&lt;/span>
html.&lt;span style="color:#658b00">enabled&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>
}
}
check.&lt;span style="color:#658b00">dependsOn&lt;/span> jacocoTestReport
}
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-groovy" data-lang="groovy">
allprojects {
apply plugin: &lt;span style="color:#cd5555">&amp;#39;maven-publish&amp;#39;&lt;/span>
publishing {
task &lt;span style="color:#008b45">sourceJar&lt;/span>(type: Jar) {
from sourceSets.&lt;span style="color:#658b00">main&lt;/span>.&lt;span style="color:#658b00">allJava&lt;/span>
classifier &lt;span style="color:#cd5555">&amp;#34;sources&amp;#34;&lt;/span>
}
publications {
mavenSnapshots(MavenPublication) {
groupId project.&lt;span style="color:#658b00">group&lt;/span>
artifactId project.&lt;span style="color:#658b00">name&lt;/span>
version project.&lt;span style="color:#658b00">version&lt;/span>
from components.&lt;span style="color:#658b00">java&lt;/span>
artifact sourceJar
ext.&lt;span style="color:#658b00">repo&lt;/span> = &lt;span style="color:#cd5555">&amp;#39;Dev&amp;#39;&lt;/span>
}
mavenRelease(MavenPublication) {
groupId project.&lt;span style="color:#658b00">group&lt;/span>
artifactId project.&lt;span style="color:#658b00">name&lt;/span>
version project.&lt;span style="color:#658b00">version&lt;/span>
from components.&lt;span style="color:#658b00">java&lt;/span>
artifact sourceJar
ext.&lt;span style="color:#658b00">repo&lt;/span> = &lt;span style="color:#cd5555">&amp;#39;Prod&amp;#39;&lt;/span>
}
}
repositories {
maven {
name &lt;span style="color:#cd5555">&amp;#39;Dev&amp;#39;&lt;/span>
url &lt;span style="color:#cd5555">&amp;#34;${NEXUS_URL}/repository/maven-snapshots/&amp;#34;&lt;/span>
authentication {
header(HttpHeaderAuthentication)
}
credentials(HttpHeaderCredentials) {
name &lt;span style="color:#cd5555">&amp;#34;Authorization&amp;#34;&lt;/span>
value &lt;span style="color:#cd5555">&amp;#34;Basic ${NEXUS_CAS_HEADER}&amp;#34;&lt;/span>
}
}
maven {
name &lt;span style="color:#cd5555">&amp;#39;Prod&amp;#39;&lt;/span>
url &lt;span style="color:#cd5555">&amp;#34;${NEXUS_URL}/repository/maven-releases/&amp;#34;&lt;/span>
}
}
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Project/gradle/repo.gradle æŒ‡å®šç§æœ‰ä»“åº“åœ°å€ä»¥åŠéªŒè¯æ–¹å¼&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-groovy" data-lang="groovy">buildscript {
repositories {
mavenLocal()
maven {
url &lt;span style="color:#cd5555">&amp;#34;${NEXUS_URL}/repository/maven-releases/&amp;#34;&lt;/span>
authentication {
header(HttpHeaderAuthentication)
}
credentials(HttpHeaderCredentials) {
name &lt;span style="color:#cd5555">&amp;#34;Authorization&amp;#34;&lt;/span>
value &lt;span style="color:#cd5555">&amp;#34;Basic ${NEXUS_CAS_HEADER}&amp;#34;&lt;/span>
}
}
maven {
url &lt;span style="color:#cd5555">&amp;#34;${NEXUS_URL}/repository/maven-snapshots/&amp;#34;&lt;/span>
authentication {
header(HttpHeaderAuthentication)
}
credentials(HttpHeaderCredentials) {
name &lt;span style="color:#cd5555">&amp;#34;Authorization&amp;#34;&lt;/span>
value &lt;span style="color:#cd5555">&amp;#34;Basic ${NEXUS_CAS_HEADER}&amp;#34;&lt;/span>
}
}
maven {
url &lt;span style="color:#cd5555">&amp;#34;${NEXUS_URL}/repository/maven-public/&amp;#34;&lt;/span>
authentication {
header(HttpHeaderAuthentication)
}
credentials(HttpHeaderCredentials) {
name &lt;span style="color:#cd5555">&amp;#34;Authorization&amp;#34;&lt;/span>
value &lt;span style="color:#cd5555">&amp;#34;Basic ${NEXUS_CAS_HEADER}&amp;#34;&lt;/span>
}
}
maven { url &lt;span style="color:#cd5555">&amp;#34;https://maven.aliyun.com/nexus/content/groups/public/&amp;#34;&lt;/span> }
maven { url &lt;span style="color:#cd5555">&amp;#34;https://repo.spring.io/milestone&amp;#34;&lt;/span> }
maven { url &lt;span style="color:#cd5555">&amp;#34;https://oss.sonatype.org/content/repositories/snapshots/&amp;#34;&lt;/span> }
}
}
allprojects {
repositories {
mavenLocal()
maven {
url &lt;span style="color:#cd5555">&amp;#34;${NEXUS_URL}/repository/maven-releases/&amp;#34;&lt;/span>
authentication {
header(HttpHeaderAuthentication)
}
credentials(HttpHeaderCredentials) {
name &lt;span style="color:#cd5555">&amp;#34;Authorization&amp;#34;&lt;/span>
value &lt;span style="color:#cd5555">&amp;#34;Basic ${NEXUS_CAS_HEADER}&amp;#34;&lt;/span>
}
}
maven {
url &lt;span style="color:#cd5555">&amp;#34;${NEXUS_URL}/repository/maven-snapshots/&amp;#34;&lt;/span>
authentication {
header(HttpHeaderAuthentication)
}
credentials(HttpHeaderCredentials) {
name &lt;span style="color:#cd5555">&amp;#34;Authorization&amp;#34;&lt;/span>
value &lt;span style="color:#cd5555">&amp;#34;Basic ${NEXUS_CAS_HEADER}&amp;#34;&lt;/span>
}
}
maven {
url &lt;span style="color:#cd5555">&amp;#34;${NEXUS_URL}/repository/maven-public/&amp;#34;&lt;/span>
authentication {
header(HttpHeaderAuthentication)
}
credentials(HttpHeaderCredentials) {
name &lt;span style="color:#cd5555">&amp;#34;Authorization&amp;#34;&lt;/span>
value &lt;span style="color:#cd5555">&amp;#34;Basic ${NEXUS_CAS_HEADER}&amp;#34;&lt;/span>
}
}
maven { url &lt;span style="color:#cd5555">&amp;#34;https://maven.aliyun.com/nexus/content/groups/public/&amp;#34;&lt;/span> }
maven { url &lt;span style="color:#cd5555">&amp;#34;https://repo.spring.io/milestone&amp;#34;&lt;/span> }
maven { url &lt;span style="color:#cd5555">&amp;#34;https://oss.sonatype.org/content/repositories/snapshots/&amp;#34;&lt;/span> }
}
}
subprojects {
repositories {
mavenLocal()
maven {
url &lt;span style="color:#cd5555">&amp;#34;${NEXUS_URL}/repository/maven-releases/&amp;#34;&lt;/span>
authentication {
header(HttpHeaderAuthentication)
}
credentials(HttpHeaderCredentials) {
name &lt;span style="color:#cd5555">&amp;#34;Authorization&amp;#34;&lt;/span>
value &lt;span style="color:#cd5555">&amp;#34;Basic ${NEXUS_CAS_HEADER}&amp;#34;&lt;/span>
}
}
maven {
url &lt;span style="color:#cd5555">&amp;#34;${NEXUS_URL}/repository/maven-snapshots/&amp;#34;&lt;/span>
authentication {
header(HttpHeaderAuthentication)
}
credentials(HttpHeaderCredentials) {
name &lt;span style="color:#cd5555">&amp;#34;Authorization&amp;#34;&lt;/span>
value &lt;span style="color:#cd5555">&amp;#34;Basic ${NEXUS_CAS_HEADER}&amp;#34;&lt;/span>
}
}
maven {
url &lt;span style="color:#cd5555">&amp;#34;${NEXUS_URL}/repository/maven-public/&amp;#34;&lt;/span>
authentication {
header(HttpHeaderAuthentication)
}
credentials(HttpHeaderCredentials) {
name &lt;span style="color:#cd5555">&amp;#34;Authorization&amp;#34;&lt;/span>
value &lt;span style="color:#cd5555">&amp;#34;Basic ${NEXUS_CAS_HEADER}&amp;#34;&lt;/span>
}
}
maven { url &lt;span style="color:#cd5555">&amp;#34;https://maven.aliyun.com/nexus/content/groups/public/&amp;#34;&lt;/span> }
maven { url &lt;span style="color:#cd5555">&amp;#34;https://repo.spring.io/milestone&amp;#34;&lt;/span> }
maven { url &lt;span style="color:#cd5555">&amp;#34;https://oss.sonatype.org/content/repositories/snapshots/&amp;#34;&lt;/span> }
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Project/gradle/check.gradle&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-groovy" data-lang="groovy">subprojects {
apply plugin: &lt;span style="color:#cd5555">&amp;#39;checkstyle&amp;#39;&lt;/span>
checkstyle {
configFile = rootProject.&lt;span style="color:#658b00">file&lt;/span>(&lt;span style="color:#cd5555">&amp;#39;deploy/checkstyle/checkstyle.xml&amp;#39;&lt;/span>)
showViolations = &lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>
&lt;span style="color:#228b22">// ignoreFailures = true
&lt;/span>&lt;span style="color:#228b22">&lt;/span>
}
&lt;span style="color:#228b22">//å¯ä»¥æŒ‡å®šæ’æŸ¥
&lt;/span>&lt;span style="color:#228b22">&lt;/span> checkstyleMain {
exclude &lt;span style="color:#cd5555">&amp;#34;**/*.groovy&amp;#34;&lt;/span>
}
apply plugin: &lt;span style="color:#cd5555">&amp;#39;pmd&amp;#39;&lt;/span>
dependencies {
pmd &lt;span style="color:#cd5555">&amp;#34;com.alibaba.p3c:p3c-pmd:2.0.0&amp;#34;&lt;/span>
}
pmd {
consoleOutput = &lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>
ruleSets = [
&lt;span style="color:#cd5555">&amp;#34;java-ali-comment&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;java-ali-concurrent&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;java-ali-constant&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;java-ali-exception&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;java-ali-flowcontrol&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;java-ali-naming&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;java-ali-oop&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;java-ali-orm&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;java-ali-other&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;java-ali-set&amp;#34;&lt;/span>
]
incrementalAnalysis = &lt;span style="color:#8b008b;font-weight:bold">false&lt;/span>
}
pmdMain {
exclude &lt;span style="color:#cd5555">&amp;#34;**/exclude_package/**&amp;#34;&lt;/span>
}
}
test.&lt;span style="color:#658b00">mustRunAfter&lt;/span> checkstyleMain, checkstyleTest
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Project/sdk/build.gradle&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-groovy" data-lang="groovy">apply from: file(&lt;span style="color:#cd5555">&amp;#34;$rootDir/versions.gradle&amp;#34;&lt;/span>)
jar {
enabled = &lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>
}
bootJar {
enabled = &lt;span style="color:#8b008b;font-weight:bold">false&lt;/span>
}
dependencies {
implementation &lt;span style="color:#cd5555">&amp;#39;org.springframework.cloud:spring-cloud-starter-openfeign:2.1.0.RELEASE&amp;#39;&lt;/span>
......
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>Project/app/build.gradle&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-groovy" data-lang="groovy">apply from: file(&lt;span style="color:#cd5555">&amp;#34;$rootDir/versions.gradle&amp;#34;&lt;/span>)
bootJar {
enabled = &lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>
}
jar {
enabled = &lt;span style="color:#8b008b;font-weight:bold">false&lt;/span>
}
dependencies {
implementation deps.&lt;span style="color:#658b00">springboot&lt;/span>.&lt;span style="color:#658b00">starter&lt;/span>
implementation deps.&lt;span style="color:#658b00">springboot&lt;/span>.&lt;span style="color:#658b00">starter_web&lt;/span>
implementation deps.&lt;span style="color:#658b00">mysql&lt;/span>
implementation deps.&lt;span style="color:#658b00">myabtis&lt;/span>.&lt;span style="color:#658b00">myabtis&lt;/span>
implementation deps.&lt;span style="color:#658b00">myabtis&lt;/span>.&lt;span style="color:#658b00">starter&lt;/span>
implementation &lt;span style="color:#cd5555">&amp;#39;org.springframework.boot:spring-boot-starter-amqp:2.1.2.RELEASE&amp;#39;&lt;/span>
implementation &lt;span style="color:#cd5555">&amp;#34;org.springframework.cloud:spring-cloud-starter-openfeign:2.1.0.RELEASE&amp;#34;&lt;/span>
implementation &lt;span style="color:#cd5555">&amp;#39;com.zaxxer:HikariCP:3.4.1&amp;#39;&lt;/span>
implementation &lt;span style="color:#cd5555">&amp;#39;com.baomidou:mybatis-plus:2.2.0&amp;#39;&lt;/span>
implementation &lt;span style="color:#cd5555">&amp;#39;com.github.pagehelper:pagehelper:5.1.2&amp;#39;&lt;/span>
implementation &lt;span style="color:#cd5555">&amp;#39;org.mongodb:mongo-java-driver:3.8.0&amp;#39;&lt;/span>
...... &lt;span style="color:#228b22">//å‰©ä½™æ˜ å°„ä¾èµ–
&lt;/span>&lt;span style="color:#228b22">&lt;/span>}
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="3-dockerfile-æ³¨æ„-add-æ–‡ä»¶è·¯å¾„">3ã€ Dockerfile æ³¨æ„ ADD æ–‡ä»¶è·¯å¾„&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-dockerfile" data-lang="dockerfile">&lt;span style="color:#8b008b;font-weight:bold">FROM&lt;/span>&lt;span style="color:#cd5555"> {HARBOR_HOST}/BaseImage&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">ADD&lt;/span> ./build/libs/app.jar /app.jar&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>.... å…¶ä»–é…ç½®&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="4project-ä¸‹æ·»åŠ -gradleproperties-æ³¨æ„åœ¨-gitignore-é‡Œé¢æ·»åŠ ä¸Šå®ƒä¸è¦ä¼ é€’åˆ°å…¬å¼€æœåŠ¡å™¨æ˜¯ä½ çš„å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯">4ã€Project/ ä¸‹æ·»åŠ  gradle.properties, æ³¨æ„åœ¨ .gitignore é‡Œé¢æ·»åŠ ä¸Šå®ƒï¼Œä¸è¦ä¼ é€’åˆ°å…¬å¼€æœåŠ¡å™¨ï¼Œæ˜¯ä½ çš„å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯&lt;/h2>
&lt;pre>&lt;code class="language-properties" data-lang="properties"># Nexus ä»“åº“åœ°å€
NEXUS_URL=https://nexus-url
# æŒ‡å®šä¸ºä½ è‡ªå·±çš„mavençš„ç”¨æˆ·é…ç½® settings.xml é‡Œé¢çš„ä½ çš„é…ç½®
NEXUS_CAS_HEADER=XXXXXXX
# gradle daemon
org.gradle.daemon=true
# ç¦ç”¨Gradle 6.x ç‰ˆæœ¬ SHA-256å’ŒSHA-512æ ¡éªŒå’Œçš„å‘å¸ƒ
# https://juejin.im/post/6844904101126553614
systemProp.org.gradle.internal.publish.checksums.insecure=true
&lt;/code>&lt;/pre>&lt;h2 id="5gitlab-ci-æ¨¡æ¿åŒ–ä¸‹æ¬¡åˆ†äº«">5ã€gitlab-ci æ¨¡æ¿åŒ–ï¼Œä¸‹æ¬¡åˆ†äº«~~~~&lt;/h2>
- https://pinkhello.me/posts/08-gradle%E5%A4%9A%E6%A8%A1%E5%9D%97%E9%A1%B9%E7%9B%AE%E6%A8%A1%E6%9D%BF%E5%8C%96/ - PinkHello, All Rights Reserved</description></item></channel></rss>