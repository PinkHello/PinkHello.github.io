<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PinkHello</title><link>https://pinkhello.me/</link><description>Recent content on PinkHello</description><generator>Hugo -- gohugo.io</generator><language>zh</language><copyright>PinkHello, All Rights Reserved</copyright><lastBuildDate>Tue, 25 May 2021 19:00:00 +0800</lastBuildDate><atom:link href="https://pinkhello.me/index.xml" rel="self" type="application/rss+xml"/><item><title>06 é«˜æ€§èƒ½é˜Ÿåˆ—Disruptor</title><link>https://pinkhello.me/posts/06-%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97disruptor/</link><pubDate>Mon, 15 Mar 2021 08:35:29 +0800</pubDate><guid>https://pinkhello.me/posts/06-%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97disruptor/</guid><description>PinkHello https://pinkhello.me/posts/06-%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97disruptor/ -&lt;h1 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h1>
&lt;p>&lt;code>Disruptor&lt;/code> æ˜¯ å¤–æ±‡äº¤æ˜“å…¬å¸&lt;code>LMAX&lt;/code>å¼€å‘çš„é«˜æ€§èƒ½é˜Ÿåˆ—ã€ç ”å‘æ˜¯ä¸ºäº†è§£å†³å†…å­˜é˜Ÿåˆ—å»¶è¿Ÿé—®é¢˜ã€‚
&lt;code>Disruptor&lt;/code> ä¸€èˆ¬ç”¨äºçº¿ç¨‹é—´çš„æ¶ˆæ¯ä¼ é€’ã€‚
&lt;a href="http://lmax-exchange.github.io/disruptor/">Disruptor GitHub åœ°å€&lt;/a>&lt;/p>
&lt;h1 id="disruptor-ä»‹ç»">&lt;code>Disruptor&lt;/code> ä»‹ç»&lt;/h1>
&lt;p>ç†è§£ &lt;code>Disruptor&lt;/code> æœ€å¥½çš„æ–¹å¼ï¼Œé€‰æ‹©ä¸€ä¸ªæœ€æ¥è¿‘ç†Ÿæ‚‰çš„æ ·æœ¬è¿›è¡Œæ¯”è¾ƒã€‚åœ¨è¿™ä¸ªå‰æä¸‹ï¼Œå¯ä»¥é€‰æ‹© &lt;code>Java&lt;/code> ä¸­çš„ &lt;code>BlockingQueue&lt;/code>.
å’Œé˜Ÿåˆ—ç›¸ä¼¼ï¼Œ&lt;code>Disruptor&lt;/code> ä¹Ÿæ˜¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ä¸åŒçš„çº¿ç¨‹ä¹‹é—´è¿›è¡Œä¼ é€’æ•°æ®çš„ï¼ˆä¾‹å¦‚æ¶ˆæ¯æˆ–è€…äº‹ä»¶ï¼‰ï¼ŒåŒæ—¶ &lt;code>Disruptor&lt;/code> æä¾›äº†ä¸€äº›å°†å…³é”®åŠŸèƒ½å’Œé˜Ÿåˆ—åˆ†å¼€çš„ç‰¹æ€§ï¼š&lt;/p>
&lt;ul>
&lt;li>å‘æ¶ˆè´¹è€…å‘é€å¤šæ’­äº‹ä»¶&lt;/li>
&lt;li>æ¶ˆæ¯è€…ä¾èµ–å…³ç³»å›¾&lt;/li>
&lt;li>é¢„å…ˆä¸ºäº‹ä»¶åˆ†é…å†…å­˜&lt;/li>
&lt;li>å¯é€‰çš„ï¼ˆæ— é”ï¼‰&lt;/li>
&lt;/ul>
&lt;h1 id="disruptor-æ ¸å¿ƒæ¦‚å¿µ">&lt;code>Disruptor&lt;/code> æ ¸å¿ƒæ¦‚å¿µ&lt;/h1>
&lt;p>åœ¨æˆ‘ä»¬ç†è§£&lt;code>Disruptor&lt;/code>å¦‚ä½•å·¥ä½œä¹‹å‰ï¼Œäº†è§£ä¸‹æ ¸å¿ƒæ¦‚å¿µ&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/RingBuffer.java">Ring Buffer&lt;/a>
ç¯å½¢æ•°ç»„è®¾è®¡ï¼Œä¸ºäº†é¿å…åƒåœ¾å›æ”¶ï¼Œé‡‡ç”¨çš„æ•°ç»„ç»“æ„ï¼Œä»3.0å¼€å§‹ï¼Œç¯å½¢ç¼“å†²åŒºä¸»è¦å­˜å‚¨å’Œæ›´æ–°åœ¨&lt;code>Disruptor&lt;/code>ä¸­ç§»åŠ¨çš„æ•°æ®ï¼ˆäº‹ä»¶ï¼‰&lt;/li>
&lt;li>&lt;a href="https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/Sequence.java">Sequence&lt;/a>
&lt;code>Disruptor&lt;/code> æ¯ä¸ªæ¶ˆè´¹è€…(&lt;code>EventProcessor&lt;/code>)ç»´æŠ¤ä¸€ä¸ª &lt;code>Sequence&lt;/code>ï¼Œå¹¶å‘çš„å¤§å¤šæ•°ä»£ç éƒ½ä¾èµ– &lt;code>Sequence&lt;/code> å€¼çš„æ”¹åŠ¨ï¼Œæ‰€ä»¥ &lt;code>Sequence&lt;/code> æ”¯æŒ &lt;code>AtomicLong&lt;/code> çš„å¤§éƒ¨åˆ†ä¹Ÿè¡Œ, å”¯ä¸€ä¸åŒçš„æ˜¯ &lt;code>Sequence&lt;/code> åŒ…å«é¢å¤–çš„åŠŸèƒ½æ¥é˜»æ­¢&lt;code>Sequence&lt;/code>å’Œå…¶ä»–å€¼ä¹‹é—´çš„ä¼ªå…±äº«(&lt;code>false sharing&lt;/code>)&lt;/li>
&lt;li>&lt;a href="https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/Sequencer.java">Sequencer&lt;/a>&lt;br>
&lt;code>Disruptor&lt;/code> æ ¸å¿ƒé€»è¾‘, ä¸¤ä¸ªå®ç°: å•ç”Ÿäº§è€…å’Œå¤šç”Ÿäº§è€…ã€‚ä»–ä»¬å®ç°äº†ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ä¹‹é—´çš„å¿«é€Ÿä¼ é€’çš„å¹¶å‘ç®—æ³•ã€‚&lt;/li>
&lt;li>&lt;a href="https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/SequenceBarrier.java">Sequence Barrier&lt;/a>
ç”± &lt;code>Sequencer&lt;/code> ç”Ÿæˆï¼ŒåŒ…å«æ­¤ &lt;code>Sequencer&lt;/code> å‘å¸ƒçš„ &lt;code>Sequence&lt;/code> æŒ‡é’ˆä»¥åŠä¾èµ–çš„å…¶ä»–æ¶ˆè´¹è€…çš„ &lt;code>Sequence&lt;/code>ã€‚åŒ…å«äº†æ¶ˆè´¹è€…æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„äº‹ä»¶çš„ä»£ç ã€‚&lt;/li>
&lt;li>&lt;a href="https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/WaitStrategy.java">Wait Strategy&lt;/a>
æ¶ˆè´¹è€…ç­‰å¾…äº‹ä»¶çš„ç­–ç•¥ï¼Œè¿™ä¸ªäº‹ä»¶ç”±ç”Ÿäº§è€…æ”¾å…¥ï¼Œå†³å®šäº†æ¶ˆè´¹è€…æ€ä¹ˆç­‰å¾…ç”Ÿäº§è€…å°†äº‹ä»¶æ”¾å…¥ &lt;code>Disruptor&lt;/code>&lt;/li>
&lt;li>Event ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ä¼ é€’çš„äº‹ä»¶ï¼Œå®Œå…¨ç”±ç”¨æˆ·å®šä¹‰&lt;/li>
&lt;li>&lt;a href="https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/EventProcessor.java">EventProcessor&lt;/a>
å¤„ç†äº‹ä»¶çš„ä¸»è¦å¾ªç¯ï¼ˆ&lt;code>main event loop&lt;/code>ï¼‰ï¼ŒåŒ…å«äº†ä¸€ä¸ª &lt;code>Sequeuece&lt;/code>. æœ‰ä¸€ä¸ªå…·ä½“çš„å®ç°ç±» &lt;code>BatchEventProcessor&lt;/code>&lt;/li>
&lt;li>&lt;a href="https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/EventHandler.java">EventHandler&lt;/a>
ç”¨æˆ·å®ç°çš„æ¥å£ï¼Œä»£è¡¨ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚å¤„ç†äº‹ä»¶ã€‚&lt;/li>
&lt;li>Producer ç”Ÿäº§è€…ã€å…ˆè·å¾—å ä½ï¼Œç„¶åæäº¤äº‹ä»¶ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://pinkhello.me/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97-Disruptor/Disruptor%E8%AE%BE%E8%AE%A1%E7%BB%84%E4%BB%B6%E5%9B%BE.jpg" alt="Disruptorè®¾è®¡ç»„ä»¶å›¾">&lt;/p>
&lt;ul>
&lt;li>
&lt;p>äº‹ä»¶å¹¿æ’­(&lt;code>Multicast Events&lt;/code>)&lt;/p>
&lt;p>äº‹ä»¶å¹¿æ’­æ˜¯ &lt;code>Disruptor&lt;/code> ä¸ &lt;code>Queue&lt;/code> æœ€å¤§çš„åŒºåˆ«ï¼Œå½“ä½ æœ‰å¤šä¸ªæ¶ˆè´¹è€…ç›‘å¬ä¸€ä¸ª &lt;code>Disruptor&lt;/code>, æ‰€æœ‰çš„äº‹ä»¶å°†ä¼šå‘å¸ƒåˆ°è¿™ä¸ªæ‰€æœ‰çš„æ¶ˆè´¹è€…ã€‚
&lt;code>Disruptor&lt;/code> è¿™ä¸€ç‰¹æ€§è¢«ç”¨æ¥éœ€è¦å¯¹åŒä¸€æ•°æ®è¿›è¡Œå¤šä¸ªå¹¶è¡Œæ“ä½œçš„æƒ…å†µã€‚
å¦‚åœ¨LMAXç³»ç»Ÿä¸­æœ‰ä¸‰ä¸ªæ“ä½œå¯ä»¥åŒæ—¶è¿›è¡Œï¼šæ—¥å¿—ï¼ˆå°†æ•°æ®æŒä¹…åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼‰ï¼Œå¤åˆ¶ï¼ˆå°†æ•°æ®å‘é€åˆ°å…¶ä»–çš„æœºå™¨ä¸Šï¼Œä»¥ç¡®ä¿å­˜åœ¨æ•°æ®è¿œç¨‹å‰¯æœ¬ï¼‰ï¼Œä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚
ä¹Ÿå¯ä»¥ä½¿ç”¨&lt;code>WokrerPool&lt;/code>æ¥å¹¶è¡Œå¤„ç†ä¸åŒçš„äº‹ä»¶ã€‚&lt;/p>
&lt;p>å¦‚ä¸Šå›¾ã€‚å¯ä»¥çœ‹åˆ°æœ‰3ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºæ­£åœ¨ä¾¦å¬&lt;code>Disrupto&lt;/code>rï¼ˆ&lt;code>JournalConsumer&lt;/code>ï¼Œ&lt;code>ReplicationConsumer&lt;/code> å’Œ &lt;code>ApplicationConsumer&lt;/code>ï¼‰ï¼Œ
è¿™äº›äº‹ä»¶å¤„ç†ç¨‹åºä¸­çš„æ¯ä¸ªå°†æ¥æ”¶&lt;code>Disruptor&lt;/code>ä¸­æ‰€æœ‰å¯ç”¨çš„æ¶ˆæ¯ï¼ˆæŒ‰ç›¸åŒé¡ºåºï¼‰ã€‚è¿™å…è®¸è¿™äº›æ¶ˆè´¹è€…ä¸­çš„æ¯ä¸€ä¸ªå¹¶è¡Œå·¥ä½œã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¶ˆè´¹è€…ä¾èµ–å…³ç³»å›¾(&lt;code>Consumer Dependency Graph&lt;/code>)&lt;/p>
&lt;p>ä¸ºäº†æ”¯æŒå®ç°ä¸šåŠ¡å¹¶è¡Œå¤„ç†æµç¨‹ï¼Œ&lt;code>Disruptor&lt;/code> æä¾›äº†å¤šä¸ªæ¶ˆè´¹è€…ä¹‹é—´çš„åä½œåŠŸèƒ½ã€‚å›åˆ°ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°† &lt;code>journalling&lt;/code> å’Œ &lt;code>replication&lt;/code> æ¶ˆè´¹å®Œæˆä»–ä»¬çš„ä¸šåŠ¡ï¼Œåå†ç»§ç»­æ‰§è¡Œä¸šåŠ¡é€»è¾‘æµç¨‹ã€‚
æˆ‘ä»¬ç§°å‘¼è¿™ä¸ªåŠŸèƒ½ä¸º &lt;code>gating&lt;/code> , &lt;code>gating&lt;/code> å‘ç”Ÿåœ¨ä¸¤ç§åœºæ™¯ä¸‹:&lt;/p>
&lt;ul>
&lt;li>ç¡®ä¿ &lt;code>Producer&lt;/code> ä¸èƒ½è¿è¡Œè¶…è¿‡ &lt;code>Consumer&lt;/code> ï¼Œå¯ä»¥é€šå¤šè°ƒç”¨ &lt;code>RingBuffer.addGatingConsumers()&lt;/code> æ¥å¢åŠ ç›¸å…³çš„æ¶ˆè´¹è€…æ¥å®Œæˆ&lt;/li>
&lt;li>ä¹‹å‰æ‰€è¯´çš„åœºæ™¯ï¼Œé€šè¿‡å¿…é¡»å…ˆå®Œæˆçš„&lt;code>Consumer&lt;/code> çš„ &lt;code>Sequence&lt;/code>çš„&lt;code>SequenceBarrier&lt;/code>æ¥å®ç°ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>äº‹ä»¶é¢„åˆ†é…(&lt;code>Event Preallocation&lt;/code>)&lt;/p>
&lt;p>&lt;code>Disruptor&lt;/code> çš„ä¸€ä¸ªç›®æ ‡å°±æ˜¯åœ¨ä½å»¶æ—¶ç¯å¢ƒä¸‹ï¼Œå‡å°‘æˆ–å¼‚å¸¸å†…å­˜çš„å ç”¨ã€‚ï¼ˆåœ¨JAVAç¯å¢ƒä¸‹ï¼Œéœ€è¦è¾ƒå°‘GCåœé¡¿çš„æ¬¡æ•°ï¼‰ï¼ˆC/C++ç¯å¢ƒä¸‹ï¼Œå¤§é‡çš„å†…å­˜åˆ†é…ä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¯é€‰æ‹©çš„æ— é”(&lt;code>Optionally Lock-free&lt;/code>)&lt;/p>
&lt;p>æ— é”çš„ &lt;code>Disruptor&lt;/code> çš„ä½å»¶è¿Ÿçš„æ— é”çš„ç‰¹æ€§å®ç°ç»†èŠ‚æ˜¯éƒ½æ˜¯åŸºäº å†…å­˜å±éšœ å’Œ CAS æ“ä½œå®ç°çš„ï¼Œåªæœ‰ä¸€ä¸ªåœºæ™¯ &lt;code>BlockingWaitStrategy&lt;/code> ä¸­ä½¿ç”¨çš„ &lt;code>Lock&lt;/code>
æ˜¯ä¸ºäº†ä½¿ç”¨ &lt;code>Lock&lt;/code> é‡Œé¢çš„ &lt;code>Condition&lt;/code>, æ–¹ä¾¿æ¶ˆè´¹è€…çº¿ç¨‹è¢« &lt;code>Park&lt;/code> æ—¶å€™ç­‰å¾…æ–°çš„äº‹ä»¶æ¥è§¦å‘ã€‚è®¸å¤šä½å»¶è¿Ÿç³»ç»Ÿä½¿ç”¨è‡ªæ—‹ï¼ˆ&lt;code>busy-wait&lt;/code>ï¼‰æ¥é¿å…ä½¿ç”¨ &lt;code>Condition&lt;/code>é€ æˆçš„æŠ–åŠ¨
ç„¶è€Œï¼Œå¤ªå¤šçš„ &lt;code>busy-wait&lt;/code> ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œç‰¹åˆ«åœ¨CPUèµ„æºå—é™çš„æƒ…å†µä¸‹ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h1 id="disruptor-å‡ ä¸ªæ ¸å¿ƒçš„è®¾è®¡">&lt;code>Disruptor&lt;/code> å‡ ä¸ªæ ¸å¿ƒçš„è®¾è®¡&lt;/h1>
&lt;h2 id="sequence-è®¾è®¡">&lt;code>Sequence&lt;/code> è®¾è®¡&lt;/h2>
&lt;p>&lt;img src="https://pinkhello.me/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97-Disruptor/Sequence.jpg" alt="Sequence è®¾è®¡">&lt;/p>
&lt;p>Sequence çœŸæ­£è®¡æ•°æ˜¯ &lt;code>value&lt;/code> é‡‡ç”¨ç¼“å†²è¡Œé˜²æ­¢ &lt;code>false sharing&lt;/code>ã€‚åœ¨&lt;code>value&lt;/code>çš„å‰åæœ‰7ä¸ª &lt;code>long&lt;/code> å‹çš„å¡«å……å€¼ï¼Œåš&lt;code>CPU cache line&lt;/code>å¡«å……é˜²æ­¢ä¼ªå…±äº«ã€‚&lt;/p>
&lt;h2 id="ringbuffer-è®¾è®¡">&lt;code>RingBuffer&lt;/code> è®¾è®¡&lt;/h2>
&lt;p>&lt;img src="https://pinkhello.me/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97-Disruptor/RingBuffer.jpg" alt="RingBuffer è®¾è®¡">&lt;/p>
&lt;p>&lt;code>RingBuffer&lt;/code> æ˜¯ä¸€ä¸ªç¯ï¼ˆé¦–å°¾ç›¸æ¥ï¼‰ï¼Œå¯ä»¥ç”¨ä½œä¸åŒçš„ä¸Šä¸‹æ–‡ï¼ˆçº¿ç¨‹ï¼‰é—´ä¼ é€’æ•°æ®çš„ &lt;code>Buffer&lt;/code>ç¯å½¢è®¾è®¡ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸ªåæ ‡ï¼Œå–å¾—å…ƒç´ é€šè¿‡å–modæ“ä½œã€‚
æ˜¯æ•°ç»„è®¾è®¡ã€éé“¾è¡¨ã€‚&lt;/p>
&lt;p>ä¸€èˆ¬æ˜¯&lt;code>2^N&lt;/code>æ¬¡æ–¹ï¼Œè¿™æ · sequence &amp;amp; (array length - 1 ) = array indexã€‚å“ˆå¸ŒMapä¹Ÿæ˜¯è¿™ç§ä½è¿ç®—åšçš„ã€‚&lt;/p>
&lt;p>&lt;code>RingBuffer&lt;/code> ç‰¹ç‚¹&lt;/p>
&lt;ul>
&lt;li>æ•°ç»„å®ç°ã€å¿«é€Ÿè®¿é—®&lt;/li>
&lt;li>å…ƒç´ æ˜¯è¦†ç›–å¼çš„ï¼Œä¸ä¸»åŠ¨æ¸…é™¤&lt;/li>
&lt;li>ç¥å¥‡çš„ç¼“å­˜è¡Œï¼ˆç¼“å­˜æ˜¯ç”±ç¼“å­˜è¡Œç»„æˆçš„ï¼Œé€šå¸¸64ä¸ªå­—èŠ‚ã€ä¸€ä¸ªJAVA long ç±»å‹ 8 å­—èŠ‚ï¼‰&lt;/li>
&lt;/ul>
&lt;h2 id="æ¶ˆè´¹è€…ä¾èµ–è®¾è®¡">æ¶ˆè´¹è€…ä¾èµ–è®¾è®¡&lt;/h2>
&lt;h2 id="ç¼“å­˜å†…å­˜åŠ è½½è¿‡ç¨‹">ç¼“å­˜å†…å­˜åŠ è½½è¿‡ç¨‹&lt;/h2>
&lt;p>&lt;img src="https://pinkhello.me/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97-Disruptor/cache-line-1.jpg" alt="ç¼“å­˜åŠ è½½è¿‡ç¨‹">
&lt;img src="https://pinkhello.me/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97-Disruptor/cache-line-2.jpg" alt="ç¼“å­˜åŠ è½½è¿‡ç¨‹">
&lt;img src="https://pinkhello.me/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97-Disruptor/cache-line-3.jpg" alt="ç¼“å­˜åŠ è½½è¿‡ç¨‹">&lt;/p>
&lt;p>&lt;a href="https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/RingBuffer.java">ç¥å¥‡çš„è§£å†³æ–¹å¼&amp;mdash;&amp;ndash; ç¼“å­˜è¡Œå¡«å……&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">long&lt;/span> p1, p2, p3, p4, p5, p6, p7; &lt;span style="color:#228b22">// cache line padding
&lt;/span>&lt;span style="color:#228b22">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">volatile&lt;/span> &lt;span style="color:#00688b;font-weight:bold">long&lt;/span> cursor = INITIAL_CURSOR_VALUE;
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">long&lt;/span> p8, p9, p10, p11, p12, p13, p14; &lt;span style="color:#228b22">// cache line padding
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="disruptor-ä½¿ç”¨demo">&lt;code>Disruptor&lt;/code> ä½¿ç”¨Demo&lt;/h1>
&lt;p>&lt;code>TransactionOrder&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">TransactionOrder&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> String id;
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> &lt;span style="color:#00688b;font-weight:bold">double&lt;/span> price;
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>TransactionHandler&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">TransactionHandler&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">implements&lt;/span> EventHandler&amp;lt;TransactionOrder&amp;gt;, WorkHandler&amp;lt;TransactionOrder&amp;gt; {
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">onEvent&lt;/span>(TransactionOrder transactionOrder, &lt;span style="color:#00688b;font-weight:bold">long&lt;/span> sequence, &lt;span style="color:#00688b;font-weight:bold">boolean&lt;/span> endOfBatch) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> Exception {
&lt;span style="color:#8b008b;font-weight:bold">this&lt;/span>.&lt;span style="color:#658b00">onEvent&lt;/span>(transactionOrder);
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">onEvent&lt;/span>(TransactionOrder transactionOrder) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> Exception {
&lt;span style="color:#228b22">//å…·ä½“çš„æ¶ˆè´¹é€»è¾‘
&lt;/span>&lt;span style="color:#228b22">&lt;/span> transactionOrder.&lt;span style="color:#658b00">setId&lt;/span>(UUID.&lt;span style="color:#658b00">randomUUID&lt;/span>().&lt;span style="color:#658b00">toString&lt;/span>());
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Demo1&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">Demo1&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">main&lt;/span>(String[] args) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> ExecutionException, InterruptedException {
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> BUFFER_SIZE = 1024;
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> THREAD_NUM = 4;
&lt;span style="color:#228b22">//createSingleProducer åˆ›å»ºå•ç”Ÿäº§è€…çš„ RingBuffer
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> RingBuffer&amp;lt;TransactionOrder&amp;gt; ringBuffer =
RingBuffer.&lt;span style="color:#658b00">createSingleProducer&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> EventFactory&amp;lt;TransactionOrder&amp;gt;() {
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> TransactionOrder &lt;span style="color:#008b45">newInstance&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> TransactionOrder();
}
}, BUFFER_SIZE, &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> YieldingWaitStrategy());
&lt;span style="color:#228b22">//åˆ›å»ºçº¿ç¨‹æ± 
&lt;/span>&lt;span style="color:#228b22">&lt;/span> ExecutorService service = Executors.&lt;span style="color:#658b00">newFixedThreadPool&lt;/span>(THREAD_NUM);
&lt;span style="color:#228b22">//åˆ›å»º SequenceBarrier
&lt;/span>&lt;span style="color:#228b22">&lt;/span> SequenceBarrier sequenceBarrier = ringBuffer.&lt;span style="color:#658b00">newBarrier&lt;/span>();
&lt;span style="color:#228b22">//åˆ›å»ºæ¶ˆæ¯å¤„ç†å™¨
&lt;/span>&lt;span style="color:#228b22">&lt;/span> BatchEventProcessor&amp;lt;TransactionOrder&amp;gt; eventProcessor =
&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> BatchEventProcessor&amp;lt;TransactionOrder&amp;gt;(ringBuffer, sequenceBarrier, &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> TransactionHandler());
&lt;span style="color:#228b22">//è¿™ä¸€éƒ¨åˆ†æ˜¯è®© RingBufferæ ¹æ®æ¶ˆè´¹è€…çŠ¶æ€è¿›è¡Œgating, åªæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…çš„è¯å¯ä»¥çœç•¥
&lt;/span>&lt;span style="color:#228b22">&lt;/span> ringBuffer.&lt;span style="color:#658b00">addGatingSequences&lt;/span>(eventProcessor.&lt;span style="color:#658b00">getSequence&lt;/span>());
&lt;span style="color:#228b22">//æŠŠæ¶ˆæ¯å¤„ç†å™¨æäº¤åˆ°çº¿ç¨‹æ± 
&lt;/span>&lt;span style="color:#228b22">&lt;/span> service.&lt;span style="color:#658b00">submit&lt;/span>(eventProcessor);
Future&amp;lt;?&amp;gt; future = service.&lt;span style="color:#658b00">submit&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Callable&amp;lt;Void&amp;gt;() {
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> Void &lt;span style="color:#008b45">call&lt;/span>() &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> Exception {
&lt;span style="color:#00688b;font-weight:bold">long&lt;/span> seq;
&lt;span style="color:#8b008b;font-weight:bold">for&lt;/span> (&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> i = 0; i&amp;lt;10000; i++) {
seq = ringBuffer.&lt;span style="color:#658b00">next&lt;/span>(); &lt;span style="color:#228b22">//ringbuffer çš„ä¸€ä¸ªå¯ç”¨åŒºå—
&lt;/span>&lt;span style="color:#228b22">&lt;/span> ringBuffer.&lt;span style="color:#658b00">get&lt;/span>(seq).&lt;span style="color:#658b00">setPrice&lt;/span>(Math.&lt;span style="color:#658b00">random&lt;/span>() *9999); &lt;span style="color:#228b22">// ç»™è¿™ä¸ªåŒºå—æ”¾å…¥æ•°æ®
&lt;/span>&lt;span style="color:#228b22">&lt;/span> ringBuffer.&lt;span style="color:#658b00">publish&lt;/span>(seq); &lt;span style="color:#228b22">//å‘å¸ƒæ•°æ®ä½¿å¾— consumer å¯ä»¥è·å–è¯¥æ•°æ®
&lt;/span>&lt;span style="color:#228b22">&lt;/span> }
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span>;
}
});
future.&lt;span style="color:#658b00">get&lt;/span>(); &lt;span style="color:#228b22">//ç­‰å¾…ç”Ÿäº§è€…ç»“æŸ
&lt;/span>&lt;span style="color:#228b22">&lt;/span>
eventProcessor.&lt;span style="color:#658b00">halt&lt;/span>(); &lt;span style="color:#228b22">//é€šçŸ¥äº‹ä»¶
&lt;/span>&lt;span style="color:#228b22">&lt;/span>
service.&lt;span style="color:#658b00">shutdown&lt;/span>(); &lt;span style="color:#228b22">//ç»ˆæ­¢çº¿ç¨‹
&lt;/span>&lt;span style="color:#228b22">&lt;/span>
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Demo2&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">Demo2&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">main&lt;/span>(String[] args) {
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> BUFFER_SIZE = 1024;
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> THREAD_NUM = 4;
EventFactory&amp;lt;TransactionOrder&amp;gt; eventFactory = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> EventFactory&amp;lt;TransactionOrder&amp;gt;() {
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> TransactionOrder &lt;span style="color:#008b45">newInstance&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> TransactionOrder();
}
};
RingBuffer&amp;lt;TransactionOrder&amp;gt; ringBuffer = RingBuffer.&lt;span style="color:#658b00">createSingleProducer&lt;/span>(eventFactory, BUFFER_SIZE);
SequenceBarrier sequenceBarrier = ringBuffer.&lt;span style="color:#658b00">newBarrier&lt;/span>();
ExecutorService service = Executors.&lt;span style="color:#658b00">newFixedThreadPool&lt;/span>(THREAD_NUM);
WorkHandler&amp;lt;TransactionOrder&amp;gt; workHandler = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> TransactionHandler();
WorkerPool&amp;lt;TransactionOrder&amp;gt; workerPool =
&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> WorkerPool&amp;lt;TransactionOrder&amp;gt;(ringBuffer, sequenceBarrier, &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> IgnoreExceptionHandler(),
workHandler);
&lt;span style="color:#228b22">//åºåˆ—åè°ƒè€…
&lt;/span>&lt;span style="color:#228b22">&lt;/span> ringBuffer.&lt;span style="color:#658b00">addGatingSequences&lt;/span>(workerPool.&lt;span style="color:#658b00">getWorkerSequences&lt;/span>());
workerPool.&lt;span style="color:#658b00">start&lt;/span>(service);
&lt;span style="color:#8b008b;font-weight:bold">for&lt;/span> (&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> i=0; i&amp;lt;8; i++) {
&lt;span style="color:#00688b;font-weight:bold">long&lt;/span> seq = ringBuffer.&lt;span style="color:#658b00">next&lt;/span>();
ringBuffer.&lt;span style="color:#658b00">get&lt;/span>(seq).&lt;span style="color:#658b00">setPrice&lt;/span>(Math.&lt;span style="color:#658b00">random&lt;/span>() * 9999);
ringBuffer.&lt;span style="color:#658b00">publish&lt;/span>(seq);
}
workerPool.&lt;span style="color:#658b00">halt&lt;/span>();
service.&lt;span style="color:#658b00">shutdown&lt;/span>();
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Demo3&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">Demo3&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">main&lt;/span>(String[] args) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> InterruptedException {
&lt;span style="color:#00688b;font-weight:bold">long&lt;/span> start = System.&lt;span style="color:#658b00">currentTimeMillis&lt;/span>();
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> BUFFER_SIZE = 1024;
&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> THREAD_NUM = 4;
ExecutorService service = Executors.&lt;span style="color:#658b00">newFixedThreadPool&lt;/span>(THREAD_NUM);
Disruptor&amp;lt;TransactionOrder&amp;gt; disruptor = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Disruptor&amp;lt;TransactionOrder&amp;gt;(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> EventFactory&amp;lt;TransactionOrder&amp;gt;() {
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> TransactionOrder &lt;span style="color:#008b45">newInstance&lt;/span>() {
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> TransactionOrder();
}
}, BUFFER_SIZE, service, ProducerType.&lt;span style="color:#658b00">SINGLE&lt;/span>, &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> BusySpinWaitStrategy());
&lt;span style="color:#228b22">/**
&lt;/span>&lt;span style="color:#228b22"> * è±å½¢æ“ä½œ
&lt;/span>&lt;span style="color:#228b22"> */&lt;/span>
&lt;span style="color:#228b22">//ä½¿ç”¨ disruptor åˆ›å»ºæ¶ˆè´¹ç»„ C1 ä¸ C2
&lt;/span>&lt;span style="color:#228b22">&lt;/span> EventHandlerGroup&amp;lt;TransactionOrder&amp;gt; eventHandlerGroup =
disruptor.&lt;span style="color:#658b00">handleEventsWith&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> TransactionHandler(), &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> TransactionVasConsumer());
&lt;span style="color:#228b22">//C3
&lt;/span>&lt;span style="color:#228b22">&lt;/span> TransactionJmsNotifyHandler jmsNotifyHandler = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> TransactionJmsNotifyHandler();
&lt;span style="color:#228b22">//å£°æ˜åœ¨ C1 å’Œ C2 å®Œäº‹å æ‰§è¡Œ JMSæ¶ˆæ¯å‘é€æ“ä½œï¼ˆC3ï¼‰
&lt;/span>&lt;span style="color:#228b22">&lt;/span> eventHandlerGroup.&lt;span style="color:#658b00">then&lt;/span>(jmsNotifyHandler);
&lt;span style="color:#228b22">/**
&lt;/span>&lt;span style="color:#228b22"> * é¡ºåºæ‰§è¡Œ
&lt;/span>&lt;span style="color:#228b22"> */&lt;/span>
&lt;span style="color:#228b22">// disruptor.handleEventsWith(new TransactionHandler())
&lt;/span>&lt;span style="color:#228b22">// .then(new TransactionVasConsumer())
&lt;/span>&lt;span style="color:#228b22">// .then(new TransactionJmsNotifyHandler());
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#228b22">/**
&lt;/span>&lt;span style="color:#228b22"> * å…­è¾¹å½¢æ“ä½œ
&lt;/span>&lt;span style="color:#228b22"> */&lt;/span>
&lt;span style="color:#228b22">// TransactionHandler h1 = new TransactionHandler();
&lt;/span>&lt;span style="color:#228b22">// TransactionHandler h2 = new TransactionHandler();
&lt;/span>&lt;span style="color:#228b22">// TransactionHandler h3 = new TransactionHandler();
&lt;/span>&lt;span style="color:#228b22">// TransactionHandler h4 = new TransactionHandler();
&lt;/span>&lt;span style="color:#228b22">// TransactionHandler h5 = new TransactionHandler();
&lt;/span>&lt;span style="color:#228b22">// TransactionHandler h6 = new TransactionHandler();
&lt;/span>&lt;span style="color:#228b22">// disruptor.handleEventsWith(h1, h2);
&lt;/span>&lt;span style="color:#228b22">// disruptor.after(h1).handleEventsWith(h4);
&lt;/span>&lt;span style="color:#228b22">// disruptor.after(h2).handleEventsWith(h5);
&lt;/span>&lt;span style="color:#228b22">// disruptor.after(h4, h5).handleEventsWith(h3);
&lt;/span>&lt;span style="color:#228b22">&lt;/span>
&lt;span style="color:#228b22">//å¯åŠ¨
&lt;/span>&lt;span style="color:#228b22">&lt;/span> disruptor.&lt;span style="color:#658b00">start&lt;/span>();
CountDownLatch latch = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> CountDownLatch(1);
&lt;span style="color:#228b22">//ç”Ÿäº§è€…å‡†å¤‡
&lt;/span>&lt;span style="color:#228b22">&lt;/span> service.&lt;span style="color:#658b00">submit&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> TransactionPubllisher(disruptor, latch));
latch.&lt;span style="color:#658b00">await&lt;/span>(); &lt;span style="color:#228b22">//ç­‰å¾…ç”Ÿäº§è€…å®Œäº‹
&lt;/span>&lt;span style="color:#228b22">&lt;/span>
disruptor.&lt;span style="color:#658b00">shutdown&lt;/span>();
service.&lt;span style="color:#658b00">shutdown&lt;/span>();
System.&lt;span style="color:#658b00">out&lt;/span>.&lt;span style="color:#658b00">println&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;æ€»è€—æ—¶:&amp;#34;&lt;/span>+ (System.&lt;span style="color:#658b00">currentTimeMillis&lt;/span>() - start));
}
}
&lt;/code>&lt;/pre>&lt;/div>- https://pinkhello.me/posts/06-%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97disruptor/ - PinkHello, All Rights Reserved</description></item><item><title>16 Hexoè¿ç§»Hugo</title><link>https://pinkhello.me/posts/16-hexo%E8%BF%81%E7%A7%BBhugo/</link><pubDate>Wed, 10 Feb 2021 19:36:33 +0800</pubDate><guid>https://pinkhello.me/posts/16-hexo%E8%BF%81%E7%A7%BBhugo/</guid><description>PinkHello https://pinkhello.me/posts/16-hexo%E8%BF%81%E7%A7%BBhugo/ -&lt;h1 id="ä¸ºä»€ä¹ˆè¿ç§»-hugo">ä¸ºä»€ä¹ˆè¿ç§» &lt;code>Hugo&lt;/code>&lt;/h1>
&lt;ul>
&lt;li>&lt;code>Hugo&lt;/code> ä½¿ç”¨æ¯” &lt;code>Hexo&lt;/code> ç®€å•, åªæœ‰å•ç‹¬çš„ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶&lt;/li>
&lt;li>è‹¦äº &lt;code>Hexo&lt;/code> çš„ &lt;code>NodeModule&lt;/code> ç®¡ç†&lt;/li>
&lt;li>è¿ç§»æˆæœ¬æ›´ä½, ç»“åˆ &lt;code>Github Action&lt;/code> å®ç° &lt;code>Markdown&lt;/code> æ–‡ç« å‘å¸ƒ, è‡ªåŠ¨æ›´æ–°è‡³é™æ€ç«™&lt;/li>
&lt;li>è§„åˆ’ï¼šåŠ å…¥è‡ªå®šä¹‰åŸŸåä»¥åŠåšé™æ€èµ„æºCDNåšçš„åŠ é€Ÿ&lt;/li>
&lt;/ul>
&lt;h1 id="å‰ç½®å·¥ä½œ">å‰ç½®å·¥ä½œ&lt;/h1>
&lt;p>1ã€ ä¹‹å‰åŸºæœ¬æ‰€æœ‰çš„åšå®¢éƒ½æ‰˜ç®¡ä¸ &lt;code>github&lt;/code>,è¿™æ¬¡ä¹Ÿä¸ä¾‹å¤–, å¤ç”¨ &lt;code>https://pinkhello.github.io&lt;/code>,åˆ›å»ºä¸¤ä¸ªé¡¹ç›®&lt;/p>
&lt;ul>
&lt;li>pinkhello.github.io template ä»“åº“&lt;/li>
&lt;li>pinkhello.github.io.source private ä»“åº“&lt;/li>
&lt;/ul>
&lt;p>2ã€å‡†å¤‡OpenSSHç§é’¥å’Œå…¬é’¥&lt;/p>
&lt;ul>
&lt;li>pinkhello.github.io ä»“åº“ æ·»åŠ  settings -&amp;gt; Deploy keys -&amp;gt; Add Deploy Key (å°†å…¬é’¥æ·»åŠ è¿›å»ã€æ³¨æ„å…è®¸ Write)&lt;/li>
&lt;li>pinkhello.github.io.source ä»“åº“ æ·»åŠ  settings -&amp;gt; Actions secrets -&amp;gt; New Repository Secret ( NAME : ACTION_DEPLOY_KEY, Value: ç§é’¥ )&lt;/li>
&lt;/ul>
&lt;p>3ã€git clone pinkhello.github.io.source ä»“åº“&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">git clone git@github.com:PinkHello/pinkhello.github.io.source.git
&lt;span style="color:#658b00">cd&lt;/span> pinkhello.github.io.source
&lt;span style="color:#228b22"># åˆå§‹åŒ–ç«™ç‚¹ã€--force å¼ºåˆ¶åˆå§‹åŒ–ã€‘&lt;/span>
hugo new site . --force
&lt;span style="color:#228b22"># content site &lt;/span>
&lt;span style="color:#228b22"># data jsonæ•°æ® or å…¶ä»–&lt;/span>
&lt;span style="color:#228b22"># static é™æ€æ–‡ä»¶&lt;/span>
&lt;span style="color:#228b22"># themes ä¸»é¢˜&lt;/span>
&lt;span style="color:#228b22"># åé¢å¯ä»¥æ‰§è¡Œ hugo new posts/XXX.md åˆ›å»ºæ–°çš„æ–‡ç« &lt;/span>
hugo new posts/XXX.md
&lt;span style="color:#228b22"># å…·ä½“å‚è€ƒ https://gohugo.io/getting-started/ è¿›è¡Œæ“ä½œ&lt;/span>
......
&lt;span style="color:#228b22"># é€‰æ‹©ä¸€ä¸ªä¸»é¢˜ https://themes.gohugo.io/ å¯ä»¥é€‰æ‹©&lt;/span>
git submodule add https://github.com/budparr/gohugo-theme-ananke.git themes/ananke
&lt;span style="color:#228b22"># åé¢çš„å‚ç…§å„ä¸ªä¸»é¢˜è®¾ç½®å’¯&lt;/span>
....
&lt;span style="color:#228b22"># æœ¬åœ°æµ‹è¯•&lt;/span>
hugo serve
&lt;span style="color:#228b22"># ç”Ÿæˆæœ€å°çš„é™æ€æ–‡ä»¶, ä¼šç”Ÿæˆ public æ–‡ä»¶&lt;/span>
hugo --minify
&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="è¿ç§»-hexo-åšå®¢è¿›å…¥-hugo">è¿ç§» &lt;code>hexo&lt;/code> åšå®¢è¿›å…¥ &lt;code>hugo&lt;/code>&lt;/h1>
&lt;p>&amp;hellip;&amp;hellip;(å¯ä»¥æ‰‹åŠ¨ã€å¯ä»¥å·¥å…·è¿›è¡Œ)&lt;/p>
&lt;h1 id="æ•´åˆ-github-action">æ•´åˆ &lt;code>Github Action&lt;/code>&lt;/h1>
&lt;p>æ–°å»º &lt;code>Github Action&lt;/code> æè¿°æ–‡ä»¶ &lt;code>.github/workflows/deploy.yml&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="color:#228b22"># This is a basic workflow to help you get started with Actions&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Deploy on Main Branch&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#228b22"># Controls when the action will run. &lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">on&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># Triggers the workflow on push or pull request events but only for the main branch&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">push&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">branches&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>[&lt;span style="color:#bbb"> &lt;/span>main ]&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">pull_request&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">branches&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>[&lt;span style="color:#bbb"> &lt;/span>main ]&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#228b22"># schedule:&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#228b22"># - cron: &amp;#39;0 21 * * *&amp;#39; # å®šæ—¶ä»»åŠ¡&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># Allows you to run this workflow manually from the Actions tab&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">workflow_dispatch&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#228b22"># A workflow run is made up of one or more jobs that can run sequentially or in parallel&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">jobs&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># This workflow contains a single job called &amp;#34;build&amp;#34;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">build&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># The type of runner that the job will run on&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">runs-on&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>ubuntu-latest&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># Steps represent a sequence of tasks that will be executed as part of the job&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">steps&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#8b008b;font-weight:bold">uses&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>actions/checkout@v2&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#8b008b;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Setup Hugo&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">uses&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>peaceiris/actions-hugo@v2&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># https://github.com/peaceiris/actions-hugo&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">with&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">hugo-version&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#cd5555">&amp;#39;latest&amp;#39;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">extended&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#8b008b;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Build&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># æ³¨æ„å¼ºåˆ¶æ›´æ–° git submodule ä¸‹è½½ï¼Œå¦åˆ™ç”Ÿæˆçš„ä¸»é¢˜æ²¡æœ‰ html æ–‡ä»¶å“¦&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">run&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>|&lt;span style="color:#cd5555">
&lt;/span>&lt;span style="color:#cd5555"> git submodule update --init --recursive
&lt;/span>&lt;span style="color:#cd5555"> hugo --minify --debug&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>- &lt;span style="color:#8b008b;font-weight:bold">name&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>Deploy&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">uses&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>peaceiris/actions-gh-pages@v3&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># https://github.com/peaceiris/actions-gh-pages&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">with&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">deploy_key&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>${{ secrets.ACTION_DEPLOY_KEY }}&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># è¿™é‡Œçš„ ACTION_DEPLOY_KEY åˆ™æ˜¯ä¸Šé¢è®¾ç½® Private Keyçš„å˜é‡å&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">external_repository&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>PinkHello/PinkHello.github.io&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># Pages è¿œç¨‹ä»“åº“ &lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">publish_dir&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>./public&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">keep_files&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">false&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># remove existing files&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">publish_branch&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>master &lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#228b22"># deploying branch&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">commit_message&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>${{ github.event.head_commit.message }}&lt;span style="color:#bbb">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>so å®Œç¾
&lt;img src="https://pinkhello.me/hexo%E8%BF%81%E7%A7%BB%E8%87%B3hugo/github_action_in_process_0.jpg" alt="è¿ç§»Hexo">
&lt;img src="https://pinkhello.me/hexo%E8%BF%81%E7%A7%BB%E8%87%B3hugo/github_action_in_process.jpg" alt="è¿ç§»Hexo">&lt;/p>
- https://pinkhello.me/posts/16-hexo%E8%BF%81%E7%A7%BBhugo/ - PinkHello, All Rights Reserved</description></item><item><title>15 è®°ä¸€æ¬¡dockeræ—¥å¿—ç£ç›˜å‘Šè­¦é—®é¢˜</title><link>https://pinkhello.me/posts/15-%E8%AE%B0%E4%B8%80%E6%AC%A1docker%E6%97%A5%E5%BF%97%E7%A3%81%E7%9B%98%E5%91%8A%E8%AD%A6%E9%97%AE%E9%A2%98/</link><pubDate>Wed, 10 Feb 2021 10:05:29 +0800</pubDate><guid>https://pinkhello.me/posts/15-%E8%AE%B0%E4%B8%80%E6%AC%A1docker%E6%97%A5%E5%BF%97%E7%A3%81%E7%9B%98%E5%91%8A%E8%AD%A6%E9%97%AE%E9%A2%98/</guid><description>PinkHello https://pinkhello.me/posts/15-%E8%AE%B0%E4%B8%80%E6%AC%A1docker%E6%97%A5%E5%BF%97%E7%A3%81%E7%9B%98%E5%91%8A%E8%AD%A6%E9%97%AE%E9%A2%98/ -&lt;h1 id="å‰æ™¯">å‰æ™¯&lt;/h1>
&lt;p>ä»Šæ—¥ï¼Œæˆ‘æ­£åœ¨å¼€å¼€å¿ƒå¿ƒçš„åˆ·ç€JFXçš„Codingä¸­ï¼Œçªç„¶çº¿ä¸ŠæŠ¥è­¦ç¾¤ä¸­çˆ†äº†ä¸ªç‚¸å¼¹ï¼ŒEC2ç£ç›˜è¶…è¿‡80%ã€‚&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/%E8%B5%84%E6%BA%90%E4%B8%8D%E8%B6%B3%E6%8A%A5%E8%AD%A6.png" alt="èµ„æºä¸è¶³é¢„è­¦">&lt;/p>
&lt;h1 id="å¤„ç†è¿‡ç¨‹">å¤„ç†è¿‡ç¨‹&lt;/h1>
&lt;p>è§£å†³é—®é¢˜å§¿åŠ¿å°±ä½ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>èµ¶ç´§å¼€æœº ==ã€‹ â¤ï¸ä¸­ä¸‡åŒ¹ğŸ¦™å¥”è…¾è€Œè¿‡ â¤ï¸ä¸­MMP&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é»˜é»˜çš„é€šè¿‡è·³æ¿æœºè¿›å…¥ç›®æ ‡æœºå™¨&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€,æ‰§è¡ŒæŸ¥çœ‹ç£ç›˜å ç”¨å¤§å°ï¼Œæˆ‘çš„ä¹–ä¹–ï¼Œå ç”¨ç¡®å®è¶…è¿‡äº†87%äº†ï¼Œä¸€ä¸‹å­æš´æ¶¨çš„&lt;/p>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># æŸ¥çœ‹ç£ç›˜å ç”¨å¤§å°&lt;/span>
&amp;gt; sudo df -h
&lt;span style="color:#228b22"># æŸ¥çœ‹å½“å‰ç›®å½•æ€»é‡&lt;/span>
&amp;gt; sudo du -sh
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>å¼€å§‹å®šä½å…·ä½“å“ªä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•å ç”¨è¿™ä¹ˆå¤§,è·‘åˆ°æ ¹ç›®å½•ä¸‹ã€‚&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹ä¸€çº§å­æ–‡ä»¶å’Œå­ç›®å½•å ç”¨çš„ç£ç›˜å®¹é‡&lt;/span>
&amp;gt; sudo du -lh --max-depth=&lt;span style="color:#b452cd">1&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>ä¸€å¼€å§‹çŒœæƒ³å¯èƒ½æ˜¯dockerå®¹å™¨çš„æ—¥å¿—å ç”¨å¤§ï¼Œä¸Šé¢æ‰§è¡Œåï¼Œè¿˜çœŸ TM æ˜¯&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">/var/lib/docker/containers ç›®å½•å ç”¨ 42G
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>å¼€å§‹æŸ¥çœ‹æ˜¯å“ªä¸ªå®¹å™¨å ç”¨çš„è¿™ä¹ˆå¤§çš„ç©ºé—´&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># æŸ¥çœ‹ containers æ—¥å¿—ç›®å½•æ’åº&lt;/span>
&amp;gt; sudo du -d1 -h /var/lib/docker/containers | sort -h
&lt;span style="color:#228b22"># æŸ¥çœ‹å…·ä½“çš„å“ªä¸ªæ—¥å¿—æ–‡ä»¶å¤§&lt;/span>
&amp;gt; sudo find /var/lib/docker/containers -name *.log
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“ç„¶è¿™ä¸ªé…å›¾æ˜¯æˆ‘æ¸…ç†ä¹‹åçš„
&lt;img src="https://pinkhello.me/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/docker%E5%AE%B9%E5%99%A8%E6%96%87%E4%BB%B6%E6%8E%92%E5%BA%8F.png" alt="dockerå®¹å™¨æ–‡ä»¶æ’åº">
&lt;img src="https://pinkhello.me/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/%E6%9F%A5%E6%89%BEdocker%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6.png" alt="æŸ¥æ‰¾dockerå®¹å™¨æ—¥å¿—æ–‡ä»¶">&lt;/p>
&lt;ul>
&lt;li>å®šä½åˆ°æœ€å¤§çš„æ–‡ä»¶ï¼Œä¸€é¡¿æ“ä½œ&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell"> &lt;span style="color:#228b22"># æ¸…ç©ºæ¯”è¾ƒå¤§çš„æ—¥å¿—æ–‡ä»¶&lt;/span>
&amp;gt; sudo sh -c &lt;span style="color:#cd5555">&amp;#34;cat /dev/null &amp;gt; &lt;/span>&lt;span style="color:#cd5555">${&lt;/span>&lt;span style="color:#00688b">log_file&lt;/span>&lt;span style="color:#cd5555">}&lt;/span>&lt;span style="color:#cd5555">&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://pinkhello.me/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/%E6%B8%85%E7%90%86docker%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97%E5%90%8E.png" alt="æ¸…ç†dockerå®¹å™¨æ—¥å¿—å">&lt;/p>
&lt;h1 id="æ€è€ƒ">æ€è€ƒ&lt;/h1>
&lt;ul>
&lt;li>ä¸Šé¢çš„æ–¹å¼æ˜¯ä¸€ç§æ–¹å¼è§£å†³ã€ä¸´æ—¶ã€‘
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell"> &lt;span style="color:#228b22"># æŸ¥çœ‹ docker çš„ Logging Driver&lt;/span>
&amp;gt; docker info | grep &lt;span style="color:#cd5555">&amp;#39;Logging Driver&amp;#39;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚ä½•å½»åº•è§£å†³è¿™ä¸ªé—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>å†™ä¸ª&lt;code>shellè„šæœ¬&lt;/code> ä½¿ç”¨ &lt;code>crontab&lt;/code> å®šæœŸæ‰§è¡Œæ¸…ç†
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell"> &lt;span style="color:#228b22">#!/bin/sh&lt;/span>
&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#cd5555">&amp;#34;======== start clean docker containers logs ========&amp;#34;&lt;/span>
&lt;span style="color:#00688b">logs&lt;/span>=&lt;span style="color:#8b008b;font-weight:bold">$(&lt;/span>find /var/lib/docker/containers/ -name *-json.log&lt;span style="color:#8b008b;font-weight:bold">)&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">for&lt;/span> log in &lt;span style="color:#00688b">$logs&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">do&lt;/span>
&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#cd5555">&amp;#34;clean logs : &lt;/span>&lt;span style="color:#00688b">$log&lt;/span>&lt;span style="color:#cd5555">&amp;#34;&lt;/span>
cat /dev/null &amp;gt; &lt;span style="color:#00688b">$log&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">done&lt;/span>
&lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#cd5555">&amp;#34;======== end clean docker containers logs ========&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>å‡å¦‚æ˜¯&lt;code>docker run&lt;/code>åˆ›å»ºå®¹å™¨çš„,æŒ‡å®š &lt;code>--log-opt max-size=${MAX_SIZE}m --log-opt max-file=${NUMBER}&lt;/code>&lt;/li>
&lt;li>&lt;code>docker-compose&lt;/code> æ–¹å¼æ›´é«˜&lt;code>docker-compose.yaml&lt;/code>æ–‡ä»¶
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">logging&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">driver&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#cd5555">&amp;#34;json-file&amp;#34;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">options&lt;/span>:&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">max-size&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#cd5555">&amp;#34;${MAX_SIZE}m&amp;#34;&lt;/span>&lt;span style="color:#bbb">
&lt;/span>&lt;span style="color:#bbb"> &lt;/span>&lt;span style="color:#8b008b;font-weight:bold">max-file&lt;/span>:&lt;span style="color:#bbb"> &lt;/span>${NUMBER}&lt;span style="color:#bbb">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>&lt;code>docker&lt;/code> å…¨å±€ä¿®æ”¹ &lt;code>/etc/docker/daemon.json&lt;/code>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json"> {
&lt;span style="color:#8b008b;font-weight:bold">&amp;#34;log-driver&amp;#34;&lt;/span>: &lt;span style="color:#cd5555">&amp;#34;json-file&amp;#34;&lt;/span>,
&lt;span style="color:#8b008b;font-weight:bold">&amp;#34;log-opts&amp;#34;&lt;/span>: {
&lt;span style="color:#8b008b;font-weight:bold">&amp;#34;max-size&amp;#34;&lt;/span>: &lt;span style="color:#cd5555">&amp;#34;${MAX_SIZE}m&amp;#34;&lt;/span>
}
}
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell"> &amp;gt; systemctl daemon-reload
&amp;gt; systemctl restart docker
&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ä¸ºä»€ä¹ˆä¼šç¬é—´ğŸ’¥å¼çš„å¢é•¿ ???&lt;/li>
&lt;/ul>
- https://pinkhello.me/posts/15-%E8%AE%B0%E4%B8%80%E6%AC%A1docker%E6%97%A5%E5%BF%97%E7%A3%81%E7%9B%98%E5%91%8A%E8%AD%A6%E9%97%AE%E9%A2%98/ - PinkHello, All Rights Reserved</description></item><item><title>05 OAuth2.0 é‚£ç‚¹äº‹</title><link>https://pinkhello.me/posts/05-oauth2.0%E9%82%A3%E7%82%B9%E4%BA%8B/</link><pubDate>Wed, 10 Feb 2021 08:32:02 +0800</pubDate><guid>https://pinkhello.me/posts/05-oauth2.0%E9%82%A3%E7%82%B9%E4%BA%8B/</guid><description>PinkHello https://pinkhello.me/posts/05-oauth2.0%E9%82%A3%E7%82%B9%E4%BA%8B/ -&lt;h2 id="oauth20-æ˜¯ä»€ä¹ˆ">&lt;code>OAuth2.0&lt;/code> æ˜¯ä»€ä¹ˆ?&lt;/h2>
&lt;p>&lt;code>OAuth2.0&lt;/code> Framework RFC 6749 [https://tools.ietf.org/html/rfc6749]&lt;/p>
&lt;p>&lt;code>OAuth&lt;/code> å°±æ˜¯ä¸€ç§æˆæƒæœºåˆ¶ï¼Œå®ƒä»‹äºå®¢æˆ·ç«¯ä¸èµ„æºæ‰€æœ‰è€…çš„æˆæƒå±‚ï¼Œä¸ºäº†åˆ†ç¦»ä¸åŒçš„è§’è‰²ã€‚
åœ¨èµ„æºæ‰€æœ‰è€…åŒæ„å¹¶å‘å®¢æˆ·ç«¯é¢å‘ä»¤ç‰Œåï¼Œå®¢æˆ·ç«¯æºå¸¦ä»¤ç‰Œå¯ä»¥è®¿é—®éƒ¨åˆ†æˆ–å…¨éƒ¨èµ„æºã€‚&lt;/p>
&lt;p>&lt;!-- raw HTML omitted -->OAuth2.0&lt;!-- raw HTML omitted --> æ˜¯&lt;!-- raw HTML omitted -->OAuth&lt;!-- raw HTML omitted --> åè®®çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œä¸º&lt;!-- raw HTML omitted -->2.0&lt;!-- raw HTML omitted -->ç‰ˆæœ¬ã€‚æœ‰æ„æ€çš„æ˜¯ &lt;!-- raw HTML omitted -->2.0&lt;!-- raw HTML omitted --> ä¸ &lt;!-- raw HTML omitted -->1.0&lt;!-- raw HTML omitted --> å¹¶ä¸å…¼å®¹ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;h2 id="oauth20-æˆæƒæ–¹å¼">&lt;code>OAuth2.0&lt;/code> æˆæƒæ–¹å¼&lt;/h2>
&lt;p>è·å–æˆæƒçš„è¿‡ç¨‹&lt;/p>
&lt;ul>
&lt;li>æˆæƒç (&lt;!-- raw HTML omitted -->authorization-code&lt;!-- raw HTML omitted -->)&lt;/li>
&lt;li>éšè—å¼(&lt;!-- raw HTML omitted -->implicit&lt;!-- raw HTML omitted -->)&lt;/li>
&lt;li>å¯†ç (&lt;!-- raw HTML omitted -->password&lt;!-- raw HTML omitted -->)&lt;/li>
&lt;li>å®¢æˆ·ç«¯å‡­è¯(&lt;!-- raw HTML omitted -->client credentials&lt;!-- raw HTML omitted -->)&lt;/li>
&lt;/ul>
&lt;p>ä¸ç®¡å“ªç§æ–¹å¼ï¼Œéƒ½éœ€è¦åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨ç”³è¯·ä»¤ç‰Œä¹‹å‰ï¼Œéœ€è¦åœ¨ç³»ç»Ÿä¸­ç”³è¯·èº«ä»½å”¯ä¸€æ ‡è¯†: å®¢æˆ·ç«¯ID &lt;!-- raw HTML omitted -->Client ID&lt;!-- raw HTML omitted --> å’Œ å®¢æˆ·ç«¯ç§˜é’¥ &lt;!-- raw HTML omitted -->Client Secret&lt;!-- raw HTML omitted -->.
è¿™æ ·èƒ½ç¡®ä¿Tokenä¸è¢«æ¶æ„ä½¿ç”¨ã€‚&lt;/p>
&lt;p>æˆæƒé‡è¦çš„å‚æ•°å’ŒæŒ‡æ ‡:&lt;/p>
&lt;ul>
&lt;li>&lt;!-- raw HTML omitted -->response_type&lt;!-- raw HTML omitted --> å“åº”ç±»å‹: &lt;!-- raw HTML omitted -->code&lt;!-- raw HTML omitted -->(è¦æ±‚è¿”å›æˆæƒç ),&lt;!-- raw HTML omitted -->token&lt;!-- raw HTML omitted -->(è¦æ±‚è¿”å›æˆæƒToken)&lt;/li>
&lt;li>&lt;!-- raw HTML omitted -->client_id&lt;!-- raw HTML omitted --> å®¢æˆ·ç«¯èº«ä»½æ ‡è¯†&lt;/li>
&lt;li>&lt;!-- raw HTML omitted -->client_secret&lt;!-- raw HTML omitted --> å®¢æˆ·ç«¯ç§˜é’¥&lt;/li>
&lt;li>&lt;!-- raw HTML omitted -->redirect_uri&lt;!-- raw HTML omitted --> é‡å®šå‘åœ°å€&lt;/li>
&lt;li>&lt;!-- raw HTML omitted -->scope&lt;!-- raw HTML omitted --> æˆæƒèŒƒå›´, &lt;!-- raw HTML omitted -->read&lt;!-- raw HTML omitted --> åªè¯»æƒé™, &lt;!-- raw HTML omitted -->all&lt;!-- raw HTML omitted --> å…¨éƒ¨æƒé™&lt;/li>
&lt;li>&lt;!-- raw HTML omitted -->grant_type&lt;!-- raw HTML omitted --> æˆæƒæ–¹å¼ &lt;!-- raw HTML omitted -->authorization_code&lt;!-- raw HTML omitted -->(æˆæƒç )ã€&lt;!-- raw HTML omitted -->password&lt;!-- raw HTML omitted -->(å¯†ç )ã€&lt;!-- raw HTML omitted -->client_credentials&lt;!-- raw HTML omitted -->
(å‡­è¯)ã€&lt;!-- raw HTML omitted -->refresh_token&lt;!-- raw HTML omitted -->(æ›´æ–°ä»¤ç‰Œ)&lt;/li>
&lt;li>&lt;!-- raw HTML omitted -->state&lt;!-- raw HTML omitted --> åº”ç”¨ç¨‹åºä¼ é€’çš„ä¸€ä¸ªéšæœºæ•°ï¼Œé˜²æ­¢ &lt;!-- raw HTML omitted -->CSRF&lt;!-- raw HTML omitted --> æ”»å‡»&lt;/li>
&lt;/ul>
&lt;h3 id="æˆæƒç httpswwwoauthcomoauth2-serversaccess-tokensauthorization-code-request-authorization-code-request">&lt;a href="https://www.oauth.com/oauth2-servers/access-tokens/authorization-code-request/" title="authorization-code-request">æˆæƒç &lt;/a>&lt;/h3>
&lt;p>åœ¨è®¿é—®ç¬¬ä¸‰æ–¹åº”ç”¨å…ˆç”³è¯·ä¸€ä¸ªæˆæƒç ï¼Œç„¶åå†ç”¨æˆæƒç è·å–ä»¤ç‰Œ.è¿™ç§æ–¹å¼ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„æµç¨‹ï¼Œå®‰å…¨æ€§ä¹Ÿæ˜¯æœ€é«˜çš„ï¼Œé€‚ç”¨äºæœ‰åç«¯çš„&lt;!-- raw HTML omitted -->Web&lt;!-- raw HTML omitted -->åº”ç”¨ã€‚æˆæƒç é€šè¿‡å‰ç«¯ä¼ é€ï¼Œä»¤ç‰Œå­˜å‚¨åœ¨åç«¯ã€‚æ‰€æœ‰çš„å’Œèµ„æºæœåŠ¡å™¨çš„äº¤äº’éƒ½åœ¨æœåŠ¡ç«¯å®Œæˆï¼Œé¿å…äº†ä»¤ç‰Œçš„æ³„éœ²ã€‚
æˆæƒç å’Œä»¤ç‰Œçš„åœ¨ æµè§ˆå™¨å’Œå®¢æˆ·ç«¯&lt;!-- raw HTML omitted -->WEB&lt;!-- raw HTML omitted -->åº”ç”¨ä»¥åŠèµ„æºæœåŠ¡å™¨çš„äº¤äº’æµç¨‹å¤§è‡´å¦‚ä¸‹:
&lt;img src="https://pinkhello.me/OAuth2-0%E9%82%A3%E7%82%B9%E4%BA%8B/auth_code.png" alt="authorization-code">&lt;/p>
&lt;ul>
&lt;li>1.2.3.4 ç”¨æˆ·é€‰æ‹© &lt;!-- raw HTML omitted -->Google&lt;!-- raw HTML omitted --> ç™»é™† &lt;!-- raw HTML omitted -->yelp.com&lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>3.4 &lt;!-- raw HTML omitted -->Yelp.com&lt;!-- raw HTML omitted --> è¯·æ±‚ç”¨æˆ·æˆæƒ &lt;!-- raw HTML omitted -->Google&lt;!-- raw HTML omitted --> æƒé™&lt;/li>
&lt;li>5.6 ç”¨æˆ·åŒæ„åè¿”å›æˆæƒç 
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;/li>
&lt;li>7.8 &lt;!-- raw HTML omitted -->Yelp.com&lt;!-- raw HTML omitted --> é€šè¿‡æˆæƒç  ä¼šå‘ &lt;!-- raw HTML omitted -->Google&lt;!-- raw HTML omitted -->å‘èµ·è¯·æ±‚&lt;!-- raw HTML omitted -->Token&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;/li>
&lt;li>9 éªŒè¯å¿…è¦å‚æ•°ï¼Œè¿”å› &lt;!-- raw HTML omitted -->Token&lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>10.11 æ“ä½œè¯·æ±‚&lt;/li>
&lt;/ul>
&lt;h3 id="éšè—å¼httpsauth0comblogoauth2-implicit-grant-and-spa-oauth2-implicit-grant-and-spa">&lt;a href="https://auth0.com/blog/oauth2-implicit-grant-and-spa/" title="oauth2-implicit-grant-and-spa">éšè—å¼&lt;/a>&lt;/h3>
&lt;p>&lt;img src="https://pinkhello.me/OAuth2-0%E9%82%A3%E7%82%B9%E4%BA%8B/implicit.png" alt="implicit">&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;h3 id="å¯†ç å¼httpswwwoauthcomoauth2-serversaccess-tokenspassword-grant-password-grant">&lt;a href="https://www.oauth.com/oauth2-servers/access-tokens/password-grant/" title="password-grant">å¯†ç å¼&lt;/a>&lt;/h3>
&lt;p>é¡¾åæ€è®®,åœ¨è‡ªå·±çš„ç³»ç»Ÿè¾“å…¥ç¬¬ä¸‰æ–¹ç³»ç»Ÿçš„è´¦å·å¯†ç ,è‡ªå·±çš„ç³»ç»Ÿæ‹¿è´¦å·å¯†ç å»ç”³è¯·ä»¤ç‰Œï¼Œå“åº”é¢˜é‡Œé¢è¿”å›token&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;h3 id="å‡­è¯å¼httpswwwoauthcomoauth2-serversaccess-tokensclient-credentials-client-credentials">&lt;a href="https://www.oauth.com/oauth2-servers/access-tokens/client-credentials/" title="client-credentials">å‡­è¯å¼&lt;/a>&lt;/h3>
&lt;p>å‡­è¯å¼å’Œå¯†ç å¾ˆç›¸ä¼¼ï¼Œä¸»è¦ç»™æ²¡æœ‰å‰ç«¯è¾“å…¥çš„é¡¹ç›®æˆ–è€…å‘½ä»¤è¡Œ&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;h2 id="ä»¤ç‰Œçš„ä½¿ç”¨å’Œæ›´æ–°">ä»¤ç‰Œçš„ä½¿ç”¨å’Œæ›´æ–°&lt;/h2>
&lt;h3 id="ä»¤ç‰Œçš„ä½¿ç”¨">&lt;a href="">ä»¤ç‰Œçš„ä½¿ç”¨&lt;/a>&lt;/h3>
&lt;p>ä»¤ç‰Œçš„æ‹¿åˆ°äº†ï¼Œå°±å¯ä»¥è°ƒç”¨Googleçš„APIè¿›è¡Œè¯·æ±‚æ•°æ®äº†ï¼Œ
ä¸€èˆ¬è®² Token æ”¾å…¥è¯·æ±‚å¤´ Authorization.&lt;/p>
&lt;h3 id="ä»¤ç‰Œçš„æ›´æ–°httpswwwoauthcomoauth2-serversaccess-tokensrefreshing-access-tokens-refreshing-access-tokens">&lt;a href="https://www.oauth.com/oauth2-servers/access-tokens/refreshing-access-tokens/" title="refreshing-access-tokens">ä»¤ç‰Œçš„æ›´æ–°&lt;/a>&lt;/h3>
&lt;p>&lt;!-- raw HTML omitted -->Token&lt;!-- raw HTML omitted --> æ˜¯æœ‰æ—¶æ•ˆæ€§çš„ï¼Œä¸€æ—¦è¿‡æœŸå°±éœ€è¦é‡æ–°è·å–ï¼Œä½†æ˜¯é‡èµ°ä¸€éæˆæƒæµç¨‹ï¼Œä¸ä»…éº»çƒ¦è€Œä¸”ç”¨æˆ·ä½“éªŒä¹Ÿä¸å¥½ï¼Œé‚£å¦‚ä½•è®©ç”¨æˆ·ä½¿ç”¨çš„ä¼˜é›…å‘¢ï¼Ÿ&lt;/p>
&lt;p>ä¸€èˆ¬åœ¨é¢å‘ä»¤ç‰Œçš„æ—¶å€™ï¼Œé¢å‘ä¸¤ä¸ª&lt;!-- raw HTML omitted -->Token&lt;!-- raw HTML omitted -->, ä¸€ä¸ªæˆæƒ&lt;!-- raw HTML omitted -->Token&lt;!-- raw HTML omitted -->,ä¸€ä¸ª&lt;!-- raw HTML omitted -->Refresh Token&lt;!-- raw HTML omitted -->,
åœ¨æ›´æ–°&lt;!-- raw HTML omitted -->refresh_token&lt;!-- raw HTML omitted -->æ—¶å€™,å°†&lt;!-- raw HTML omitted -->grant_type&lt;!-- raw HTML omitted -->æŒ‡å®šä¸º&lt;!-- raw HTML omitted -->refresh_token&lt;!-- raw HTML omitted -->,
å‚æ•°&lt;!-- raw HTML omitted -->refresh_token&lt;!-- raw HTML omitted -->æ˜¯ç”¨äºæ›´æ–°&lt;!-- raw HTML omitted -->Token&lt;!-- raw HTML omitted -->çš„&lt;!-- raw HTML omitted -->refresh_token&lt;!-- raw HTML omitted -->&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;h1 id="æ€»ç»“">æ€»ç»“&lt;/h1>
&lt;h1 id="å®‰åˆ©">å®‰åˆ©&lt;/h1>
&lt;ul>
&lt;li>Client
&lt;ul>
&lt;li>Go &lt;a href="https://godoc.org/golang.org/x/oauth2">https://godoc.org/golang.org/x/oauth2&lt;/a>&lt;/li>
&lt;li>Java
&lt;ul>
&lt;li>&lt;a href="https://spring.io/projects/spring-social/">https://spring.io/projects/spring-social/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://spring.io/projects/spring-security/">https://spring.io/projects/spring-security/&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Server
&lt;ul>
&lt;li>Go
&lt;ul>
&lt;li>&lt;a href="https://github.com/go-oauth2/oauth2">https://github.com/go-oauth2/oauth2&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/zalando/gin-oauth2">https://github.com/zalando/gin-oauth2&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Java &lt;a href="https://github.com/zalando/tokens">https://github.com/zalando/tokens&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>å‚è€ƒ&lt;/p>
&lt;ul>
&lt;li>jsonwebtoken.io &lt;a href="https://www.jsonwebtoken.io/">https://www.jsonwebtoken.io/&lt;/a>&lt;/li>
&lt;li>oauth.net &lt;a href="https://oauth.net/2/">https://oauth.net/2/&lt;/a>&lt;/li>
&lt;li>aliyun.com
&lt;ul>
&lt;li>&lt;a href="https://help.aliyun.com/document_detail/32144.html?spm=5176.87240.400427.53.32fa4614S88B0N">https://help.aliyun.com/document_detail/32144.html?spm=5176.87240.400427.53.32fa4614S88B0N&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://help.aliyun.com/document_detail/32008.html?spm=a2c4g.11186623.6.780.40435837SXpbPT">https://help.aliyun.com/document_detail/32008.html?spm=a2c4g.11186623.6.780.40435837SXpbPT&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://help.aliyun.com/document_detail/32026.html?spm=a2c4g.11186623.6.856.20b1c06dgVW6Ri">https://help.aliyun.com/document_detail/32026.html?spm=a2c4g.11186623.6.856.20b1c06dgVW6Ri&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
- https://pinkhello.me/posts/05-oauth2.0%E9%82%A3%E7%82%B9%E4%BA%8B/ - PinkHello, All Rights Reserved</description></item><item><title>04 å¦‚ä½•æ„å»ºä¸€ä¸ªç®€å•çš„RPCè°ƒç”¨</title><link>https://pinkhello.me/posts/04-%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84rpc%E8%B0%83%E7%94%A8/</link><pubDate>Wed, 10 Feb 2021 08:24:19 +0800</pubDate><guid>https://pinkhello.me/posts/04-%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84rpc%E8%B0%83%E7%94%A8/</guid><description>PinkHello https://pinkhello.me/posts/04-%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84rpc%E8%B0%83%E7%94%A8/ -&lt;p>1ã€ä»€ä¹ˆå«RPC?&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>&lt;img src="https://pinkhello.me/%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BARPC%E8%B0%83%E7%94%A8/RPC%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1%E8%BF%87%E7%A8%8B.jpg" alt="RPCè°ƒç”¨æœåŠ¡è¿‡ç¨‹">&lt;/p>
&lt;p>RPCæ„æˆ&lt;/p>
&lt;ul>
&lt;li>RPC Consumer&lt;/li>
&lt;li>RPC Provider&lt;/li>
&lt;li>ConfigServer&lt;/li>
&lt;/ul>
&lt;ul>
&lt;li>1ã€&lt;code>Provider&lt;/code> å¯åŠ¨ &lt;code>ConfigServer&lt;/code> æ³¨å†ŒæœåŠ¡&lt;/li>
&lt;li>2ã€&lt;code>Consumer&lt;/code> å¯åŠ¨ &lt;code>ConfigServer&lt;/code> è®¢é˜…æœåŠ¡ï¼Œ&lt;/li>
&lt;li>3ã€å‘èµ·è°ƒç”¨ &lt;code>Consumer&lt;/code> &amp;mdash;&amp;gt; &lt;code>Provider&lt;/code>&lt;/li>
&lt;li>4ã€å“åº”è°ƒç”¨ &lt;code>Consumer&lt;/code> &amp;lt;&amp;mdash; &lt;code>Provider&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>2ã€ä»€ä¹ˆæ˜¯ &lt;code>Netty&lt;/code> ? &lt;a href="https://netty.io/">https://netty.io/&lt;/a>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>&lt;img src="https://pinkhello.me/%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BARPC%E8%B0%83%E7%94%A8/netty%E6%A1%86%E6%9E%B6%E5%9B%BE.png" alt="nettyæ¡†æ¶å›¾">&lt;/p>
&lt;p>3ã€ç°æœ‰çš„å¼€æºçš„é¡¹ç›®æ˜¯å¦ä½¿ç”¨äº† &lt;code>Netty&lt;/code> ?&lt;/p>
&lt;ul>
&lt;li>Dubbo&lt;/li>
&lt;li>Grpc&lt;/li>
&lt;li>Spark&lt;/li>
&lt;li>&amp;hellip;.&lt;/li>
&lt;/ul>
&lt;p>4ã€&lt;code>RPC Provider&lt;/code> å¯åŠ¨&lt;/p>
&lt;ul>
&lt;li>&lt;code>Netty Server&lt;/code> æ–¹å¼å¯åŠ¨&lt;/li>
&lt;li>&lt;code>Rpc&lt;/code> æœåŠ¡çš„æ³¨å†Œ
&lt;img src="https://pinkhello.me/%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BARPC%E8%B0%83%E7%94%A8/RPC%E4%B8%8ENetty%E7%BB%93%E5%90%88Provider%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B.png" alt="RPCä¸Nettyç»“åˆProviderè°ƒç”¨è¿‡ç¨‹">&lt;/li>
&lt;/ul>
&lt;p>5ã€&lt;code>RPC Consumer&lt;/code> å¯åŠ¨&lt;/p>
&lt;ul>
&lt;li>&lt;code>Netty Client&lt;/code> æ–¹å¼å¯åŠ¨&lt;/li>
&lt;li>&lt;code>RPC&lt;/code> æ³›åŒ–è°ƒç”¨ã€é€šè¿‡å­—èŠ‚ç åŸºäºåå°„æ¥å®ç°è¿œç¨‹è°ƒåº¦&lt;/li>
&lt;li>&lt;code>Consumer&lt;/code> æœåŠ¡è®¢é˜…&lt;/li>
&lt;li>å¯åŠ¨æ—¶å»ºç«‹é•¿è¿æ¥
&lt;img src="https://pinkhello.me/%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BARPC%E8%B0%83%E7%94%A8/RPC%E4%B8%8ENetty%E7%BB%93%E5%90%88Consumer%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B.png" alt="RPCä¸Nettyç»“åˆConsumerè°ƒç”¨è¿‡ç¨‹">&lt;/li>
&lt;/ul>
&lt;p>6ã€ä»ç¬¬å››å¯ä»¥çœ‹å‡ºï¼Œå¤šä¸ª &lt;code>Provider&lt;/code> æ˜¯ç”±ä¸€ä¸ª &lt;code>NettyServer&lt;/code> æä¾›çš„ï¼Œé€šè¿‡ &lt;code>HandlerMap&lt;/code> æ˜ å°„æ‰¾åˆ°å¯¹åº”çš„ &lt;code>Ioc Bean&lt;/code>ï¼Œå®ŒæˆæœåŠ¡è°ƒç”¨&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">æœåŠ¡ç«¯
EventLoopGroup bossGroup = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> NioEventLoopGroup(1);
EventLoopGroup workerGroup = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> NioEventLoopGroup();
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
ServerBootstrap b = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ServerBootstrap();
b.&lt;span style="color:#658b00">group&lt;/span>(bossGroup, workerGroup)
.&lt;span style="color:#658b00">channel&lt;/span>(NioServerSocketChannel.&lt;span style="color:#658b00">class&lt;/span>)
.&lt;span style="color:#658b00">option&lt;/span>(ChannelOption.&lt;span style="color:#658b00">SO_BACKLOG&lt;/span>, 100)
.&lt;span style="color:#658b00">handler&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> LoggingHandler(LogLevel.&lt;span style="color:#658b00">INFO&lt;/span>))
.&lt;span style="color:#658b00">childHandler&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ChannelInitializer&amp;lt;SocketChannel&amp;gt;() {
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">initChannel&lt;/span>(SocketChannel ch) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> Exception {
ChannelPipeline p = ch.&lt;span style="color:#658b00">pipeline&lt;/span>();
p.&lt;span style="color:#658b00">addLast&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> RpcEncoder(RpcRequest.&lt;span style="color:#658b00">class&lt;/span>));
p.&lt;span style="color:#658b00">addLast&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> RpcDecoder(RpcResponse.&lt;span style="color:#658b00">class&lt;/span>));
p.&lt;span style="color:#658b00">addLast&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> RpcHandler());
}});
&lt;span style="color:#228b22">// Start the server.
&lt;/span>&lt;span style="color:#228b22">&lt;/span> ChannelFuture f = b.&lt;span style="color:#658b00">bind&lt;/span>(PORT).&lt;span style="color:#658b00">sync&lt;/span>();
&lt;span style="color:#228b22">// Wait until the server socket is closed.
&lt;/span>&lt;span style="color:#228b22">&lt;/span> f.&lt;span style="color:#658b00">channel&lt;/span>().&lt;span style="color:#658b00">closeFuture&lt;/span>().&lt;span style="color:#658b00">sync&lt;/span>();
} &lt;span style="color:#8b008b;font-weight:bold">finally&lt;/span> {
&lt;span style="color:#228b22">// Shut down all event loops to terminate all threads.
&lt;/span>&lt;span style="color:#228b22">&lt;/span> bossGroup.&lt;span style="color:#658b00">shutdownGracefully&lt;/span>();
workerGroup.&lt;span style="color:#658b00">shutdownGracefully&lt;/span>();
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://pinkhello.me/%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BARPC%E8%B0%83%E7%94%A8/Netty%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AFTCP%E9%93%BE%E6%8E%A5%E4%B8%8A%E7%9A%84%E8%AF%B7%E6%B1%82.jpg" alt="Nettyå¦‚ä½•å¤„ç†å®¢æˆ·ç«¯TCPé“¾æ¥ä¸Šçš„è¯·æ±‚">&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BARPC%E8%B0%83%E7%94%A8/NettyReactor%E5%B7%A5%E4%BD%9C%E6%A1%86%E6%9E%B6%E5%9B%BE.jpg" alt="NettyReactorå·¥ä½œæ¡†æ¶å›¾">&lt;/p>
&lt;ul>
&lt;li>&lt;code>BossGroup&lt;/code> -&amp;gt; å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚&lt;/li>
&lt;li>&lt;code>EventGroup&lt;/code> â€”&amp;gt; å¤„ç†IO &lt;code>Read/Write&lt;/code> æ“ä½œã€æ‰§è¡Œä»»åŠ¡ç³»ç»ŸTaskã€å®šæ—¶ä»»åŠ¡&lt;/li>
&lt;li>&lt;code>ChildChannelHandler&lt;/code> æ–¹å¼æ˜¯å¯¹ &lt;code>ChannelPipeline&lt;/code> çš„è®¾ç½®ã€&lt;/li>
&lt;li>&lt;code>ChannelPipeline&lt;/code> æ˜¯ç›¸å½“äºä»»åŠ¡é“¾çš„æ¨¡å¼, æ˜¯ä¸€ä¸² &lt;code>ChannelHandler&lt;/code> çš„å®ä¾‹&lt;/li>
&lt;li>&lt;code>ChannelHandlerContext&lt;/code> æ˜¯ &lt;code>ChannelPipeline&lt;/code> å’Œ &lt;code>ChannelHandler&lt;/code> çš„å…³ç³»&lt;/li>
&lt;li>æ¯ä¸ªé“¾æ¥å¯¹äº &lt;code>Sever&lt;/code> ç«¯éƒ½ä¼šåˆ›å»ºä¸€ä¸ª &lt;code>Channel&lt;/code> ï¼Œå¯ä»¥å°† &lt;code>Channel&lt;/code> ç†è§£ä¸º &lt;code>Connection&lt;/code> ï¼ˆå…¶å®çœŸæ­£çš„æ˜¯ &lt;code>Connection&lt;/code> å±äº &lt;code>Channel&lt;/code> çš„ä¸€éƒ¨åˆ†ï¼‰&lt;/li>
&lt;li>æ¯ä¸ª &lt;code>Channel&lt;/code> éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„å”¯ä¸€çš„ &lt;code>ChannelPipeline&lt;/code> æ“ä½œï¼Œå¯¹äºå…¶ä»–çš„ &lt;code>Channel&lt;/code> çš„ &lt;code>ChannelPipeline&lt;/code> æ˜¯éš”ç¦»çš„&lt;/li>
&lt;li>&lt;code>RPC Handler&lt;/code> æ˜¯æˆ‘ä»¬å¯¹äºè‡ªå·±çš„æ‰¾å¯» &lt;code>RPC&lt;/code> æœåŠ¡å¤„ç†çš„ &lt;code>Handler&lt;/code> å®ç°&lt;/li>
&lt;li>&lt;code>RPC Encoder&lt;/code> æ˜¯æˆ‘ä»¬å¯¹äºè‡ªå·±çš„æ‰¾å¯» &lt;code>RPC&lt;/code> åºåˆ—åŒ–çš„ç¼–ç çš„ &lt;code>Handler&lt;/code> å®ç°&lt;/li>
&lt;li>&lt;code>RPC Decoder&lt;/code> æ˜¯æˆ‘ä»¬å¯¹äºè‡ªå·±çš„æ‰¾å¯» &lt;code>RPC&lt;/code> åºåˆ—åŒ–çš„è§£ç çš„ &lt;code>Handler&lt;/code> å®ç°&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">å®¢æˆ·ç«¯
EventLoopGroup group = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> NioEventLoopGroup();
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
Bootstrap b = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> Bootstrap();
b.&lt;span style="color:#658b00">group&lt;/span>(group)
.&lt;span style="color:#658b00">channel&lt;/span>(NioSocketChannel.&lt;span style="color:#658b00">class&lt;/span>)
.&lt;span style="color:#658b00">option&lt;/span>(ChannelOption.&lt;span style="color:#658b00">TCP_NODELAY&lt;/span>, &lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>)
.&lt;span style="color:#658b00">handler&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> ChannelInitializer&amp;lt;SocketChannel&amp;gt;() {
&lt;span style="color:#707a7c">@Override&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">void&lt;/span> &lt;span style="color:#008b45">initChannel&lt;/span>(SocketChannel ch) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> Exception {
ChannelPipeline p = ch.&lt;span style="color:#658b00">pipeline&lt;/span>();
p.&lt;span style="color:#658b00">addLast&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> RpcEncoder(RpcResponse.&lt;span style="color:#658b00">class&lt;/span>));
p.&lt;span style="color:#658b00">addLast&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> RpcDecoder(RpcRequest.&lt;span style="color:#658b00">class&lt;/span>));
p.&lt;span style="color:#658b00">addLast&lt;/span>(&lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> RpcClientHandler());
}});
&lt;span style="color:#228b22">// Start the client.
&lt;/span>&lt;span style="color:#228b22">&lt;/span> ChannelFuture f = b.&lt;span style="color:#658b00">connect&lt;/span>(HOST, PORT).&lt;span style="color:#658b00">sync&lt;/span>();
&lt;span style="color:#228b22">// Wait until the connection is closed.
&lt;/span>&lt;span style="color:#228b22">&lt;/span> f.&lt;span style="color:#658b00">channel&lt;/span>().&lt;span style="color:#658b00">closeFuture&lt;/span>().&lt;span style="color:#658b00">sync&lt;/span>();
} &lt;span style="color:#8b008b;font-weight:bold">finally&lt;/span> {
&lt;span style="color:#228b22">// Shut down the event loop to terminate all threads.
&lt;/span>&lt;span style="color:#228b22">&lt;/span> group.&lt;span style="color:#658b00">shutdownGracefully&lt;/span>();
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>7ã€&lt;code>RPC&lt;/code> åºåˆ—åŒ–&lt;/p>
&lt;ul>
&lt;li>äºŒè¿›åˆ¶æ•°æ®&lt;/li>
&lt;li>Hessian&lt;/li>
&lt;li>Avro&lt;/li>
&lt;li>ProtoBuffer (Protobuf)&lt;/li>
&lt;li>JSON&lt;/li>
&lt;li>XML&lt;/li>
&lt;/ul>
&lt;p>8ã€å…³äº &lt;code>RPC&lt;/code> çš„å®ç°æ€è€ƒä¸æŠ€æœ¯è®¨è®º&lt;/p>
&lt;ul>
&lt;li>ä¸šåŠ¡æ–¹æ³•ã€å› ä¸ºæ˜¯æ”¶åˆ°è¯·æ±‚æ¶ˆæ¯è€Œè§¦å‘çš„åç»­åŠ¨ä½œè°ƒç”¨ï¼Œä¸åšé¢å¤–è®¾ç½®ï¼Œè‚¯å®šæ˜¯ä½¿ç”¨çš„ &lt;code>WorkGroup&lt;/code> é‡Œé¢çš„çº¿ç¨‹æ“ä½œçš„ã€‚
è€Œä½œä¸ºä¸šåŠ¡å±‚ï¼Œä¸åº”è¯¥ä¸åº•å±‚å…³è”ï¼Œåº”è¯¥åˆ‡å‰²å¼€æ¥ï¼ŒåŠ¿å¿…ä¼šå¼•å…¥çœŸçš„ä¸šåŠ¡ä¾§çº¿ç¨‹æ± ã€‚
é‚£ä¹ˆå¦‚ä½•å¼•ç”¨ã€æ€ä¹ˆå¼•ç”¨ï¼Ÿ(å…³äº ä¸šåŠ¡çº¿ç¨‹æ±  ä¸ &lt;code>WorkGroup&lt;/code> çš„ &lt;code>EvenLoop&lt;/code> çš„æ€è€ƒ )&lt;/li>
&lt;li>å…³äº &lt;code>RPC&lt;/code> è°ƒç”¨å¤§éƒ¨åˆ†æ˜¯åŒæ­¥çš„è°ƒç”¨ï¼Œè€Œ &lt;code>Netty&lt;/code> åº•å±‚æ˜¯å®Œå…¨å¼‚æ­¥äº‹ä»¶æœºåˆ¶ï¼Œåœ¨RPCæ¡†æ¶å±‚é¢å¦‚ä½•å®ç°åŒæ­¥çš„è°ƒç”¨æ–¹å¼çš„ï¼Ÿ&lt;/li>
&lt;li>åŸºäº &lt;code>TCP&lt;/code> çš„é•¿é“¾æ¥è°ƒç”¨ï¼Œåœ¨ &lt;code>RPC&lt;/code> ä¸Šä½ ä¼šæƒ³åˆ°å…¶ä»–çš„å“ªäº›ä¸œä¸œï¼Ÿ&lt;/li>
&lt;li>åœ¨æ­¤ç¯å¢ƒä¸‹ï¼Œæˆ‘æ²¡æœ‰ä»‹ç» &lt;code>RPC&lt;/code> æœåŠ¡äº IOCå®¹å™¨çš„ç»“åˆï¼Œå¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œå¦‚ä½•åšåˆ° æ³¨è§£æœºåˆ¶ã€&lt;code>JAVA CONFIG&lt;/code> æœºåˆ¶ã€&lt;code>XML SCHEMA&lt;/code> æœºåˆ¶æ¥åš?
&lt;ul>
&lt;li>GUICE&lt;/li>
&lt;li>SPRING&lt;/li>
&lt;li>SPI&lt;/li>
&lt;li>&amp;hellip;.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
- https://pinkhello.me/posts/04-%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84rpc%E8%B0%83%E7%94%A8/ - PinkHello, All Rights Reserved</description></item><item><title>é“¾æ¥</title><link>https://pinkhello.me/links/</link><pubDate>Tue, 09 Feb 2021 10:38:21 +0800</pubDate><guid>https://pinkhello.me/links/</guid><description>PinkHello https://pinkhello.me/links/ -- https://pinkhello.me/links/ - PinkHello, All Rights Reserved</description></item><item><title>å…³äºæˆ‘</title><link>https://pinkhello.me/about/</link><pubDate>Tue, 09 Feb 2021 10:36:43 +0800</pubDate><guid>https://pinkhello.me/about/</guid><description>PinkHello https://pinkhello.me/about/ -&lt;hr>
&lt;h2 id="-ä¸ªäººä»‹ç»">ğŸ‘· ä¸ªäººä»‹ç»&lt;/h2>
&lt;p>PinkHello &lt;img src="https://views.whatilearened.today/views/github/pinkhello/pinkhello.svg" alt="views">&lt;/p>
&lt;p>&lt;img src="https://github-readme-stats.vercel.app/api?username=pinkhello&amp;amp;show_icons=true&amp;amp;theme=vue&amp;amp;hide_border=true&amp;amp;line_height=20&amp;amp;count_private=true" alt="">&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">PinkHello := &amp;amp;Info {
Name: &lt;span style="color:#cd5555">&amp;#34;PinkHello&amp;#34;&lt;/span>,
Occupation: &lt;span style="color:#cd5555">&amp;#34;Full Stack Developer&amp;#34;&lt;/span>,
Email: &lt;span style="color:#cd5555">&amp;#34;lee123lee123@163.com&amp;#34;&lt;/span>,
Wechat: &lt;span style="color:#cd5555">&amp;#34;chess_1&amp;#34;&lt;/span>,
Website: &lt;span style="color:#cd5555">&amp;#34;https://pinkhello.me&amp;#34;&lt;/span>,
Location: &lt;span style="color:#cd5555">&amp;#34;Shanghai China&amp;#34;&lt;/span>
}
&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h2 id="-æŠ€èƒ½">âš¡ æŠ€èƒ½&lt;/h2>
&lt;p>Language&lt;br>
&lt;img src="https://img.shields.io/badge/-Java-black?style=flat-square&amp;amp;logo=Java" alt="Java">
&lt;img src="https://img.shields.io/badge/-Go-black?style=flat-square&amp;amp;logo=Go" alt="Go">
&lt;img src="https://img.shields.io/badge/-Python-black?style=flat-square&amp;amp;logo=Python" alt="Python">
&lt;img src="https://img.shields.io/badge/-JavaScript-black?style=flat-square&amp;amp;logo=JavaScript" alt="JavaScript">&lt;/p>
&lt;p>Framework&lt;br>
&lt;img src="https://img.shields.io/badge/-Vue-000000?style=flat-square&amp;amp;logo=Vue.js" alt="Vue">
&lt;img src="https://img.shields.io/badge/-Spring-black?style=flat-square&amp;amp;logo=Spring" alt="Spring">
&lt;img src="https://img.shields.io/badge/-Spring%20Boot(Cloud)-black?style=flat-square&amp;amp;logo=Spring%20Boot(Cloud)" alt="Spring Boot(Cloud)">
&lt;img src="https://img.shields.io/badge/-Dubbo-black?style=flat-square&amp;amp;logo=Dubbo" alt="Dubbo">
&lt;img src="https://img.shields.io/badge/-Flask-black?style=flat-square&amp;amp;logo=Flask" alt="Flask">
&lt;img src="https://img.shields.io/badge/-Echo-black?style=flat-square&amp;amp;logo=Echo" alt="Echo">
&lt;img src="https://img.shields.io/badge/-Gin-black?style=flat-square&amp;amp;logo=Gin" alt="Gin">
&lt;img src="https://img.shields.io/badge/-Grpc-black?style=flat-square&amp;amp;logo=Grpc" alt="Grpc">&lt;/p>
&lt;p>Tools&lt;br>
&lt;img src="https://img.shields.io/badge/-Redis-black?style=flat-square&amp;amp;logo=Redis" alt="Redis">
&lt;img src="https://img.shields.io/badge/-MySQL-black?style=flat-square&amp;amp;logo=mysql" alt="MySQL">
&lt;img src="https://img.shields.io/badge/-Nginx-black?style=flat-square&amp;amp;logo=Nginx" alt="Nginx">
&lt;img src="https://img.shields.io/badge/-MongoDB-black?style=flat-square&amp;amp;logo=MongoDB" alt="MongoDB">
&lt;img src="https://img.shields.io/badge/-Pulsar-black?style=flat-square&amp;amp;logo=Pulsar" alt="Pulsar">
&lt;img src="https://img.shields.io/badge/-Kafka-black?style=flat-square&amp;amp;logo=Kafka" alt="Kafka">
&lt;img src="https://img.shields.io/badge/-Nsq-black?style=flat-square&amp;amp;logo=Nsq" alt="Nsq">
&lt;img src="https://img.shields.io/badge/-RabbitMQ-black?style=flat-square&amp;amp;logo=RabbitMQ" alt="RabbitMQ">
&lt;img src="https://img.shields.io/badge/-GitHub-181717?style=flat-square&amp;amp;logo=github" alt="GitHub">&lt;/p>
&lt;p>Others&lt;br>
&lt;img src="https://img.shields.io/badge/-Kubernetes-black?style=flat-square&amp;amp;logo=Kubernetes" alt="Kubernetes">
&lt;img src="https://img.shields.io/badge/-Docker-black?style=flat-square&amp;amp;logo=Docker" alt="Docker">
&lt;img src="https://img.shields.io/badge/-Linux-black?style=flat-square&amp;amp;logo=Linux" alt="Linux">
&lt;img src="https://img.shields.io/badge/-Deepin-007CFF?style=flat-square&amp;amp;logo=deepin" alt="Deepin">
&lt;img src="https://img.shields.io/badge/-Centos-262577?style=flat-square&amp;amp;logo=Centos" alt="Centos">
&lt;img src="https://img.shields.io/badge/-Raspberry%20Pi-C51A4A?style=flat-square&amp;amp;logo=Raspberry-Pi" alt="Raspberry Pi">&lt;/p>
&lt;hr>
&lt;h2 id="-ä¸ªäººå¼€æºé¡¹ç›®">ğŸ³ ä¸ªäººå¼€æºé¡¹ç›®&lt;/h2>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">é¡¹ç›®&lt;/th>
&lt;th style="text-align:left">æè¿°&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">&lt;a href="https://github.com/pinkhello/gopush">GoPush&lt;/a>&lt;/td>
&lt;td style="text-align:left">ä¸€ä¸ªå®æ—¶æ¨é€ç»„ä»¶&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">&lt;a href="https://github.com/pinkhello/spring-boot-starter-dubbo">spring-boot-starter-dubbo&lt;/a>&lt;/td>
&lt;td style="text-align:left">dubbo-spring-boot-è„šæ‰‹æ¶&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">&lt;a href="https://github.com/pinkhello/go-starter">go-starter&lt;/a>&lt;/td>
&lt;td style="text-align:left">GoæœåŠ¡å¼€å‘è„šæ‰‹æ¶&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;hr>
&lt;h2 id="-2021-okr-è¿›åº¦">ğŸš€ 2021 OKR è¿›åº¦&lt;/h2>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">åŠ¨ä½œ&lt;/th>
&lt;th style="text-align:left">è¿›åº¦&lt;/th>
&lt;th style="text-align:left">ç›®æ ‡&lt;/th>
&lt;th style="text-align:left">ç¼ºé™·&lt;/th>
&lt;th style="text-align:left">å…¶ä»–&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">ğŸ‘¯ GoæœåŠ¡å¼€å‘è„šæ‰‹æ¶&lt;/td>
&lt;td style="text-align:left">done&lt;/td>
&lt;td style="text-align:left">&lt;a href="https://github.com/pinkhello/go-starter">go-starter&lt;/a>&lt;/td>
&lt;td style="text-align:left">ut&lt;/td>
&lt;td style="text-align:left">-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">ğŸ’µ GoæœåŠ¡å¼€å‘è„šæ‰‹æ¶å¼€å‘ä¸€ä¸ªç®€å•å‰åç«¯ç³»ç»Ÿ&lt;/td>
&lt;td style="text-align:left">done&lt;/td>
&lt;td style="text-align:left">&lt;a href="http://121.4.242.26">æˆ¿äº§CRMä¿¡æ¯ç³»ç»Ÿ&lt;/a> test/123456&lt;/td>
&lt;td style="text-align:left">-&lt;/td>
&lt;td style="text-align:left">BEé‡‡ç”¨çš„&lt;a href="https://github.com/pinkhello/go-starter">go-starter&lt;/a>, FE é‡‡ç”¨çš„&lt;a href="https://pro.antdv.com/">ant-design-vue-pro&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">ğŸ³ K8SåŸç†&lt;/td>
&lt;td style="text-align:left">running&lt;/td>
&lt;td style="text-align:left">&lt;a href="https://pinkhello.me/categories/k8s/">K8Såšå®¢æˆæ¡£&lt;/a>&lt;/td>
&lt;td style="text-align:left">-&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">ğŸš€ RocketMQ æºä»£ç é˜…è¯»(Java)&lt;/td>
&lt;td style="text-align:left">running&lt;/td>
&lt;td style="text-align:left">&lt;a href="https://pinkhello.me/categories/rocketmq/">RocketMQåšå®¢æˆæ¡£&lt;/a>&lt;/td>
&lt;td style="text-align:left">-&lt;/td>
&lt;td style="text-align:left">-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">ğŸš€ RocketMQ å®¢æˆ·ç«¯ä»£ç é˜…è¯»(Compare Go/Java)&lt;/td>
&lt;td style="text-align:left">running&lt;/td>
&lt;td style="text-align:left">&lt;a href="https://pinkhello.me/categories/rocketmq/">RocketMQåšå®¢æˆæ¡£&lt;/a>&lt;/td>
&lt;td style="text-align:left">-&lt;/td>
&lt;td style="text-align:left">-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">ğŸ˜„ MySQLå®ç°åŸç†è§£æ&lt;/td>
&lt;td style="text-align:left">prepare&lt;/td>
&lt;td style="text-align:left">åšå®¢æˆæ¡£&lt;/td>
&lt;td style="text-align:left">-&lt;/td>
&lt;td style="text-align:left">-&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">ğŸ« æ•°æ®ç»“æ„ä¸ç®—æ³•ä¹‹ç¾&lt;/td>
&lt;td style="text-align:left">prepare&lt;/td>
&lt;td style="text-align:left">åšå®¢æˆæ¡£&lt;/td>
&lt;td style="text-align:left">-&lt;/td>
&lt;td style="text-align:left">-&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
- https://pinkhello.me/about/ - PinkHello, All Rights Reserved</description></item><item><title>å›æœ›K8S ç™½è¯å®¹å™¨</title><link>https://pinkhello.me/posts/18-%E5%9B%9E%E6%9C%9Bk8s-%E7%99%BD%E8%AF%9D%E5%AE%B9%E5%99%A8/</link><pubDate>Sat, 15 Feb 2020 10:16:34 +0800</pubDate><guid>https://pinkhello.me/posts/18-%E5%9B%9E%E6%9C%9Bk8s-%E7%99%BD%E8%AF%9D%E5%AE%B9%E5%99%A8/</guid><description>PinkHello https://pinkhello.me/posts/18-%E5%9B%9E%E6%9C%9Bk8s-%E7%99%BD%E8%AF%9D%E5%AE%B9%E5%99%A8/ -&lt;h1 id="è¿›ç¨‹å¼€å¯">è¿›ç¨‹å¼€å¯&lt;/h1>
&lt;h2 id="å®¹å™¨-åˆ°åº•æ˜¯ä»€ä¹ˆ">å®¹å™¨, åˆ°åº•æ˜¯ä»€ä¹ˆ?&lt;/h2>
&lt;blockquote>
&lt;p>å‰é¢æå‡º: å®¹å™¨æ˜¯ä¸€ç§æ²™ç›’æŠ€æœ¯. å°±æ˜¯ä¸€ä¸ªé›†è£…ç®±, æŠŠåº”ç”¨è£…èµ·æ¥çš„æŠ€æœ¯. è¿™æ ·, åº”ç”¨ä¸åº”ç”¨ä¹‹é—´æœ‰äº†è¾¹ç•Œä¸è‡³äºäº’ç›¸å¹²æ‰°; æœ‰äº†è¿™äº›é›†è£…ç®±, ä¹Ÿæ–¹ä¾¿æ¬æ¥æ¬å».&lt;/p>
&lt;/blockquote>
&lt;p>ç å†œéƒ½çŸ¥é“å¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ä»£ç çš„å¯æ‰§è¡Œé•œåƒ(&lt;code>executable image&lt;/code>). ä¸€æ—¦ç¨‹åºæ‰§è¡Œèµ·æ¥, å†…å­˜æ•°æ®ã€å¯„å­˜å™¨çš„å€¼ã€å †æ ˆçš„æŒ‡ä»¤ã€æ‰“å¼€çš„æ–‡ä»¶ç­‰è¿™äº›é›†åˆæ±‡é›†æˆä¸€ä¸ªç¨‹åºçš„è®¡ç®—æœºæ‰§è¡Œç¯å¢ƒæ€»å’Œ: è¿›ç¨‹.&lt;/p>
&lt;p>&lt;code>è¿›ç¨‹&lt;/code>: é™æ€è¡¨ç°æ˜¯ç¨‹åº, åŠ¨æ€è¡¨ç°è®¡ç®—æœºçš„æ•°æ®å’ŒçŠ¶æ€çš„æ€»å’Œã€‚&lt;/p>
&lt;p>å®¹å™¨çš„æ ¸å¿ƒåŠŸèƒ½, å°±æ˜¯é€šè¿‡çº¦æŸå’Œä¿®æ”¹è¿›ç¨‹çš„åŠ¨æ€è¡¨ç°, ä»è€Œä¸ºå…¶åˆ›é€ ä¸€ä¸ª&amp;quot;è¾¹ç•Œ&amp;quot;.&lt;/p>
&lt;ul>
&lt;li>&lt;code>Cgroups æŠ€æœ¯&lt;/code> åˆ¶é€ çº¦æŸçš„ä¸»è¦æ‰‹æ®µ&lt;/li>
&lt;li>&lt;code>Namespace æŠ€æœ¯&lt;/code> ä¿®æ”¹è¿›ç¨‹è§†å›¾çš„ä¸»è¦æ–¹æ³•&lt;/li>
&lt;/ul>
&lt;p>&lt;code>docker run&lt;/code> , &lt;code>-it&lt;/code> å‘Šè¯‰ &lt;code>Docker&lt;/code> å¯åŠ¨å®¹å™¨å, éœ€è¦åˆ†é…ä¸€ä¸ªæ–‡æœ¬è¾“å…¥/è¾“å‡ºç¯å¢ƒ, ä¹Ÿå°±æ˜¯ &lt;code>TTY&lt;/code>, è·Ÿå®¹å™¨çš„æ ‡å‡†è¾“å…¥ç›¸å…³è”, è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å’Œè¿™ä¸ª&lt;code>Docker&lt;/code>å®¹å™¨è¿›è¡Œäº¤äº’äº†ã€‚è€Œ &lt;code>/bin/sh&lt;/code> å°±æ˜¯æˆ‘ä»¬åœ¨ &lt;code>Docker&lt;/code> å®¹å™¨é‡Œè¿è¡Œçš„ç¨‹åº.&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&amp;gt; docker run -it busybox /bin/sh
/ &lt;span style="color:#228b22">#&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¸®æˆ‘å¯åŠ¨ä¸€ä¸ªå®¹å™¨, åœ¨å®¹å™¨é‡Œæ‰§è¡Œ &lt;code>/bin/sh&lt;/code>, å¹¶ä¸”ç»™æˆ‘åˆ†é…ä¸€ä¸ªå‘½ä»¤è¡Œç»ˆç«¯è·Ÿè¿™ä¸ªå®¹å™¨è¿›è¡Œäº¤äº’, åœ¨è¿™ä¸ªæ‰§è¡Œç¯å¢ƒä¸‹å¯ä»¥å®Œå…¨æ‰§è¡Œ&lt;code>LINUX&lt;/code>å‘½ä»¤,ä¸”ä¸å®¿ä¸»æœºå®Œå…¨éš”ç¦»åœ¨ä¸åŒçš„ä¸–ç•Œä¸­.&lt;/p>
&lt;p>&lt;code>Docker&lt;/code>å¯¹è¢«éš”ç¦»åº”ç”¨çš„è¿›ç¨‹ç©ºé—´åšäº†æ‰‹è„š, ä½¿å¾—è¿™äº›è¿›ç¨‹åªèƒ½çœ‹åˆ°é‡æ–°è®¡ç®—çš„è¿›ç¨‹ç¼–å·, å¯æ˜¯å®é™…ä¸Š, ä»–ä»¬åœ¨å®¿ä¸»æœºçš„æ“ä½œç³»ç»Ÿé‡Œ, è¿˜æ˜¯åŸæ¥çš„ç¬¬&lt;code>N&lt;/code>å·è¿›ç¨‹. è¿™ç§æŠ€æœ¯å°±æ˜¯&lt;code>Linux&lt;/code>å†…éƒ¨çš„&lt;code>Namespace&lt;/code>æœºåˆ¶ã€‚&lt;/p>
&lt;p>&lt;code>Namespace&lt;/code> çš„ä½¿ç”¨æ–¹å¼ä¹Ÿéå¸¸æœ‰æ„æ€ï¼šå®ƒå…¶å®åªæ˜¯ &lt;code>Linux&lt;/code> åˆ›å»ºæ–°è¿›ç¨‹çš„ä¸€ä¸ªå¯é€‰å‚æ•°ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ &lt;code>Linux&lt;/code> ç³»ç»Ÿä¸­åˆ›å»ºçº¿ç¨‹çš„ç³»ç»Ÿè°ƒç”¨æ˜¯ &lt;code>clone()&lt;/code>ï¼Œæ¯”å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">int &lt;span style="color:#00688b">pid&lt;/span> = clone(main_function, stack_size, SIGCHLD, NULL);
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œå¹¶ä¸”è¿”å›çš„å®ƒçš„è¿›ç¨‹å· pidã€‚&lt;/p>
&lt;p>å½“è°ƒç”¨ clone() ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹æ—¶ï¼Œå°±å¯ä»¥åœ¨å‚æ•°ä¸­æŒ‡å®š CLONE_NEWPID å‚æ•°ï¼Œæ¯”å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">int &lt;span style="color:#00688b">pid&lt;/span> = clone(main_function, stack_size, CLONE_NEWPID | SIGCHLD, NULL);
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ—¶ï¼Œæ–°åˆ›å»ºçš„è¿™ä¸ªè¿›ç¨‹å°±ä¼šçœ‹åˆ°ä¸€ä¸ªå…¨æ–°çš„è¿›ç¨‹ç©ºé—´ï¼Œåœ¨è¿™ä¸ªè¿›ç¨‹ç©ºé—´é‡Œï¼Œä»–çš„&lt;code>PID&lt;/code>æ˜¯&lt;code>1&lt;/code>ï¼Œä¹‹æ‰€ä»¥è¯´çœ‹åˆ°ï¼Œæ˜¯å› ä¸ºæ˜¯ä¸€ä¸ªéšœçœ¼æ³•ï¼Œåœ¨å®¿ä¸»æœºçœŸå®çš„è¿›ç¨‹ç©ºé—´é‡Œï¼Œè¿™ä¸ª&lt;code>PID&lt;/code>è¿˜æ˜¯çœŸå®çš„æ•°å€¼.å½“å¤šæ¬¡æ‰§è¡Œ&lt;code>clone()&lt;/code>è°ƒç”¨, ä¼šåˆ›å»ºå¤šä¸ª &lt;code>PID Namespace&lt;/code>, æ¯ä¸ª Namespace é‡Œçš„åº”ç”¨è¿›ç¨‹ï¼Œéƒ½ä¼šè®¤ä¸ºè‡ªå·±æ˜¯å½“å‰å®¹å™¨é‡Œçš„ç¬¬&lt;code>1&lt;/code>å·è¿›ç¨‹ï¼Œçœ‹ä¸ä»…&lt;code>å®¿ä¸»æœº&lt;/code>çš„ä¹Ÿçœ‹ä¸åˆ°å…¶ä»–çš„&lt;code>Namespace&lt;/code>.&lt;/p>
&lt;blockquote>
&lt;p>å¤‡æ³¨:
Linuxæä¾›äº†ä¸åŒçš„Namespaceï¼Œå»åº”å¯¹ä¸åŒçš„è¿›ç¨‹ä¸Šä¸‹æ–‡&lt;/p>
&lt;ul>
&lt;li>PID Namespace&lt;/li>
&lt;li>Mount Namespace&lt;/li>
&lt;li>IPC Namespace&lt;/li>
&lt;li>UTS Namespace&lt;/li>
&lt;li>Network Namespace&lt;/li>
&lt;li>User Namespace&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>Dockerå®¹å™¨ï¼Œå°±æ˜¯åœ¨åˆ›å»ºå®¹å™¨è¿›ç¨‹æ—¶å€™ï¼ŒæŒ‡å®šäº†è¿™ä¸ªè¿›ç¨‹æ‰€éœ€è¦å¯ç”¨çš„ä¸€ç»„ Namespace å‚æ•°, è¿™æ ·, å®¹å™¨å°±åªèƒ½ çœ‹åˆ° å½“å‰ Namespace æ‰€é™å®šçš„ èµ„æºã€æ–‡ä»¶ã€è®¾å¤‡ã€çŠ¶æ€ æˆ–è€… é…ç½®ã€‚æ‰€ä»¥è¯´, å®¹å™¨ï¼Œå…¶å®æ˜¯ä¸€ç§ç‰¹æ®Šçš„è¿›ç¨‹ã€‚&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E5%9B%9E%E6%9C%9BK8S/%E5%AE%B9%E5%99%A8%E4%B8%8E%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.jpg" alt="å®¹å™¨ä¸è™šæ‹Ÿæœºå·¥ä½œåŸç†">&lt;/p>
&lt;p>å¯ä»¥çœ‹å‡ºå›¾ä¸­ &lt;code>Hypervisor&lt;/code> æ˜¯è™šæ‹Ÿæœºä¸»è¦éƒ¨åˆ†ã€‚å®ƒé€šè¿‡ç¡¬ä»¶è™šæ‹ŸåŒ–åŠŸèƒ½ï¼Œæ¨¡æ‹Ÿå‡ºäº†è¿è¡Œä¸€ä¸ªæ“ä½œç³»ç»Ÿéœ€è¦çš„å„ç§ç¡¬ä»¶ï¼Œæ¯”å¦‚ CPUã€å†…å­˜ã€I/Oè®¾å¤‡ç­‰ã€‚ è¿™æ ·ï¼Œç”¨æˆ·çš„è¿›ç¨‹å¯ä»¥åœ¨è¿™ä¸ªè™šæ‹Ÿçš„æœºå™¨ä¸­ï¼Œåªèƒ½çœ‹åˆ°è™šæ‹Ÿç¯å¢ƒçš„æ–‡ä»¶å’Œç›®å½•ä»¥åŠè®¾å¤‡ï¼Œèµ·åˆ°éš”ç¦»çš„ä½œç”¨ã€‚
è€Œå³è¾¹çš„å›¾ï¼Œ&lt;code>Docker Engine&lt;/code>æ›¿æ¢äº†&lt;code>Hypervisor&lt;/code>,ä½†æ˜¯æœ‰ä¸ªæ ¸å¿ƒä¸€ç‚¹&lt;code>Docker Engine&lt;/code>å¹¶ä¸å°‘&lt;code>è½»é‡çº§&lt;/code>è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚&lt;/p>
&lt;p>åœ¨&lt;code>Linux&lt;/code>çš„&lt;code>Namespace&lt;/code>å·¥ä½œæ–¹å¼å, åœ¨ä½¿ç”¨&lt;code>Docker&lt;/code>çš„æ—¶å€™,&lt;code>Docker&lt;/code>å¹¶æ²¡æœ‰ä¸€ä¸ªçœŸæ­£çš„&lt;code>Dockerå®¹å™¨&lt;/code>è¿è¡Œåœ¨å®¿ä¸»æœºé‡Œé¢ï¼Œè€Œæ˜¯&lt;code>Docker&lt;/code>å¯åŠ¨è¿˜æ˜¯åŸæ¥çš„åº”ç”¨è¿›ç¨‹ï¼Œåªä¸è¿‡åœ¨åˆ›å»ºè¿™äº›è¿›ç¨‹æ—¶å€™ï¼ŒåŠ ä¸Šäº†å„ç§&lt;code>Namespace&lt;/code>å‚æ•°ï¼Œä½¿å¾—è¿™äº›è¿›ç¨‹è§‰å¾—è‡ªå·±æ˜¯åœ¨å„è‡ªçš„&lt;code>PID Namespace&lt;/code>æ˜¯ç¬¬ä¸€å·è¿›ç¨‹ï¼Œå¹¶ä¸”åªèƒ½çœ‹åˆ°å„è‡ª&lt;code>Mount Namespace&lt;/code>é‡ŒæŒ‚åœ¨çš„ç›®å½•å’Œæ–‡ä»¶ã€åªèƒ½è®¿é—®å„è‡ª&lt;code>Network Namespace&lt;/code>é‡Œçš„ç½‘ç»œè®¾å¤‡.&lt;/p>
&lt;h1 id="éš”ç¦»å’Œé™åˆ¶">éš”ç¦»å’Œé™åˆ¶&lt;/h1>
&lt;p>å‰é¢æåˆ°å®ç° &lt;code>éš”ç¦»&lt;/code> çš„æ‰‹æ®µ: &lt;code>Namespace&lt;/code>. &lt;code>Namespace&lt;/code> æŠ€æœ¯å®é™…ä¿®æ”¹äº†åº”ç”¨è¿›ç¨‹çœ‹å¾…æ•´ä¸ªè®¡ç®—æœºçš„&amp;quot;è§†å›¾&amp;quot;ï¼Œå³å®ƒçš„&amp;quot;è§†çº¿&amp;quot;è¢«æ“ä½œç³»ç»Ÿåšäº†é™åˆ¶ï¼Œåªèƒ½&amp;quot;çœ‹åˆ°&amp;quot;æŸäº›çŸ¥é“çš„å†…å®¹.&lt;/p>
&lt;h2 id="ä¸ºä»€ä¹ˆéœ€è¦éš”ç¦»">ä¸ºä»€ä¹ˆéœ€è¦&lt;code>éš”ç¦»&lt;/code>&lt;/h2>
&lt;ul>
&lt;li>é¦–å…ˆï¼Œæ—¢ç„¶å®¹å™¨åªæ˜¯è¿è¡Œåœ¨å®¿ä¸»æœºä¸Šçš„ä¸€ç§ç‰¹æ®Šçš„è¿›ç¨‹ï¼Œé‚£ä¹ˆå¤šä¸ªå®¹å™¨ä¹‹é—´ä½¿ç”¨çš„å°±è¿˜æ˜¯åŒä¸€ä¸ªå®¿ä¸»æœºçš„æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚&lt;/li>
&lt;li>åœ¨Linuxå†…æ ¸ä¸­ï¼Œè¿˜æœ‰è®¸å¤šèµ„æºå’Œå¯¹è±¡æ˜¯ä¸èƒ½è¢« Namespace åŒ–çš„ï¼Œæœ€å…¸å‹çš„ä¾‹å­æ˜¯ï¼šæ—¶é—´
&lt;blockquote>
&lt;p>å®¹å™¨ä¸­ä½¿ç”¨ settimeofday(2) ç³»ç»Ÿè°ƒç”¨ä¿®æ”¹äº†æ—¶é—´ï¼Œæ•´ä¸ªå®¿ä¸»æœºçš„æ—¶é—´éƒ½ä¼šè¢«éšä¹‹ä¿®æ”¹ã€‚è¿™æ ·è‚¯å®šä¸é¢„æœŸä¸ç¬¦&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;h2 id="ä¸Šè¿°æ˜¯ä¸ºä»€ä¹ˆè¦éš”ç¦»ä¸‹é¢è¯´ä¸ºä»€ä¹ˆè¦é™åˆ¶è¿™ä¸ªé—®é¢˜">ä¸Šè¿°æ˜¯ä¸ºä»€ä¹ˆè¦&lt;code>éš”ç¦»&lt;/code>ï¼Œä¸‹é¢è¯´ä¸ºä»€ä¹ˆè¦&lt;code>é™åˆ¶&lt;/code>è¿™ä¸ªé—®é¢˜ã€‚&lt;/h2>
&lt;blockquote>
&lt;p>åœ¨å®¿ä¸»æœºä¸Š,å¯åŠ¨å¤šä¸ªå®¹å™¨éƒ½æ˜¯åœ¨å®¿ä¸»æœºä¸Šçš„ç‰¹æ®Šè¿›ç¨‹,ä½†æ˜¯åœ¨ä¸åŒçš„è¿›ç¨‹ä¹‹é—´, èµ„æºï¼ˆCPUã€å†…å­˜ï¼‰è¿˜æ˜¯å¯èƒ½è¢«å…¶ä»–è¿›ç¨‹ï¼ˆæˆ–è€…å®¹å™¨ï¼‰å ç”¨çš„ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>Linux Cgroups&lt;/code>å…¨ç§°&lt;code>Linux Control Group&lt;/code> å°±æ˜¯ Linux å†…æ ¸ä¸­ç”¨æ¥ä¸ºè¿›ç¨‹è®¾ç½®èµ„æºé™åˆ¶çš„ä¸€ä¸ªé‡è¦åŠŸèƒ½, é™åˆ¶ä¸€ä¸ªè¿›ç¨‹ç»„èƒ½å¤Ÿä½¿ç”¨çš„èµ„æºä¸Šé™, åŒ…æ‹¬ CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œå¸¦å®½ ç­‰ç­‰ã€‚æ­¤å¤– &lt;code>Cgroups&lt;/code> è¿˜èƒ½å¤Ÿå¯¹è¿›ç¨‹è¿›è¡Œä¼˜å…ˆçº§è®¾ç½®ã€å®¡è®¡ï¼Œä»¥åŠå°†è¿›ç¨‹æŒ‚èµ·å’Œæ¢å¤æ“ä½œã€‚&lt;/p>
&lt;p>åœ¨&lt;code>Linux&lt;/code>ä¸­,&lt;code>Cgroups&lt;/code>ç»™ç”¨æˆ·æš´éœ²å‡ºæ¥çš„æ“ä½œæ¥å£æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼Œå³å®ƒä»¥æ–‡ä»¶å’Œç›®å½•çš„æ–¹å¼ç»„ç»‡åœ¨æ“ä½œç³»ç»Ÿçš„ &lt;code>/sys/fs/cgroup&lt;/code> è·¯å¾„ä¸‹&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># Ubuntu ä¸‹ mount æŒ‡ä»¤å±•ç¤ºå‡ºæ¥&lt;/span>
&amp;gt; mount -t cgroup
cpuset on /sys/fs/cgroup/cpuset &lt;span style="color:#658b00">type&lt;/span> cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)
cpu on /sys/fs/cgroup/cpu &lt;span style="color:#658b00">type&lt;/span> cgroup (rw,nosuid,nodev,noexec,relatime,cpu)
cpuacct on /sys/fs/cgroup/cpuacct &lt;span style="color:#658b00">type&lt;/span> cgroup (rw,nosuid,nodev,noexec,relatime,cpuacct)
blkio on /sys/fs/cgroup/blkio &lt;span style="color:#658b00">type&lt;/span> cgroup (rw,nosuid,nodev,noexec,relatime,blkio)
memory on /sys/fs/cgroup/memory &lt;span style="color:#658b00">type&lt;/span> cgroup (rw,nosuid,nodev,noexec,relatime,memory)
...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°åœ¨ &lt;code>/sys/fs/cgroup&lt;/code> ä¸‹é¢åˆå¾ˆå¤šè¯¸å¦‚&lt;code>cpuset&lt;/code>ã€&lt;code>cpu&lt;/code>ã€&lt;code>memory&lt;/code>è¿™æ ·çš„å­ç›®,ä¹Ÿå«å­ç³»ç»Ÿ.è¿™äº›éƒ½æ˜¯å¯ä»¥è¢«&lt;code>Cgroups&lt;/code>è¿›è¡Œé™åˆ¶çš„èµ„æºç§ç±»,è€Œåœ¨å­ç³»ç»Ÿå¯¹åº”çš„èµ„æºç§ç±»ä¸‹, ä½ å°±å¯ä»¥çœ‹åˆ°è¯¥ç±»èµ„æºå…·ä½“å¯ä»¥è¢«é™åˆ¶çš„æ–¹æ³•ã€‚æ¯”å¦‚, å¯¹&lt;code>CPU&lt;/code>å­ç³»ç»Ÿæ¥è¯´ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°å‡ ä¸ªé…ç½®æ–‡ä»¶ï¼Œè¿™ä¸ªæŒ‡ä»¤æ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&amp;gt; ls /sys/fs/cgroup/cpu
cgroup.clone_children cpu.cfs_period_us cpu.rt_period_us cpu.shares notify_on_release
cgroup.procs cpu.cfs_quota_us cpu.rt_runtime_us cpu.stat tasks
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¾“å‡ºä¸­&lt;code>cfs_period&lt;/code>å’Œ&lt;code>cfs_quota&lt;/code>è¿™æ ·çš„å…³é”®è¯ã€‚ç»„åˆä½¿ç”¨,é™åˆ¶è¿›ç¨‹åœ¨é•¿åº¦ä¸º&lt;code>cfs_period&lt;/code>çš„ä¸€æ®µæ—¶é—´å†…,åªèƒ½è¢«åˆ†é…åˆ°æ€»é‡ä¸º&lt;code>cfs_quota&lt;/code>çš„&lt;code>CPU&lt;/code>æ—¶é—´&lt;/p>
&lt;p>å¦‚ä½•ä½¿ç”¨&lt;code>cgroups&lt;/code>å‘¢ï¼Ÿ&lt;/p>
&lt;p>åœ¨å¯¹åº”çš„å­ç³»ç»Ÿçš„ä¸‹é¢åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œæ¯”å¦‚é™åˆ¶CPUè¿›å…¥ &lt;code>/sys/fs/cgroups/cpu&lt;/code> ç›®å½•ä¸‹&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&amp;gt; &lt;span style="color:#658b00">cd&lt;/span> /sys/fs/cgroups/cpu
&amp;gt; mkdir container
&amp;gt; ls container/
cgroup.clone_children cpu.cfs_period_us cpu.rt_period_us cpu.shares notify_on_releasecgroup.procs cpu.cfs_quota_us cpu.rt_runtime_us cpu.stat tasks
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªç›®å½•å°±ç§°ä¸ºä¸€ä¸ªæ§åˆ¶ç»„ï¼Œæ“ä½œç³»ç»Ÿè‡ªåŠ¨åœ¨æ–°åˆ›å»ºçš„ &lt;code>container&lt;/code> ç›®å½•ä¸‹ï¼Œè‡ªåŠ¨ç”Ÿæˆè¯¥å­ç³»ç»Ÿçš„å¯¹åº”çš„èµ„æºé™åˆ¶æ–‡ä»¶.&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># æŸ¥çœ‹ container æ§åˆ¶ç»„çš„ CPU quota è¿˜æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼š-1ï¼ŒCPU period åˆ™æ˜¯é»˜è®¤çš„ 100 ms (100000 us)&lt;/span>
&amp;gt; cat /sys/fs/cgroup/cpu/container/cpu.cfs_quota_us
-1
&amp;gt; cat /sys/fs/cgroup/cpu/container/cpu.cfs_period_us
&lt;span style="color:#b452cd">100000&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‘ &lt;code>container&lt;/code> ç»„é‡Œçš„ &lt;code>cfs_quota&lt;/code> æ–‡ä»¶å†™å…¥ 20 msï¼ˆ20000 usï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22">#æ„å‘³ç€åœ¨æ¯ 100 ms çš„æ—¶é—´é‡Œï¼Œè¢«è¯¥æ§åˆ¶ç»„é™åˆ¶çš„è¿›ç¨‹åªèƒ½ä½¿ç”¨ 20 ms çš„ CPU æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¿›ç¨‹åªèƒ½ä½¿ç”¨åˆ° 20% çš„ CPU å¸¦å®½ã€‚&lt;/span>
&amp;gt; &lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#b452cd">20000&lt;/span> &amp;gt; /sys/fs/cgroup/cpu/container/cpu.cfs_quota_us
&lt;span style="color:#228b22"># ç°åœ¨æŠŠéœ€è¦è¢«é™åˆ¶çš„è¿›ç¨‹çš„ PID å†™å…¥ container ç»„é‡Œçš„ tasks æ–‡ä»¶ï¼Œä¸Šé¢çš„è®¾ç½®å°±ä¼šå¯¹è¯¥è¿›ç¨‹ç”Ÿæ•ˆäº†&lt;/span>
&amp;gt; &lt;span style="color:#658b00">echo&lt;/span> &lt;span style="color:#cd5555">${&lt;/span>&lt;span style="color:#00688b">éœ€è¦é™åˆ¶çš„è¿›ç¨‹PID&lt;/span>&lt;span style="color:#cd5555">}&lt;/span> &amp;gt; /sys/fs/cgroup/cpu/container/tasks
&lt;span style="color:#228b22"># top æŒ‡ä»¤æŸ¥çœ‹, è®¡ç®—æœºCPUä½¿ç”¨ç‡ç«‹åˆ»é™ä½åˆ°20%&lt;/span>
&amp;gt; top
%Cpu0 : 20.3 us, 0.0 sy, 0.0 ni, 79.7 id, 0.0 wa, 0.0 hi, 0.0 si, 0.0 st
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ ·, &lt;code>Cgroups&lt;/code> çš„æ¯ä¸€ä¸ªå­ç³»ç»Ÿéƒ½æœ‰å…¶ç‹¬æœ‰çš„èµ„æºé™åˆ¶èƒ½åŠ›&lt;/p>
&lt;ul>
&lt;li>&lt;code>cpu&lt;/code>, ä¸ºè¿›ç¨‹è®¾å®š&lt;code>cpu&lt;/code>ä½¿ç”¨çš„é™åˆ¶;&lt;/li>
&lt;li>&lt;code>blkio&lt;/code>, ä¸ºå—è®¾å¤‡è®¾å®š I/O é™åˆ¶, ä¸€èˆ¬ç”¨æˆ·ç£ç›˜ç­‰è®¾å¤‡;&lt;/li>
&lt;li>&lt;code>cpuset&lt;/code>, ä¸ºè¿›ç¨‹åˆ†é…å•ç‹¬çš„ CPUæ ¸å’Œå¯¹åº”çš„å†…å­˜èŠ‚ç‚¹;&lt;/li>
&lt;li>&lt;code>memory&lt;/code>, ä¸ºè¿›ç¨‹è®¾å®šå†…å­˜ä½¿ç”¨çš„é™åˆ¶&lt;/li>
&lt;/ul>
&lt;p>&lt;code>Linux Cgroups&lt;/code>çš„è®¾è®¡ï¼Œå®ƒå°±æ˜¯&lt;code>ä¸€ä¸ªå­ç³»ç»Ÿçš„ç›®å½•åŠ ä¸Šä¸€ç»„èµ„æºé™åˆ¶æ–‡ä»¶çš„ç»„åˆ&lt;/code>ã€‚è€Œå¯¹äº&lt;code>Docker&lt;/code>ç­‰&lt;code>Linux&lt;/code>å®¹å™¨é¡¹ç›®æ¥è¯´ï¼Œå®ƒä»¬åªéœ€è¦åœ¨æ¯ä¸ªå­ç³»ç»Ÿä¸‹é¢ï¼Œä¸ºæ¯ä¸ªå®¹å™¨åˆ›å»ºä¸€ä¸ªæ§åˆ¶ç»„(å³åˆ›å»ºä¸€ä¸ªæ–°ç›®å½•), ç„¶ååœ¨å¯åŠ¨è¿›ç¨‹ä¹‹åï¼ŒæŠŠè¿™ä¸ªè¿›ç¨‹çš„&lt;code>PID&lt;/code>å†™åˆ°å¯¹åº”çš„æ§åˆ¶ç»„çš„&lt;code>tasks&lt;/code>æ–‡ä»¶ä¸­.&lt;/p>
&lt;p>é‚£ä¹ˆåœ¨&lt;code>Docker&lt;/code>å®¹å™¨ä¸­ï¼Œå¦‚ä½•å¯åŠ¨çš„æ—¶å€™çŸ¥é“æ§åˆ¶ç»„ä¸‹é¢çš„èµ„æºå¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># docker run æ—¶çš„å‚æ•°æŒ‡å®š&lt;/span>
&amp;gt; docker run -it --cpu-period=&lt;span style="color:#b452cd">100000&lt;/span> --cpu-quota=&lt;span style="color:#b452cd">20000&lt;/span> ubuntu /bin/bash
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨å¯åŠ¨è¿™ä¸ªå®¹å™¨åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;code>Cgroups&lt;/code> æ–‡ä»¶ç³»ç»Ÿä¸‹ï¼Œ&lt;code>CPU&lt;/code>å­ç³»ç»Ÿä¸­, &lt;code>docker&lt;/code>è¿™ä¸ªæ§åˆ¶ç»„é‡Œçš„èµ„æºé™åˆ¶æ–‡ä»¶å†…å®¹æ¥ç¡®è®¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&amp;gt; cat /sys/fs/cgroup/cpu/docker/5d5c9f67d/cpu.cfs_period_us
&lt;span style="color:#b452cd">100000&lt;/span>
&amp;gt; cat /sys/fs/cgroup/cpu/docker/5d5c9f67d/cpu.cfs_quota_us
&lt;span style="color:#b452cd">20000&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™å°±æ„å‘³ç€è¿™ä¸ª&lt;code>Docker&lt;/code>å®¹å™¨,åªèƒ½ä½¿ç”¨åˆ° &lt;code>20%&lt;/code> çš„&lt;code>CPUå¸¦å®½&lt;/code>&lt;/p>
&lt;p>æ ¸å¿ƒæ¦‚å¿µï¼š&lt;/p>
&lt;blockquote>
&lt;p>å®¹å™¨å°±æ˜¯ä¸€ä¸ª&lt;code>å•è¿›ç¨‹&lt;/code>æ¨¡å‹. ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„&lt;code>Docker&lt;/code>å®¹å™¨,å…¶å®å°±æ˜¯å¯ç”¨äº†å¤šä¸ª&lt;code>Linux Namespace&lt;/code>çš„åº”ç”¨è¿›ç¨‹,è€Œè¿™ä¸ªè¿›ç¨‹èƒ½å¤Ÿä½¿ç”¨çš„èµ„æºé‡,åˆ™å—&lt;code>Cgroups&lt;/code>é…ç½®çš„é™åˆ¶&lt;/p>
&lt;/blockquote>
&lt;p>ä¸€ä¸ªå®¹å™¨çš„æœ¬è´¨æ˜¯ä¸€ä¸ªè¿›ç¨‹, ç”¨æˆ·çš„åº”ç”¨è¿›ç¨‹å®é™…ä¸Šå°±æ˜¯å®¹å™¨çš„&lt;code>PID=1&lt;/code>çš„è¿›ç¨‹, ä¹Ÿæ˜¯å…¶ä»–åç»­åˆ›å»ºæ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ã€‚è¿™å°±æ„å‘³ç€ï¼Œåœ¨ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œä½ æ²¡æœ‰åŠæ³•åŒæ—¶è¿è¡Œä¸¤ä¸ªä¸åŒçš„åº”ç”¨ï¼Œé™¤éä½ èƒ½äº‹å…ˆæ‰¾åˆ°å…¬å…±çš„&lt;code>PID=1&lt;/code>çš„ç¨‹åºå……å½“ä¸¤ä¸ªä¸åŒåº”ç”¨çš„çˆ¶è¿›ç¨‹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šä¼šä½¿ç”¨&lt;code>systemd&lt;/code>æˆ–è€…&lt;code>supervisord&lt;/code>ä»£ç†åº”ç”¨æœ¬èº«ä½œä¸ºå®¹å™¨çš„å¯åŠ¨è¿›ç¨‹ã€‚&lt;/p>
&lt;p>å®¹å™¨çš„æœ¬èº«è®¾è®¡ï¼Œå¸Œæœ›å®¹å™¨å’Œåº”ç”¨èƒ½å¤ŸåŒç”Ÿå‘½å‘¨æœŸï¼Œè¿™ä¸ªå¯¹åç»­çš„å®¹å™¨ç¼–æ’éå¸¸é‡è¦ã€‚&lt;/p>
&lt;p>&lt;code>Linux&lt;/code>ä¸‹çš„&lt;code>/proc&lt;/code>ç›®å½•å­˜å‚¨çš„æ˜¯çºªå½•å½“å‰å†…æ ¸è¿è¡ŒçŠ¶æ€çš„ä¸€äº›åˆ—ç‰¹æ®Šæ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è®¿é—®è¿™äº›æ–‡ä»¶ï¼ŒæŸ¥çœ‹ç³»ç»Ÿä»¥åŠå½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„ä¿¡æ¯, æ¯”å¦‚ CPUä½¿ç”¨ã€å†…å­˜å ç”¨ï¼Œ&lt;code>top&lt;/code>æŒ‡ä»¤æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯çš„ä¸»è¦æ•°æ®æ¥æº. åœ¨å®¹å™¨ä¸­æ‰§è¡Œ top æŒ‡ä»¤, å‘ç°å®¿ä¸»æœºçš„CPUå’Œå†…å­˜çš„æ•°æ®ï¼Œä¸æ˜¯å½“å‰å®¹å™¨çš„æ•°æ®ã€‚&lt;/p>
&lt;blockquote>
&lt;p>é€ æˆè¿™ä¸ªé—®é¢˜çš„åŸå› å°±æ˜¯ï¼Œ&lt;code>/proc&lt;/code> æ–‡ä»¶ç³»ç»Ÿå¹¶ä¸çŸ¥é“ç”¨æˆ·é€šè¿‡ &lt;code>Cgroups&lt;/code> ç»™è¿™ä¸ªå®¹å™¨åšäº†ä»€ä¹ˆæ ·çš„èµ„æºé™åˆ¶ï¼Œå³ï¼š&lt;code>/proc&lt;/code> æ–‡ä»¶ç³»ç»Ÿä¸äº†è§£ &lt;code>Cgroups&lt;/code> é™åˆ¶çš„å­˜åœ¨ã€‚
å½“ç„¶å¯ä»¥å€ŸåŠ©å…¶ä»– &lt;code>lxcfs&lt;/code> å¯è§£å†³æ­¤é—®é¢˜&lt;/p>
&lt;/blockquote>
&lt;h1 id="å®¹å™¨é•œåƒ">å®¹å™¨é•œåƒ&lt;/h1>
&lt;h2 id="å®¹å™¨ä¸­çš„è¿›ç¨‹çœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿåˆæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢">å®¹å™¨ä¸­çš„è¿›ç¨‹çœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿåˆæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿ&lt;/h2>
&lt;p>å˜¿å˜¿, &lt;code>Mount Namespace&lt;/code> å¼€å¯åï¼Œå®¹å™¨è¿›è¡Œçœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿä¹Ÿè·Ÿå®¿ä¸»æœºå®Œå…¨ä¸€æ ·ã€‚&lt;code>Mount Namespace&lt;/code> ä¿®æ”¹çš„ï¼Œæ˜¯å®¹å™¨è¿›ç¨‹å¯¹æ–‡ä»¶ç³»ç»Ÿ&amp;quot;æŒ‚è½½ç‚¹&amp;quot;çš„è®¤çŸ¥ã€‚&lt;code>Mount Namespace&lt;/code> è·Ÿå…¶ä»–çš„ &lt;code>Namespace&lt;/code> çš„ä½¿ç”¨ç•¥æœ‰ä¸åŒçš„åœ°æ–¹ï¼šå®ƒå¯¹å®¹å™¨è¿›ç¨‹è§†å›¾çš„æ”¹å˜ï¼Œä¸€å®šæ˜¯ä¼´éšç€æŒ‚è½½æ“ä½œï¼ˆ&lt;code>mount&lt;/code>ï¼‰æ‰èƒ½ç”Ÿæ•ˆã€‚&lt;/p>
&lt;p>åœ¨&lt;code>Linux&lt;/code>æ“ä½œç³»ç»Ÿä¸­ï¼Œæœ‰ä¸€ä¸ª &lt;code>chroot&lt;/code> çš„å‘½ä»¤ï¼š&lt;code>change root file system&lt;/code>ï¼Œ æ”¹å˜è¿›ç¨‹çš„æ ¹ç›®å½•åˆ°ä½ æŒ‡å®šçš„ä½ç½®ã€‚è¿™ä¸ª &lt;code>Mount Namespace&lt;/code> æ­£æ˜¯åŸºäºå¯¹ &lt;code>chroot&lt;/code> çš„ä¸æ–­æ”¹è‰¯çš„ï¼Œä¹Ÿæ˜¯ &lt;code>Linux&lt;/code> æ“ä½œç³»ç»Ÿé‡Œç¬¬ä¸€ä¸ª &lt;code>Namespace&lt;/code>ã€‚
è€ŒæŒ‚è½½åœ¨å®¹å™¨æ ¹ç›®å½•ä¸Šï¼Œç”¨æ¥ä¸ºå®¹å™¨è¿›ç¨‹æä¾›éš”ç¦»åæ‰§è¡Œç¯å¢ƒçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå°±æ˜¯æ‰€è°“çš„å®¹å™¨é•œåƒã€‚å®ƒè¿˜æœ‰ä¸€ä¸ªæ›´ä¸“ä¸šçš„åå­—å«åš &lt;code>rootfs&lt;/code>ï¼ˆæ ¹æ–‡ä»¶ç³»ç»Ÿï¼‰&lt;/p>
&lt;p>ä¸€ä¸ªå¸¸è§çš„ &lt;code>rootfs&lt;/code>ï¼ŒåŒ…å«ä¸€äº›ç›®å½•å’Œæ–‡ä»¶:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&amp;gt; ls /
bin dev etc home lib lib64 mnt opt proc root run sbin sys tmp usr var
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è€Œè¿›å…¥å®¹å™¨ä¹‹åæ‰§è¡Œçš„ &lt;code>/bin/bash&lt;/code>, å°±æ˜¯ &lt;code>/bin&lt;/code> ç›®å½•ä¸‹çš„å¯æ‰§è¡Œæ–‡ä»¶, ä¸å®¿ä¸»æœºçš„ &lt;code>/bin/bash&lt;/code> å®Œå…¨ä¸åŒã€‚&lt;/p>
&lt;p>å¯¹äº &lt;code>Docker&lt;/code> é¡¹ç›®æ¥è¯´ï¼Œå®ƒæœ€æ ¸å¿ƒçš„åŸç†å°±æ˜¯ä¸ºå¸¦åˆ›å»ºçš„ç”¨æˆ·è¿›ç¨‹ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯ç”¨ &lt;code>Linux Namespace&lt;/code> é…ç½®ï¼›&lt;/li>
&lt;li>è®¾ç½®æŒ‡å®šçš„ &lt;code>Cgroups&lt;/code> å‚æ•°ï¼›&lt;/li>
&lt;li>åˆ‡æ¢è¿›ç¨‹çš„æ ¹ç›®å½•ï¼ˆ&lt;code>Change Root&lt;/code>ï¼‰.&lt;/li>
&lt;/ul>
&lt;p>è¿™æ ·ï¼Œä¸€ä¸ªå®Œæ•´çš„å®¹å™¨å°±è¯ç”Ÿäº†ã€‚ä¸è¿‡ï¼Œåœ¨&lt;code>Docker&lt;/code>é¡¹ç›®åœ¨æœ€åä¸€æ­¥çš„åˆ‡æ¢ä¸Šä¼˜å…ˆä½¿ç”¨&lt;code>pivot_root&lt;/code>ç³»ç»Ÿè°ƒç”¨,å¦‚æœç³»ç»Ÿä¸æ”¯æŒï¼Œæ‰ä¼šä½¿ç”¨&lt;code>chroot&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>rootfs&lt;/code>åªæ˜¯æ“ä½œç³»ç»Ÿæ‰€åŒ…å«çš„æ–‡ä»¶ã€é…ç½®å’Œç›®å½•ï¼Œå¹¶ä¸åŒ…å«æ“ä½œç³»ç»Ÿå†…æ ¸ã€‚åœ¨&lt;code>Linux&lt;/code>æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿™ä¸¤éƒ¨åˆ†åˆ†å¼€å­˜æ”¾çš„ã€‚æ“ä½œç³»ç»Ÿåªåœ¨å¼€æœºå¯åŠ¨çš„æ—¶å€™æ‰ä¼šåŠ è½½æŒ‡å®šç‰ˆæœ¬çš„å†…æ ¸é•œåƒã€‚
æ‰€ä»¥è¯´&lt;code>rootfs&lt;/code>åªæ˜¯æ“ä½œç³»ç»Ÿçš„&amp;quot;èº¯å£³&amp;quot;ï¼Œå¹¶æ²¡æœ‰æ“ä½œç³»ç»Ÿçš„&amp;quot;çµé­‚&amp;quot;ï¼ŒåŒä¸€å°æœºå™¨çš„æ‰€æœ‰å®¹å™¨ï¼Œéƒ½å…±äº«å®¿ä¸»æœºæ“ä½œç³»ç»Ÿçš„å†…æ ¸ã€‚å› ä¸ºå…±äº«çš„å®¿ä¸»æœºå†…æ ¸ï¼Œåº”ç”¨ç¨‹åºéœ€è¦é…ç½®çš„å†…æ ¸å‚æ•°ã€åŠ è½½é¢å¤–çš„å†…æ ¸æ¨¡å—ï¼Œä»¥åŠè·Ÿå†…æ ¸è¿›è¡Œçš„ç›´æ¥äº¤äº’ã€‚å†…æ ¸ç›¸å¯¹äºä¸»æœºä¸Šæ‰€æœ‰å®¹å™¨çš„æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ã€‚&lt;/p>
&lt;p>ç”±äº&lt;code>rootfs&lt;/code>çš„å­˜åœ¨,å®¹å™¨æœ‰äº†æœ€é‡è¦çš„ç‰¹æ€§: ä¸€è‡´æ€§&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯å®¹å™¨çš„ä¸€è‡´æ€§å‘¢">ä»€ä¹ˆæ˜¯å®¹å™¨çš„ä¸€è‡´æ€§å‘¢ï¼Ÿ&lt;/h2>
&lt;p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­ã€æœ¬åœ°ç¯å¢ƒã€äº‘ç¯å¢ƒã€æ‰“åŒ…æ˜¯ä¸€ä¸ªååˆ†ç—›è‹¦çš„è¿‡ç¨‹ï¼ˆå¯¹äº&lt;code>PAAS&lt;/code>ç¯å¢ƒæ¥è¯´ï¼‰ï¼Œæœ‰äº†å®¹å™¨é•œåƒï¼ˆ&lt;code>rootfs&lt;/code>ï¼‰ä¹‹åï¼Œä¼˜é›…çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚&lt;/p>
&lt;blockquote>
&lt;p>ç”±äº &lt;code>rootfs&lt;/code> é‡Œæ‰“åŒ…çš„ä¸åªæ˜¯åº”ç”¨ï¼Œè€Œæ˜¯æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„æ–‡ä»¶å’Œç›®å½•ï¼Œä¹Ÿå°±æ„å‘³ç€åº”ç”¨ä»¥åŠå®ƒè¿è¡Œçš„æ‰€éœ€è¦çš„æ‰€æœ‰ä¾èµ–ï¼Œéƒ½è¢«å°è£…åœ¨ä¸€èµ·ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>å¯¹äºä¸€ä¸ªåº”ç”¨æ¥è¯´ï¼Œæ“ä½œç³»ç»Ÿæœ¬èº«æ‰æ˜¯å®ƒè¿è¡Œæ‰€éœ€è¦çš„å®Œæ•´çš„&amp;quot;ä¾èµ–åº“&amp;quot;ï¼Œæœ‰äº†å®¹å™¨é•œåƒæ‰“åŒ…æ“ä½œç³»ç»Ÿçš„èƒ½åŠ›ï¼Œè¿™ä¸ªæœ€åŸºç¡€çš„ä¾èµ–ç¯å¢ƒä¹Ÿç»ˆäºå˜æˆäº†åº”ç”¨æ²™ç›’çš„ä¸€éƒ¨åˆ†ã€‚è¿™å°±èµ‹äºˆäº†å®¹å™¨çš„ä¸€è‡´æ€§ï¼šæ— è®ºåœ¨æœ¬åœ°ã€äº‘ç«¯ï¼Œè¿˜æ˜¯åœ¨ä»»ä½•åœ°æ–¹çš„æœºå™¨ä¸Šï¼Œç”¨æˆ·åªéœ€è¦è§£å‹æ‰“åŒ…å¥½çš„å®¹å™¨é•œåƒï¼Œè¿™æ ·è¿™ä¸ªåº”ç”¨æ‰€éœ€è¦çš„å®Œæ•´çš„æ‰§è¡Œç¯å¢ƒå°±è¢«é‡ç°å‡ºæ¥äº†ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="å¦‚ä½•è§£å†³æ¯æ¬¡å‡çº§å¦‚ä½•è§£å†³é‡å¤åˆ¶ä½œ-rootfs-çš„é—®é¢˜å‘¢">å¦‚ä½•è§£å†³æ¯æ¬¡å‡çº§ï¼Œå¦‚ä½•è§£å†³é‡å¤åˆ¶ä½œ &lt;code>rootfs&lt;/code> çš„é—®é¢˜å‘¢ï¼Ÿ&lt;/h2>
&lt;p>&lt;code>Docker&lt;/code>å…¬å¸å®ç°&lt;code>Docker&lt;/code>é•œåƒçš„æ—¶å€™æ²¡æœ‰ä½¿ç”¨é‡åˆ¶ä½œ&lt;code>rootfs&lt;/code>æµç¨‹ï¼Œè€Œæ˜¯åœ¨&lt;code>Docker&lt;/code>åœ¨é•œåƒçš„è®¾è®¡ä¸­ï¼Œå¼•å…¥äº†å±‚ï¼ˆ&lt;code>layer&lt;/code>ï¼‰çš„æ¦‚å¿µã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·åˆ¶ä½œé•œåƒçš„æ¯ä¸€æ­¥æ“ä½œï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå±‚ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå¢é‡çš„&lt;code>rootfs&lt;/code>.&lt;/p>
&lt;p>è”åˆæ–‡ä»¶ç³»ç»Ÿ(&lt;code>Union File System&lt;/code>) &lt;code>UnionFS&lt;/code>, æœ€ä¸»è¦çš„åŠŸèƒ½æ˜¯å°†ä¸åŒä½ç½®çš„ç›®å½•è”åˆæŒ‚è½½ï¼ˆ&lt;code>union mount&lt;/code>ï¼‰åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&amp;gt; tree
.
|- A
| |- a
| |- x
|--- B
|-- b
|-- x
&lt;span style="color:#228b22"># è”åˆæŒ‚è½½ï¼Œä¸¤ä¸ªç›®å½•æŒ‚è½½åˆ°å…¬å…±ç›®å½•Cä¸Š&lt;/span>
&amp;gt; mkdir C
&amp;gt; mount -t aufs -o &lt;span style="color:#00688b">dirs&lt;/span>=./A:./B none ./C
&lt;span style="color:#228b22"># å±•ç¤ºCæ–‡ä»¶&lt;/span>
&amp;gt; tree ./C
./C
|-- a
|-- b
|-- x
&lt;span style="color:#228b22"># æ­¤æ—¶å¯¹ C é‡Œçš„æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œåœ¨ç›®å½• A å’Œ B ä¸­éƒ½ä¼šç”Ÿæ•ˆ&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="docker-layeræ¦‚å¿µ">&lt;code>docker&lt;/code> &lt;code>layer&lt;/code>æ¦‚å¿µ&lt;/h2>
&lt;p>å…³é”®ç›®å½•:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">/var/lib/docker/aufs/diff/&amp;lt;layer_id&amp;gt;
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># æ‹‰å–ubuntué•œåƒ&lt;/span>
&amp;gt; docker pull ubuntu:latest
&lt;span style="color:#228b22"># å±•ç¤ºimageçš„å±‚&lt;/span>
&amp;gt; docker image inspect ubuntu:latest
...
&lt;span style="color:#cd5555">&amp;#34;RootFS&amp;#34;&lt;/span>: {
&lt;span style="color:#cd5555">&amp;#34;Type&amp;#34;&lt;/span>: &lt;span style="color:#cd5555">&amp;#34;layers&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;Layers&amp;#34;&lt;/span>: [
&lt;span style="color:#cd5555">&amp;#34;sha256:f49017d4d5ce9c0f544c...&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;sha256:8f2b771487e9d6354080...&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;sha256:ccd4d61916aaa2159429...&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;sha256:c01d74f99de40e097c73...&amp;#34;&lt;/span>,
&lt;span style="color:#cd5555">&amp;#34;sha256:268a067217b5fe78e000...&amp;#34;&lt;/span>
]
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>ubuntu&lt;/code>é•œåƒçš„æ˜¯äº”å±‚ç»„æˆï¼Œè¿™äº”å±‚å°±æ˜¯5ä¸ªå¢é‡ &lt;code>rootfs&lt;/code>,æ¯ä¸€å±‚éƒ½æ˜¯ &lt;code>ubuntu&lt;/code> æ“ä½œç³»ç»Ÿæ–‡ä»¶ä¸ç›®å½•çš„ä¸€éƒ¨åˆ†; è€Œåœ¨ä½¿ç”¨é•œåƒæ—¶, &lt;code>Docker&lt;/code> ä¼šæŠŠè¿™äº›å¢é‡çš„è”åˆæŒ‚è½½åœ¨ä¸€ä¸ªç»Ÿä¸€çš„æŒ‚è½½ç‚¹ä¸Šã€‚æŒ‚è½½ç‚¹å°±æ˜¯ &lt;code>/var/lib/docker/aufs/mnt/&lt;/code>,æ¯”å¦‚:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">/var/lib/docker/aufs/mnt/6e3be5d2ecccae7cc0fcfa2a2f5c89dc21ee30e166be823ceaeba15dce645b3e
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># è¿™ä¸ªç›®å½•ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ ubuntu æ“ä½œç³»ç»Ÿ&lt;/span>
&amp;gt; ls /var/lib/docker/aufs/mnt/6e3be5d2ecccae7cc0fcfa2a2f5c89dc21ee30e166be823ceaeba15dce645b3e
bin boot dev etc home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var
&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‰é¢çš„äº”ä¸ªé•œåƒå±‚ï¼Œå¦‚ä½•è¢«æŒ‚è½½åˆ°è¿™æ ·ä¸€ä¸ªå®Œæ•´çš„&lt;code>Ubuntu&lt;/code>çš„æ–‡ä»¶ç³»ç»Ÿçš„å‘¢ï¼Ÿè¿™ä¸ªä¿¡æ¯çºªå½•åœ¨ &lt;code>AuFS&lt;/code> çš„ç³»ç»Ÿç›®å½• &lt;code>/sys/fs/aufs&lt;/code> ä¸‹é¢ã€‚æŸ¥çœ‹ &lt;code>AuFS&lt;/code> çš„æŒ‚è½½ä¿¡æ¯, æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°è¿™ä¸ªç›®å½•å¯¹åº”çš„ &lt;code>AuFS&lt;/code> çš„å†…éƒ¨IDï¼ˆä¹Ÿå«&lt;code>si&lt;/code>ï¼‰ï¼Œ&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># si=972c6d361e6b32ba&lt;/span>
&amp;gt; cat /proc/mounts| grep aufs
none /var/lib/docker/aufs/mnt/6e3be5d2ecccae7cc0fc... aufs rw,relatime,si=972c6d361e6b32ba,dio,dirperm1 &lt;span style="color:#b452cd">0&lt;/span> &lt;span style="color:#b452cd">0&lt;/span>
&lt;span style="color:#228b22"># æŸ¥çœ‹è¢«è”åˆæŒ‚è½½åœ¨ä¸€èµ·çš„å„ä¸ªå±‚çš„ä¿¡æ¯&lt;/span>
&amp;gt; cat /sys/fs/aufs/si_972c6d361e6b32ba/br[0-9]*
/var/lib/docker/aufs/diff/6e3be5d2ecccae7cc...=rw
/var/lib/docker/aufs/diff/6e3be5d2ecccae7cc...-init=ro+wh
/var/lib/docker/aufs/diff/32e8e20064858c0f2...=ro+wh
/var/lib/docker/aufs/diff/2b8858809bce62e62...=ro+wh
/var/lib/docker/aufs/diff/20707dce8efc0d267...=ro+wh
/var/lib/docker/aufs/diff/72b0744e06247c7d0...=ro+wh
/var/lib/docker/aufs/diff/a524a729adadedb90...=ro+wh
&lt;span style="color:#228b22"># é•œåƒçš„å±‚éƒ½æ”¾ç½®åœ¨ `/var/lib/docker/aufs/diff` ç›®å½•ä¸‹ï¼Œç„¶åè¢«è”åˆæŒ‚è½½åœ¨ `/var/lib/docker/aufs/mnt` é‡Œé¢ &lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;img src="https://pinkhello.me/%E5%9B%9E%E6%9C%9BK8S/ubuntu-layer.png" alt="å®¹å™¨çš„rootfsçš„å±•ç¤º">&lt;/p>
&lt;ul>
&lt;li>ç¬¬ä¸€éƒ¨åˆ†: åªè¯»å±‚
&lt;blockquote>
&lt;p>å®ƒæ˜¯è¿™ä¸ªå®¹å™¨ &lt;code>rootfs&lt;/code> æœ€ä¸‹é¢çš„ 5 å±‚, å¯¹åº”çš„æ­£æ˜¯ &lt;code>ubuntu&lt;/code> é•œåƒçš„äº”å±‚.ä»–ä»¬çš„æŒ‚è½½æ–¹å¼éƒ½æ˜¯åªè¯»çš„ï¼ˆro+wh readonly+whiteoutï¼‰&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>ç¬¬äºŒéƒ¨åˆ†: å¯è¯»å†™å±‚
&lt;blockquote>
&lt;p>å®ƒæ˜¯è¿™ä¸ªå®¹å™¨çš„ &lt;code>rootfs&lt;/code> æœ€ä¸Šé¢çš„ä¸€å±‚ï¼ˆ6e3be5d2ecccae7ccï¼‰ï¼Œå®ƒçš„æŒ‚è½½æ–¹å¼ä¸ºï¼š&lt;code>rw&lt;/code> ï¼ˆread writeï¼‰, åœ¨è¿™ä¸ªå®¹å™¨ä¸­è¿›è¡Œä¿®æ”¹äº§ç”Ÿçš„å†…å®¹å°±ä¼šä»¥å¢é‡çš„æ–¹å¼å‡ºç°åœ¨è¿™ä¸€å±‚ã€‚
å‡å¦‚åˆ é™¤åªè¯»å±‚çš„ä¸€ä¸ªæ–‡ä»¶å‘¢ï¼Ÿè¿™æ—¶å€™ &lt;code>AuFS&lt;/code> åœ¨å¯è¯»å†™å±‚åˆ›å»ºäº†ä¸€ä¸ª &lt;code>whiteout&lt;/code> æ–‡ä»¶ï¼ŒæŠŠåªè¯»å±‚é‡Œçš„æ–‡ä»¶ é®æŒ¡ èµ·æ¥äº†ã€‚å¯¹ä¸Šå±‚æ¥è¯´ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯ä¸å¯è§çš„ã€‚
è¿™è¾¹å¯è¯»å†™å±‚çš„ä½œç”¨å°±æ˜¯å­˜æ”¾æˆ‘ä»¬è‡ªå·±ä¿®æ”¹åçš„ &lt;code>rootfs&lt;/code> åäº§ç”Ÿçš„å¢é‡ï¼Œæ— è®ºå¢åˆ æ”¹éƒ½åœ¨æ­¤å¤„å¤„ç†ï¼Œå¢é‡çš„ &lt;code>rootfs&lt;/code>&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>ç¬¬ä¸‰éƒ¨åˆ†: &lt;code>Init&lt;/code> å±‚
&lt;blockquote>
&lt;p>å®ƒæ˜¯ä»¥&amp;quot;-init&amp;quot;ç»“å°¾çš„å±‚ï¼Œå¤¹åœ¨åªè¯»å±‚å’Œè¯»å†™å±‚ä¹‹é—´, &lt;code>Init&lt;/code> å±‚æ˜¯&lt;code>Docker&lt;/code>é¡¹ç›®å•ç‹¬ç”Ÿæˆçš„å†…éƒ¨å±‚ï¼Œä¸“é—¨ç”¨æ¥å­˜æ”¾ &lt;code>/etc/hosts&lt;/code>ã€&lt;code>/etc/resolv.conf&lt;/code> ç­‰ä¿¡æ¯ï¼Œè¿™äº›æ–‡ä»¶æœ¬æ¥å±äºåªè¯»çš„&lt;code>Ubuntu&lt;/code>é•œåƒä¸€éƒ¨åˆ†ï¼Œä½†ç”¨æˆ·å¾€å¾€éœ€è¦åœ¨å¯åŠ¨çš„æ—¶å€™å†™å…¥ä¸€å®šæŒ‡å®šçš„å€¼ &lt;code>hostname&lt;/code>ï¼Œç”¨æˆ·å¯ä»¥åœ¨å¯è¯»å†™å±‚å¯¹ä»–ä»¬è¿›è¡Œä¿®æ”¹ã€‚&lt;/p>
&lt;p>å¯æ˜¯æˆ‘ä»¬ä¿®æ”¹å¾€å¾€åªå¯¹å½“å‰å®¹å™¨ç”Ÿæ•ˆï¼Œæˆ‘ä»¬å¹¶ä¸å¸Œæœ›æ‰§è¡Œ &lt;code>docker commit&lt;/code> æ—¶ï¼ŒæŠŠè¿™äº›ä¿¡æ¯è¿åŒå¯è¯»å†™å±‚ä¸€èµ·æäº¤æ‰ã€‚æ‰€ä»¥&lt;code>Docker&lt;/code>çš„åšæ³•ï¼Œæ—¶ä¿®æ”¹çš„è¿™äº›æ–‡ä»¶ä»¥åï¼Œä»¥ä¸€ä¸ªå•ç‹¬çš„å±‚æŒ‚è½½å‡ºæ¥ï¼Œè€Œç”¨æˆ·æ‰§è¡Œçš„ &lt;code>docker commit&lt;/code> åªä¼šæäº¤å¯è¯»å†™å±‚ï¼Œæ‰€ä»¥ä¸ä¼šåŒ…å«è¿™äº›å†…å®¹ã€‚&lt;/p>
&lt;p>æœ€ç»ˆè¿™ 7 å±‚éƒ½è¢«è”åˆæŒ‚è½½åˆ° &lt;code>/var/lib/docker/aufs/mnt&lt;/code> ç›®å½•ä¸‹&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;h1 id="dockerå®¹å™¨">&lt;code>Docker&lt;/code>å®¹å™¨&lt;/h1>
&lt;h2 id="docker-å¦‚ä½•å®ç°å®¹å™¨çš„">docker å¦‚ä½•å®ç°å®¹å™¨çš„&lt;/h2>
&lt;ul>
&lt;li>&lt;code>Linux Namespace&lt;/code> éš”ç¦»èƒ½åŠ›&lt;/li>
&lt;li>&lt;code>Linux Cgroups&lt;/code> é™åˆ¶èƒ½åŠ›&lt;/li>
&lt;li>åŸºäº &lt;code>rootfs&lt;/code> æ–‡ä»¶ç³»ç»Ÿçš„å¢é‡å®ç°&lt;/li>
&lt;/ul>
&lt;h2 id="å¼€å‘çš„åº”ç”¨çš„å¦‚ä½•å®¹å™¨åŒ–çš„æ­¥éª¤">å¼€å‘çš„åº”ç”¨çš„å¦‚ä½•å®¹å™¨åŒ–çš„æ­¥éª¤&lt;/h2>
&lt;h3 id="1dockerfile-åˆ¶ä½œå®¹å™¨é•œåƒ">1ã€&lt;code>Dockerfile&lt;/code> åˆ¶ä½œå®¹å™¨é•œåƒ&lt;/h3>
&lt;p>åˆ¶ä½œ&lt;code>rootfs&lt;/code>è¿‡ç¨‹ï¼Œ&lt;code>Docker&lt;/code>æä¾›äº†ä¸€ä¸ªä¾¿æ·çš„æ–¹å¼: &lt;code>Dockerfile&lt;/code>&lt;/p>
&lt;p>ä¸¾ä¾‹ä¸ªå†™ä¸ª &lt;code>app.py&lt;/code>, ä½¿ç”¨ &lt;code>Flask&lt;/code> å¯åŠ¨ä¸€ä¸ª&lt;code>Web&lt;/code>æœåŠ¡å™¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-python" data-lang="python">&lt;span style="color:#8b008b;font-weight:bold">from&lt;/span> &lt;span style="color:#008b45;text-decoration:underline">flask&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">import&lt;/span> Flask
&lt;span style="color:#8b008b;font-weight:bold">import&lt;/span> &lt;span style="color:#008b45;text-decoration:underline">socket&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">import&lt;/span> &lt;span style="color:#008b45;text-decoration:underline">os&lt;/span>
app = Flask(__name__)
&lt;span style="color:#707a7c">@app.route&lt;/span>(&lt;span style="color:#cd5555">&amp;#39;/&amp;#39;&lt;/span>)
&lt;span style="color:#8b008b;font-weight:bold">def&lt;/span> &lt;span style="color:#008b45">hello&lt;/span>():
html = &lt;span style="color:#cd5555">&amp;#34;&amp;lt;h3&amp;gt;Hello {name}!&amp;lt;/h3&amp;gt;&amp;#34;&lt;/span> \
&lt;span style="color:#cd5555">&amp;#34;&amp;lt;b&amp;gt;Hostname:&amp;lt;/b&amp;gt; {hostname}&amp;lt;br/&amp;gt;&amp;#34;&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> html.format(name=os.getenv(&lt;span style="color:#cd5555">&amp;#34;NAME&amp;#34;&lt;/span>, &lt;span style="color:#cd5555">&amp;#34;world&amp;#34;&lt;/span>), hostname=socket.gethostname())
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> __name__ == &lt;span style="color:#cd5555">&amp;#34;__main__&amp;#34;&lt;/span>:
app.run(host=&lt;span style="color:#cd5555">&amp;#39;0.0.0.0&amp;#39;&lt;/span>, port=&lt;span style="color:#b452cd">80&lt;/span>)
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># å±•ç¤º Python ä¾èµ–çš„å…³ç³»&lt;/span>
&amp;gt; cat requirements.txt
Flask
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-dockerfile" data-lang="dockerfile">&lt;span style="color:#228b22"># ä½¿ç”¨å®˜æ–¹ pythoné•œåƒ&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">FROM&lt;/span>&lt;span style="color:#cd5555"> python&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#228b22"># åˆ‡æ¢å·¥ä½œç›®å½•&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">WORKDIR&lt;/span>&lt;span style="color:#cd5555"> /app&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#228b22"># å°†å½“å‰ç›®å½•ä¸‹å†…å®¹å¤åˆ¶åˆ° /app&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">ADD&lt;/span> . /app&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#228b22"># æŒ‰ç…§åº”ç”¨ä¾èµ–&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">RUN&lt;/span> pip install -r requirements.txt&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#228b22"># å…è®¸å¤–ç•Œè®¿é—®å®¹å™¨80ç«¯å£&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">EXPOSE&lt;/span>&lt;span style="color:#cd5555"> 80&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#228b22"># è®¾ç½®ç¯å¢ƒå˜é‡&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">ENV&lt;/span> NAME helloworld&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#228b22"># å¯åŠ¨pythonåº”ç”¨&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;span style="color:#a61717;background-color:#e3d2d2">&lt;/span>&lt;span style="color:#8b008b;font-weight:bold">CMD&lt;/span> [&lt;span style="color:#cd5555">&amp;#34;python&amp;#34;&lt;/span>,&lt;span style="color:#cd5555">&amp;#34;app.py&amp;#34;&lt;/span>]&lt;span style="color:#a61717;background-color:#e3d2d2">
&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ‰äº† Dockerfile å¯ä»¥è¿›è¡Œ Docker é•œåƒçš„åˆ¶ä½œ&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># ä½¿ç”¨dockerfileæ‰“ä¸€ä¸ª åä¸º helloworld çš„é•œåƒ&lt;/span>
&amp;gt; docker build -t helloword .
&lt;span style="color:#228b22"># å±•ç¤ºdocker&lt;/span>
&amp;gt; docker image ls
REPOSITORY TAG IMAGE ID
helloworld latest 654286cdf963
&lt;span style="color:#228b22"># å¯åŠ¨ä¸€ä¸ªå®¹å™¨ 8080 æ˜ å°„ 80&lt;/span>
&amp;gt; docker run -p 8080:80 helloword
&lt;span style="color:#228b22"># docker push&lt;/span>
&lt;span style="color:#228b22"># docker tag&lt;/span>
&amp;gt; docker inspect --format &lt;span style="color:#cd5555">&amp;#39;{{ .State.Pid }}&amp;#39;&lt;/span> 4ddf4638572d
&lt;span style="color:#b452cd">25686&lt;/span>
&lt;span style="color:#228b22"># å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªè¿›ç¨‹çš„æ¯ç§ Linux Namespaceï¼Œéƒ½åœ¨å®ƒå¯¹åº”çš„ /proc/[è¿›ç¨‹å·]/ns ä¸‹æœ‰ä¸€ä¸ªå¯¹åº”çš„è™šæ‹Ÿæ–‡ä»¶ï¼Œå¹¶ä¸”é“¾æ¥åˆ°ä¸€ä¸ªçœŸå®çš„ Namespace æ–‡ä»¶ä¸Šã€‚&lt;/span>
&amp;gt; ls -l /proc/25686/ns
total &lt;span style="color:#b452cd">0&lt;/span>
lrwxrwxrwx &lt;span style="color:#b452cd">1&lt;/span> root root &lt;span style="color:#b452cd">0&lt;/span> Aug &lt;span style="color:#b452cd">13&lt;/span> 14:05 cgroup -&amp;gt; cgroup:[4026531835]
lrwxrwxrwx &lt;span style="color:#b452cd">1&lt;/span> root root &lt;span style="color:#b452cd">0&lt;/span> Aug &lt;span style="color:#b452cd">13&lt;/span> 14:05 ipc -&amp;gt; ipc:[4026532278]
lrwxrwxrwx &lt;span style="color:#b452cd">1&lt;/span> root root &lt;span style="color:#b452cd">0&lt;/span> Aug &lt;span style="color:#b452cd">13&lt;/span> 14:05 mnt -&amp;gt; mnt:[4026532276]
lrwxrwxrwx &lt;span style="color:#b452cd">1&lt;/span> root root &lt;span style="color:#b452cd">0&lt;/span> Aug &lt;span style="color:#b452cd">13&lt;/span> 14:05 net -&amp;gt; net:[4026532281]
lrwxrwxrwx &lt;span style="color:#b452cd">1&lt;/span> root root &lt;span style="color:#b452cd">0&lt;/span> Aug &lt;span style="color:#b452cd">13&lt;/span> 14:05 pid -&amp;gt; pid:[4026532279]
lrwxrwxrwx &lt;span style="color:#b452cd">1&lt;/span> root root &lt;span style="color:#b452cd">0&lt;/span> Aug &lt;span style="color:#b452cd">13&lt;/span> 14:05 pid_for_children -&amp;gt; pid:[4026532279]
lrwxrwxrwx &lt;span style="color:#b452cd">1&lt;/span> root root &lt;span style="color:#b452cd">0&lt;/span> Aug &lt;span style="color:#b452cd">13&lt;/span> 14:05 user -&amp;gt; user:[4026531837]
lrwxrwxrwx &lt;span style="color:#b452cd">1&lt;/span> root root &lt;span style="color:#b452cd">0&lt;/span> Aug &lt;span style="color:#b452cd">13&lt;/span> 14:05 uts -&amp;gt; uts:[4026532277]
&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¹Ÿå°±æ„å‘³ç€ï¼šä¸€ä¸ªè¿›ç¨‹ï¼Œå¯ä»¥é€‰æ‹©åŠ å…¥åˆ°æŸä¸ªè¿›ç¨‹å·²æœ‰çš„ &lt;code>Namespace&lt;/code> å½“ä¸­ï¼Œä»è€Œè¾¾åˆ°â€œè¿›å…¥â€è¿™ä¸ªè¿›ç¨‹æ‰€åœ¨å®¹å™¨çš„ç›®çš„ï¼Œè¿™æ­£æ˜¯ &lt;code>docker exec&lt;/code> çš„å®ç°åŸç†ã€‚&lt;/p>
&lt;h3 id="2volume-æœºåˆ¶å…è®¸å°†å®¿ä¸»æœºä¸Šçš„æŒ‡å®šçš„ç›®å½•æˆ–è€…æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨é‡Œé¢è¿›è¡Œè¯»å–å’Œä¿®æ”¹">2ã€&lt;code>Volume&lt;/code> æœºåˆ¶ï¼Œå…è®¸å°†å®¿ä¸»æœºä¸Šçš„æŒ‡å®šçš„ç›®å½•æˆ–è€…æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨é‡Œé¢è¿›è¡Œè¯»å–å’Œä¿®æ”¹&lt;/h3>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&amp;gt; docker run -v /test ...
&amp;gt; docker run -v /home:/test ...
&lt;/code>&lt;/pre>&lt;/div>&lt;p>åªä¸è¿‡ï¼Œåœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼Œç”±äºä½ å¹¶æ²¡æœ‰æ˜¾ç¤ºå£°æ˜å®¿ä¸»æœºç›®å½•ï¼Œé‚£ä¹ˆ &lt;code>Docker&lt;/code> å°±ä¼šé»˜è®¤åœ¨å®¿ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½• &lt;code>/var/lib/docker/volumes/[VOLUME_ID]/_data&lt;/code>ï¼Œç„¶åæŠŠå®ƒæŒ‚è½½åˆ°å®¹å™¨çš„ &lt;code>/test&lt;/code> ç›®å½•ä¸Šã€‚è€Œåœ¨ç¬¬äºŒç§æƒ…å†µä¸‹ï¼Œ&lt;code>Docker&lt;/code> å°±ç›´æ¥æŠŠå®¿ä¸»æœºçš„ &lt;code>/home&lt;/code> ç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„ &lt;code>/test&lt;/code> ç›®å½•ä¸Šã€‚&lt;/p>
&lt;p>å½“å®¹å™¨è¿›ç¨‹è¢«åˆ›å»ºä¹‹åï¼Œå°½ç®¡å¼€å¯äº† &lt;code>Mount Namespace&lt;/code>ï¼Œä½†æ˜¯åœ¨å®ƒæ‰§è¡Œ &lt;code>chroot&lt;/code>ï¼ˆæˆ–è€… &lt;code>pivot_root&lt;/code>ï¼‰ä¹‹å‰ï¼Œå®¹å™¨è¿›ç¨‹ä¸€ç›´å¯ä»¥çœ‹åˆ°å®¿ä¸»æœºä¸Šçš„æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚&lt;/p>
&lt;p>è€Œå®¿ä¸»æœºä¸Šçš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¹Ÿè‡ªç„¶åŒ…æ‹¬äº†æˆ‘ä»¬è¦ä½¿ç”¨çš„å®¹å™¨é•œåƒã€‚è¿™ä¸ªé•œåƒçš„å„ä¸ªå±‚ï¼Œä¿å­˜åœ¨ &lt;code>/var/lib/docker/aufs/diff&lt;/code> ç›®å½•ä¸‹ï¼Œåœ¨å®¹å™¨è¿›ç¨‹å¯åŠ¨åï¼Œå®ƒä»¬ä¼šè¢«è”åˆæŒ‚è½½åœ¨ &lt;code>/var/lib/docker/aufs/mnt/&lt;/code> ç›®å½•ä¸­ï¼Œè¿™æ ·å®¹å™¨æ‰€éœ€çš„ &lt;code>rootfs&lt;/code> å°±å‡†å¤‡å¥½äº†ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ &lt;code>rootfs&lt;/code> å‡†å¤‡å¥½ä¹‹åï¼Œåœ¨æ‰§è¡Œ &lt;code>chroot&lt;/code> ä¹‹å‰ï¼ŒæŠŠ &lt;code>Volume&lt;/code> æŒ‡å®šçš„å®¿ä¸»æœºç›®å½•ï¼ˆæ¯”å¦‚ &lt;code>/home&lt;/code> ç›®å½•ï¼‰ï¼ŒæŒ‚è½½åˆ°æŒ‡å®šçš„å®¹å™¨ç›®å½•ï¼ˆæ¯”å¦‚ &lt;code>/test&lt;/code> ç›®å½•ï¼‰åœ¨å®¿ä¸»æœºä¸Šå¯¹åº”çš„ç›®å½•ï¼ˆå³ &lt;code>/var/lib/docker/aufs/mnt/[å¯è¯»å†™å±‚ ID]/test&lt;/code>ï¼‰ä¸Šï¼Œè¿™ä¸ª &lt;code>Volume&lt;/code> çš„æŒ‚è½½å·¥ä½œå°±å®Œæˆäº†ã€‚&lt;/p>
&lt;p>æ›´é‡è¦çš„æ˜¯ï¼Œç”±äºæ‰§è¡Œè¿™ä¸ªæŒ‚è½½æ“ä½œæ—¶ï¼Œâ€œå®¹å™¨è¿›ç¨‹â€å·²ç»åˆ›å»ºäº†ï¼Œä¹Ÿå°±æ„å‘³ç€æ­¤æ—¶ &lt;code>Mount Namespace&lt;/code> å·²ç»å¼€å¯äº†ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªæŒ‚è½½äº‹ä»¶åªåœ¨è¿™ä¸ªå®¹å™¨é‡Œå¯è§ã€‚ä½ åœ¨å®¿ä¸»æœºä¸Šï¼Œæ˜¯çœ‹ä¸è§å®¹å™¨å†…éƒ¨çš„è¿™ä¸ªæŒ‚è½½ç‚¹çš„ã€‚è¿™å°±ä¿è¯äº†å®¹å™¨çš„éš”ç¦»æ€§ä¸ä¼šè¢« &lt;code>Volume&lt;/code> æ‰“ç ´ã€‚&lt;/p>
&lt;p>è€Œè¿™é‡Œè¦ä½¿ç”¨åˆ°çš„æŒ‚è½½æŠ€æœ¯ï¼Œå°±æ˜¯ &lt;code>Linux&lt;/code> çš„ç»‘å®šæŒ‚è½½ï¼ˆ&lt;code>bind mount&lt;/code>ï¼‰æœºåˆ¶ã€‚å®ƒçš„ä¸»è¦ä½œç”¨å°±æ˜¯ï¼Œå…è®¸ä½ å°†ä¸€ä¸ªç›®å½•æˆ–è€…æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ•´ä¸ªè®¾å¤‡ï¼ŒæŒ‚è½½åˆ°ä¸€ä¸ªæŒ‡å®šçš„ç›®å½•ä¸Šã€‚å¹¶ä¸”ï¼Œè¿™æ—¶ä½ åœ¨è¯¥æŒ‚è½½ç‚¹ä¸Šè¿›è¡Œçš„ä»»ä½•æ“ä½œï¼Œåªæ˜¯å‘ç”Ÿåœ¨è¢«æŒ‚è½½çš„ç›®å½•æˆ–è€…æ–‡ä»¶ä¸Šï¼Œè€ŒåŸæŒ‚è½½ç‚¹çš„å†…å®¹åˆ™ä¼šè¢«éšè—èµ·æ¥ä¸”ä¸å—å½±å“ã€‚&lt;/p>
&lt;p>&lt;img src="https://pinkhello.me/%E5%9B%9E%E6%9C%9BK8S/python-app-image.jpg" alt="åº”ç”¨çš„é•œåƒ">&lt;/p>
&lt;h1 id="kubernetes-æœ¬è´¨">&lt;code>Kubernetes&lt;/code> æœ¬è´¨&lt;/h1>
&lt;h2 id="å›é¡¾">å›é¡¾&lt;/h2>
&lt;p>ä¸€ä¸ªå®¹å™¨ï¼š&lt;code>Linux Namespace&lt;/code>ã€&lt;code>Linux Cgroups&lt;/code>ã€ &lt;code>rootfs&lt;/code> ä¸‰ç§æŠ€æœ¯æ„å»ºçš„è¿›ç¨‹éš”ç¦»ç¯å¢ƒã€‚&lt;/p>
&lt;p>ä¸€ä¸ªæ­£åœ¨å…è®¸çš„ &lt;code>Linux&lt;/code> çš„å®¹å™¨:&lt;/p>
&lt;ul>
&lt;li>ä¸€ç»„è”åˆæŒ‚è½½åœ¨ &lt;code>/var/lib/docker/aufs/mnt&lt;/code> ä¸Šçš„ &lt;code>rootfs&lt;/code>, å®¹å™¨çš„é™æ€è§†å›¾ï¼ˆå®¹å™¨é•œåƒï¼‰&lt;/li>
&lt;li>ä¸€ä¸ªæœ‰ &lt;code>Namespace&lt;/code> + &lt;code>Cgroups&lt;/code> æ„æˆçš„éš”ç¦»ç¯å¢ƒï¼Œå®¹å™¨çš„åŠ¨æ€è§†å›¾ï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼‰&lt;/li>
&lt;/ul>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>åœ¨æ•´ä¸ªå¼€å‘æµç¨‹ä¸­ &amp;ldquo;å¼€å‘ - æµ‹è¯• - å‘å¸ƒ&amp;rdquo;ï¼ŒçœŸæ­£æ‰¿è½½å®¹å™¨ä¿¡æ¯ä¼ é€’çš„æ˜¯&lt;code>å®¹å™¨é•œåƒ&lt;/code>ï¼ç„¶è€Œäº‘è®¡ç®—å•†æƒ³è¦ä¸å…¨éƒ¨ç”¨æˆ·å…³è”èµ·æ¥ï¼Œé‚£ä¹ˆåªæœ‰é€šè¿‡&lt;code>å®¹å™¨é•œåƒ&lt;/code>ã€‚
å®¹å™¨åªæ˜¯å¼€å‘è€…æ‰‹é‡Œçš„å°å·¥å…·ï¼Œä½†æ˜¯æƒ³ä»å®¹å™¨è¿›å…¥å®¹å™¨äº‘çš„æ–¹å¼ï¼Œå°±éœ€è¦ &lt;code>å®¹å™¨ç¼–æ’&lt;/code> æŠ€æœ¯.&lt;/p>
&lt;h2 id="å®¹å™¨ç¼–æ’æŠ€æœ¯">&lt;code>å®¹å™¨ç¼–æ’&lt;/code>æŠ€æœ¯&lt;/h2>
&lt;p>å¤§æˆ˜ä¹‹åï¼ŒKubernetes åº”è¿è€Œç”Ÿ&lt;/p>
&lt;h3 id="kubernetes-é¡¶å±‚è®¾è®¡">Kubernetes é¡¶å±‚è®¾è®¡&lt;/h3>
&lt;ul>
&lt;li>ç¼–æ’ã€è°ƒåº¦ã€å®¹å™¨äº‘ã€é›†ç¾¤ç®¡ç†&lt;/li>
&lt;li>è·¯ç”±ç½‘å…³ã€æ°´å¹³æ‰©å±•ã€ç›‘æ§ã€å¤‡ä»½ã€ç¾éš¾æ¢å¤&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://pinkhello.me/%E5%9B%9E%E6%9C%9BK8S/kubernetes-%E6%9E%B6%E6%9E%84.png" alt="kubernetesæ¶æ„">&lt;/p>
&lt;p>Kubernetes æ˜¯ç”± Master å’Œ Node ä¸¤ç§èŠ‚ç‚¹ï¼Œæ§åˆ¶èŠ‚ç‚¹ ä¸ è®¡ç®—èŠ‚ç‚¹&lt;/p>
&lt;ul>
&lt;li>æ§åˆ¶èŠ‚ç‚¹ï¼ˆä¸‰ä¸ªç»„ä»¶ï¼‰
&lt;ul>
&lt;li>kube-apiserver è´Ÿè´£APIæœåŠ¡&lt;/li>
&lt;li>kube-scheduler è´Ÿè´£è°ƒåº¦&lt;/li>
&lt;li>kube-controller-manager è´Ÿè´£å®¹å™¨ç¼–æ’&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>è®¡ç®—èŠ‚ç‚¹
&lt;ul>
&lt;li>æ ¸å¿ƒ kubelet è´Ÿè´£å’Œå®¹å™¨è¿è¡Œæ—¶ï¼ˆæ¯”å¦‚dockerï¼‰äº¤äº’
&lt;ul>
&lt;li>äº¤äº’çš„æ—¶å€™çš„ä¾èµ–æ¥å£ CRI ï¼ˆContainer Runtime Interfaceï¼‰çš„è¿œç¨‹è°ƒç”¨æ¥å£&lt;/li>
&lt;li>é€šè¿‡ gRPC åè®® ä¸ Device Plugin è¿›è¡Œäº¤äº’&lt;/li>
&lt;li>è°ƒç”¨ç½‘ç»œæ’ä»¶ä¸ºå®¹å™¨é…ç½®ç½‘ç»œ CNI ï¼ˆContainer Networking Interfaceï¼‰&lt;/li>
&lt;li>è°ƒç”¨å­˜å‚¨æ’ä»¶ä¸ºå®¹å™¨é…ç½®æŒä¹…åŒ–å­˜å‚¨ CSI ï¼ˆContainer Storage Interfaceï¼‰&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>etcd æ•´ä¸ªé›†ç¾¤çš„æŒä¹…åŒ–æ•°æ®ï¼Œç”± kube-apiserver å¤„ç†åä¿å­˜åœ¨ Etcd ä¸­&lt;/li>
&lt;/ul>
&lt;p>ä»ä¸€å¼€å§‹ï¼ŒKubernetes å°±æ²¡æœ‰è¡£æœåˆ° Docker é¡¹ç›®ä¸Šï¼Œæ²¡æœ‰å°†å®ƒä½œä¸ºæ¶æ„çš„æ ¸å¿ƒï¼Œåªæ˜¯å°†å®ƒä½œä¸ºäº†æœ€åº•å±‚çš„å®¹å™¨è¿è¡Œæ—¶çš„å®ç°&lt;/p>
&lt;p>Kubernetes é¡¹ç›®æœ€ä¸»è¦çš„è®¾è®¡æ€æƒ³ï¼šä»å®è§‚çš„è§’åº¦ã€ä»¥ç»Ÿä¸€çš„æ–¹å¼å®šä¹‰ä»»åŠ¡ä¹‹é—´çš„å„ç§å…³ç³»ï¼Œä¸ºå°†æ¥æ”¯æŒæ›´å¤šç§ç±»çš„å…³ç³»ç•™æœ‰ä½™åœ°&lt;/p>
&lt;blockquote>
&lt;p>ä¾‹å¦‚ï¼š
Kubernetes åœ¨è®¿é—®å…³ç³»ä¸Šçš„æ“ä½œ&lt;/p>
&lt;p>Pod æ˜¯ Kubernetes çš„æœ€åŸºç¡€çš„å¯¹è±¡ã€‚
Service æ˜¯ Kubernetes æä¾›çš„è®¿é—®å…³ç³»çš„æœåŠ¡å¯¹è±¡&lt;/p>
&lt;p>æˆ‘ç°åœ¨ä¸¤ä¸ªåº”ç”¨å„è‡ªä¸ºPODï¼Œç°åœ¨è¦åšåˆ°Aåº”ç”¨è®¿é—®Båº”ç”¨ï¼Œåœ¨ä½¿ç”¨æ—¶å€™ï¼Œå¯¹äºå®¹å™¨éœ€è¦ IP åœ°å€ä¿¡æ¯ä¸å˜ç­‰ç­‰ã€‚
Kubernetesçš„åšæ³•æ˜¯ Pod ç»‘å®šä¸€ä¸ª Service æœåŠ¡ï¼Œè€Œ Service æœåŠ¡å£°æ˜çš„ IP åœ°å€ç­‰ä¿¡æ¯æ˜¯ä¸å˜çš„ï¼Œè¿™ä¸ªServiceæœåŠ¡ä¸»è¦ä½œç”¨å°±æ˜¯ä½œä¸º Pod çš„ä»£ç†å…¥å£ï¼Œä»è€Œæ›¿ä»£Podå¯¹å¤–æš´éœ²ä¸€ä¸ªå›ºå®šçš„ç½‘ç»œåœ°å€ã€‚
è¿™æ ·å¯¹äºè°ƒç”¨æ–¹åªéœ€è¦å…³ç³» Service å£°æ˜ä¿¡æ¯ï¼Œè€ŒServiceåç«¯çœŸæ­£ä»£ç†çš„Pod çš„IPåœ°å€ã€ç«¯å£ç­‰ä¿¡æ¯çš„è‡ªåŠ¨æ›´æ–°ã€ç»´æŠ¤æ˜¯ Kubernetesçš„èŒè´£ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;img src="https://pinkhello.me/%E5%9B%9E%E6%9C%9BK8S/kubernetes-%E5%85%A8%E6%99%AF%E5%9B%BE.png" alt="kuberneteså…¨æ™¯å›¾">&lt;/p>
&lt;ul>
&lt;li>Pod&lt;/li>
&lt;li>Service æè¿°è®¿é—®å…³ç³»&lt;/li>
&lt;li>Secret å¯†é’¥&lt;/li>
&lt;li>Job æè¿°ä¸€æ¬¡æ€§è¿è¡Œçš„POD&lt;/li>
&lt;li>DaemonSet æè¿°æ¯ä¸ªå®¿ä¸»æœºå¿…é¡»ä¸”åªèƒ½è¿è¡Œä¸€ä¸ªå‰¯æœ¬çš„å®ˆæŠ¤è¿›ç¨‹æœåŠ¡&lt;/li>
&lt;li>CronJob æè¿°å®šæ—¶ä»»åŠ¡&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>å¦‚ä½•ç¼–æ’ä¸€ä¸ªK8Sé¡¹ç›®&lt;/p>
&lt;ul>
&lt;li>é€šè¿‡ç¼–æ’å¯¹è±¡, æ¯”å¦‚ Podã€Jobã€CronJob ç­‰ï¼Œæ¥æè¿°è¯•å›¾ç®¡ç†çš„åº”ç”¨ï¼›&lt;/li>
&lt;li>å®šä¹‰æœåŠ¡å¯¹è±¡, æ¯”å¦‚ Serviceã€Secretã€Horizontal Pod Autoscalerç­‰ï¼Œä¼šè´Ÿè´£å…·ä½“çš„å¹³å°çº§åŠŸèƒ½&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;p>&lt;code>å£°æ˜å¼ API&lt;/code> å¯¹åº”çš„ &lt;code>ç¼–æ’å¯¹è±¡&lt;/code> å’Œ &lt;code>æœåŠ¡å¯¹è±¡&lt;/code>ï¼Œéƒ½æ˜¯ Kubernetes é¡¹ç›®ä¸­çš„ API å¯¹è±¡ï¼ˆAPI Objectï¼‰&lt;/p>
- https://pinkhello.me/posts/18-%E5%9B%9E%E6%9C%9Bk8s-%E7%99%BD%E8%AF%9D%E5%AE%B9%E5%99%A8/ - PinkHello, All Rights Reserved</description></item><item><title>å›æœ›K8S å°é²¸é±¼å®¹å™¨æŠ€æœ¯</title><link>https://pinkhello.me/posts/17-%E5%9B%9E%E6%9C%9Bk8s-%E5%B0%8F%E9%B2%B8%E9%B1%BC%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/</link><pubDate>Tue, 11 Feb 2020 10:50:42 +0800</pubDate><guid>https://pinkhello.me/posts/17-%E5%9B%9E%E6%9C%9Bk8s-%E5%B0%8F%E9%B2%B8%E9%B1%BC%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/</guid><description>PinkHello https://pinkhello.me/posts/17-%E5%9B%9E%E6%9C%9Bk8s-%E5%B0%8F%E9%B2%B8%E9%B1%BC%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/ -&lt;h1 id="ä»€ä¹ˆæ˜¯å®¹å™¨">ä»€ä¹ˆæ˜¯å®¹å™¨&lt;/h1>
&lt;p>åœ¨å®¹å™¨ä¹‹å‰, ç«çˆ†äº‘è®¡ç®—å¸‚åœºçš„æ˜¯ &lt;code>PAAS&lt;/code>, &lt;code>PAAS&lt;/code>å·²ç»æ·±å…¥äººå¿ƒ. é‚£æ—¶å€™çªç„¶æœ‰ä¸€å®¶å…¬å¸ dotCloud å‰‘èµ°åé”‹, ç›´æ¥å¼€æºå‡ºäº† &lt;code>Docker&lt;/code> é¡¹ç›®ï¼Œå¹¶ä¸”ç›´æ¥é¢å‘çš„ç¤¾åŒºã€‚ è¿™æ ·çš„åšæ³•ç›´æ¥å°†å½“æ—¶çš„&lt;code>PAAS&lt;/code>æµä¸»è¦å…¬å¸æ‰“çš„å±æ»šå°¿æµã€‚&lt;/p>
&lt;p>å›å¤´çœ‹, &lt;code>PAAS&lt;/code> æœ€æ ¸å¿ƒçš„æ˜¯éš”ç¦»ç¯å¢ƒ,æˆ–è€…å« &lt;code>æ²™ç›’&lt;/code>,åœ¨æˆ‘çœ‹æ¥ä¹Ÿå°±æ˜¯ &lt;code>å®¹å™¨&lt;/code>. è€Œ &lt;code>Docker&lt;/code> é¡¹ç›®å’Œ &lt;code>Cloud Foundry&lt;/code> çš„å®¹å™¨æ²¡æœ‰å¤ªå¤§çš„ä¸åŒ,ä½†æ˜¯å®ƒä¸ºä»€ä¹ˆèƒ½é’ˆå¯¹ &lt;code>PAAS&lt;/code>è¿›è¡Œäº†ä¸€åœºå¿«é€Ÿçš„é—ªç”µæˆ˜å‘¢ï¼Ÿ&lt;/p>
&lt;blockquote>
&lt;p>å¯¹çš„, å°±æ˜¯ &lt;code>Docker&lt;/code> é•œåƒ, è¿™ä¸ªå°å°çš„åˆ›æ–°, è¿…é€Ÿæ”¹å˜äº†äº‘è®¡ç®—çš„å‘å±•è½¨è¿¹! &lt;code>Docker&lt;/code> é•œåƒè§£å†³çš„æ˜¯ &lt;code>æ‰“åŒ…&lt;/code> é—®é¢˜ã€‚ä¹Ÿè®¸æœ‰äººè¯´&lt;code>Docker&lt;/code> é•œåƒå°±æ˜¯ä¸€ä¸ªå‹ç¼©åŒ…ã€‚ä½†æ˜¯å°±æ˜¯è¿™ä¸ªå‹ç¼©åŒ…åŒ…å«äº†å®Œæ•´çš„æ“ä½œç³»ç»Ÿæ–‡ä»¶å’Œç›®å½•, åŒ…å«äº†æ•´ä¸ªåº”ç”¨æ‰€éœ€è¦çš„ä¾èµ–ï¼Œä¸€åŒ…åœ¨æ‰‹, ä½ å¯ä»¥è½»æ˜“çš„è¿è¡Œä½ çš„&lt;code>æ²™ç›’&lt;/code>,å¹¶ä¸”æœ¬åœ°ç¯å¢ƒä¸äº‘ç«¯ç¯å¢ƒé«˜åº¦ä¸€è‡´ï¼ˆè¿™æ˜¯æœ€å®è´µçš„ï¼‰ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>Docker&lt;/code>ç»™&lt;code>PAAS&lt;/code>è¿›è¡Œäº†è‡´å‘½æ‰“å‡», æä¾›äº†ä¾¿åˆ©çš„æ‰“åŒ…æœºåˆ¶, é¢å‘åç«¯å¼€å‘è€…æ¥è¯´, å±è”½äº†æœºå™¨ã€å†…æ ¸ç­‰æŠ€æœ¯ç»†èŠ‚, é¿å…äº†åœ¨ä¸åŒç¯å¢ƒé—´çš„å·®å¼‚å¼•å…¥çš„è¯•é”™æˆæœ¬ã€‚æ˜¯ä¸€æ¬¡è§£æ”¾ç”Ÿäº§åŠ›çš„é©å‘½ã€‚å½“ç„¶å¾ˆå¤šå¼€å‘è€…ç”¨è„šæŠ•ç¥¨, äº†ç»“äº†&lt;code>PAAS&lt;/code>æ—¶ä»£ã€‚&lt;/p>
&lt;h1 id="docker-ä¸‰å¤§åˆ©å™¨">&lt;code>Docker&lt;/code> ä¸‰å¤§åˆ©å™¨&lt;/h1>
&lt;ul>
&lt;li>&lt;code>Docker&lt;/code>é¡¹ç›®çš„é«˜è°ƒå¼€æº, è§£å†³äº†æ‰“åŒ…å’Œå‘å¸ƒå›°æ‰°è¿ç»´çš„æŠ€æœ¯éš¾é¢˜ï¼ŒåŒæ—¶å®ƒä¹Ÿç¬¬ä¸€æ¬¡çº¯åç«¯çš„æ¦‚å¿µé€šè¿‡å‹å¥½çš„è®¾è®¡å’Œå°è£…äº¤ä»˜åˆ°äº†å¼€å‘è€…çš„æ‰‹é‡Œã€‚&lt;/li>
&lt;li>&lt;code>Swarm&lt;/code>,&lt;code>Docker&lt;/code>æ˜¯åˆ›å»ºå’Œå¯åœå®¹å™¨çš„å·¥å…·,é‚£ä¹ˆ&lt;code>Swarm&lt;/code>æ˜¯ä¸ºäº†å‘å¹³å°åŒ–å‘å±•è€Œæå‡ºçš„ã€‚å®ƒæä¾›äº†å®Œæ•´çš„æ•´ä½“å¯¹å¤–æä¾›é›†ç¾¤ç®¡ç†åŠŸèƒ½,å®ƒçš„äº®ç‚¹æ˜¯å®Œå…¨ä½¿ç”¨&lt;code>Docker&lt;/code>åŸæœ¬çš„ç®¡ç†å®¹å™¨çš„APIæ¥å®Œæˆé›†ç¾¤ç®¡ç†&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-shell" data-lang="shell">&lt;span style="color:#228b22"># Swarmå¤šæœºç¯å¢ƒä¸‹ï¼ŒæŒ‡ä»¤ä¼šè¢«Swarmæ‹¦æˆªå¤„ç†ï¼Œåé¢é€šè¿‡è°ƒåº¦ç®—æ³•æ‰¾åˆ°åˆé€‚çš„Docker Daemonè¿è¡Œ&lt;/span>
docker run -H &lt;span style="color:#cd5555">&amp;#34;Swarmé›†ç¾¤API&amp;#34;&lt;/span> &lt;span style="color:#cd5555">&amp;#34;æˆ‘çš„å®¹å™¨&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;code>Compose&lt;/code>(Fig)é¡¹ç›®, è¿™æ˜¯ç¬¬ä¸€æ¬¡åœ¨å¼€å‘è€…é¢å‰æå‡º &lt;code>å®¹å™¨ç¼–æ’&lt;/code>(Container Orchestration)æ¦‚å¿µã€‚&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>åº”ç”¨å®¹å™¨ A, æ•°æ®åº“å®¹å™¨B, è´Ÿè½½å‡è¡¡å®¹å™¨C, Compose å…è®¸ Aã€Bã€C ä¸‰ä¸ªå®¹å™¨å®šä¹‰åœ¨é…ç½®æ–‡ä»¶ä¸­, å¹¶æŒ‡å®šå…³è”å…³ç³». åªéœ€è¦æ‰§è¡Œ (fig/docker-compose up)&lt;/p>
&lt;/blockquote>
&lt;h1 id="å®¹å™¨åŒ–ç¾¤é›„å¹¶èµ·ä¸å°˜åŸƒè½å®š">å®¹å™¨åŒ–ç¾¤é›„å¹¶èµ·ä¸å°˜åŸƒè½å®š&lt;/h1>
&lt;p>å®¹å™¨å¼€å¯ç«çˆ†æ¨¡å¼, å¤§é‡å›´ç»• &lt;code>Docker&lt;/code> é¡¹ç›®çš„ç½‘ç»œã€å­˜å‚¨ã€ç›‘æ§ã€&lt;code>CI/CD&lt;/code>ã€UI ç­‰æ¶Œç°äº†è¯¸å¦‚ &lt;code>Rancher&lt;/code>ã€&lt;code>Tutum&lt;/code> ç­‰åœ¨å¼€æºå’Œå•†ä¸šä¸Šå–å¾—æˆåŠŸçš„åˆ›ä¸šå…¬å¸ã€‚
åœ¨ &lt;code>Docker&lt;/code> ã€ &lt;code>Google&lt;/code>ã€&lt;code>CoreOS&lt;/code>ã€&lt;code>ReaHat&lt;/code> ç­‰å…¬å¸åœ¨äº‘è®¡ç®—å¤§æ‰“å‡ºæ‰‹çš„æ—¶å€™ï¼Œè½åœ¨ä¸‹é£çš„ &lt;code>Google&lt;/code>ã€&lt;code>CoreOS&lt;/code>ã€&lt;code>RedHat&lt;/code> å¼€å§‹å¿½æ‚  &lt;code>Docker&lt;/code> å°† &lt;code>Libcontainer&lt;/code> é¡¹ç›®æå‡ºã€ç»„å»ºä¸€ä¸ªå®Œå…¨ç‹¬ç«‹ä¸­ç«‹çš„åŸºé‡‘ä¼šç®¡ç†ï¼Œä»¥ &lt;code>RunC&lt;/code>ï¼ˆæ”¹åçš„ &lt;code>Libcontainer&lt;/code> ï¼‰ä¸ºä¾æ®ï¼Œå¤§å®¶å…±åŒåˆ¶å®šä¸€å¥—å®¹å™¨å’Œé•œåƒçš„æ ‡å‡†å’Œè§„èŒƒã€‚è¿™å¥—æ ‡å‡†å’Œè§„èŒƒå°±æ˜¯ &lt;code>OCI&lt;/code>(&lt;code>Open Container Initiative&lt;/code>),
&lt;code>OCI&lt;/code> çš„æå‡ºï¼Œå°†å®¹å™¨è¿è¡Œæ—¶å’Œé•œåƒçš„å®ç°ä»&lt;code>Docker&lt;/code>é¡¹ç›®åªå®Œå…¨å‰¥ç¦»å¼€æ¥ã€‚ï¼ˆå¥½ä¸€æ‹›å›´é­æ•‘èµµï¼Œæ”¹å–„&lt;code>Docker&lt;/code>å…¬å¸ä¸€å®¶ç‹¬å¤§ï¼Œå…¶ä»–å…¬å¸ä¸ä¾èµ–ä¸&lt;code>Docker&lt;/code>é¡¹ç›®ï¼‰
è¿™æ˜¯ç¬¬ä¸€æ­¥ï¼Œåé¢å°±æ˜¯å®¹å™¨ä¹‹ä¸Šçš„å¹³å°å±‚ï¼Œå°±æ˜¯ &lt;code>PAAS&lt;/code> å±‚äº†,åæ¥&lt;code>Google&lt;/code>ã€&lt;code>RedHat&lt;/code> ç­‰åŸºç¡€è®¾æ–½ç©å®¶ï¼Œå…±åŒå‘èµ· &lt;code>CNCF&lt;/code>(&lt;code>Cloud Native Computing Foundation&lt;/code>) åŸºé‡‘ä¼šã€‚ä»¥ &lt;code>Kubernetes&lt;/code> é¡¹ç›®ä¸ºåŸºç¡€ï¼Œå»ºç«‹ç”±å¼€æºåŸºç¡€è®¾æ–½å‚å•†é¢†å¯¼çš„æŒ‰ç…§åŸºé‡‘ä¼šæ–¹å¼è¿è¥çš„å¹³å°çº§ç¤¾åŒºã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;code>Kubernetes&lt;/code> é¡¹ç›®å¿…é¡»èƒ½å¤Ÿåœ¨å®¹å™¨ç¼–æ’é¢†åŸŸå–å¾—è¶³å¤Ÿå¤§çš„ç«äº‰ä¼˜åŠ¿&lt;/li>
&lt;li>&lt;code>CNCF&lt;/code> ç¤¾åŒºå¿…é¡»ä»¥ &lt;code>Kubernetes&lt;/code> é¡¹ç›®ä¸ºæ ¸å¿ƒï¼Œè¦†ç›–æ›´å¤šçš„å¸¸è§&lt;/li>
&lt;/ul>
&lt;p>&lt;code>Kubernetes&lt;/code> å½“åˆä¸ºä»€ä¹ˆè¢«è®¤ä¸ºè®¾è®¡æ€æƒ³è¿‡äºè¶…å‰ï¼Œå°±æ˜¯å› ä¸º Google åœ¨å®¹å™¨åŒ–å¤šå¹´çš„æ²‰æ·€å’Œå‡åï¼ˆ&lt;code>Borg&lt;/code> å’Œ &lt;code>Omega&lt;/code> ç‰¹æ€§ã€è½åœ¨ &lt;code>K8S&lt;/code> ä¸Šå°±æ˜¯ &lt;code>Pod&lt;/code>ã€&lt;code>Sidecar&lt;/code> çš„åŠŸèƒ½å’Œè®¾è®¡æ¨¡å¼ï¼‰
&lt;code>Kubernetes&lt;/code> å½“åˆæ²¡æœ‰é€‰æ‹©å’Œ &lt;code>Swarm&lt;/code> å±•å¼€åŒè´¨åŒ–ç«äº‰ï¼Œè€Œæ˜¯æå‡ºå¤ªå¤šçš„è®¾è®¡ç†å¿µå’Œå·å¬åŠ›ï¼Œå¾ˆå¿«æ„å»ºäº†ä¸åŒçš„å®¹å™¨ç¼–æ’çš„ç®¡ç†çš„ç”Ÿæ€ç†å¿µã€‚è¶…è¿‡äº†&lt;code>Swarm&lt;/code>é¡¹ç›®ã€‚æœ‰äº†è¿™ä¸ªåï¼Œåˆå°†å®¹å™¨ç›‘æ§äº‹å®æ ‡å‡† &lt;code>prometheus&lt;/code>èå…¥å…¶ä¸­ï¼Œåé¢åˆæ–°å¢äº† &lt;code>Fluentd&lt;/code>ã€&lt;code>OpenTracing&lt;/code>ã€&lt;code>CNDI&lt;/code> ç­‰è¯¸å¤šå®¹å™¨ç”Ÿæ€å·¥å…·å’Œé¡¹ç›®ã€‚åé¢åˆä¸€è®°è¡¥åˆ€ï¼šæ•´ä¸ªç¤¾åŒºè¿›è¡Œæ¨è¿›&lt;code>æ°‘ä¸»åŒ–&lt;/code>æ¶æ„, ä» API åˆ° å®¹å™¨è¿è¡Œæ—¶çš„ æ¯ä¸€å±‚,
&lt;code>Kubernetes&lt;/code> é¡¹ç›®éƒ½ä¸ºå¼€å‘è€…æš´éœ²å‡ºäº†å¯ä»¥æ‰©å±•çš„æ’ä»¶æœºåˆ¶, é¼“åŠ±ç¤¾åŒºç”¨æˆ·é€šè¿‡ä»£ç çš„æ–¹å¼ä»‹å…¥ &lt;code>Kubernetes&lt;/code> é¡¹ç›®çš„æ¯ä¸€ä¸ªé˜¶æ®µã€‚è¿™ä¸ªæ“ä½œé’ˆå¯¹ &lt;code>Docker&lt;/code> æ¥è¯´æ˜¯è‡´å‘½çš„,æ•´ä¸ªå®¹å™¨ç¤¾åŒºå‚¬ç”Ÿäº†å¤§é‡çš„ã€åŸºäº &lt;code>Kubernetes API&lt;/code> çš„åšæ‰©å±•çš„å’ŒäºŒæ¬¡å¼€å‘åˆ›æ–°çš„&lt;/p>
&lt;ul>
&lt;li>å¾®æœåŠ¡æ²»ç†é¡¹ç›® &lt;code>Istio&lt;/code>&lt;/li>
&lt;li>çŠ¶æ€åº”ç”¨éƒ¨ç½²æ¶æ„ &lt;code>Operator&lt;/code>&lt;/li>
&lt;li>&amp;hellip;&lt;/li>
&lt;/ul>
&lt;p>ç»è¿‡ä¸€äº›åˆ—éªšæ“ä½œåï¼ŒK8S å¤§è¡Œå…¶é“ï¼Œç¼–æ’ä¹‹äº‰è½ä¸‹å¸·å¹•ï¼Œå®¹å™¨ç¤¾åŒºçš„åç»­ç¹è£å®Œå…¨ä»¥ &lt;code>Kubernetes&lt;/code> é¡¹ç›®ä¸ºæ ¸å¿ƒçš„ç™¾å®¶äº‰é¸£, ä» &lt;code>Rancher&lt;/code>é¡¹ç›® çš„å†å²è¿­ä»£è¿‡ç¨‹ä¸­ä¹Ÿèƒ½çœ‹å‡ºè¿™ä¸ªç²¾å½©çº·å‘ˆçš„å±•ç°ã€‚&lt;/p>
- https://pinkhello.me/posts/17-%E5%9B%9E%E6%9C%9Bk8s-%E5%B0%8F%E9%B2%B8%E9%B1%BC%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF/ - PinkHello, All Rights Reserved</description></item><item><title>14 å·¥ä½œçºªå®2020</title><link>https://pinkhello.me/posts/14-%E5%B7%A5%E4%BD%9C%E7%BA%AA%E5%AE%9E2020/</link><pubDate>Mon, 10 Feb 2020 10:00:19 +0800</pubDate><guid>https://pinkhello.me/posts/14-%E5%B7%A5%E4%BD%9C%E7%BA%AA%E5%AE%9E2020/</guid><description>PinkHello https://pinkhello.me/posts/14-%E5%B7%A5%E4%BD%9C%E7%BA%AA%E5%AE%9E2020/ -&lt;h1 id="æ¯æ—¥ä¸€æ€ç¯‡">æ¯æ—¥ä¸€æ€ç¯‡&lt;/h1>
&lt;h2 id="2019-10-12-æ¯æ—¥ä¸€æ€-mysql-walæŠ€æœ¯-å’Œ-ringbuffer-æ€æƒ³å¥½ä¸€è‡´">[2019-10-12 æ¯æ—¥ä¸€æ€] Mysql WALæŠ€æœ¯ å’Œ RingBuffer æ€æƒ³å¥½ä¸€è‡´?&lt;/h2>
&lt;h2 id="2019-10-14-æ¯æ—¥ä¸€æ€-jwt-ç»­ç­¾è¯¥å¦‚ä½•åš">[2019-10-14 æ¯æ—¥ä¸€æ€] JWT ç»­ç­¾è¯¥å¦‚ä½•åš?&lt;/h2>
&lt;h2 id="2019-10-16-æ¯æ—¥ä¸€æ€-tcpip-åè®®å…·ä½“æŒ‡å“ªäº›">[2019-10-16 æ¯æ—¥ä¸€æ€] TCP/IP åè®®å…·ä½“æŒ‡å“ªäº›?&lt;/h2>
&lt;blockquote>
&lt;p>æˆ‘ä»¬éƒ½çŸ¥é“ç½‘ç»œæ˜¯7å±‚æ¨¡å‹ï¼Œåº”è¡¨ä¼šä¼ ç½‘æ•°ç‰©ï¼Œ
ç°åœ¨æˆ‘åªè®¨è®ºåº”ä¼ ç½‘æ•°è¿™4å±‚ã€‚TCP/IPåè®®åº”è¯¥è¢«ç§°ä¸ºTCP/IPæ—ï¼Œ
æˆ‘çš„ç†è§£ä»–ä¸æ˜¯å±äºå•ä¸ªçš„åè®®ç±»å‹ï¼Œæ˜¯ä¸€ä¸ªç»Ÿç§°ï¼ŒçŸ¥é“ç½‘ç»œæ¨¡å‹æ ¸å¿ƒè®¾è®¡æ€æƒ³æ˜¯åˆ†å±‚ï¼Œä¸ºä»€ä¹ˆåˆ†å±‚ï¼Œåˆ†å±‚ä»è®¾è®¡ä¸Šå’Œå®ç°éš¾åº¦ä¸Šéƒ½ç®€å•å¾ˆå¤šï¼Œå“ªä¸€å±‚éœ€è¦ä¿®æ”¹åªéœ€è¦ä¿®æ”¹è¿™ä¸€å±‚ã€‚&lt;/p>
&lt;ul>
&lt;li>åº”ç”¨å±‚ï¼Œåƒæœ€å¸¸è§çš„httpã€ftpã€dnsã€rtspã€rtmpç­‰ç­‰åè®®éƒ½æ˜¯å±äºè¿™ç±»ï¼Œ&lt;/li>
&lt;li>ä¼ è¾“å±‚å‘¢æŒ‰ç…§ä¼ è¾“ç±»å‹åˆåˆ†äº†TCPå’ŒUDP,&lt;/li>
&lt;li>ç½‘ç»œå±‚ï¼Œæ˜¯æ•°æ®åŒ…äº¤äº’çš„å±‚é¢ï¼Œ&lt;/li>
&lt;li>æ•°æ®é“¾è·¯å±‚æ˜¯å¤„ç†ç½‘å¡ã€æ“ä½œç³»ç»Ÿç­‰ç­‰è½¯ç¡¬æŠ½è±¡å‡ºçš„å¯è§éƒ¨åˆ†ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸¾ä¸€ä¸ªæ —å­ï¼Œä¸€ä¸ªhttpè¯·æ±‚ï¼Œåœ¨åº”ç”¨å±‚é¢æ˜¯å®Œæ•´çš„ï¼Œåé¢è¢«ä¼ è¾“å±‚ï¼ˆTCPå±‚ï¼‰è¢«åˆ†åŒ…ï¼Œå¹¶æ‰“ä¸Šåºå·æ ‡è®°ï¼Œå†è¿›å…¥ç½‘ç»œå±‚ï¼ˆIPå±‚ï¼‰æ·»åŠ IPé¦–éƒ¨ï¼ˆç›®æ ‡macåœ°å€ç­‰ç­‰ï¼‰ï¼Œ
ä¸‹é¢å°±æ˜¯å¼€å§‹ç–¯ç‹‚çš„å‘é€äº†ï¼Œæ¥æ”¶æ–¹ä¸€æ ·æ˜¯è¿™ä¸ªè¿‡ç¨‹çš„é€†åºã€‚åº”ç”¨å¤„ç†å®Œæˆåé¢çš„å“åº”è¿‡ç¨‹ä¸è¯·æ±‚è¿‡ç¨‹ä¸€æ ·çš„ä¸€ä¸ªè¿‡ç¨‹ã€‚åŒæ—¶å¯ä»¥æ‰©å±•å‡ºL4ä¸L7çš„é—®é¢˜ï¼Œ
å„è‡ªæ˜¯å¦‚ä½•å»å®ç°è´Ÿè½½å‡è¡¡çš„ï¼ŸL4æ˜¯å¯ä»¥çœ‹å‡ºæ˜¯åŸºäºä¼ è¾“å±‚å³TCPå±‚å·¥ä½œï¼ˆé€šè¿‡å‘å¸ƒVIPï¼ˆç¬¬ä¸‰å±‚ï¼‰ä»¥åŠç¬¬å››å±‚ç«¯å£ï¼‰ï¼ŒL7åŸºäºåº”ç”¨å±‚å·¥ä½œï¼ˆç¬¬å››å±‚åŸºç¡€ä¸Š+è€ƒè™‘åº”ç”¨ç‰¹å¾ï¼‰ï¼Œ
æ¯”å¦‚HTTPçš„URLã€å®¢æˆ·ç«¯çš„ç±»åˆ«ã€è¯­è¨€ç±»å‹ç­‰ç­‰ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="2019-10-18-æ¯æ—¥ä¸€æ€ä¸€ç§åœºæ™¯rabbitmq-çš„-exchange-ä¸º-fanout-ç±»å‹ç»‘å®šåˆ°å¤šä¸ªqueue-ä»€ä¹ˆæƒ…å†µä¼šè§¦å‘-rabbitmq-æµæ§å¦‚ä½•è§£å†³">[2019-10-18 æ¯æ—¥ä¸€æ€]ä¸€ç§åœºæ™¯ï¼Œrabbitmq çš„ Exchange ä¸º fanout ç±»å‹ï¼Œç»‘å®šåˆ°å¤šä¸ªqueue, ä»€ä¹ˆæƒ…å†µä¼šè§¦å‘ rabbitmq æµæ§ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ&lt;/h2>
&lt;h2 id="2019-10-22-æ¯æ—¥ä¸€æ€idåºåˆ—ç”Ÿäº§å™¨æ€ä¹ˆå®ç°å‘¢">[2019-10-22 æ¯æ—¥ä¸€æ€]IDåºåˆ—ç”Ÿäº§å™¨æ€ä¹ˆå®ç°å‘¢ï¼Ÿ&lt;/h2>
&lt;blockquote>
&lt;p>uuidç”Ÿæˆ&lt;/p>
&lt;ul>
&lt;li>åŸºäºæ—¶é—´ï¼ˆ60ä½utcæ—¶é—´ å’Œ æ—¶é—´åºåˆ—å€¼14ä½ï¼Œä»¥åŠmacåœ°å€ï¼‰&lt;/li>
&lt;li>åŸºäºåç§°ï¼ˆé’ˆå¯¹å‘½åç©ºé—´dnsã€urlç­‰åˆ†é…ï¼ŒæŠŠåç§°è½¬æˆå­—èŠ‚åºåˆ—ï¼Œå†ç”¨md5æˆ–sha-1ä¸å‘½åç©ºé—´æ ‡è¯†è¿›è¡Œè®¡ç®—ï¼Œäº§ç”Ÿå“ˆå¸Œç»“æœï¼‰&lt;/li>
&lt;li>åŸºäºéšæœºæ•°ï¼ˆå¯†ç å­¦éšæœºæ•°ï¼Œç³»ç»Ÿçš„ç¡¬ç›˜å†…å­˜çº¿ç¨‹å †æ ˆè¿›ç¨‹å¥æŸ„ç­‰sha-1ç”Ÿæˆå“ˆå¸Œç»“æœï¼‰&lt;/li>
&lt;/ul>
&lt;p>snowflakeï¼Œ64bitï¼Œlongå‹ID&lt;/p>
&lt;ul>
&lt;li>IDç”Ÿæˆæ–¹å¼ 1bitï¼ˆä¸ä½¿ç”¨ï¼‰ï¼Œ41bitæ—¶é—´æˆ³ï¼ˆå½“å‰æ¯«ç§’æ•°ã€69å¹´ä¸€è½®å›ï¼‰ï¼Œ10bitæœºå™¨ç ï¼ˆ1024å°ï¼Œ5bitæ•°æ®ä¸­å¿ƒï¼Œ5bitæœºå™¨IDï¼‰ï¼Œ12bitä½œä¸ºæ¯«ç§’å†…åºåˆ—å·ï¼ˆå•æœºç†è®º 409.6w/sï¼‰&lt;/li>
&lt;li>é›ªèŠ±ç®—æ³•ï¼Œå¤šå°æœºå™¨ï¼Œæœ‰å› ä¸ºæ—¶é’Ÿå›æ‹¨å¯¼è‡´çš„IDç”Ÿæˆé—®é¢˜ï¼Œå½“ç„¶å¯ä»¥é€šè¿‡å‘ç”Ÿæ—¶é’Ÿå›æ‹¨åä¸€ä¸ªé˜ˆå€¼ï¼Œåœ¨é˜ˆå€¼å†…åˆ™ä¸å…è®¸äº§ç”Ÿæ–°çš„IDï¼ŒåŒæ­¥é˜»å¡ï¼Œåœ¨é˜ˆå€¼å¤–é‡æ–°è®¾ç½®æœºå™¨IDæ¥è§£å†³&lt;/li>
&lt;li>github.com/baidu/uid-generator æŠ€æœ¯è€é“ç™¾åº¦å¼€æºçš„åŸºäºsnowflakeå®ç°çš„IDç”Ÿæˆå™¨ï¼Œå¯ä»¥å€Ÿé‰´ç ”è¯»ä¸€ä¸‹&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h2 id="2019-11-01-æ¯æ—¥ä¸€æ€æˆ‘ä»¬å¸¸è¯´çš„é™æµæ˜¯ä»€ä¹ˆä¸ºä»€ä¹ˆè¦é™æµé™æµæœ‰å“ªäº›æ–¹å¼">[2019-11-01 æ¯æ—¥ä¸€æ€]æˆ‘ä»¬å¸¸è¯´çš„é™æµæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦é™æµï¼Ÿé™æµæœ‰å“ªäº›æ–¹å¼ï¼Ÿ&lt;/h2>
&lt;blockquote>
&lt;p>æˆ‘ä»¬å¸¸è¯´çš„é™æµï¼Œé¡¾åæ€ä¹‰å³é™åˆ¶æµé‡. é™åˆ¶ç³»ç»Ÿçš„è¾“å…¥å’Œè¾“å‡º
å¸¸ç”¨çš„é™æµå‘å±•è‡³ä»Šï¼Œæœ‰å››ç§æ–¹å¼&lt;/p>
&lt;ul>
&lt;li>å›ºå®šæ—¶é—´è®¡æ•°å™¨&lt;/li>
&lt;li>æ¼æ¡¶&lt;/li>
&lt;li>ä»¤ç‰Œæ¡¶&lt;/li>
&lt;li>æ»‘åŠ¨çª—å£è®¡æ•°å™¨&lt;/li>
&lt;/ul>
&lt;p>å›ºå®šçª—å£è®¡æ•°å™¨ï¼šä»¥å•ä½æ—¶é—´å†…è¿›å…¥ç³»ç»Ÿï¼ˆç³»ç»Ÿçº§åˆ«ï¼‰æˆ–è€…æŸä¸€ä¸ªå•ä¸€æ¥å£æœåŠ¡ï¼ˆç³»ç»ŸæœåŠ¡çº§åˆ«ï¼‰è¯·æ±‚æ¬¡æ•°ï¼Œåœ¨è¿™ä¸ªå•ä½æ—¶é—´å†…çš„è¶…è¿‡æ¬¡æ•°ï¼Œæ‹’ç»æœåŠ¡æˆ–è€…æ›´æ¢å…¶ä»–æ–¹æ¡ˆï¼ˆé™çº§ã€ç†”æ–­ï¼‰è¾¾åˆ°é™æµç›®çš„ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å¯ä»¥çœ‹å‡ºï¼Œæ˜æ˜¾çš„ç¼ºç‚¹ï¼Œä»æ•´ä½“æ›²çº¿ä¸Šï¼Œæ¯›åˆºç°è±¡éå¸¸ä¸¥é‡ï¼Œå‡è®¾å•ä½æ—¶é—´ 1s å†…é™åˆ¶ 100 æ¬¡ï¼Œåœ¨0-10mså†…æˆ‘å·²ç»è¯·æ±‚è¶…è¿‡100æ¬¡äº†ï¼Œåé¢çš„è¯·æ±‚å…¨éƒ¨æ‹’ç»æˆ–è€…åšå…¶ä»–å¤„ç†äº†ã€‚æ— æ³•æ§åˆ¶å•ä½æ—¶é—´å†…çš„çªå‘æµé‡ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ¼æ¡¶: æ¡¶çš„å®¹é‡å›ºå®šï¼Œæ¡¶æµå‡ºçš„é€Ÿç‡æ’å®šã€‚æ¡¶æ»¡åˆ™é™æµã€‚ä¹Ÿæ˜¯æ— æ³•åº”å¯¹çªå‘æµé‡&lt;/p>
&lt;p>ä»¤ç‰Œæ¡¶ï¼š è¿˜æ˜¯æ¡¶çš„æ–¹å¼ï¼Œ æ¡¶ä¸­å­˜æ”¾çš„æ˜¯ token ï¼Œæ ¹æ®é™æµçš„å¤§å°ï¼Œ token ä»¥æ’å®šé€Ÿç‡è¿›å…¥æ¡¶ä¸­ï¼Œè®¾ç½®æ¡¶çš„æœ€å¤§çš„ token å®¹é‡ï¼Œå½“æ¡¶æ»¡æ—¶å€™æ‹’ç»æ–°æ·»åŠ çš„token
ï¼Œæˆ–è€…ç›´æ¥ä¸¢å¼ƒã€‚æ‰€æœ‰è¯·æ±‚è¿›å…¥å…ˆè·å–ä»¤ç‰Œï¼Œå¾—åˆ°ä»¤ç‰Œç»§ç»­ä¸‹é¢çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¤„ç†å®Œæˆåˆ é™¤ tokenã€‚&lt;/p>
&lt;blockquote>
&lt;p>ç›¸æ¯” æ¼æ¡¶ï¼Œ ä¸€å®šç¨‹åº¦ä¸Šå…è®¸çªå‘æµé‡ï¼Œå¹³æ»‘é™æµï¼Œå› ä¸º æ¡¶ ä¸­çš„ token æ˜¯åŒ€é€Ÿæ”¾å…¥çš„ï¼ŒæŠµå¾¡çªå‘æµé‡ã€‚æ¡¶çš„ token æ•°é‡ä¸ä¼šè¶…è¿‡ç»™å®šçš„æœ€å¤§å€¼ã€‚
å‚è€ƒ guava rate limiter&lt;/p>
&lt;/blockquote>
&lt;p>æ»‘åŠ¨çª—å£è®¡æ•°å™¨:(å‚è€ƒSentinelä¸­ä½¿ç”¨çš„é»˜è®¤é™æµæ–¹å¼)
æ˜¯å¯¹å›ºå®šæ—¶é—´çª—å£è®¡æ•°å™¨çš„ä¼˜åŒ–ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³å›ºå®šæ—¶é—´è®¡æ•°å™¨çš„æ— æ³•é¢å¯¹çªå‘æµé‡ï¼Œä½•ä¸ºæ»‘åŠ¨çª—å£å‘¢ï¼Ÿ
å‡è®¾å•ä½æ—¶é—´å®šä½ 1sï¼Œ è®¡æ•°å™¨é™åˆ¶åœ¨ 1000 æ¬¡ï¼Œ å†å°†è€… 1s åˆ’åˆ†ä¸º 100ms ä¸ºä¸€ä¸ªå°æ ¼å­ï¼Œæ€»å…± 10 ä¸ªæ ¼å­ï¼Œ
æ¯ä¸ªæ ¼å­è¿˜æœ‰è®¡æ•°å™¨ï¼Œå½“ä¸€ä¸ªè¯·æ±‚è¿›æ¥ï¼Œåœ¨å¯¹åº”çš„æ—¶é—´æ ¼å­é‡Œé¢çš„è®¡æ•°å™¨ +1 ï¼Œåªè¦æ€»çš„è¿™ä¸ªå•ä½æ—¶é—´å†…æ‰€æœ‰çš„æ—¶é—´æ ¼å­è®¡æ•°å™¨æ€»å’Œå°äº é™åˆ¶æ¬¡æ•°ï¼Œå°±ä¸ä¼šå¯åŠ¨é™æµä½œç”¨ã€‚
å¯ä»¥çœ‹å‡ºæ¥ï¼Œå‡å¦‚æˆ‘çš„åˆ’åˆ†çš„æ ¼å­å¾ˆå°ï¼Œæ»‘åŠ¨çª—å£æ»šåŠ¨å°†æ˜¯è¶Šå¹³æ»‘çš„ã€‚
psï¼š 0.00 - 1.00 æœ‰ 10 ä¸ªæ ¼å­ï¼Œè¿™æ˜¯ä¸€ä¸ªæ»‘åŠ¨çª—å£æœŸï¼Œç„¶å 0.10-1.10æ˜¯ä¸€ä¸ªçª—å£æœŸï¼Œè¿™æ ·è®¡ç®—çš„&lt;/p>
&lt;/blockquote>
&lt;h2 id="2019-11-04-æ¯æ—¥ä¸€æ€-å‡å¦‚mqæ¶ˆæ¯é˜Ÿåˆ—äº§ç”Ÿäº†å †ç§¯å¦‚ä½•æ›´å¿«çš„æ¶ˆè´¹">[2019-11-04 æ¯æ—¥ä¸€æ€] å‡å¦‚MQæ¶ˆæ¯é˜Ÿåˆ—äº§ç”Ÿäº†å †ç§¯ï¼Œå¦‚ä½•æ›´å¿«çš„æ¶ˆè´¹ï¼Ÿ&lt;/h2>
&lt;blockquote>
&lt;p>ä¼šä»å¤šç§é˜Ÿåˆ—å»åˆ†æï¼Œrabbitmqï¼Œkafkaï¼Œrocketmqï¼Œpulsarç­‰å¤šä¸ªæ¶ˆæ¯ä¸­é—´ä»¶å»åˆ†æã€‚
RabbitMqå¾—çœ‹æ˜¯ä»€ä¹ˆæ¨¡å¼ï¼Œå¦‚æœæ˜¯ç”Ÿäº§æ¶ˆè´¹è€…æ¨¡å¼æ˜¯å¯ä»¥çš„ï¼Œå‘å¸ƒè®¢é˜…æ¨¡å¼å°±æ²¡åµç”¨ï¼ŒåŠ ä¸ªè®¢é˜…è€…è€Œå·²ã€‚kafkaçœ‹consumerçš„æ•°é‡å§ï¼Œå¦‚æœå·²ç»å¤§äºç­‰äºpartitionæ•°é‡äº†ï¼ŒåŠ consumerä¹Ÿæ²¡åµç”¨ã€‚pulsar
æ˜¯ä¹Ÿä¸€æ ·å•Šï¼Œæœ‰ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼Œä¹Ÿæœ‰ç‹¬å å’Œå¤±è´¥æ›¿è¡¥æ¨¡å¼ã€‚&lt;/p>
&lt;p>å¯¹çš„ï¼Œå…ˆè¯´kafkaå’ŒRocketMQï¼Œä»–ä»¬éƒ½æ˜¯åŸºäºpartitionçš„å­˜å‚¨æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªsubjectåˆ†ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªpartitionï¼ŒServeræ”¶åˆ°æ¶ˆæ¯åˆ†å‘åˆ°æŸä¸ªpartitionä¸Šï¼Œè€Œconsumer
æ¶ˆè´¹æ—¶å€™æ˜¯ä¸partitionç›¸å¯¹åº”çš„ï¼Œå½“partitionä¸consumeræ•°é‡ç›¸ç­‰æ—¶ï¼Œæ˜¯ä¸€å¯¹ä¸€ï¼Œå½“å°äºæ—¶å€™ï¼Œä¼šæœ‰consumerç©ºé—²ï¼Œå¤§äºæ—¶å€™ï¼Œçœ‹æ•°é‡ï¼Œæœ‰consumer
ä¼šè´Ÿè´£å¤šä¸ªï¼Œæ¯”è¾ƒç¹å¿™ã€‚åœ¨äº§ç”Ÿé˜Ÿåˆ—ç§¯å‹æ—¶å€™ï¼Œè¿™æ—¶å€™æœ€åˆç†çš„åˆ†é…å‡å‹ç­–ç•¥æ˜¯ partitionæ•°é‡å’Œconsumeræ•°é‡æˆå€æ•°å…³ç³»ï¼Œå•ä¸ªå¢åŠ consumer
æ•°é‡å¹¶ä¸èƒ½æœ‰æ•ˆæé«˜æ—¶å€™ï¼Œå¹¶ä¸”å¹¶ä¸èƒ½é©¬ä¸Šæé«˜æ¶ˆè´¹æ•ˆç‡ï¼Œéœ€è¦æ·»åŠ å¯¹åº”çš„partitionæ•°é‡ï¼Œä½†æ˜¯å°±å¸¦æ¥äº†å¦å¤–çš„é—®é¢˜ï¼Œpartitionæ•°é‡å¢åŠ ï¼Œç‰¹åˆ«æ˜¯kafkaï¼Œpartitionèµ„æºæ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡çš„èµ„æºï¼Œå¢åŠ partition
æ•°é‡è¿˜éœ€è¦è€ƒè™‘é›†ç¾¤çš„å¤„ç†èƒ½åŠ›ï¼Œå¦å¤–åœ¨é«˜å³°è¿‡åï¼Œæƒ³è¦consumerç¼©å®¹ä¹Ÿæ¯”è¾ƒéº»çƒ¦å“¦ï¼Œå› ä¸ºpartitionåªèƒ½å¢åŠ ä¸èƒ½å‡å°‘ã€‚&lt;/p>
&lt;p>é’ˆå¯¹partitionå­˜å‚¨æ–¹å¼çš„ï¼Œæ‰©å®¹ç›¸å…³çš„é—®é¢˜ï¼Œå·²ç»å †ç§¯çš„æ¶ˆæ¯æ˜¯ä¸èƒ½å¿«é€Ÿæ¶ˆè´¹çš„ï¼Œå‡è®¾æ˜¯2partitionå¯¹2ä¸ªconsumerï¼Œè¿™æ—¶å€™å¢åŠ partitionå’Œconsumeræ˜¯æ— ç”¨çš„ï¼Œå› ä¸ºå·²ç»å †ç§¯çš„åªèƒ½ç”±è¿™ä¸¤ä¸ªconsumer
æ¶ˆè´¹ï¼Œæ¨ªå‘æ‰©å±•ä¸å¯èƒ½äº†ï¼Œåªèƒ½çºµå‘æ‰©å±•ï¼Œè¿™æ—¶å€™è¦ä¹ˆåªèƒ½æ¥å—å·²ç»å †ç§¯æ…¢æ…¢æ¶ˆè´¹ï¼Œå¹¶ä¸”å°½é‡å‡å°‘å…¥è¿™ä¸¤ä¸ªpartitionçš„æ¶ˆæ¯ï¼Œæˆ–è€…æ‰§è¡Œæ¯”è¾ƒé‡ç‚¹å†å‡è¡¡ç­–ç•¥ï¼&lt;/p>
&lt;/blockquote>
&lt;h2 id="2019-11-18-æ¯æ—¥ä¸€æ€-httpdnsæœ‰å•¥å¥½å¤„-httpdns-ä¸ºä»€ä¹ˆä¸€èˆ¬åªé€‚ç”¨äº-app-æˆ–è€…-cs-æ¶æ„bs-ä¸ºä½•ä¸é€‚ç”¨">[2019-11-18 æ¯æ—¥ä¸€æ€] HttpDNSæœ‰å•¥å¥½å¤„, HttpDNS ä¸ºä»€ä¹ˆä¸€èˆ¬åªé€‚ç”¨äº APP æˆ–è€… C/S æ¶æ„ï¼ŒB/S ä¸ºä½•ä¸é€‚ç”¨?#&lt;/h2>
&lt;blockquote>
&lt;p>HttpDNS æ˜¯åŸºäºHTTPåè®®å‘èµ·æœåŠ¡å™¨Aè®°å½•çš„åœ°å€ï¼Œä¸å­˜åœ¨å‘æœ¬åœ°è¿è¥å•†è¯¢é—® domain è§£æè¿‡ç¨‹
é€‚ç”¨äºAPPæˆ–è€…C/Sæ¶æ„ï¼Œæ˜¯å®ƒçš„ç‰¹æ®Šæ€§å¯¼è‡´çš„ï¼Œ&lt;/p>
&lt;ul>
&lt;li>ä¸€èˆ¬åœ¨ç»ˆç«¯è¿™ç§ä¿¡å·å·®ã€ä¿¡å·ä¸ç¨³å®šä¸‹ï¼Œè¦æƒ³å°½é‡çš„ä»‹ç»äº¤äº’&lt;/li>
&lt;li>è·‘é©¬æœºåˆ¶é€‰å–å°±è¿‘åœ°å€&lt;/li>
&lt;li>SDKåµŒå…¥&lt;/li>
&lt;/ul>
&lt;/blockquote>
&lt;h2 id="2019-12-12-æ¯æ—¥ä¸€æ€æˆ‘ä»¬çŸ¥é“è®¸å¤šé•¿é“¾æ¥æƒ…å†µä¸‹ä¿è¯é“¾æ¥æœ‰æ•ˆå¤§éƒ¨åˆ†æ˜¯é€šè¿‡-tcp-keepalive-ä¸-åº”ç”¨å¿ƒè·³-æ¥ç¡®å®šå„è‡ªçš„å®šä½æ˜¯ä»€ä¹ˆä¸ºä»€ä¹ˆå¤§å¤šæ•°æƒ…å†µä¸‹å¾ˆå¤šimç³»ç»ŸåŒæ—¶ä½¿ç”¨-tcp-keepalive-ä¸-åº”ç”¨å±‚å¿ƒè·³å»ç¡®è®¤-åº”ç”¨å±‚å¿ƒè·³è®¾è®¡ä¸Šæœ‰å•¥è®²ç©¶">[2019-12-12 æ¯æ—¥ä¸€æ€]æˆ‘ä»¬çŸ¥é“è®¸å¤šé•¿é“¾æ¥æƒ…å†µä¸‹ï¼Œä¿è¯é“¾æ¥æœ‰æ•ˆå¤§éƒ¨åˆ†æ˜¯é€šè¿‡ TCP Keepalive ä¸ åº”ç”¨å¿ƒè·³ æ¥ç¡®å®šï¼Œå„è‡ªçš„å®šä½æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå¤§å¤šæ•°æƒ…å†µä¸‹å¾ˆå¤šIMç³»ç»ŸåŒæ—¶ä½¿ç”¨ TCP Keepalive ä¸ åº”ç”¨å±‚å¿ƒè·³å»ç¡®è®¤ï¼Ÿ åº”ç”¨å±‚å¿ƒè·³è®¾è®¡ä¸Šæœ‰å•¥è®²ç©¶ï¼Ÿ&lt;/h2>
&lt;blockquote>
&lt;p>TCP Keepalive æ˜¯ TCP/IP åè®®è‡ªå¸¦ï¼Œæ— éœ€é¢å¤–çš„å¼€å‘ï¼Œä½†æ˜¯ä¸çµæ´»ï¼Œè€Œä¸”æˆ‘ä»¬ä¸€èˆ¬åœ¨åº”ç”¨å±‚é¢æ˜¯æ— æ³•æ„ŸçŸ¥ã€‚æ›´æ”¹TCP Keepalive ç›¸å…³å‚æ•°éœ€è¦ä¿®æ”¹/etc/sysctl.conf&lt;/p>
&lt;p>åº”ç”¨å±‚å¿ƒè·³æ˜¯ä¸ºäº†ä¿æ´»ï¼Œä¿è¯é“¾æ¥çš„å¯ç”¨æ€§&lt;/p>
&lt;ul>
&lt;li>è¿è¥å•†çš„ç¯å¢ƒï¼Œï¼Œå­˜åœ¨ NAT è¶…æ—¶æ–­é“¾é—®é¢˜&lt;/li>
&lt;li>è®©åº”ç”¨çŸ¥æ™“ç½‘ç»œå¯ç”¨æƒ…å†µï¼Œé…Œæƒ…å¤„ç†æ–­é“¾é‡è¿é—®é¢˜&lt;/li>
&lt;li>å¯ä»¥æœ‰æ•ˆçš„æ±Ÿéƒ½æœåŠ¡ç«¯ä¸ºäº†ç»´æŠ¤æ— æ•ˆé“¾æ¥çš„å¼€é”€&lt;/li>
&lt;/ul>
&lt;p>åº”ç”¨å±‚å¿ƒè·³è®¾è®¡ä¸Š&lt;/p>
&lt;ul>
&lt;li>å›ºå®šé¢‘ç‡ï¼Œé€šå¸¸åªæœ‰è¯·æ±‚å¤´ï¼Œæ¶ˆæ¯ä½“ç©ºåŒ…ï¼ˆåœ¨åˆ¤æ–­è¿™ç±»å¿ƒè·³å¤„ç†æ—¶å€™ï¼Œå®¢æˆ·ç«¯ä¸€èˆ¬è¦åˆ¤æ–­è¶…æ—¶æ—¶é—´å¤§äºå¿ƒè·³é—´éš”ã€å¯èƒ½å­˜åœ¨ç½‘ç»œå»¶è¿Ÿã€‘ï¼‰&lt;/li>
&lt;li>æ™ºèƒ½å¿ƒè·³ï¼Œæ ¹æ®ç½‘ç»œçŠ¶å†µè‡ªåŠ¨è°ƒæ•´å‘é€çš„é¢‘ç‡ï¼Œæ¥é€‚é…å½“å‰ç½‘ç»œæƒ…å†µçš„æœ€ä½³å¿ƒè·³é¢‘ç‡ï¼ˆå„ä¸ªåœ°åŒºå„ä¸ªæœåŠ¡å•† NAT è¶…æ—¶è®¾è®¡ä¸ä¸€æ ·ï¼Œé•¿çš„å¤šè¾¾å‡ ä¸ªå°æ—¶ï¼Œå°‘çš„åªæœ‰å‡ ç§’ï¼‰&lt;/li>
&lt;/ul>
&lt;p>æ™ºèƒ½å¿ƒè·³ï¼Œä¸€èˆ¬é‡‡ç”¨äºŒåˆ†æ³•æ¥é€æ¸é€¼è¿‘æœåŠ¡å•†çš„ NAT è¶…æ—¶è®¾è®¡ã€‚å¿ƒè·³è®¾è®¡ä¸Šä¸ä¼šæ˜¯ç©ºåŒ…ï¼Œè€Œæ˜¯ä¼ è¾“çš„æ˜¯å®¢æˆ·ç«¯çš„å¿ƒè·³é¢‘ç‡æ˜¯å¤šå°‘ã€‚
ï¼ˆå‡è®¾ æœ€å°å€¼ 20 s æœ€å¤§å€¼ 1å°æ—¶ï¼‰===&amp;gt; é€æ¸äºŒåˆ†ä¸‹å»&lt;/p>
&lt;/blockquote>
&lt;h2 id="2019-12-14-æ¯æ—¥ä¸€æ€-å¦‚ä½•åˆ¤æ–­ä»»æ„ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶åœ¨æœåŠ¡ç«¯æ˜¯å¦å­˜åœ¨å‘¢ç½‘ç›˜çš„ç§’ä¼ çš„å®ç°æ€è·¯">[2019-12-14 æ¯æ—¥ä¸€æ€] å¦‚ä½•åˆ¤æ–­ä»»æ„ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶åœ¨æœåŠ¡ç«¯æ˜¯å¦å­˜åœ¨å‘¢ï¼Ÿç½‘ç›˜çš„â€œç§’ä¼ â€çš„å®ç°æ€è·¯ï¼Ÿ&lt;/h2>
&lt;blockquote>
&lt;p>å¯¹æ¯”æ–‡ä»¶ï¼Œç¡®å®æ˜¯ä½¿ç”¨çš„æ–‡ä»¶çš„æå–çš„ç‰¹å¾å€¼ï¼ˆå•é¡¹å“ˆå¸Œç®—æ³•ï¼‰,å“ˆå¸Œç®—æ³•æ˜¯æœ‰å†²çªçš„ï¼Œè™½ç„¶æ¦‚ç‡è¾ƒå°ï¼Œ é‚£ä¹ˆå¦‚ä½•è¿™ç§å†²çªå‘¢ï¼šåœ¨æœåŠ¡ç«¯ï¼Œ
å¯¹è¯¥æ–‡ä»¶è¿›è¡Œä¸åŒçš„å•å‘Hashç®—æ³•ï¼ˆMD5ï¼ŒSHA-1ï¼‰ç­‰ç­‰å¾—åˆ°å¤šä¸ªå€¼ï¼Œä¸€ä¸€å¯¹æ¯”ï¼Œåªæœ‰å…¨éƒ¨ç›¸åŒæ‰è®¤ä¸ºæ˜¯åŒä¸€ä¸ªæ–‡ä»¶ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆè¦å“ˆå¸Œï¼Ÿä¸ºäº†å°†ä¸€ä¸ªä¸å®šé•¿ã€ä¸ç¡®å®šçš„ä¸œä¸œ è½¬åŒ–æˆ å›ºå®šé•¿åº¦çš„å›ºåŒ–çš„ç‰¹å¾å€¼ï¼Œå¹¶è¦ä¿è¯å”¯ä¸€æ€§ã€‚&lt;/p>
&lt;/blockquote>
&lt;h1 id="å¡«å‘è®°å½•">å¡«å‘è®°å½•&lt;/h1>
&lt;h2 id="dockerç›¸å…³">dockerç›¸å…³&lt;/h2>
&lt;ul>
&lt;li>dockeré»˜è®¤ç½‘æ¡¥é—®é¢˜&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>æœåŠ¡å™¨é»˜è®¤ç½‘æ¡¥ 172.19.0.0, è€Œ docker ç½‘æ¡¥é»˜è®¤172.17.0.0,
åœ¨å¯åŠ¨å¤šä¸ªçš„dockerå®¹å™¨çš„æ—¶å€™ä¼šå¯¼è‡´åœ°å€å†²çªï¼Œæ¡¥æ¥ç½‘å¡å‡‰ï¼Œ
éœ€è¦æ›´æ”¹docker é»˜è®¤çš„ç½‘æ¡¥åœ°å€&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-markdown" data-lang="markdown"> {
&amp;#34;debug&amp;#34; : true,
&amp;#34;default-address-pools&amp;#34; : [
{
&amp;#34;base&amp;#34; : &amp;#34;172.31.0.0/16&amp;#34;,
&amp;#34;size&amp;#34; : 24
}
]
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ›´æ”¹æˆå’Œä¸»æœºä¸ä¸€æ ·çš„çš„ç½‘æ®µåœ°å€&lt;/p>
&lt;/blockquote>
&lt;h2 id="redisåˆ†å¸ƒå¼é”">redisåˆ†å¸ƒå¼é”&lt;/h2>
&lt;div class="highlight">&lt;pre style="background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-java" data-lang="java">
&lt;span style="color:#8b008b;font-weight:bold">package&lt;/span> &lt;span style="color:#008b45;text-decoration:underline">com.kezaihui.thor.biz.core.adapter.redis.lock&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">import&lt;/span> &lt;span style="color:#008b45;text-decoration:underline">lombok.extern.slf4j.Slf4j&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">import&lt;/span> &lt;span style="color:#008b45;text-decoration:underline">org.springframework.beans.factory.annotation.Autowired&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">import&lt;/span> &lt;span style="color:#008b45;text-decoration:underline">org.springframework.data.redis.core.RedisTemplate&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">import&lt;/span> &lt;span style="color:#008b45;text-decoration:underline">org.springframework.data.redis.core.script.DefaultRedisScript&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">import&lt;/span> &lt;span style="color:#008b45;text-decoration:underline">org.springframework.stereotype.Component&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">import&lt;/span> &lt;span style="color:#008b45;text-decoration:underline">java.util.Collections&lt;/span>;
&lt;span style="color:#228b22">/**
&lt;/span>&lt;span style="color:#228b22"> * RedisTemplateDistributeLockUtil
&lt;/span>&lt;span style="color:#228b22"> */&lt;/span>
&lt;span style="color:#707a7c">@Slf4j&lt;/span>
&lt;span style="color:#707a7c">@Component&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">class&lt;/span> &lt;span style="color:#008b45;font-weight:bold">RedisTemplateDistributeLockUtil&lt;/span> {
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String LOCK_SCRIPT =
&lt;span style="color:#cd5555">&amp;#34;local key = KEYS[1]; local value = ARGV[1]; if redis.call(&amp;#39;set&amp;#39;, key, value, &amp;#39;NX&amp;#39; ,&amp;#39;PX&amp;#39;, %d) &amp;#34;&lt;/span>
+ &lt;span style="color:#cd5555">&amp;#34;then return 1 else return 0 end&amp;#34;&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> String UNLOCK_SCRIPT =
&lt;span style="color:#cd5555">&amp;#34;if redis.call(&amp;#39;get&amp;#39;, KEYS[1]) == ARGV[1] then return redis.call(&amp;#39;del&amp;#39;,KEYS[1]) else return 0 end&amp;#34;&lt;/span>;
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">static&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">final&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> EXPIRE = 5000;
&lt;span style="color:#707a7c">@Autowired&lt;/span>
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> RedisTemplate redisTemplate;
&lt;span style="color:#8b008b;font-weight:bold">private&lt;/span> String &lt;span style="color:#008b45">lockExpireScript&lt;/span>(&lt;span style="color:#00688b;font-weight:bold">int&lt;/span> expireMills) {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (expireMills &amp;lt;= 0) {
expireMills = EXPIRE;
}
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> String.&lt;span style="color:#658b00">format&lt;/span>(LOCK_SCRIPT, expireMills);
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">boolean&lt;/span> &lt;span style="color:#008b45">lock&lt;/span>(String key, String value, &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> expireMills) {
String script = lockExpireScript(expireMills);
DefaultRedisScript&amp;lt;Long&amp;gt; redisScript = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> DefaultRedisScript&amp;lt;&amp;gt;(script, Long.&lt;span style="color:#658b00">class&lt;/span>);
Long execute = (Long) redisTemplate.&lt;span style="color:#658b00">execute&lt;/span>(redisScript, Collections.&lt;span style="color:#658b00">singletonList&lt;/span>(key),
Collections.&lt;span style="color:#658b00">singletonList&lt;/span>(value));
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> execute != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span> &amp;amp;&amp;amp; execute != 0;
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">boolean&lt;/span> &lt;span style="color:#008b45">blockLock&lt;/span>(String key, String value, &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> expireMills) &lt;span style="color:#8b008b;font-weight:bold">throws&lt;/span> DistributeLockTimeoutException {
&lt;span style="color:#228b22">// è¢«é˜»å¡çš„æ—¶é—´è¶…è¿‡5ç§’å°±åœæ­¢è·å–é”
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#00688b;font-weight:bold">int&lt;/span> blockTime = expireMills;
&lt;span style="color:#228b22">// é»˜è®¤çš„é—´éš”æ—¶é—´
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">for&lt;/span> (; ; ) {
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (blockTime &amp;gt;= 0) {
String script = lockExpireScript(expireMills);
DefaultRedisScript&amp;lt;Long&amp;gt; redisScript = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> DefaultRedisScript&amp;lt;&amp;gt;(script, Long.&lt;span style="color:#658b00">class&lt;/span>);
Long result = (Long) redisTemplate.&lt;span style="color:#658b00">execute&lt;/span>(redisScript, Collections.&lt;span style="color:#658b00">singletonList&lt;/span>(key), value);
&lt;span style="color:#8b008b;font-weight:bold">if&lt;/span> (result != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span> &amp;amp;&amp;amp; result == 1) {
&lt;span style="color:#228b22">// å¾—åˆ°äº†é”
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">true&lt;/span>;
} &lt;span style="color:#8b008b;font-weight:bold">else&lt;/span> {
blockTime -= 300;
&lt;span style="color:#8b008b;font-weight:bold">try&lt;/span> {
Thread.&lt;span style="color:#658b00">sleep&lt;/span>(300);
} &lt;span style="color:#8b008b;font-weight:bold">catch&lt;/span> (InterruptedException e) {
log.&lt;span style="color:#658b00">error&lt;/span>(&lt;span style="color:#cd5555">&amp;#34;RedisTemplateDistributeLockUtil.blockLock error!&amp;#34;&lt;/span>, e);
}
}
} &lt;span style="color:#8b008b;font-weight:bold">else&lt;/span> {
&lt;span style="color:#228b22">// å·²ç»è¶…æ—¶
&lt;/span>&lt;span style="color:#228b22">&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">throw&lt;/span> &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> DistributeLockTimeoutException(&lt;span style="color:#cd5555">&amp;#34;Distribute Lock Timeout&amp;#34;&lt;/span>);
}
}
}
&lt;span style="color:#8b008b;font-weight:bold">public&lt;/span> &lt;span style="color:#00688b;font-weight:bold">boolean&lt;/span> &lt;span style="color:#008b45">unlock&lt;/span>(String key, String value) {
String script = UNLOCK_SCRIPT;
DefaultRedisScript&amp;lt;Long&amp;gt; redisScript = &lt;span style="color:#8b008b;font-weight:bold">new&lt;/span> DefaultRedisScript&amp;lt;&amp;gt;(script, Long.&lt;span style="color:#658b00">class&lt;/span>);
Long execute = (Long) redisTemplate.&lt;span style="color:#658b00">execute&lt;/span>(redisScript, Collections.&lt;span style="color:#658b00">singletonList&lt;/span>(key), value);
&lt;span style="color:#8b008b;font-weight:bold">return&lt;/span> execute != &lt;span style="color:#8b008b;font-weight:bold">null&lt;/span> &amp;amp;&amp;amp; execute != 0;
}
}
&lt;/code>&lt;/pre>&lt;/div>- https://pinkhello.me/posts/14-%E5%B7%A5%E4%BD%9C%E7%BA%AA%E5%AE%9E2020/ - PinkHello, All Rights Reserved</description></item></channel></rss>