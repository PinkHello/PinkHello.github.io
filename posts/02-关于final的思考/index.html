<!doctype html><html lang=en><head><title>一杯哈希不加盐</title><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#000084"><link rel=icon href=https://pinkhello.github.io//favicon.ico><link rel=canonical href=https://pinkhello.github.io/></head><body><nav class="navbar navbar-inverse navbar-fixed-top"><div class=navbar-inner><div class=container><button type=button class="btn btn-navbar" data-toggle=collapse data-target=.nav-collapse></button>
<a class=brand href=https://pinkhello.github.io/>一杯哈希不加盐</a><div class="nav-collapse collapse"><ul class=nav><li><a href=/about/><span>About</span></a></li><li><a href=/posts/><span>Archive</span></a></li></ul></div></div></div></nav><div id=content class=container><div class="row-fluid navmargin"><div class=page-header><h1>02 关于final的思考 - Wed, Feb 10, 2021</h1></div><p class=lead></p><h2 id=关于final的思考>关于<code>final</code>的思考</h2><ul><li><code>final</code> 是声明数据域最终的,不可以修改的，常见的 是类的 序列化<code>ID</code></li><li><code>String</code> 类，其数据域都是 <code>final</code> 的</li></ul><h3 id=修改-final-修饰的属性>修改 <code>final</code> 修饰的属性</h3><p>反射修改 <code>final</code> 修饰的数据域【非常成功的修改了】</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Test</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello world&#34;</span><span style=color:#f92672>;</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> NoSuchFieldException<span style=color:#f92672>,</span> IllegalAccessException <span style=color:#f92672>{</span>
        Test test <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Test<span style=color:#f92672>();</span>
        Field field <span style=color:#f92672>=</span> test<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>);</span>
        field<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
        field<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>test<span style=color:#f92672>,</span><span style=color:#e6db74>&#34;HELLO, WORLD!&#34;</span><span style=color:#f92672>);</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>field<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>test<span style=color:#f92672>));</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>test<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

输出
Hello<span style=color:#f92672>,</span> WORLD<span style=color:#f92672>!</span>
hello  world

</code></pre></div><p>第一个输出是因为说明运行成功，修改<code>final</code>修饰的对象的属性成功修改；</p><p>但是第二个输出，表明了我直接使用 <code>name</code> 的属性却还是输出端额原来的值.</p><p>反编译后的代码</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Test</span> <span style=color:#f92672>{</span>
   <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello world&#34;</span><span style=color:#f92672>;</span>

   <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Test</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
   <span style=color:#f92672>}</span>

   <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> NoSuchFieldException<span style=color:#f92672>,</span> IllegalAccessException <span style=color:#f92672>{</span>
       Test test <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Test<span style=color:#f92672>();</span>
       Field field <span style=color:#f92672>=</span> test<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>);</span>
       field<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
       field<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>test<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;HELLO, WORLD!&#34;</span><span style=color:#f92672>);</span>
       System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>field<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>test<span style=color:#f92672>));</span>
       PrintStream var10000 <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>;</span>
       test<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>();</span>
       var10000<span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hello world&#34;</span><span style=color:#f92672>);</span>
   <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>可以看出 使用对象.属性的已经被替换了，这是由于<code>JVM</code> 的内联优化（方法调用(参数压栈,跳转到方法处执行,再调回,处理栈参数,处理返回值)）导致的，会直接替换掉使用 final 修饰的字段。【当然也可以关闭内联优化】</p><h3 id=修改使用-final-修饰的-static-类属性>修改使用 <code>final</code> 修饰的 <code>static</code> 类属性</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Test</span> <span style=color:#f92672>{</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> String NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;static hello world&#34;</span><span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> NoSuchFieldException<span style=color:#f92672>,</span> IllegalAccessException <span style=color:#f92672>{</span>
        Test test <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Test<span style=color:#f92672>();</span>
        
        <span style=color:#75715e>//修改NAME
</span><span style=color:#75715e></span>        Field sfield <span style=color:#f92672>=</span> test<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;NAME&#34;</span><span style=color:#f92672>);</span>
        sfield<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
        sfield<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>test<span style=color:#f92672>,</span><span style=color:#e6db74>&#34;STATIC HELLO, WORLD!&#34;</span><span style=color:#f92672>);</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>sfield<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>test<span style=color:#f92672>));</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>test<span style=color:#f92672>.</span><span style=color:#a6e22e>NAME</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

输出异常  Can not set <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> 

</code></pre></div><p>修改<code>Field</code>中的<code>modifiers</code>数据域，清除代表<code>final</code>的那个bit，才可以成功修改。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Test</span> <span style=color:#f92672>{</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>static</span> String NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;static hello world&#34;</span><span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> NoSuchFieldException<span style=color:#f92672>,</span> IllegalAccessException <span style=color:#f92672>{</span>
        Test test <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Test<span style=color:#f92672>();</span>

        <span style=color:#75715e>//修改NAME
</span><span style=color:#75715e></span>        Field sfield <span style=color:#f92672>=</span> test<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;NAME&#34;</span><span style=color:#f92672>);</span>
        Field modifiers <span style=color:#f92672>=</span> sfield<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getDeclaredField</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;modifiers&#34;</span><span style=color:#f92672>);</span>
        modifiers<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
        modifiers<span style=color:#f92672>.</span><span style=color:#a6e22e>setInt</span><span style=color:#f92672>(</span>sfield<span style=color:#f92672>,</span> sfield<span style=color:#f92672>.</span><span style=color:#a6e22e>getModifiers</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;</span> <span style=color:#f92672>~</span>Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>FINAL</span><span style=color:#f92672>);</span><span style=color:#75715e>//fianl标志位置0
</span><span style=color:#75715e></span>
        sfield<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
        sfield<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>test<span style=color:#f92672>,</span><span style=color:#e6db74>&#34;STATIC HELLO, WORLD!&#34;</span><span style=color:#f92672>);</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>sfield<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>test<span style=color:#f92672>));</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>test<span style=color:#f92672>.</span><span style=color:#a6e22e>NAME</span><span style=color:#f92672>);</span>

    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

输出

STATIC HELLO<span style=color:#f92672>,</span> WORLD<span style=color:#f92672>!</span>
<span style=color:#66d9ef>static</span> hello world

</code></pre></div><h4><a href=https://pinkhello.github.io/>Back to Home</a></h4></div></div><footer class=container><hr class=soften><p><a href=https://pinkhello.github.io/>hugo.386 theme</a> |
&copy;
<a href=https://pinkhello.github.io/ target=_blank>一杯哈希不加盐</a>
<span id=thisyear>2020</span>
| Built on <a href=//gohugo.io target=_blank>Hugo</a></p><p class=text-center><a href=https://github.com/PinkHello>GitHub</a></p></footer></body><link rel=stylesheet href=/css/bootstrap.css><link rel=stylesheet href=/css/bootstrap-responsive.css><link rel=stylesheet href=/css/style.css><script src=/js/jquery.js></script><script src=/js/bootstrap-386.js></script><script src=/js/bootstrap-transition.js></script><script src=/js/bootstrap-alert.js></script><script src=/js/bootstrap-modal.js></script><script src=/js/bootstrap-dropdown.js></script><script src=/js/bootstrap-scrollspy.js></script><script src=/js/bootstrap-tab.js></script><script src=/js/bootstrap-tooltip.js></script><script src=/js/bootstrap-popover.js></script><script src=/js/bootstrap-button.js></script><script src=/js/bootstrap-collapse.js></script><script src=/js/bootstrap-carousel.js></script><script src=/js/bootstrap-typeahead.js></script><script src=/js/bootstrap-affix.js></script><script>_386={fastLoad:false,onePass:false,speedFactor:1};function ThisYear(){document.getElementById('thisyear').innerHTML=new Date().getFullYear();};</script></html>