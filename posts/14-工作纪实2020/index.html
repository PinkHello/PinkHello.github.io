<!doctype html><html><head><title>14 工作纪实2020</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><meta property="og:title" content="14 工作纪实2020"><meta property="og:description" content="每日一思篇 [2019-10-12 每日一思] Mysql WAL技术 和 RingBuffer 思想好一致? [2019-10-14 每日一思] JWT 续签该如何做? [2019-10-16 每日一思] TCP/IP 协议具体指哪些?  我们都知道网络是7层模型，应表会传网数物， 现在我只讨论应传网数这4层。TCP/IP协议应该被称为TCP/IP族， 我的理解他不是属于单个的协议类型，是一个统称，知道网络模型核心设计思想是分层，为什么分层，分层从设计上和实现难度上都简单很多，哪一层需要修改只需要修改这一层。
 应用层，像最常见的http、ftp、dns、rtsp、rtmp等等协议都是属于这类， 传输层呢按照传输类型又分了TCP和UDP, 网络层，是数据包交互的层面， 数据链路层是处理网卡、操作系统等等软硬抽象出的可见部分。  举一个栗子，一个http请求，在应用层面是完整的，后面被传输层（TCP层）被分包，并打上序号标记，再进入网络层（IP层）添加IP首部（目标mac地址等等）， 下面就是开始疯狂的发送了，接收方一样是这个过程的逆序。应用处理完成后面的响应过程与请求过程一样的一个过程。同时可以扩展出L4与L7的问题， 各自是如何去实现负载均衡的？L4是可以看出是基于传输层即TCP层工作（通过发布VIP（第三层）以及第四层端口），L7基于应用层工作（第四层基础上+考虑应用特征）， 比如HTTP的URL、客户端的类别、语言类型等等。
 [2019-10-18 每日一思]一种场景，rabbitmq 的 Exchange 为 fanout 类型，绑定到多个queue, 什么情况会触发 rabbitmq 流控？如何解决？ [2019-10-22 每日一思]ID序列生产器怎么实现呢？  uuid生成
 基于时间（60位utc时间 和 时间序列值14位，以及mac地址） 基于名称（针对命名空间dns、url等分配，把名称转成字节序列，再用md5或sha-1与命名空间标识进行计算，产生哈希结果） 基于随机数（密码学随机数，系统的硬盘内存线程堆栈进程句柄等sha-1生成哈希结果）  snowflake，64bit，long型ID
 ID生成方式 1bit（不使用），41bit时间戳（当前毫秒数、69年一轮回），10bit机器码（1024台，5bit数据中心，5bit机器ID），12bit作为毫秒内序列号（单机理论 409.6w/s） 雪花算法，多台机器，有因为时钟回拨导致的ID生成问题，当然可以通过发生时钟回拨后一个阈值，在阈值内则不允许产生新的ID，同步阻塞，在阈值外重新设置机器ID来解决 github.com/baidu/uid-generator 技术老铁百度开源的基于snowflake实现的ID生成器，可以借鉴研读一下   [2019-11-01 每日一思]我们常说的限流是什么？为什么要限流？限流有哪些方式？  我们常说的限流，顾名思义即限制流量. 限制系统的输入和输出 常用的限流发展至今，有四种方式
 固定时间计数器 漏桶 令牌桶 滑动窗口计数器  固定窗口计数器：以单位时间内进入系统（系统级别）或者某一个单一接口服务（系统服务级别）请求次数，在这个单位时间内的超过次数，拒绝服务或者更换其他方案（降级、熔断）达到限流目的。"><meta property="og:type" content="article"><meta property="og:url" content="https://pinkhello.github.io/posts/14-%E5%B7%A5%E4%BD%9C%E7%BA%AA%E5%AE%9E2020/"><meta property="article:published_time" content="2021-02-10T10:00:19+08:00"><meta property="article:modified_time" content="2021-02-10T10:00:19+08:00"><meta property="og:site_name" content="一杯哈希不加盐"><meta name=twitter:card content="summary"><meta name=twitter:title content="14 工作纪实2020"><meta name=twitter:description content="每日一思篇 [2019-10-12 每日一思] Mysql WAL技术 和 RingBuffer 思想好一致? [2019-10-14 每日一思] JWT 续签该如何做? [2019-10-16 每日一思] TCP/IP 协议具体指哪些?  我们都知道网络是7层模型，应表会传网数物， 现在我只讨论应传网数这4层。TCP/IP协议应该被称为TCP/IP族， 我的理解他不是属于单个的协议类型，是一个统称，知道网络模型核心设计思想是分层，为什么分层，分层从设计上和实现难度上都简单很多，哪一层需要修改只需要修改这一层。
 应用层，像最常见的http、ftp、dns、rtsp、rtmp等等协议都是属于这类， 传输层呢按照传输类型又分了TCP和UDP, 网络层，是数据包交互的层面， 数据链路层是处理网卡、操作系统等等软硬抽象出的可见部分。  举一个栗子，一个http请求，在应用层面是完整的，后面被传输层（TCP层）被分包，并打上序号标记，再进入网络层（IP层）添加IP首部（目标mac地址等等）， 下面就是开始疯狂的发送了，接收方一样是这个过程的逆序。应用处理完成后面的响应过程与请求过程一样的一个过程。同时可以扩展出L4与L7的问题， 各自是如何去实现负载均衡的？L4是可以看出是基于传输层即TCP层工作（通过发布VIP（第三层）以及第四层端口），L7基于应用层工作（第四层基础上+考虑应用特征）， 比如HTTP的URL、客户端的类别、语言类型等等。
 [2019-10-18 每日一思]一种场景，rabbitmq 的 Exchange 为 fanout 类型，绑定到多个queue, 什么情况会触发 rabbitmq 流控？如何解决？ [2019-10-22 每日一思]ID序列生产器怎么实现呢？  uuid生成
 基于时间（60位utc时间 和 时间序列值14位，以及mac地址） 基于名称（针对命名空间dns、url等分配，把名称转成字节序列，再用md5或sha-1与命名空间标识进行计算，产生哈希结果） 基于随机数（密码学随机数，系统的硬盘内存线程堆栈进程句柄等sha-1生成哈希结果）  snowflake，64bit，long型ID
 ID生成方式 1bit（不使用），41bit时间戳（当前毫秒数、69年一轮回），10bit机器码（1024台，5bit数据中心，5bit机器ID），12bit作为毫秒内序列号（单机理论 409.6w/s） 雪花算法，多台机器，有因为时钟回拨导致的ID生成问题，当然可以通过发生时钟回拨后一个阈值，在阈值内则不允许产生新的ID，同步阻塞，在阈值外重新设置机器ID来解决 github.com/baidu/uid-generator 技术老铁百度开源的基于snowflake实现的ID生成器，可以借鉴研读一下   [2019-11-01 每日一思]我们常说的限流是什么？为什么要限流？限流有哪些方式？  我们常说的限流，顾名思义即限制流量. 限制系统的输入和输出 常用的限流发展至今，有四种方式
 固定时间计数器 漏桶 令牌桶 滑动窗口计数器  固定窗口计数器：以单位时间内进入系统（系统级别）或者某一个单一接口服务（系统服务级别）请求次数，在这个单位时间内的超过次数，拒绝服务或者更换其他方案（降级、熔断）达到限流目的。"><script src=/vendor/js/jquery.min.js></script><script src=/vendor/js/popper.min.js></script><script src=/vendor/js/bootstrap.min.js></script><script src=/vendor/js/smooth-scroll.polyfills.min.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><script src=/vendor/js/vue.min.js></script><link rel=stylesheet href=https://pinkhello.github.io/scss/journal.min.c116bc90d171283f099f173854157ec8f183f9073b93443b2c8ad82899ee9025.css integrity="sha256-wRa8kNFxKD8Jnxc4VBV+yPGD+Qc7k0Q7LIrYKJnukCU=" media=screen><link rel=stylesheet href=https://pinkhello.github.io/scss/dark-mode.min.552aae4638a84aa57cf0b195750a49ea9131d3bb621d1ed3ebc9b14b18166536.css integrity="sha256-VSquRjioSqV88LGVdQpJ6pEx07tiHR7T68mxSxgWZTY=" media=screen><script src=https://pinkhello.github.io//js/loadCSS.js></script><script>loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");</script><script src=https://pinkhello.github.io//js/toc-collapse.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script><script src=/vendor/js/md5.min.js></script><script>var gitalk=new Gitalk({clientID:'Iv1.3fa398411d6a4b95',clientSecret:'702b4a43ae8ec28c194360c19b3204325bc0bd0d',repo:'pinkhello.github.io',owner:'PinkHello',admin:['PinkHello'],id:md5(location.pathname),distractionFreeMode:'false'});window.onload=function(){gitalk.render('gitalk-container')}</script></head><body><div id=app><div ref=sideContainer class=side-container><a class="a-block nav-head false" href=https://pinkhello.github.io/><div class=nav-title>一杯哈希不加盐</div><div class=nav-subtitle>做一个快乐的程序猿</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/posts>Archive</a>
<a class="a-block nav-link-item false" href=/categories>Categories</a>
<a class="a-block nav-link-item false" href=/tags>Tags</a>
<a class="a-block nav-link-item false" href=/about>About</a>
<a class="a-block nav-link-item false" href=/links>Links</a>
<a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://amazingrise.net>Rise</a><br>移植自 <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
一杯哈希不加盐, All Rights Reserved</div></div><div ref=extraContainer class=extra-container><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc-content><center>- 目录 -</center><ul><li><a href=#%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d%e7%af%87 onclick="onNavClick(`#每日一思篇-nav`)" id=每日一思篇-nav>每日一思篇</a></li><ul class=collapse data-toggle=collapse><li><a href=#2019-10-12-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d-mysql-wal%e6%8a%80%e6%9c%af-%e5%92%8c-ringbuffer-%e6%80%9d%e6%83%b3%e5%a5%bd%e4%b8%80%e8%87%b4 onclick="onNavClick(`#2019-10-12-每日一思-mysql-wal技术-和-ringbuffer-思想好一致-nav`)" id=2019-10-12-每日一思-mysql-wal技术-和-ringbuffer-思想好一致-nav>[2019-10-12 每日一思] Mysql WAL技术 和 RingBuffer 思想好一致?</a></li><li><a href=#2019-10-14-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d-jwt-%e7%bb%ad%e7%ad%be%e8%af%a5%e5%a6%82%e4%bd%95%e5%81%9a onclick="onNavClick(`#2019-10-14-每日一思-jwt-续签该如何做-nav`)" id=2019-10-14-每日一思-jwt-续签该如何做-nav>[2019-10-14 每日一思] JWT 续签该如何做?</a></li><li><a href=#2019-10-16-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d-tcpip-%e5%8d%8f%e8%ae%ae%e5%85%b7%e4%bd%93%e6%8c%87%e5%93%aa%e4%ba%9b onclick="onNavClick(`#2019-10-16-每日一思-tcpip-协议具体指哪些-nav`)" id=2019-10-16-每日一思-tcpip-协议具体指哪些-nav>[2019-10-16 每日一思] TCP/IP 协议具体指哪些?</a></li><li><a href=#2019-10-18-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d%e4%b8%80%e7%a7%8d%e5%9c%ba%e6%99%afrabbitmq-%e7%9a%84-exchange-%e4%b8%ba-fanout-%e7%b1%bb%e5%9e%8b%e7%bb%91%e5%ae%9a%e5%88%b0%e5%a4%9a%e4%b8%aaqueue-%e4%bb%80%e4%b9%88%e6%83%85%e5%86%b5%e4%bc%9a%e8%a7%a6%e5%8f%91-rabbitmq-%e6%b5%81%e6%8e%a7%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3 onclick="onNavClick(`#2019-10-18-每日一思一种场景rabbitmq-的-exchange-为-fanout-类型绑定到多个queue-什么情况会触发-rabbitmq-流控如何解决-nav`)" id=2019-10-18-每日一思一种场景rabbitmq-的-exchange-为-fanout-类型绑定到多个queue-什么情况会触发-rabbitmq-流控如何解决-nav>[2019-10-18 每日一思]一种场景，rabbitmq 的 Exchange 为 fanout 类型，绑定到多个queue, 什么情况会触发 rabbitmq 流控？如何解决？</a></li><li><a href=#2019-10-22-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9did%e5%ba%8f%e5%88%97%e7%94%9f%e4%ba%a7%e5%99%a8%e6%80%8e%e4%b9%88%e5%ae%9e%e7%8e%b0%e5%91%a2 onclick="onNavClick(`#2019-10-22-每日一思id序列生产器怎么实现呢-nav`)" id=2019-10-22-每日一思id序列生产器怎么实现呢-nav>[2019-10-22 每日一思]ID序列生产器怎么实现呢？</a></li><li><a href=#2019-11-01-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d%e6%88%91%e4%bb%ac%e5%b8%b8%e8%af%b4%e7%9a%84%e9%99%90%e6%b5%81%e6%98%af%e4%bb%80%e4%b9%88%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e9%99%90%e6%b5%81%e9%99%90%e6%b5%81%e6%9c%89%e5%93%aa%e4%ba%9b%e6%96%b9%e5%bc%8f onclick="onNavClick(`#2019-11-01-每日一思我们常说的限流是什么为什么要限流限流有哪些方式-nav`)" id=2019-11-01-每日一思我们常说的限流是什么为什么要限流限流有哪些方式-nav>[2019-11-01 每日一思]我们常说的限流是什么？为什么要限流？限流有哪些方式？</a></li><li><a href=#2019-11-04-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d-%e5%81%87%e5%a6%82mq%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e4%ba%a7%e7%94%9f%e4%ba%86%e5%a0%86%e7%a7%af%e5%a6%82%e4%bd%95%e6%9b%b4%e5%bf%ab%e7%9a%84%e6%b6%88%e8%b4%b9 onclick="onNavClick(`#2019-11-04-每日一思-假如mq消息队列产生了堆积如何更快的消费-nav`)" id=2019-11-04-每日一思-假如mq消息队列产生了堆积如何更快的消费-nav>[2019-11-04 每日一思] 假如MQ消息队列产生了堆积，如何更快的消费？</a></li><li><a href=#2019-11-18-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d-httpdns%e6%9c%89%e5%95%a5%e5%a5%bd%e5%a4%84-httpdns-%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%80%e8%88%ac%e5%8f%aa%e9%80%82%e7%94%a8%e4%ba%8e-app-%e6%88%96%e8%80%85-cs-%e6%9e%b6%e6%9e%84bs-%e4%b8%ba%e4%bd%95%e4%b8%8d%e9%80%82%e7%94%a8 onclick="onNavClick(`#2019-11-18-每日一思-httpdns有啥好处-httpdns-为什么一般只适用于-app-或者-cs-架构bs-为何不适用-nav`)" id=2019-11-18-每日一思-httpdns有啥好处-httpdns-为什么一般只适用于-app-或者-cs-架构bs-为何不适用-nav>[2019-11-18 每日一思] HttpDNS有啥好处, HttpDNS 为什么一般只适用于 APP 或者 C/S 架构，B/S 为何不适用?#</a></li><li><a href=#2019-12-12-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d%e6%88%91%e4%bb%ac%e7%9f%a5%e9%81%93%e8%ae%b8%e5%a4%9a%e9%95%bf%e9%93%be%e6%8e%a5%e6%83%85%e5%86%b5%e4%b8%8b%e4%bf%9d%e8%af%81%e9%93%be%e6%8e%a5%e6%9c%89%e6%95%88%e5%a4%a7%e9%83%a8%e5%88%86%e6%98%af%e9%80%9a%e8%bf%87-tcp-keepalive-%e4%b8%8e-%e5%ba%94%e7%94%a8%e5%bf%83%e8%b7%b3-%e6%9d%a5%e7%a1%ae%e5%ae%9a%e5%90%84%e8%87%aa%e7%9a%84%e5%ae%9a%e4%bd%8d%e6%98%af%e4%bb%80%e4%b9%88%e4%b8%ba%e4%bb%80%e4%b9%88%e5%a4%a7%e5%a4%9a%e6%95%b0%e6%83%85%e5%86%b5%e4%b8%8b%e5%be%88%e5%a4%9aim%e7%b3%bb%e7%bb%9f%e5%90%8c%e6%97%b6%e4%bd%bf%e7%94%a8-tcp-keepalive-%e4%b8%8e-%e5%ba%94%e7%94%a8%e5%b1%82%e5%bf%83%e8%b7%b3%e5%8e%bb%e7%a1%ae%e8%ae%a4-%e5%ba%94%e7%94%a8%e5%b1%82%e5%bf%83%e8%b7%b3%e8%ae%be%e8%ae%a1%e4%b8%8a%e6%9c%89%e5%95%a5%e8%ae%b2%e7%a9%b6 onclick="onNavClick(`#2019-12-12-每日一思我们知道许多长链接情况下保证链接有效大部分是通过-tcp-keepalive-与-应用心跳-来确定各自的定位是什么为什么大多数情况下很多im系统同时使用-tcp-keepalive-与-应用层心跳去确认-应用层心跳设计上有啥讲究-nav`)" id=2019-12-12-每日一思我们知道许多长链接情况下保证链接有效大部分是通过-tcp-keepalive-与-应用心跳-来确定各自的定位是什么为什么大多数情况下很多im系统同时使用-tcp-keepalive-与-应用层心跳去确认-应用层心跳设计上有啥讲究-nav>[2019-12-12 每日一思]我们知道许多长链接情况下，保证链接有效大部分是通过 TCP Keepalive 与 应用心跳 来确定，各自的定位是什么？为什么大多数情况下很多IM系统同时使用 TCP Keepalive 与 应用层心跳去确认？ 应用层心跳设计上有啥讲究？</a></li><li><a href=#2019-12-14-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d-%e5%a6%82%e4%bd%95%e5%88%a4%e6%96%ad%e4%bb%bb%e6%84%8f%e7%94%a8%e6%88%b7%e4%b8%8a%e4%bc%a0%e7%9a%84%e6%96%87%e4%bb%b6%e5%9c%a8%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%98%af%e5%90%a6%e5%ad%98%e5%9c%a8%e5%91%a2%e7%bd%91%e7%9b%98%e7%9a%84%e7%a7%92%e4%bc%a0%e7%9a%84%e5%ae%9e%e7%8e%b0%e6%80%9d%e8%b7%af onclick="onNavClick(`#2019-12-14-每日一思-如何判断任意用户上传的文件在服务端是否存在呢网盘的秒传的实现思路-nav`)" id=2019-12-14-每日一思-如何判断任意用户上传的文件在服务端是否存在呢网盘的秒传的实现思路-nav>[2019-12-14 每日一思] 如何判断任意用户上传的文件在服务端是否存在呢？网盘的“秒传”的实现思路？</a></li></ul><li><a href=#%e5%a1%ab%e5%9d%91%e8%ae%b0%e5%bd%95 onclick="onNavClick(`#填坑记录-nav`)" id=填坑记录-nav>填坑记录</a></li><ul class=collapse data-toggle=collapse><li><a href=#docker%e7%9b%b8%e5%85%b3 onclick="onNavClick(`#docker相关-nav`)" id=docker相关-nav>docker相关</a></li><li><a href=#redis%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81 onclick="onNavClick(`#redis分布式锁-nav`)" id=redis分布式锁-nav>redis分布式锁</a></li></ul></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a class=pagination-action v-on:click=toggleDarkMode><i class="material-icons pagination-action-icon" v-if=isDarkMode>brightness_4</i>
<i class="material-icons pagination-action-icon" v-else=isDarkMode>brightness_7</i></a></div></div><div class=single-column-drawer-container ref=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/posts>Archive</a>
<a class="a-block drawer-menu-item false" href=/categories>Categories</a>
<a class="a-block drawer-menu-item false" href=/tags>Tags</a>
<a class="a-block drawer-menu-item false" href=/about>About</a>
<a class="a-block drawer-menu-item false" href=/links>Links</a>
<a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- 目录 -</center><ul><li><a href=#%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d%e7%af%87 onclick="onNavClick(`#每日一思篇-nav`)" id=每日一思篇-nav>每日一思篇</a></li><ul class=collapse data-toggle=collapse><li><a href=#2019-10-12-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d-mysql-wal%e6%8a%80%e6%9c%af-%e5%92%8c-ringbuffer-%e6%80%9d%e6%83%b3%e5%a5%bd%e4%b8%80%e8%87%b4 onclick="onNavClick(`#2019-10-12-每日一思-mysql-wal技术-和-ringbuffer-思想好一致-nav`)" id=2019-10-12-每日一思-mysql-wal技术-和-ringbuffer-思想好一致-nav>[2019-10-12 每日一思] Mysql WAL技术 和 RingBuffer 思想好一致?</a></li><li><a href=#2019-10-14-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d-jwt-%e7%bb%ad%e7%ad%be%e8%af%a5%e5%a6%82%e4%bd%95%e5%81%9a onclick="onNavClick(`#2019-10-14-每日一思-jwt-续签该如何做-nav`)" id=2019-10-14-每日一思-jwt-续签该如何做-nav>[2019-10-14 每日一思] JWT 续签该如何做?</a></li><li><a href=#2019-10-16-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d-tcpip-%e5%8d%8f%e8%ae%ae%e5%85%b7%e4%bd%93%e6%8c%87%e5%93%aa%e4%ba%9b onclick="onNavClick(`#2019-10-16-每日一思-tcpip-协议具体指哪些-nav`)" id=2019-10-16-每日一思-tcpip-协议具体指哪些-nav>[2019-10-16 每日一思] TCP/IP 协议具体指哪些?</a></li><li><a href=#2019-10-18-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d%e4%b8%80%e7%a7%8d%e5%9c%ba%e6%99%afrabbitmq-%e7%9a%84-exchange-%e4%b8%ba-fanout-%e7%b1%bb%e5%9e%8b%e7%bb%91%e5%ae%9a%e5%88%b0%e5%a4%9a%e4%b8%aaqueue-%e4%bb%80%e4%b9%88%e6%83%85%e5%86%b5%e4%bc%9a%e8%a7%a6%e5%8f%91-rabbitmq-%e6%b5%81%e6%8e%a7%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3 onclick="onNavClick(`#2019-10-18-每日一思一种场景rabbitmq-的-exchange-为-fanout-类型绑定到多个queue-什么情况会触发-rabbitmq-流控如何解决-nav`)" id=2019-10-18-每日一思一种场景rabbitmq-的-exchange-为-fanout-类型绑定到多个queue-什么情况会触发-rabbitmq-流控如何解决-nav>[2019-10-18 每日一思]一种场景，rabbitmq 的 Exchange 为 fanout 类型，绑定到多个queue, 什么情况会触发 rabbitmq 流控？如何解决？</a></li><li><a href=#2019-10-22-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9did%e5%ba%8f%e5%88%97%e7%94%9f%e4%ba%a7%e5%99%a8%e6%80%8e%e4%b9%88%e5%ae%9e%e7%8e%b0%e5%91%a2 onclick="onNavClick(`#2019-10-22-每日一思id序列生产器怎么实现呢-nav`)" id=2019-10-22-每日一思id序列生产器怎么实现呢-nav>[2019-10-22 每日一思]ID序列生产器怎么实现呢？</a></li><li><a href=#2019-11-01-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d%e6%88%91%e4%bb%ac%e5%b8%b8%e8%af%b4%e7%9a%84%e9%99%90%e6%b5%81%e6%98%af%e4%bb%80%e4%b9%88%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e9%99%90%e6%b5%81%e9%99%90%e6%b5%81%e6%9c%89%e5%93%aa%e4%ba%9b%e6%96%b9%e5%bc%8f onclick="onNavClick(`#2019-11-01-每日一思我们常说的限流是什么为什么要限流限流有哪些方式-nav`)" id=2019-11-01-每日一思我们常说的限流是什么为什么要限流限流有哪些方式-nav>[2019-11-01 每日一思]我们常说的限流是什么？为什么要限流？限流有哪些方式？</a></li><li><a href=#2019-11-04-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d-%e5%81%87%e5%a6%82mq%e6%b6%88%e6%81%af%e9%98%9f%e5%88%97%e4%ba%a7%e7%94%9f%e4%ba%86%e5%a0%86%e7%a7%af%e5%a6%82%e4%bd%95%e6%9b%b4%e5%bf%ab%e7%9a%84%e6%b6%88%e8%b4%b9 onclick="onNavClick(`#2019-11-04-每日一思-假如mq消息队列产生了堆积如何更快的消费-nav`)" id=2019-11-04-每日一思-假如mq消息队列产生了堆积如何更快的消费-nav>[2019-11-04 每日一思] 假如MQ消息队列产生了堆积，如何更快的消费？</a></li><li><a href=#2019-11-18-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d-httpdns%e6%9c%89%e5%95%a5%e5%a5%bd%e5%a4%84-httpdns-%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%80%e8%88%ac%e5%8f%aa%e9%80%82%e7%94%a8%e4%ba%8e-app-%e6%88%96%e8%80%85-cs-%e6%9e%b6%e6%9e%84bs-%e4%b8%ba%e4%bd%95%e4%b8%8d%e9%80%82%e7%94%a8 onclick="onNavClick(`#2019-11-18-每日一思-httpdns有啥好处-httpdns-为什么一般只适用于-app-或者-cs-架构bs-为何不适用-nav`)" id=2019-11-18-每日一思-httpdns有啥好处-httpdns-为什么一般只适用于-app-或者-cs-架构bs-为何不适用-nav>[2019-11-18 每日一思] HttpDNS有啥好处, HttpDNS 为什么一般只适用于 APP 或者 C/S 架构，B/S 为何不适用?#</a></li><li><a href=#2019-12-12-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d%e6%88%91%e4%bb%ac%e7%9f%a5%e9%81%93%e8%ae%b8%e5%a4%9a%e9%95%bf%e9%93%be%e6%8e%a5%e6%83%85%e5%86%b5%e4%b8%8b%e4%bf%9d%e8%af%81%e9%93%be%e6%8e%a5%e6%9c%89%e6%95%88%e5%a4%a7%e9%83%a8%e5%88%86%e6%98%af%e9%80%9a%e8%bf%87-tcp-keepalive-%e4%b8%8e-%e5%ba%94%e7%94%a8%e5%bf%83%e8%b7%b3-%e6%9d%a5%e7%a1%ae%e5%ae%9a%e5%90%84%e8%87%aa%e7%9a%84%e5%ae%9a%e4%bd%8d%e6%98%af%e4%bb%80%e4%b9%88%e4%b8%ba%e4%bb%80%e4%b9%88%e5%a4%a7%e5%a4%9a%e6%95%b0%e6%83%85%e5%86%b5%e4%b8%8b%e5%be%88%e5%a4%9aim%e7%b3%bb%e7%bb%9f%e5%90%8c%e6%97%b6%e4%bd%bf%e7%94%a8-tcp-keepalive-%e4%b8%8e-%e5%ba%94%e7%94%a8%e5%b1%82%e5%bf%83%e8%b7%b3%e5%8e%bb%e7%a1%ae%e8%ae%a4-%e5%ba%94%e7%94%a8%e5%b1%82%e5%bf%83%e8%b7%b3%e8%ae%be%e8%ae%a1%e4%b8%8a%e6%9c%89%e5%95%a5%e8%ae%b2%e7%a9%b6 onclick="onNavClick(`#2019-12-12-每日一思我们知道许多长链接情况下保证链接有效大部分是通过-tcp-keepalive-与-应用心跳-来确定各自的定位是什么为什么大多数情况下很多im系统同时使用-tcp-keepalive-与-应用层心跳去确认-应用层心跳设计上有啥讲究-nav`)" id=2019-12-12-每日一思我们知道许多长链接情况下保证链接有效大部分是通过-tcp-keepalive-与-应用心跳-来确定各自的定位是什么为什么大多数情况下很多im系统同时使用-tcp-keepalive-与-应用层心跳去确认-应用层心跳设计上有啥讲究-nav>[2019-12-12 每日一思]我们知道许多长链接情况下，保证链接有效大部分是通过 TCP Keepalive 与 应用心跳 来确定，各自的定位是什么？为什么大多数情况下很多IM系统同时使用 TCP Keepalive 与 应用层心跳去确认？ 应用层心跳设计上有啥讲究？</a></li><li><a href=#2019-12-14-%e6%af%8f%e6%97%a5%e4%b8%80%e6%80%9d-%e5%a6%82%e4%bd%95%e5%88%a4%e6%96%ad%e4%bb%bb%e6%84%8f%e7%94%a8%e6%88%b7%e4%b8%8a%e4%bc%a0%e7%9a%84%e6%96%87%e4%bb%b6%e5%9c%a8%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%98%af%e5%90%a6%e5%ad%98%e5%9c%a8%e5%91%a2%e7%bd%91%e7%9b%98%e7%9a%84%e7%a7%92%e4%bc%a0%e7%9a%84%e5%ae%9e%e7%8e%b0%e6%80%9d%e8%b7%af onclick="onNavClick(`#2019-12-14-每日一思-如何判断任意用户上传的文件在服务端是否存在呢网盘的秒传的实现思路-nav`)" id=2019-12-14-每日一思-如何判断任意用户上传的文件在服务端是否存在呢网盘的秒传的实现思路-nav>[2019-12-14 每日一思] 如何判断任意用户上传的文件在服务端是否存在呢？网盘的“秒传”的实现思路？</a></li></ul><li><a href=#%e5%a1%ab%e5%9d%91%e8%ae%b0%e5%bd%95 onclick="onNavClick(`#填坑记录-nav`)" id=填坑记录-nav>填坑记录</a></li><ul class=collapse data-toggle=collapse><li><a href=#docker%e7%9b%b8%e5%85%b3 onclick="onNavClick(`#docker相关-nav`)" id=docker相关-nav>docker相关</a></li><li><a href=#redis%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81 onclick="onNavClick(`#redis分布式锁-nav`)" id=redis分布式锁-nav>redis分布式锁</a></li></ul></div></div></div></div></div><transition name=fade><div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav ref=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div ref=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a ref=navTitle class=navbar-brand href=https://pinkhello.github.io/>一杯哈希不加盐</a>
<button type=button class=nav-darkmode-toggle v-on:click=toggleDarkMode>
<i class=material-icons v-if=isDarkMode>brightness_4</i>
<i class=material-icons v-else=isDarkMode>brightness_7</i></button></div></nav><div class=single-column-header-container ref=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://pinkhello.github.io/><div class=single-column-header-title>一杯哈希不加盐</div><div class=single-column-header-subtitle>做一个快乐的程序猿</div></a></div><div id=content><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>14 工作纪实2020<div class=post-meta><time itemprop=datePublished>2021-02-10 10:00</time></div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h1 id=每日一思篇>每日一思篇</h1><h2 id=2019-10-12-每日一思-mysql-wal技术-和-ringbuffer-思想好一致>[2019-10-12 每日一思] Mysql WAL技术 和 RingBuffer 思想好一致?</h2><h2 id=2019-10-14-每日一思-jwt-续签该如何做>[2019-10-14 每日一思] JWT 续签该如何做?</h2><h2 id=2019-10-16-每日一思-tcpip-协议具体指哪些>[2019-10-16 每日一思] TCP/IP 协议具体指哪些?</h2><blockquote><p>我们都知道网络是7层模型，应表会传网数物，
现在我只讨论应传网数这4层。TCP/IP协议应该被称为TCP/IP族，
我的理解他不是属于单个的协议类型，是一个统称，知道网络模型核心设计思想是分层，为什么分层，分层从设计上和实现难度上都简单很多，哪一层需要修改只需要修改这一层。</p><ul><li>应用层，像最常见的http、ftp、dns、rtsp、rtmp等等协议都是属于这类，</li><li>传输层呢按照传输类型又分了TCP和UDP,</li><li>网络层，是数据包交互的层面，</li><li>数据链路层是处理网卡、操作系统等等软硬抽象出的可见部分。</li></ul><p>举一个栗子，一个http请求，在应用层面是完整的，后面被传输层（TCP层）被分包，并打上序号标记，再进入网络层（IP层）添加IP首部（目标mac地址等等），
下面就是开始疯狂的发送了，接收方一样是这个过程的逆序。应用处理完成后面的响应过程与请求过程一样的一个过程。同时可以扩展出L4与L7的问题，
各自是如何去实现负载均衡的？L4是可以看出是基于传输层即TCP层工作（通过发布VIP（第三层）以及第四层端口），L7基于应用层工作（第四层基础上+考虑应用特征），
比如HTTP的URL、客户端的类别、语言类型等等。</p></blockquote><h2 id=2019-10-18-每日一思一种场景rabbitmq-的-exchange-为-fanout-类型绑定到多个queue-什么情况会触发-rabbitmq-流控如何解决>[2019-10-18 每日一思]一种场景，rabbitmq 的 Exchange 为 fanout 类型，绑定到多个queue, 什么情况会触发 rabbitmq 流控？如何解决？</h2><h2 id=2019-10-22-每日一思id序列生产器怎么实现呢>[2019-10-22 每日一思]ID序列生产器怎么实现呢？</h2><blockquote><p>uuid生成</p><ul><li>基于时间（60位utc时间 和 时间序列值14位，以及mac地址）</li><li>基于名称（针对命名空间dns、url等分配，把名称转成字节序列，再用md5或sha-1与命名空间标识进行计算，产生哈希结果）</li><li>基于随机数（密码学随机数，系统的硬盘内存线程堆栈进程句柄等sha-1生成哈希结果）</li></ul><p>snowflake，64bit，long型ID</p><ul><li>ID生成方式 1bit（不使用），41bit时间戳（当前毫秒数、69年一轮回），10bit机器码（1024台，5bit数据中心，5bit机器ID），12bit作为毫秒内序列号（单机理论 409.6w/s）</li><li>雪花算法，多台机器，有因为时钟回拨导致的ID生成问题，当然可以通过发生时钟回拨后一个阈值，在阈值内则不允许产生新的ID，同步阻塞，在阈值外重新设置机器ID来解决</li><li>github.com/baidu/uid-generator 技术老铁百度开源的基于snowflake实现的ID生成器，可以借鉴研读一下</li></ul></blockquote><h2 id=2019-11-01-每日一思我们常说的限流是什么为什么要限流限流有哪些方式>[2019-11-01 每日一思]我们常说的限流是什么？为什么要限流？限流有哪些方式？</h2><blockquote><p>我们常说的限流，顾名思义即限制流量. 限制系统的输入和输出
常用的限流发展至今，有四种方式</p><ul><li>固定时间计数器</li><li>漏桶</li><li>令牌桶</li><li>滑动窗口计数器</li></ul><p>固定窗口计数器：以单位时间内进入系统（系统级别）或者某一个单一接口服务（系统服务级别）请求次数，在这个单位时间内的超过次数，拒绝服务或者更换其他方案（降级、熔断）达到限流目的。</p><blockquote><p>可以看出，明显的缺点，从整体曲线上，毛刺现象非常严重，假设单位时间 1s 内限制 100 次，在0-10ms内我已经请求超过100次了，后面的请求全部拒绝或者做其他处理了。无法控制单位时间内的突发流量。</p></blockquote><p>漏桶: 桶的容量固定，桶流出的速率恒定。桶满则限流。也是无法应对突发流量</p><p>令牌桶： 还是桶的方式， 桶中存放的是 token ，根据限流的大小， token 以恒定速率进入桶中，设置桶的最大的 token 容量，当桶满时候拒绝新添加的token
，或者直接丢弃。所有请求进入先获取令牌，得到令牌继续下面的业务逻辑，处理完成删除 token。</p><blockquote><p>相比 漏桶， 一定程度上允许突发流量，平滑限流，因为 桶 中的 token 是匀速放入的，抵御突发流量。桶的 token 数量不会超过给定的最大值。
参考 guava rate limiter</p></blockquote><p>滑动窗口计数器:(参考Sentinel中使用的默认限流方式)
是对固定时间窗口计数器的优化，就是为了解决固定时间计数器的无法面对突发流量，何为滑动窗口呢？
假设单位时间定位 1s， 计数器限制在 1000 次， 再将者 1s 划分为 100ms 为一个小格子，总共 10 个格子，
每个格子还有计数器，当一个请求进来，在对应的时间格子里面的计数器 +1 ，只要总的这个单位时间内所有的时间格子计数器总和小于 限制次数，就不会启动限流作用。
可以看出来，假如我的划分的格子很小，滑动窗口滚动将是越平滑的。
ps： 0.00 - 1.00 有 10 个格子，这是一个滑动窗口期，然后 0.10-1.10是一个窗口期，这样计算的</p></blockquote><h2 id=2019-11-04-每日一思-假如mq消息队列产生了堆积如何更快的消费>[2019-11-04 每日一思] 假如MQ消息队列产生了堆积，如何更快的消费？</h2><blockquote><p>会从多种队列去分析，rabbitmq，kafka，rocketmq，pulsar等多个消息中间件去分析。
RabbitMq得看是什么模式，如果是生产消费者模式是可以的，发布订阅模式就没卵用，加个订阅者而已。kafka看consumer的数量吧，如果已经大于等于partition数量了，加consumer也没卵用。pulsar
是也一样啊，有生产者消费者模式，也有独占和失败替补模式。</p><p>对的，先说kafka和RocketMQ，他们都是基于partition的存储模型，也就是说每个subject分为一个或多个partition，Server收到消息分发到某个partition上，而consumer
消费时候是与partition相对应的，当partition与consumer数量相等时，是一对一，当小于时候，会有consumer空闲，大于时候，看数量，有consumer
会负责多个，比较繁忙。在产生队列积压时候，这时候最合理的分配减压策略是 partition数量和consumer数量成倍数关系，单个增加consumer
数量并不能有效提高时候，并且并不能马上提高消费效率，需要添加对应的partition数量，但是就带来了另外的问题，partition数量增加，特别是kafka，partition资源是一个比较重的资源，增加partition
数量还需要考虑集群的处理能力，另外在高峰过后，想要consumer缩容也比较麻烦哦，因为partition只能增加不能减少。</p><p>针对partition存储方式的，扩容相关的问题，已经堆积的消息是不能快速消费的，假设是2partition对2个consumer，这时候增加partition和consumer是无用的，因为已经堆积的只能由这两个consumer
消费，横向扩展不可能了，只能纵向扩展，这时候要么只能接受已经堆积慢慢消费，并且尽量减少入这两个partition的消息，或者执行比较重点再均衡策略！</p></blockquote><h2 id=2019-11-18-每日一思-httpdns有啥好处-httpdns-为什么一般只适用于-app-或者-cs-架构bs-为何不适用>[2019-11-18 每日一思] HttpDNS有啥好处, HttpDNS 为什么一般只适用于 APP 或者 C/S 架构，B/S 为何不适用?#</h2><blockquote><p>HttpDNS 是基于HTTP协议发起服务器A记录的地址，不存在向本地运营商询问 domain 解析过程
适用于APP或者C/S架构，是它的特殊性导致的，</p><ul><li>一般在终端这种信号差、信号不稳定下，要想尽量的介绍交互</li><li>跑马机制选取就近地址</li><li>SDK嵌入</li></ul></blockquote><h2 id=2019-12-12-每日一思我们知道许多长链接情况下保证链接有效大部分是通过-tcp-keepalive-与-应用心跳-来确定各自的定位是什么为什么大多数情况下很多im系统同时使用-tcp-keepalive-与-应用层心跳去确认-应用层心跳设计上有啥讲究>[2019-12-12 每日一思]我们知道许多长链接情况下，保证链接有效大部分是通过 TCP Keepalive 与 应用心跳 来确定，各自的定位是什么？为什么大多数情况下很多IM系统同时使用 TCP Keepalive 与 应用层心跳去确认？ 应用层心跳设计上有啥讲究？</h2><blockquote><p>TCP Keepalive 是 TCP/IP 协议自带，无需额外的开发，但是不灵活，而且我们一般在应用层面是无法感知。更改TCP Keepalive 相关参数需要修改/etc/sysctl.conf</p><p>应用层心跳是为了保活，保证链接的可用性</p><ul><li>运营商的环境，，存在 NAT 超时断链问题</li><li>让应用知晓网络可用情况，酌情处理断链重连问题</li><li>可以有效的江都服务端为了维护无效链接的开销</li></ul><p>应用层心跳设计上</p><ul><li>固定频率，通常只有请求头，消息体空包（在判断这类心跳处理时候，客户端一般要判断超时时间大于心跳间隔【可能存在网络延迟】）</li><li>智能心跳，根据网络状况自动调整发送的频率，来适配当前网络情况的最佳心跳频率（各个地区各个服务商 NAT 超时设计不一样，长的多达几个小时，少的只有几秒）</li></ul><p>智能心跳，一般采用二分法来逐渐逼近服务商的 NAT 超时设计。心跳设计上不会是空包，而是传输的是客户端的心跳频率是多少。
（假设 最小值 20 s 最大值 1小时）===> 逐渐二分下去</p></blockquote><h2 id=2019-12-14-每日一思-如何判断任意用户上传的文件在服务端是否存在呢网盘的秒传的实现思路>[2019-12-14 每日一思] 如何判断任意用户上传的文件在服务端是否存在呢？网盘的“秒传”的实现思路？</h2><blockquote><p>对比文件，确实是使用的文件的提取的特征值（单项哈希算法）,哈希算法是有冲突的，虽然概率较小， 那么如何这种冲突呢：在服务端，
对该文件进行不同的单向Hash算法（MD5，SHA-1）等等得到多个值，一一对比，只有全部相同才认为是同一个文件。</p><p>为什么要哈希？为了将一个不定长、不确定的东东 转化成 固定长度的固化的特征值，并要保证唯一性。</p></blockquote><h1 id=填坑记录>填坑记录</h1><h2 id=docker相关>docker相关</h2><ul><li>docker默认网桥问题</li></ul><blockquote><p>服务器默认网桥 172.19.0.0, 而 docker 网桥默认172.17.0.0,
在启动多个的docker容器的时候会导致地址冲突，桥接网卡凉，
需要更改docker 默认的网桥地址</p><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-markdown data-lang=markdown> { 
   &#34;debug&#34; : true,
   &#34;default-address-pools&#34; : [
       {
           &#34;base&#34; : &#34;172.31.0.0/16&#34;,
          &#34;size&#34; : 24
       }
   ]
 }
</code></pre></div><p>更改成和主机不一样的的网段地址</p></blockquote><h2 id=redis分布式锁>redis分布式锁</h2><div class=highlight><pre style=background-color:#eed;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>
<span style=color:#8b008b;font-weight:700>package</span> <span style=color:#008b45;text-decoration:underline>com.kezaihui.thor.biz.core.adapter.redis.lock</span>;

<span style=color:#8b008b;font-weight:700>import</span> <span style=color:#008b45;text-decoration:underline>lombok.extern.slf4j.Slf4j</span>;
<span style=color:#8b008b;font-weight:700>import</span> <span style=color:#008b45;text-decoration:underline>org.springframework.beans.factory.annotation.Autowired</span>;
<span style=color:#8b008b;font-weight:700>import</span> <span style=color:#008b45;text-decoration:underline>org.springframework.data.redis.core.RedisTemplate</span>;
<span style=color:#8b008b;font-weight:700>import</span> <span style=color:#008b45;text-decoration:underline>org.springframework.data.redis.core.script.DefaultRedisScript</span>;
<span style=color:#8b008b;font-weight:700>import</span> <span style=color:#008b45;text-decoration:underline>org.springframework.stereotype.Component</span>;

<span style=color:#8b008b;font-weight:700>import</span> <span style=color:#008b45;text-decoration:underline>java.util.Collections</span>;

<span style=color:#228b22>/**
</span><span style=color:#228b22> * RedisTemplateDistributeLockUtil
</span><span style=color:#228b22> */</span>
<span style=color:#707a7c>@Slf4j</span>
<span style=color:#707a7c>@Component</span>
<span style=color:#8b008b;font-weight:700>public</span> <span style=color:#8b008b;font-weight:700>class</span> <span style=color:#008b45;font-weight:700>RedisTemplateDistributeLockUtil</span> {


    <span style=color:#8b008b;font-weight:700>public</span> <span style=color:#8b008b;font-weight:700>static</span> <span style=color:#8b008b;font-weight:700>final</span> String LOCK_SCRIPT =
            <span style=color:#cd5555>&#34;local key = KEYS[1]; local value = ARGV[1]; if redis.call(&#39;set&#39;, key, value, &#39;NX&#39; ,&#39;PX&#39;, %d) &#34;</span>
                    + <span style=color:#cd5555>&#34;then return 1 else return 0 end&#34;</span>;

    <span style=color:#8b008b;font-weight:700>public</span> <span style=color:#8b008b;font-weight:700>static</span> <span style=color:#8b008b;font-weight:700>final</span> String UNLOCK_SCRIPT =
            <span style=color:#cd5555>&#34;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;,KEYS[1]) else return 0 end&#34;</span>;

    <span style=color:#8b008b;font-weight:700>public</span> <span style=color:#8b008b;font-weight:700>static</span> <span style=color:#8b008b;font-weight:700>final</span> <span style=color:#00688b;font-weight:700>int</span> EXPIRE = 5000;

    <span style=color:#707a7c>@Autowired</span>
    <span style=color:#8b008b;font-weight:700>private</span> RedisTemplate redisTemplate;


    <span style=color:#8b008b;font-weight:700>private</span> String <span style=color:#008b45>lockExpireScript</span>(<span style=color:#00688b;font-weight:700>int</span> expireMills) {
        <span style=color:#8b008b;font-weight:700>if</span> (expireMills &lt;= 0) {
            expireMills = EXPIRE;
        }
        <span style=color:#8b008b;font-weight:700>return</span> String.<span style=color:#658b00>format</span>(LOCK_SCRIPT, expireMills);
    }

    <span style=color:#8b008b;font-weight:700>public</span> <span style=color:#00688b;font-weight:700>boolean</span> <span style=color:#008b45>lock</span>(String key, String value, <span style=color:#00688b;font-weight:700>int</span> expireMills) {
        String script = lockExpireScript(expireMills);
        DefaultRedisScript&lt;Long&gt; redisScript = <span style=color:#8b008b;font-weight:700>new</span> DefaultRedisScript&lt;&gt;(script, Long.<span style=color:#658b00>class</span>);
        Long execute = (Long) redisTemplate.<span style=color:#658b00>execute</span>(redisScript, Collections.<span style=color:#658b00>singletonList</span>(key),
                Collections.<span style=color:#658b00>singletonList</span>(value));
        <span style=color:#8b008b;font-weight:700>return</span> execute != <span style=color:#8b008b;font-weight:700>null</span> &amp;&amp; execute != 0;
    }

    <span style=color:#8b008b;font-weight:700>public</span> <span style=color:#00688b;font-weight:700>boolean</span> <span style=color:#008b45>blockLock</span>(String key, String value, <span style=color:#00688b;font-weight:700>int</span> expireMills) <span style=color:#8b008b;font-weight:700>throws</span> DistributeLockTimeoutException {
        <span style=color:#228b22>// 被阻塞的时间超过5秒就停止获取锁
</span><span style=color:#228b22></span>        <span style=color:#00688b;font-weight:700>int</span> blockTime = expireMills;
        <span style=color:#228b22>// 默认的间隔时间
</span><span style=color:#228b22></span>        <span style=color:#8b008b;font-weight:700>for</span> (; ; ) {
            <span style=color:#8b008b;font-weight:700>if</span> (blockTime &gt;= 0) {
                String script = lockExpireScript(expireMills);
                DefaultRedisScript&lt;Long&gt; redisScript = <span style=color:#8b008b;font-weight:700>new</span> DefaultRedisScript&lt;&gt;(script, Long.<span style=color:#658b00>class</span>);
                Long result = (Long) redisTemplate.<span style=color:#658b00>execute</span>(redisScript, Collections.<span style=color:#658b00>singletonList</span>(key), value);
                <span style=color:#8b008b;font-weight:700>if</span> (result != <span style=color:#8b008b;font-weight:700>null</span> &amp;&amp; result == 1) {
                    <span style=color:#228b22>// 得到了锁
</span><span style=color:#228b22></span>                    <span style=color:#8b008b;font-weight:700>return</span> <span style=color:#8b008b;font-weight:700>true</span>;
                } <span style=color:#8b008b;font-weight:700>else</span> {
                    blockTime -= 300;
                    <span style=color:#8b008b;font-weight:700>try</span> {
                        Thread.<span style=color:#658b00>sleep</span>(300);
                    } <span style=color:#8b008b;font-weight:700>catch</span> (InterruptedException e) {
                        log.<span style=color:#658b00>error</span>(<span style=color:#cd5555>&#34;RedisTemplateDistributeLockUtil.blockLock error!&#34;</span>, e);
                    }
                }
            } <span style=color:#8b008b;font-weight:700>else</span> {
                <span style=color:#228b22>// 已经超时
</span><span style=color:#228b22></span>                <span style=color:#8b008b;font-weight:700>throw</span> <span style=color:#8b008b;font-weight:700>new</span> DistributeLockTimeoutException(<span style=color:#cd5555>&#34;Distribute Lock Timeout&#34;</span>);
            }
        }
    }

    <span style=color:#8b008b;font-weight:700>public</span> <span style=color:#00688b;font-weight:700>boolean</span> <span style=color:#008b45>unlock</span>(String key, String value) {
        String script = UNLOCK_SCRIPT;
        DefaultRedisScript&lt;Long&gt; redisScript = <span style=color:#8b008b;font-weight:700>new</span> DefaultRedisScript&lt;&gt;(script, Long.<span style=color:#658b00>class</span>);
        Long execute = (Long) redisTemplate.<span style=color:#658b00>execute</span>(redisScript, Collections.<span style=color:#658b00>singletonList</span>(key), value);
        <span style=color:#8b008b;font-weight:700>return</span> execute != <span style=color:#8b008b;font-weight:700>null</span> &amp;&amp; execute != 0;
    }
}

</code></pre></div><hr width=100% id=EOF><p style=color:#777>最后修改于 2021-02-10</p></div></div><nav class=post-pagination><a class=newer-posts href=https://pinkhello.github.io/posts/15-%E8%AE%B0%E4%B8%80%E6%AC%A1docker%E6%97%A5%E5%BF%97%E7%A3%81%E7%9B%98%E5%91%8A%E8%AD%A6%E9%97%AE%E9%A2%98/>下回<br>15 记一次docker日志磁盘告警问题</a>
<a class=older-posts href=https://pinkhello.github.io/posts/13-kafka%E4%B8%8Edebezium%E6%9E%84%E5%BB%BAcdc%E7%AE%A1%E9%81%93/>上回<br>13 Kafka与Debezium构建CDC管道</a></nav><div class=post-comment-wrapper><div id=gitalk-container></div></div></div></div></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://amazingrise.net>Rise</a><br>移植自 <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
一杯哈希不加盐, All Rights Reserved</div></div><script>let app;app=new Vue({el:'#app',data:{scrollY:0,navOpacity:0,isDrawerOpen:false,mounted:false,isDarkMode:false},methods:{sgn(t,x){let k=1./(1.-2*t);if(x<=t)return 0;else if(x>=1-t)return 1;else{return k*(x-t);}},handleScroll(){this.scrollY=window.scrollY;this.navOpacity=this.sgn(.0,Math.min(1,Math.max(0,window.scrollY/(this.pageHeadHeight()-this.navBarHeight()*0.8))));const{navBar,navBackground,navTitle,extraContainer,streamContainer}=this.$refs;if(this.navOpacity>=1){navBackground.style.opacity=1;navTitle.style.opacity=1;}else{navBackground.style.opacity=0;navTitle.style.opacity=0;}},handleResize(){const{navBar,navBackground,navTitle,extraContainer,streamContainer}=this.$refs;extraContainer.style.left=(streamContainer.offsetWidth-extraContainer.offsetWidth)+'px';},navBarHeight(){return this.$refs.navBar.offsetHeight;},pageHeadHeight(){return this.$refs.pageHead.offsetHeight;},toggleDrawer(){this.isDrawerOpen=!this.isDrawerOpen;document.getElementsByTagName('html')[0].style.overflow=this.isDrawerOpen?'hidden':'unset';},closeDrawer(){this.isDrawerOpen=false;document.getElementsByTagName('html')[0].style.overflow=this.isDrawerOpen?'hidden':'unset';},toggleDarkMode(){this.isDarkMode=!this.isDarkMode;if(this.isDarkMode==true){document.cookie="night=1;path=/";document.body.classList.add("night");}else{document.cookie="night=0;path=/";document.body.classList.remove("night");}}},created(){window.addEventListener('scroll',this.handleScroll);window.addEventListener('resize',this.handleResize);window._nonDesktop=function(){let check=false;(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check=true;})(navigator.userAgent||navigator.vendor||window.opera);return check;};var night=document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/,"$1");if(night==""){if(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches){}}else{if(night=="1"){this.toggleDarkMode();}}},mounted(){this.handleScroll();this.handleResize();this.mounted=true;},destroyed(){window.removeEventListener('scroll',this.handleScroll);window.removeEventListener('resize',this.handleResize);}});</script><script src=https://pinkhello.github.io//js/journal.js></script></body></html>