<!doctype html><html lang=en><head><title>一杯哈希不加盐</title><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#000084"><link rel=icon href=https://pinkhello.github.io//favicon.ico><link rel=canonical href=https://pinkhello.github.io/></head><body><nav class="navbar navbar-inverse navbar-fixed-top"><div class=navbar-inner><div class=container><button type=button class="btn btn-navbar" data-toggle=collapse data-target=.nav-collapse></button>
<a class=brand href=https://pinkhello.github.io/>一杯哈希不加盐</a><div class="nav-collapse collapse"><ul class=nav><li><a href=/about/><span>About</span></a></li><li><a href=/posts/><span>Archive</span></a></li></ul></div></div></div></nav><div id=content class=container><div class="row-fluid navmargin"><div class=page-header><h1>06 高性能队列Disruptor - Wed, Feb 10, 2021</h1></div><p class=lead></p><h1 id=背景>背景</h1><p><code>Disruptor</code> 是 外汇交易公司<code>LMAX</code>开发的高性能队列、研发是为了解决内存队列延迟问题。
<code>Disruptor</code> 一般用于线程间的消息传递。
<a href=http://lmax-exchange.github.io/disruptor/>Disruptor GitHub 地址</a></p><h1 id=disruptor-介绍><code>Disruptor</code> 介绍</h1><p>理解 <code>Disruptor</code> 最好的方式，选择一个最接近熟悉的样本进行比较。在这个前提下，可以选择 <code>Java</code> 中的 <code>BlockingQueue</code>.
和队列相似，<code>Disruptor</code> 也是在同一个进程中不同的线程之间进行传递数据的（例如消息或者事件），同时 <code>Disruptor</code> 提供了一些将关键功能和队列分开的特性：</p><ul><li>向消费者发送多播事件</li><li>消息者依赖关系图</li><li>预先为事件分配内存</li><li>可选的（无锁）</li></ul><h1 id=disruptor-核心概念><code>Disruptor</code> 核心概念</h1><p>在我们理解<code>Disruptor</code>如何工作之前，了解下核心概念</p><ul><li><a href=https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/RingBuffer.java>Ring Buffer</a>
环形数组设计，为了避免垃圾回收，采用的数组结构，从3.0开始，环形缓冲区主要存储和更新在<code>Disruptor</code>中移动的数据（事件）</li><li><a href=https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/Sequence.java>Sequence</a>
<code>Disruptor</code> 每个消费者(<code>EventProcessor</code>)维护一个 <code>Sequence</code>，并发的大多数代码都依赖 <code>Sequence</code> 值的改动，所以 <code>Sequence</code> 支持 <code>AtomicLong</code> 的大部分也行, 唯一不同的是 <code>Sequence</code> 包含额外的功能来阻止<code>Sequence</code>和其他值之间的伪共享(<code>false sharing</code>)</li><li><a href=https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/Sequencer.java>Sequencer</a><br><code>Disruptor</code> 核心逻辑, 两个实现: 单生产者和多生产者。他们实现了生产者与消费者之间的快速传递的并发算法。</li><li><a href=https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/SequenceBarrier.java>Sequence Barrier</a>
由 <code>Sequencer</code> 生成，包含此 <code>Sequencer</code> 发布的 <code>Sequence</code> 指针以及依赖的其他消费者的 <code>Sequence</code>。包含了消费者检查是否有可用的事件的代码。</li><li><a href=https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/WaitStrategy.java>Wait Strategy</a>
消费者等待事件的策略，这个事件由生产者放入，决定了消费者怎么等待生产者将事件放入 <code>Disruptor</code></li><li>Event 生产者与消费者传递的事件，完全由用户定义</li><li><a href=https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/EventProcessor.java>EventProcessor</a>
处理事件的主要循环（<code>main event loop</code>），包含了一个 <code>Sequeuece</code>. 有一个具体的实现类 <code>BatchEventProcessor</code></li><li><a href=https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/EventHandler.java>EventHandler</a>
用户实现的接口，代表一个消费者。处理事件。</li><li>Producer 生产者、先获得占位，然后提交事件。</li></ul><p><img src=/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97-Disruptor/Disruptor%E8%AE%BE%E8%AE%A1%E7%BB%84%E4%BB%B6%E5%9B%BE.jpg alt=Disruptor设计组件图></p><ul><li><p>事件广播(<code>Multicast Events</code>)</p><p>事件广播是 <code>Disruptor</code> 与 <code>Queue</code> 最大的区别，当你有多个消费者监听一个 <code>Disruptor</code>, 所有的事件将会发布到这个所有的消费者。
<code>Disruptor</code> 这一特性被用来需要对同一数据进行多个并行操作的情况。
如在LMAX系统中有三个操作可以同时进行：日志（将数据持久到日志文件中），复制（将数据发送到其他的机器上，以确保存在数据远程副本），业务逻辑处理。
也可以使用<code>WokrerPool</code>来并行处理不同的事件。</p><p>如上图。可以看到有3个事件处理程序正在侦听<code>Disrupto</code>r（<code>JournalConsumer</code>，<code>ReplicationConsumer</code> 和 <code>ApplicationConsumer</code>），
这些事件处理程序中的每个将接收<code>Disruptor</code>中所有可用的消息（按相同顺序）。这允许这些消费者中的每一个并行工作。</p></li><li><p>消费者依赖关系图(<code>Consumer Dependency Graph</code>)</p><p>为了支持实现业务并行处理流程，<code>Disruptor</code> 提供了多个消费者之间的协作功能。回到上面的例子中，我们可以将 <code>journalling</code> 和 <code>replication</code> 消费完成他们的业务，后再继续执行业务逻辑流程。
我们称呼这个功能为 <code>gating</code> , <code>gating</code> 发生在两种场景下:</p><ul><li>确保 <code>Producer</code> 不能运行超过 <code>Consumer</code> ，可以通多调用 <code>RingBuffer.addGatingConsumers()</code> 来增加相关的消费者来完成</li><li>之前所说的场景，通过必须先完成的<code>Consumer</code> 的 <code>Sequence</code>的<code>SequenceBarrier</code>来实现。</li></ul></li><li><p>事件预分配(<code>Event Preallocation</code>)</p><p><code>Disruptor</code> 的一个目标就是在低延时环境下，减少或异常内存的占用。（在JAVA环境下，需要较少GC停顿的次数）（C/C++环境下，大量的内存分配也是一个问题）</p></li><li><p>可选择的无锁(<code>Optionally Lock-free</code>)</p><p>无锁的 <code>Disruptor</code> 的低延迟的无锁的特性实现细节是都是基于 内存屏障 和 CAS 操作实现的，只有一个场景 <code>BlockingWaitStrategy</code> 中使用的 <code>Lock</code>
是为了使用 <code>Lock</code> 里面的 <code>Condition</code>, 方便消费者线程被 <code>Park</code> 时候等待新的事件来触发。许多低延迟系统使用自旋（<code>busy-wait</code>）来避免使用 <code>Condition</code>造成的抖动
然而，太多的 <code>busy-wait</code> 会导致性能下降，特别在CPU资源受限的情况下。</p></li></ul><h1 id=disruptor-几个核心的设计><code>Disruptor</code> 几个核心的设计</h1><h2 id=sequence-设计><code>Sequence</code> 设计</h2><p><img src=/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97-Disruptor/Sequence.jpg alt="Sequence 设计"></p><p>Sequence 真正计数是 <code>value</code> 采用缓冲行防止 <code>false sharing</code>。在<code>value</code>的前后有7个 <code>long</code> 型的填充值，做<code>CPU cache line</code>填充防止伪共享。</p><h2 id=ringbuffer-设计><code>RingBuffer</code> 设计</h2><p><img src=/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97-Disruptor/RingBuffer.jpg alt="RingBuffer 设计"></p><p><code>RingBuffer</code> 是一个环（首尾相接），可以用作不同的上下文（线程）间传递数据的 <code>Buffer</code>环形设计，每个元素都有个坐标，取得元素通过取mod操作。
是数组设计、非链表。</p><p>一般是<code>2^N</code>次方，这样 sequence & (array length - 1 ) = array index。哈希Map也是这种位运算做的。</p><p><code>RingBuffer</code> 特点</p><ul><li>数组实现、快速访问</li><li>元素是覆盖式的，不主动清除</li><li>神奇的缓存行（缓存是由缓存行组成的，通常64个字节、一个JAVA long 类型 8 字节）</li></ul><h2 id=消费者依赖设计>消费者依赖设计</h2><h2 id=缓存内存加载过程>缓存内存加载过程</h2><p><img src=/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97-Disruptor/cache-line-1.jpg alt=缓存加载过程>
<img src=/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97-Disruptor/cache-line-2.jpg alt=缓存加载过程>
<img src=/%E9%AB%98%E6%80%A7%E8%83%BD%E9%98%9F%E5%88%97-Disruptor/cache-line-3.jpg alt=缓存加载过程></p><p><a href=https://github.com/LMAX-Exchange/disruptor/blob/master/src/main/java/com/lmax/disruptor/RingBuffer.java>神奇的解决方式&mdash;&ndash; 缓存行填充</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> p1<span style=color:#f92672>,</span> p2<span style=color:#f92672>,</span> p3<span style=color:#f92672>,</span> p4<span style=color:#f92672>,</span> p5<span style=color:#f92672>,</span> p6<span style=color:#f92672>,</span> p7<span style=color:#f92672>;</span> <span style=color:#75715e>// cache line padding
</span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>long</span> cursor <span style=color:#f92672>=</span> INITIAL_CURSOR_VALUE<span style=color:#f92672>;</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>long</span> p8<span style=color:#f92672>,</span> p9<span style=color:#f92672>,</span> p10<span style=color:#f92672>,</span> p11<span style=color:#f92672>,</span> p12<span style=color:#f92672>,</span> p13<span style=color:#f92672>,</span> p14<span style=color:#f92672>;</span> <span style=color:#75715e>// cache line padding 
</span></code></pre></div><h1 id=disruptor-使用demo><code>Disruptor</code> 使用Demo</h1><p><code>TransactionOrder</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TransactionOrder</span> <span style=color:#f92672>{</span>
       <span style=color:#66d9ef>private</span> String id<span style=color:#f92672>;</span>
       <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>double</span> price<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><p><code>TransactionHandler</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TransactionHandler</span> <span style=color:#66d9ef>implements</span> EventHandler<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;,</span> WorkHandler<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onEvent</span><span style=color:#f92672>(</span>TransactionOrder transactionOrder<span style=color:#f92672>,</span>  <span style=color:#66d9ef>long</span> sequence<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> endOfBatch<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onEvent</span><span style=color:#f92672>(</span>transactionOrder<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onEvent</span><span style=color:#f92672>(</span>TransactionOrder transactionOrder<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        <span style=color:#75715e>//具体的消费逻辑
</span><span style=color:#75715e></span>        transactionOrder<span style=color:#f92672>.</span><span style=color:#a6e22e>setId</span><span style=color:#f92672>(</span>UUID<span style=color:#f92672>.</span><span style=color:#a6e22e>randomUUID</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p><code>Demo1</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo1</span> <span style=color:#f92672>{</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> ExecutionException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>int</span> BUFFER_SIZE <span style=color:#f92672>=</span> 1024<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>int</span> THREAD_NUM <span style=color:#f92672>=</span> 4<span style=color:#f92672>;</span>

        <span style=color:#75715e>//createSingleProducer 创建单生产者的 RingBuffer
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>final</span> RingBuffer<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;</span> ringBuffer <span style=color:#f92672>=</span>
                RingBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>createSingleProducer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> EventFactory<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
                     <span style=color:#66d9ef>public</span> TransactionOrder <span style=color:#a6e22e>newInstance</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
                        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TransactionOrder<span style=color:#f92672>();</span>
                    <span style=color:#f92672>}</span>
                <span style=color:#f92672>},</span> BUFFER_SIZE<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> YieldingWaitStrategy<span style=color:#f92672>());</span>

        <span style=color:#75715e>//创建线程池
</span><span style=color:#75715e></span>        ExecutorService service <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newFixedThreadPool</span><span style=color:#f92672>(</span>THREAD_NUM<span style=color:#f92672>);</span>

        <span style=color:#75715e>//创建 SequenceBarrier
</span><span style=color:#75715e></span>        SequenceBarrier sequenceBarrier <span style=color:#f92672>=</span> ringBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>newBarrier</span><span style=color:#f92672>();</span>

        <span style=color:#75715e>//创建消息处理器
</span><span style=color:#75715e></span>        BatchEventProcessor<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;</span> eventProcessor <span style=color:#f92672>=</span>
                <span style=color:#66d9ef>new</span> BatchEventProcessor<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;(</span>ringBuffer<span style=color:#f92672>,</span> sequenceBarrier<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> TransactionHandler<span style=color:#f92672>());</span>

        <span style=color:#75715e>//这一部分是让 RingBuffer根据消费者状态进行gating, 只有一个消费者的话可以省略
</span><span style=color:#75715e></span>        ringBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>addGatingSequences</span><span style=color:#f92672>(</span>eventProcessor<span style=color:#f92672>.</span><span style=color:#a6e22e>getSequence</span><span style=color:#f92672>());</span>

        <span style=color:#75715e>//把消息处理器提交到线程池
</span><span style=color:#75715e></span>        service<span style=color:#f92672>.</span><span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span>eventProcessor<span style=color:#f92672>);</span>

        Future<span style=color:#f92672>&lt;?&gt;</span> future <span style=color:#f92672>=</span> service<span style=color:#f92672>.</span><span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Callable<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>public</span> Void <span style=color:#a6e22e>call</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>long</span> seq<span style=color:#f92672>;</span>
                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i<span style=color:#f92672>&lt;</span>10000<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
                    seq <span style=color:#f92672>=</span> ringBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span> <span style=color:#75715e>//ringbuffer 的一个可用区块
</span><span style=color:#75715e></span>                    ringBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>seq<span style=color:#f92672>).</span><span style=color:#a6e22e>setPrice</span><span style=color:#f92672>(</span>Math<span style=color:#f92672>.</span><span style=color:#a6e22e>random</span><span style=color:#f92672>()</span> <span style=color:#f92672>*</span>9999<span style=color:#f92672>);</span> <span style=color:#75715e>// 给这个区块放入数据
</span><span style=color:#75715e></span>                    ringBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>publish</span><span style=color:#f92672>(</span>seq<span style=color:#f92672>);</span> <span style=color:#75715e>//发布数据使得 consumer 可以获取该数据
</span><span style=color:#75715e></span>                <span style=color:#f92672>}</span>
                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>});</span>
        future<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span> <span style=color:#75715e>//等待生产者结束
</span><span style=color:#75715e></span>
        eventProcessor<span style=color:#f92672>.</span><span style=color:#a6e22e>halt</span><span style=color:#f92672>();</span> <span style=color:#75715e>//通知事件
</span><span style=color:#75715e></span>
        service<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span> <span style=color:#75715e>//终止线程
</span><span style=color:#75715e></span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

</code></pre></div><p><code>Demo2</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo2</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>int</span> BUFFER_SIZE <span style=color:#f92672>=</span> 1024<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>int</span> THREAD_NUM <span style=color:#f92672>=</span> 4<span style=color:#f92672>;</span>

        EventFactory<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;</span> eventFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> EventFactory<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>public</span> TransactionOrder <span style=color:#a6e22e>newInstance</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TransactionOrder<span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>};</span>

        RingBuffer<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;</span> ringBuffer <span style=color:#f92672>=</span> RingBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>createSingleProducer</span><span style=color:#f92672>(</span>eventFactory<span style=color:#f92672>,</span> BUFFER_SIZE<span style=color:#f92672>);</span>

        SequenceBarrier sequenceBarrier <span style=color:#f92672>=</span> ringBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>newBarrier</span><span style=color:#f92672>();</span>

        ExecutorService service <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newFixedThreadPool</span><span style=color:#f92672>(</span>THREAD_NUM<span style=color:#f92672>);</span>

        WorkHandler<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;</span> workHandler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TransactionHandler<span style=color:#f92672>();</span>

        WorkerPool<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;</span> workerPool <span style=color:#f92672>=</span>
                <span style=color:#66d9ef>new</span> WorkerPool<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;(</span>ringBuffer<span style=color:#f92672>,</span> sequenceBarrier<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> IgnoreExceptionHandler<span style=color:#f92672>(),</span>
                        workHandler<span style=color:#f92672>);</span>
        <span style=color:#75715e>//序列协调者
</span><span style=color:#75715e></span>        ringBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>addGatingSequences</span><span style=color:#f92672>(</span>workerPool<span style=color:#f92672>.</span><span style=color:#a6e22e>getWorkerSequences</span><span style=color:#f92672>());</span>

        workerPool<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>(</span>service<span style=color:#f92672>);</span>

        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span>0<span style=color:#f92672>;</span> i<span style=color:#f92672>&lt;</span>8<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>long</span> seq <span style=color:#f92672>=</span> ringBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>();</span>
            ringBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>seq<span style=color:#f92672>).</span><span style=color:#a6e22e>setPrice</span><span style=color:#f92672>(</span>Math<span style=color:#f92672>.</span><span style=color:#a6e22e>random</span><span style=color:#f92672>()</span> <span style=color:#f92672>*</span> 9999<span style=color:#f92672>);</span>
            ringBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>publish</span><span style=color:#f92672>(</span>seq<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>

        workerPool<span style=color:#f92672>.</span><span style=color:#a6e22e>halt</span><span style=color:#f92672>();</span>
        service<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p><code>Demo3</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Demo3</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException <span style=color:#f92672>{</span>

        <span style=color:#66d9ef>long</span> start <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>int</span> BUFFER_SIZE <span style=color:#f92672>=</span> 1024<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>int</span> THREAD_NUM <span style=color:#f92672>=</span> 4<span style=color:#f92672>;</span>

        ExecutorService service <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newFixedThreadPool</span><span style=color:#f92672>(</span>THREAD_NUM<span style=color:#f92672>);</span>


        Disruptor<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;</span> disruptor <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Disruptor<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;(</span><span style=color:#66d9ef>new</span> EventFactory<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>public</span> TransactionOrder <span style=color:#a6e22e>newInstance</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TransactionOrder<span style=color:#f92672>();</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>},</span> BUFFER_SIZE<span style=color:#f92672>,</span> service<span style=color:#f92672>,</span> ProducerType<span style=color:#f92672>.</span><span style=color:#a6e22e>SINGLE</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> BusySpinWaitStrategy<span style=color:#f92672>());</span>

        <span style=color:#75715e>/**
</span><span style=color:#75715e>         * 菱形操作
</span><span style=color:#75715e>         */</span>
        <span style=color:#75715e>//使用 disruptor 创建消费组 C1 与 C2
</span><span style=color:#75715e></span>        EventHandlerGroup<span style=color:#f92672>&lt;</span>TransactionOrder<span style=color:#f92672>&gt;</span> eventHandlerGroup <span style=color:#f92672>=</span>
                disruptor<span style=color:#f92672>.</span><span style=color:#a6e22e>handleEventsWith</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> TransactionHandler<span style=color:#f92672>(),</span> <span style=color:#66d9ef>new</span> TransactionVasConsumer<span style=color:#f92672>());</span>
        <span style=color:#75715e>//C3
</span><span style=color:#75715e></span>        TransactionJmsNotifyHandler jmsNotifyHandler <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TransactionJmsNotifyHandler<span style=color:#f92672>();</span>
        <span style=color:#75715e>//声明在 C1 和 C2 完事后 执行 JMS消息发送操作（C3）
</span><span style=color:#75715e></span>        eventHandlerGroup<span style=color:#f92672>.</span><span style=color:#a6e22e>then</span><span style=color:#f92672>(</span>jmsNotifyHandler<span style=color:#f92672>);</span>

        <span style=color:#75715e>/**
</span><span style=color:#75715e>         * 顺序执行
</span><span style=color:#75715e>         */</span>
<span style=color:#75715e>//        disruptor.handleEventsWith(new TransactionHandler())
</span><span style=color:#75715e>//                .then(new TransactionVasConsumer())
</span><span style=color:#75715e>//                .then(new TransactionJmsNotifyHandler());
</span><span style=color:#75715e></span>        <span style=color:#75715e>/**
</span><span style=color:#75715e>         * 六边形操作
</span><span style=color:#75715e>         */</span>
<span style=color:#75715e>//        TransactionHandler h1 = new TransactionHandler();
</span><span style=color:#75715e>//        TransactionHandler h2 = new TransactionHandler();
</span><span style=color:#75715e>//        TransactionHandler h3 = new TransactionHandler();
</span><span style=color:#75715e>//        TransactionHandler h4 = new TransactionHandler();
</span><span style=color:#75715e>//        TransactionHandler h5 = new TransactionHandler();
</span><span style=color:#75715e>//        TransactionHandler h6 = new TransactionHandler();
</span><span style=color:#75715e>//        disruptor.handleEventsWith(h1, h2);
</span><span style=color:#75715e>//        disruptor.after(h1).handleEventsWith(h4);
</span><span style=color:#75715e>//        disruptor.after(h2).handleEventsWith(h5);
</span><span style=color:#75715e>//        disruptor.after(h4, h5).handleEventsWith(h3);
</span><span style=color:#75715e></span>

        <span style=color:#75715e>//启动
</span><span style=color:#75715e></span>        disruptor<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>

        CountDownLatch latch <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CountDownLatch<span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
        <span style=color:#75715e>//生产者准备
</span><span style=color:#75715e></span>        service<span style=color:#f92672>.</span><span style=color:#a6e22e>submit</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> TransactionPubllisher<span style=color:#f92672>(</span>disruptor<span style=color:#f92672>,</span> latch<span style=color:#f92672>));</span>

        latch<span style=color:#f92672>.</span><span style=color:#a6e22e>await</span><span style=color:#f92672>();</span> <span style=color:#75715e>//等待生产者完事
</span><span style=color:#75715e></span>
        disruptor<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
        service<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>

        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;总耗时:&#34;</span><span style=color:#f92672>+</span> <span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> start<span style=color:#f92672>));</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4><a href=https://pinkhello.github.io/>Back to Home</a></h4></div></div><footer class=container><hr class=soften><p><a href=https://pinkhello.github.io/>hugo.386 theme</a> |
&copy;
<a href=https://pinkhello.github.io/ target=_blank>一杯哈希不加盐</a>
<span id=thisyear>2020</span>
| Built on <a href=//gohugo.io target=_blank>Hugo</a></p><p class=text-center><a href=https://github.com/PinkHello>GitHub</a></p></footer></body><link rel=stylesheet href=/css/bootstrap.css><link rel=stylesheet href=/css/bootstrap-responsive.css><link rel=stylesheet href=/css/style.css><script src=/js/jquery.js></script><script src=/js/bootstrap-386.js></script><script src=/js/bootstrap-transition.js></script><script src=/js/bootstrap-alert.js></script><script src=/js/bootstrap-modal.js></script><script src=/js/bootstrap-dropdown.js></script><script src=/js/bootstrap-scrollspy.js></script><script src=/js/bootstrap-tab.js></script><script src=/js/bootstrap-tooltip.js></script><script src=/js/bootstrap-popover.js></script><script src=/js/bootstrap-button.js></script><script src=/js/bootstrap-collapse.js></script><script src=/js/bootstrap-carousel.js></script><script src=/js/bootstrap-typeahead.js></script><script src=/js/bootstrap-affix.js></script><script>_386={fastLoad:false,onePass:false,speedFactor:1};function ThisYear(){document.getElementById('thisyear').innerHTML=new Date().getFullYear();};</script></html>