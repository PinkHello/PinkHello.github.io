<!doctype html><html><head><title>RocketMQ源码阅读 开篇</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content="RocketMQ开箱源码详解-开天辟地"><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><meta property="og:title" content="RocketMQ源码阅读 开篇"><meta property="og:description" content="RocketMQ开箱源码详解-开天辟地"><meta property="og:type" content="article"><meta property="og:url" content="https://pinkhello.me/posts/rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%BC%80%E7%AF%87/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-19T15:02:20+08:00"><meta property="article:modified_time" content="2021-05-19T15:02:20+08:00"><meta property="og:site_name" content="PinkHello"><meta name=twitter:card content="summary"><meta name=twitter:title content="RocketMQ源码阅读 开篇"><meta name=twitter:description content="RocketMQ开箱源码详解-开天辟地"><script src=/vendor/js/jquery.min.js></script><script src=/vendor/js/popper.min.js></script><script src=/vendor/js/bootstrap.min.js></script><script src=/vendor/js/smooth-scroll.polyfills.min.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><script src=/vendor/js/vue.min.js></script><link rel=stylesheet href=https://pinkhello.me/scss/journal.min.5e8f3f653e9f6ce67bf72ff8ee6fee69decf7b5639a3ae7f8344750ad4e065b1.css integrity="sha256-Xo8/ZT6fbOZ79y/47m/uad7Pe1Y5o65/g0R1CtTgZbE=" media=screen><link rel=stylesheet href=https://pinkhello.me/scss/dark-mode.min.bdfa63b2e89903517dcbb1032b537d54cff3f425c19d008a78dfe49e6cd07ced.css integrity="sha256-vfpjsuiZA1F9y7EDK1N9VM/z9CXBnQCKeN/knmzQfO0=" media=screen><script src=https://pinkhello.me//js/loadCSS.js></script><script>loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons")</script><script src=https://pinkhello.me//js/toc-collapse.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script><script src=/vendor/js/md5.min.js></script><script>var gitalk=new Gitalk({clientID:'8c0085cae1e614334721',clientSecret:'7a38150ae970beb3b45a710466594003ee659b6c',repo:'PinkHello.github.io',owner:'PinkHello',admin:['PinkHello'],id:md5(location.pathname),distractionFreeMode:'false',proxy:'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'});window.onload=function(){gitalk.render('gitalk-container')}</script></head><body><div id=app><div ref=sideContainer class=side-container><a class="a-block nav-head false" href=https://pinkhello.me/><div class=nav-title>PinkHello</div><div class=nav-subtitle>做一个快乐的程序猿</div></a><div class=nav-link-list><a class="a-block nav-link-item false" href=/about>关于我</a>
<a class="a-block nav-link-item active" href=/posts>文章</a>
<a class="a-block nav-link-item false" href=/categories>类目</a>
<a class="a-block nav-link-item false" href=/tags>标签</a>
<a class="a-block nav-link-item false" href=/links>链接</a>
<a class="a-block nav-link-item false" href=/index.xml>RSS Feed</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://amazingrise.net>Rise</a><br>移植自 <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
PinkHello, All Rights Reserved</div></div><div ref=extraContainer class=extra-container><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc-content><center>- 目录 -</center><ul><li><a href=#rocketmq-%e6%98%af%e4%bb%80%e4%b9%88 onclick="onNavClick(`#rocketmq-是什么-nav`)" id=rocketmq-是什么-nav>RocketMQ 是什么?</a></li><li><a href=#rocketmq-%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5 onclick="onNavClick(`#rocketmq-基本概念-nav`)" id=rocketmq-基本概念-nav>RocketMQ 基本概念</a></li><li><a href=#rocketmq-%e9%83%a8%e7%bd%b2%e6%9e%b6%e6%9e%84 onclick="onNavClick(`#rocketmq-部署架构-nav`)" id=rocketmq-部署架构-nav>RocketMQ 部署架构</a></li><li><a href=#rocketmq--%e4%ba%8b%e5%8a%a1%e6%b6%88%e6%81%af- onclick="onNavClick(`#rocketmq--事务消息--nav`)" id=rocketmq--事务消息--nav>RocketMQ * 事务消息 *</a></li></ul></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a class=pagination-action v-on:click=toggleDarkMode><i class="material-icons pagination-action-icon" v-if=isDarkMode>brightness_4</i>
<i class="material-icons pagination-action-icon" v-else=isDarkMode>brightness_7</i></a></div></div><div class=single-column-drawer-container ref=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item false" href=/about>关于我</a>
<a class="a-block drawer-menu-item active" href=/posts>文章</a>
<a class="a-block drawer-menu-item false" href=/categories>类目</a>
<a class="a-block drawer-menu-item false" href=/tags>标签</a>
<a class="a-block drawer-menu-item false" href=/links>链接</a>
<a class="a-block drawer-menu-item false" href=/index.xml>RSS Feed</a><div class=toc><div class=toc-content><center>- 目录 -</center><ul><li><a href=#rocketmq-%e6%98%af%e4%bb%80%e4%b9%88 onclick="onNavClick(`#rocketmq-是什么-nav`)" id=rocketmq-是什么-nav>RocketMQ 是什么?</a></li><li><a href=#rocketmq-%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5 onclick="onNavClick(`#rocketmq-基本概念-nav`)" id=rocketmq-基本概念-nav>RocketMQ 基本概念</a></li><li><a href=#rocketmq-%e9%83%a8%e7%bd%b2%e6%9e%b6%e6%9e%84 onclick="onNavClick(`#rocketmq-部署架构-nav`)" id=rocketmq-部署架构-nav>RocketMQ 部署架构</a></li><li><a href=#rocketmq--%e4%ba%8b%e5%8a%a1%e6%b6%88%e6%81%af- onclick="onNavClick(`#rocketmq--事务消息--nav`)" id=rocketmq--事务消息--nav>RocketMQ * 事务消息 *</a></li></ul></div></div></div></div></div><transition name=fade><div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav ref=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div ref=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a ref=navTitle class=navbar-brand href=https://pinkhello.me/>PinkHello</a>
<button type=button class=nav-darkmode-toggle v-on:click=toggleDarkMode>
<i class=material-icons v-if=isDarkMode>brightness_4</i>
<i class=material-icons v-else=isDarkMode>brightness_7</i></button></div></nav><div class=single-column-header-container ref=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://pinkhello.me/><div class=single-column-header-title>PinkHello</div><div class=single-column-header-subtitle>做一个快乐的程序猿</div></a></div><div id=content><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>RocketMQ源码阅读 开篇<div class=post-subtitle>RocketMQ开箱源码详解-开天辟地</div><div class=post-meta><time itemprop=datePublished>2021-05-19 15:02</time>
<i class=material-icons>folder</i>
<a href=/categories/rocketmq>RocketMQ</a>
&nbsp;
<i class=material-icons>label</i>
<a href=/tags/rocketmq>RocketMQ</a>
&nbsp;
<a href=/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6>消息中间件</a>
&nbsp;
<i class=material-icons>schedule</i>
9 min
49 s.</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h1 id=rocketmq-是什么>RocketMQ 是什么?</h1><p><a href=http://rocketmq.apache.org/>RocketMQ</a> 是 Alibaba 捐赠给 Apache 的一款分布式、队列模型的开源消息中间件。</p><ul><li>Github <a href=https://github.com/apache/rocketmq>https://github.com/apache/rocketmq</a></li></ul><p>从官网也能看出它的一些特性:</p><ul><li>低延迟 ()</li><li>高可用</li><li>万亿级的消息支持</li><li>&mldr;</li></ul><h1 id=rocketmq-基本概念>RocketMQ 基本概念</h1><p>RocketMQ 是由 Producer、Broker、Consumer 三部分组成, Producer 负责生产 Message, Consumer 负责消费 Message, Broker 负责存储 Message。
每个 Broker 可以存储多个 Topic 的消息, 每个 Topic 的消息也可以分片存储在不同的 Broker上。 Message Queue 用于存储消息的物理地址，每个 Topic 的消息地址存储于对歌 Message Queue 中。
Consumer Group 由多个 Consumer 实例组成。</p><ul><li><p>Producer 负责生产消息，同步发送、异步发送、顺序发送、单向发送。同步和异步需要Broker确认信息，单向发送不需要。</p></li><li><p>Consumer 负责消费消息，一般异步消费。一个消费者会从 Broker 拉取消息。（拉取式消费、推动式消费）</p></li><li><p>Broker Server 负责存储、转发消息。 接收 Producer 发送来的消息并存储、同时为 Consumer 拉取请求做准备。当然也存储这消息相关的元数据（消费组、消费进度偏移、主题、队列消息等）</p></li><li><p>Name Server 为消息路由的提供者。Producer 和 Consumer 能够通过 它查找各个 Topic 相应的 Broker IP 列表，多个 Name Server 组成集群，相互独立、没有信息交换。</p></li><li><p>Message 消息系统所传输信息的物理载体，生产和消费数据的最小单元，每条消息必须属于一个 Topic, RocketMQ 中每个消息拥有一个唯一的 MessageID，且可以携带业务标识的Key。系统提供通过 MessageId 和 Key 查询消息的功能</p></li><li><p>Topic 表示一类消息的集合，每个主题包含若干条消息，每条消息智只能属于一个 topic，是 RocketMQ 进行 消息定义的基本单位。</p></li><li><p>Tag 为消息设置的标志，用于同一个 Topic 下区分不同类型的消息。来自同一个业务单元的消息，可以根据不同的业务在同一个主题下设置不同的标签。Tag 能够有效的保持代码清晰度和连贯性，并优化 RocketMQ 的查询系统。 Consumer 可以根据 Tag 实现不同的子主题的不同消费逻辑。</p></li><li><p>Pull Consumer</p></li><li><p>Push Consumer</p></li><li><p>Producer Group</p></li><li><p>Consumer Group</p></li><li><p>Clustering</p></li><li><p>Broadcasting</p></li><li><p>Normal Ordered Message</p></li><li><p>Strictly Ordered Message</p></li></ul><h1 id=rocketmq-部署架构>RocketMQ 部署架构</h1><p><img src=/rocketmq/rocketmq_architecture_3.png alt=RocketMQ部署架构></p><ul><li>Producer: 消息发布决赛、支持分布式集群部署，Producer 通过MQ的负载均衡莫款选择相应的Broker进行消息投递。</li><li>Consumer: 消息消费角色、支持分布式集群部署，支持Push方式、Pull方式对消息进行消费，同时也指出集群方式和广播方式进行消费。</li><li>Name Server: NameServer是一个非常简单的Topic路由注册中心，其角色类似Dubbo中的zookeeper，支持Broker的动态注册与发现。</li></ul><blockquote><ul><li>Broker 管理，NameServer接受Broker集群的注册信息并且保存下来作为路由信息的基本数据。然后提供心跳检测机制，检查Broker是否还存活；</li><li>路由信息管理, 每个NameServer将保存关于Broker集群的整个路由信息和用于客户端查询的队列信息。然后Producer和Consumer通过NameServer就可以知道整个Broker集群的路由信息，从而进行消息的投递和消费。
NameServer通常也是集群的方式部署，各实例间相互不进行信息通讯。Broker是向每一台NameServer注册自己的路由信息，所以每一个NameServer实例上面都保存一份完整的路由信息。当某个NameServer因某种原因下线了，Broker仍然可以向其它NameServer同步其路由信息，Producer,Consumer仍然可以动态感知Broker的路由的信息</li></ul></blockquote><p>RocketMQ 网路部署特点:</p><ul><li>NameSever 是无状态节点，可集群部署，节点之间无任何信息同步。Broker是向每一台NameServer注册自己的路由信息，所以每一个NameServer实例上面都保存一份完整的路由信息。当某个NameServer因某种原因下线了，Broker仍然可以向其它NameServer同步其路由信息，Producer,Consumer仍然可以动态感知Broker的路由的信息。</li><li>Broker部署相对复杂，Broker分为Master与Slave，一个Master可以对应多个Slave，但是一个Slave只能对应一个Master，Master与Slave 的对应关系通过指定相同的BrokerName，不同的BrokerId 来定义，BrokerId为0表示Master，非0表示Slave。Master也可以部署多个。每个Broker与NameServer集群中的所有节点建立长连接，定时注册Topic信息到所有NameServer。 注意：当前RocketMQ版本在部署架构上支持一Master多Slave，但只有BrokerId=1的从服务器才会参与消息的读负载。</li><li>Producer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer获取Topic路由信息，并向提供Topic 服务的Master建立长连接，且定时向Master发送心跳。Producer完全无状态，可集群部署。</li><li>Consumer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer获取Topic路由信息，并向提供Topic服务的Master、Slave建立长连接，且定时向Master、Slave发送心跳。Consumer既可以从Master订阅消息，也可以从Slave订阅消息，消费者在向Master拉取消息时，Master服务器会根据拉取偏移量与最大偏移量的距离（判断是否读老消息，产生读I/O），以及从服务器是否可读等因素建议下一次是从Master还是Slave拉取。</li></ul><h1 id=rocketmq--事务消息->RocketMQ * 事务消息 *</h1><p>后面专门一章讲述这个事务消息</p><hr width=100% id=EOF><p style=color:#777>最后修改于 2021-05-19</p></div></div><nav class=post-pagination><a class=newer-posts>下回<br>已经到头啦。</a>
<a class=older-posts href=https://pinkhello.me/posts/%E7%AE%97%E6%B3%95-bitmap/>上回<br>算法 Bitmap</a></nav><div class=post-comment-wrapper><div id=gitalk-container></div></div></div></div></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://amazingrise.net>Rise</a><br>移植自 <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
PinkHello, All Rights Reserved</div></div><script>let app;app=new Vue({el:'#app',data:{scrollY:0,navOpacity:0,isDrawerOpen:!1,mounted:!1,isDarkMode:!1},methods:{sgn(a,b){let c=1/(1-2*a);return b<=a?0:b>=1-a?1:c*(b-a)},handleScroll(){this.scrollY=window.scrollY,this.navOpacity=this.sgn(0,Math.min(1,Math.max(0,window.scrollY/(this.pageHeadHeight()-this.navBarHeight()*.8))));const{navBar:c,navBackground:a,navTitle:b,extraContainer:d,streamContainer:e}=this.$refs;this.navOpacity>=1?(a.style.opacity=1,b.style.opacity=1):(a.style.opacity=0,b.style.opacity=0)},handleResize(){const{navBar:c,navBackground:d,navTitle:e,extraContainer:a,streamContainer:b}=this.$refs;a.style.left=b.offsetWidth-a.offsetWidth+'px'},navBarHeight(){return this.$refs.navBar.offsetHeight},pageHeadHeight(){return this.$refs.pageHead.offsetHeight},toggleDrawer(){this.isDrawerOpen=!this.isDrawerOpen,document.getElementsByTagName('html')[0].style.overflow=this.isDrawerOpen?'hidden':'unset'},closeDrawer(){this.isDrawerOpen=!1,document.getElementsByTagName('html')[0].style.overflow=this.isDrawerOpen?'hidden':'unset'},toggleDarkMode(){this.isDarkMode=!this.isDarkMode,this.isDarkMode==!0?(document.cookie="night=1;path=/",document.body.classList.add("night")):(document.cookie="night=0;path=/",document.body.classList.remove("night"))}},created(){window.addEventListener('scroll',this.handleScroll),window.addEventListener('resize',this.handleResize),window._nonDesktop=function(){let a=!1;return function(b){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(b)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0,4)))&&(a=!0)}(navigator.userAgent||navigator.vendor||window.opera),a};var a=document.cookie.replace(/(?:(?:^|.*;\s*)night\s*\=\s*([^;]*).*$)|^.*$/,"$1");a==""?window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches:a=="1"&&this.toggleDarkMode()},mounted(){this.handleScroll(),this.handleResize(),this.mounted=!0},destroyed(){window.removeEventListener('scroll',this.handleScroll),window.removeEventListener('resize',this.handleResize)}})</script><script src=https://pinkhello.me//js/journal.js></script></body></html>