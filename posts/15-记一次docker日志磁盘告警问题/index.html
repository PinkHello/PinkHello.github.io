<!doctype html><html lang=en><head><title>一杯哈希不加盐</title><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#000084"><link rel=icon href=https://pinkhello.github.io//favicon.ico><link rel=canonical href=https://pinkhello.github.io/></head><body><nav class="navbar navbar-inverse navbar-fixed-top"><div class=navbar-inner><div class=container><button type=button class="btn btn-navbar" data-toggle=collapse data-target=.nav-collapse></button>
<a class=brand href=https://pinkhello.github.io/>一杯哈希不加盐</a><div class="nav-collapse collapse"><ul class=nav><li><a href=/about/><span>About</span></a></li><li><a href=/posts/><span>Archive</span></a></li></ul></div></div></div></nav><div id=content class=container><div class="row-fluid navmargin"><div class=page-header><h1>15 记一次docker日志磁盘告警问题 - Wed, Feb 10, 2021</h1></div><p class=lead></p><h1 id=前景>前景</h1><p>今日，我正在开开心心的刷着JFX的Coding中，突然线上报警群中爆了个炸弹，EC2磁盘超过80%。</p><p><img src=/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/%E8%B5%84%E6%BA%90%E4%B8%8D%E8%B6%B3%E6%8A%A5%E8%AD%A6.png alt=资源不足预警></p><h1 id=处理过程>处理过程</h1><p>解决问题姿势就位：</p><ul><li><p>赶紧开机 ==》 ❤️中万匹🦙奔腾而过 ❤️中MMP</p></li><li><p>默默的通过跳板机进入目标机器</p></li><li><p>不管三七二十一,执行查看磁盘占用大小，我的乖乖，占用确实超过了87%了，一下子暴涨的</p></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># 查看磁盘占用大小</span>
&gt; sudo df -h
<span style=color:#75715e># 查看当前目录总量</span>
&gt; sudo du -sh
</code></pre></div><ul><li>开始定位具体哪个文件或者目录占用这么大,跑到根目录下。</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># 查看当前目录下一级子文件和子目录占用的磁盘容量</span>
&gt; sudo du -lh --max-depth<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</code></pre></div><ul><li>一开始猜想可能是docker容器的日志占用大，上面执行后，还真 TM 是</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>/var/lib/docker/containers 目录占用 42G
</code></pre></div><ul><li>开始查看是哪个容器占用的这么大的空间</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># 查看 containers 日志目录排序</span>
&gt; sudo du -d1 -h /var/lib/docker/containers | sort -h
<span style=color:#75715e># 查看具体的哪个日志文件大</span>
&gt; sudo find /var/lib/docker/containers -name *.log
</code></pre></div><p>当然这个配图是我清理之后的
<img src=/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/docker%E5%AE%B9%E5%99%A8%E6%96%87%E4%BB%B6%E6%8E%92%E5%BA%8F.png alt=docker容器文件排序>
<img src=/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/%E6%9F%A5%E6%89%BEdocker%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6.png alt=查找docker容器日志文件></p><ul><li>定位到最大的文件，一顿操作</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>   <span style=color:#75715e># 清空比较大的日志文件</span>
   &gt; sudo sh -c <span style=color:#e6db74>&#34;cat /dev/null &gt; </span><span style=color:#e6db74>${</span>log_file<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><p><img src=/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/%E6%B8%85%E7%90%86docker%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97%E5%90%8E.png alt=清理docker容器日志后></p><h1 id=思考>思考</h1><ul><li>上面的方式是一种方式解决【临时】<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>  <span style=color:#75715e># 查看 docker 的 Logging Driver</span>
  &gt; docker info | grep <span style=color:#e6db74>&#39;Logging Driver&#39;</span>
</code></pre></div><p>如何彻底解决这个问题：</p><ul><li>写个<code>shell脚本</code> 使用 <code>crontab</code> 定期执行清理<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>   <span style=color:#75715e>#!/bin/sh</span>
   echo <span style=color:#e6db74>&#34;======== start clean docker containers logs ========&#34;</span>  
   logs<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>find /var/lib/docker/containers/ -name *-json.log<span style=color:#66d9ef>)</span>  
   <span style=color:#66d9ef>for</span> log in $logs  
     <span style=color:#66d9ef>do</span>  
     echo <span style=color:#e6db74>&#34;clean logs : </span>$log<span style=color:#e6db74>&#34;</span>  
     cat /dev/null &gt; $log  
     <span style=color:#66d9ef>done</span>  
   echo <span style=color:#e6db74>&#34;======== end clean docker containers logs ========&#34;</span>
</code></pre></div></li><li>假如是<code>docker run</code>创建容器的,指定 <code>--log-opt max-size=${MAX_SIZE}m --log-opt max-file=${NUMBER}</code></li><li><code>docker-compose</code> 方式更高<code>docker-compose.yaml</code>文件<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  <span style=color:#f92672>logging</span>:
      <span style=color:#f92672>driver</span>: <span style=color:#e6db74>&#34;json-file&#34;</span>
      <span style=color:#f92672>options</span>:
        <span style=color:#f92672>max-size</span>: <span style=color:#e6db74>&#34;${MAX_SIZE}m&#34;</span>
        <span style=color:#f92672>max-file</span>: <span style=color:#ae81ff>${NUMBER}</span>
</code></pre></div></li><li><code>docker</code> 全局修改 <code>/etc/docker/daemon.json</code><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>  {
    <span style=color:#f92672>&#34;log-driver&#34;</span>: <span style=color:#e6db74>&#34;json-file&#34;</span>,
    <span style=color:#f92672>&#34;log-opts&#34;</span>: {
      <span style=color:#f92672>&#34;max-size&#34;</span>: <span style=color:#e6db74>&#34;${MAX_SIZE}m&#34;</span>
    }
  }
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>  &gt; systemctl daemon-reload
  &gt; systemctl restart docker
</code></pre></div></li></ul></li><li>为什么会瞬间💥式的增长 ???</li></ul><h4><a href=https://pinkhello.github.io/>Back to Home</a></h4></div></div><footer class=container><hr class=soften><p><a href=https://pinkhello.github.io/>hugo.386 theme</a> |
&copy;
<a href=https://pinkhello.github.io/ target=_blank>一杯哈希不加盐</a>
<span id=thisyear>2020</span>
| Built on <a href=//gohugo.io target=_blank>Hugo</a></p><p class=text-center><a href=https://github.com/PinkHello>GitHub</a></p></footer></body><link rel=stylesheet href=/css/bootstrap.css><link rel=stylesheet href=/css/bootstrap-responsive.css><link rel=stylesheet href=/css/style.css><script src=/js/jquery.js></script><script src=/js/bootstrap-386.js></script><script src=/js/bootstrap-transition.js></script><script src=/js/bootstrap-alert.js></script><script src=/js/bootstrap-modal.js></script><script src=/js/bootstrap-dropdown.js></script><script src=/js/bootstrap-scrollspy.js></script><script src=/js/bootstrap-tab.js></script><script src=/js/bootstrap-tooltip.js></script><script src=/js/bootstrap-popover.js></script><script src=/js/bootstrap-button.js></script><script src=/js/bootstrap-collapse.js></script><script src=/js/bootstrap-carousel.js></script><script src=/js/bootstrap-typeahead.js></script><script src=/js/bootstrap-affix.js></script><script>_386={fastLoad:false,onePass:false,speedFactor:1};function ThisYear(){document.getElementById('thisyear').innerHTML=new Date().getFullYear();};</script></html>