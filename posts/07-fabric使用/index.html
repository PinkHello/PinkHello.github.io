<!doctype html><html lang=en><head><title>一杯哈希不加盐</title><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#000084"><link rel=icon href=https://pinkhello.github.io//favicon.ico><link rel=canonical href=https://pinkhello.github.io/></head><body><nav class="navbar navbar-inverse navbar-fixed-top"><div class=navbar-inner><div class=container><button type=button class="btn btn-navbar" data-toggle=collapse data-target=.nav-collapse></button>
<a class=brand href=https://pinkhello.github.io/>一杯哈希不加盐</a><div class="nav-collapse collapse"><ul class=nav><li><a href=/about/><span>About</span></a></li><li><a href=/posts/><span>Archive</span></a></li></ul></div></div></div></nav><div id=content class=container><div class="row-fluid navmargin"><div class=page-header><h1>07 Fabric使用 - Wed, Feb 10, 2021</h1></div><p class=lead></p><h2 id=docker-加入systemctl环境并启动docker>docker 加入systemctl环境并启动docker</h2><p>快速安装docker</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -sSL https://get.daocloud.io/docker | sh
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl enable docker
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl start docker
</code></pre></div><h2 id=docker-compose-安装>docker-compose 安装</h2><p>走外网或者 <code>github</code> 太慢,可以使用内部加速</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> curl -L <span style=color:#e6db74>&#34;https://github.com/docker/compose/releases/download/X.XX.X/docker-compose-</span><span style=color:#66d9ef>$(</span>uname -s<span style=color:#66d9ef>)</span><span style=color:#e6db74>-</span><span style=color:#66d9ef>$(</span>uname -m<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> -o /usr/local/bin/docker-compose
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> curl -L https://get.daocloud.io/docker/compose/releases/download/1.26.2/docker-compose-<span style=color:#e6db74>`</span>uname -s<span style=color:#e6db74>`</span>-<span style=color:#e6db74>`</span>uname -m<span style=color:#e6db74>`</span> &gt; /usr/local/bin/docker-compose
</code></pre></div><h2 id=fabric-自动运维>fabric 自动运维</h2><h3 id=python-虚拟环境安装>python 虚拟环境安装</h3><p><a href=https://www.liaoxuefeng.com/wiki/1016959663602400/1019273143120480>参考</a></p><p>创建一个独立的虚拟环境</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cd 目标目录
virtualenv --no-site-packages venv
</code></pre></div><p>激活虚拟环境</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>source venv/bin/activate
</code></pre></div><h3 id=python-pip-安装-fabric>python pip 安装 Fabric</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>pip install fabric3
</code></pre></div><h3 id=python-pip-导出依赖>python pip 导出依赖</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>pip freeze &gt; requirements.txt
</code></pre></div><h3 id=其他python-pip-导入安装>其他python pip 导入安装</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>pip install -r requirements.txt
</code></pre></div><h3 id=fabric-文档-fabfiles-文档httpsfabric-chsreadthedocsiozh_cnchsusagefabfileshtml><a href=https://fabric-chs.readthedocs.io/zh_CN/chs/usage/fabfiles.html>Fabric 文档 fabfiles 文档</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># encoding=utf-8</span>
<span style=color:#f92672>from</span> fabric.api <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
<span style=color:#f92672>from</span> fabric.context_managers <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>

env<span style=color:#f92672>.</span>user <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;root&#39;</span>

env<span style=color:#f92672>.</span>gateway <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;192.168.1.118&#39;</span>

env<span style=color:#f92672>.</span>hosts <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;10.10.2.6&#39;</span>,<span style=color:#e6db74>&#39;10.10.2.7&#39;</span>]

env<span style=color:#f92672>.</span>passwords <span style=color:#f92672>=</span> {
    <span style=color:#e6db74>&#39;root@10.10.2.6:22&#39;</span>:<span style=color:#e6db74>&#39;PASSWORD_2&#39;</span>,
    <span style=color:#e6db74>&#39;root@10.10.2.7:22&#39;</span>:<span style=color:#e6db74>&#39;PASSWORD_2&#39;</span>,
    <span style=color:#e6db74>&#39;root@192.168.1.118:22&#39;</span>:<span style=color:#e6db74>&#39;PASSWORD_1&#39;</span>
}

jump_server <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;jump_server&#39;</span>
astra_server <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;astra_server&#39;</span>

<span style=color:#75715e># 指定 role 角色组</span>
env<span style=color:#f92672>.</span>roledefs<span style=color:#f92672>=</span> {
    jump_server: [<span style=color:#e6db74>&#39;192.168.1.118&#39;</span>],
    astra_server: [<span style=color:#e6db74>&#39;10.10.2.6&#39;</span>,<span style=color:#e6db74>&#39;10.10.2.7&#39;</span>]
}

<span style=color:#75715e># 测试</span>
<span style=color:#a6e22e>@task</span>
<span style=color:#a6e22e>@roles</span>(jump_server)
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test</span>():
    run(<span style=color:#e6db74>&#39;ls -la &amp;&amp; pwd&#39;</span>)
 
<span style=color:#75715e># 登录私有仓库</span>
<span style=color:#a6e22e>@task</span>
<span style=color:#a6e22e>@roles</span>(astra_server)
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>docker_login</span>():
    run(<span style=color:#e6db74>&#39;docker login -u USERNAME -p PASSWORD docker-registery.xxx.com&#39;</span>)

<span style=color:#75715e># 测试</span>
<span style=color:#a6e22e>@task</span>
<span style=color:#a6e22e>@roles</span>(astra_server)
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>docker_ps</span>():
    run(<span style=color:#e6db74>&#39;docker ps&#39;</span>)


<span style=color:#75715e># 上传docker-compose</span>
<span style=color:#a6e22e>@task</span>
<span style=color:#a6e22e>@roles</span>(astra_server)
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>put_docker_compose</span>():
<span style=color:#75715e># 上传失败，照样往下执行 with settings(warn_only=True)</span>
    <span style=color:#66d9ef>with</span> settings(warn_only<span style=color:#f92672>=</span>True):
        result <span style=color:#f92672>=</span> put(<span style=color:#e6db74>&#39;deploy/prod/docker-compose.yml&#39;</span>,<span style=color:#e6db74>&#39;~/docker-compose.yml&#39;</span>)
    <span style=color:#66d9ef>if</span> result<span style=color:#f92672>.</span>failed:
        abort(<span style=color:#e6db74>&#39;Aborting file put task!&#39;</span>)

<span style=color:#75715e># 重新docker-compose部署</span>
<span style=color:#a6e22e>@task</span>
<span style=color:#a6e22e>@roles</span>(astra_server)
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>restart_docker_compose</span>():
    run(<span style=color:#e6db74>&#39;docker-compose stop &amp;&amp; docker-compose up -d&#39;</span>)

<span style=color:#a6e22e>@task</span>
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>deploy</span>():
    docker_login()
    docker_ps()
    put_docker_compose()
    restart_docker_compose()
</code></pre></div><h4><a href=https://pinkhello.github.io/>Back to Home</a></h4></div></div><footer class=container><hr class=soften><p><a href=https://pinkhello.github.io/>hugo.386 theme</a> |
&copy;
<a href=https://pinkhello.github.io/ target=_blank>一杯哈希不加盐</a>
<span id=thisyear>2020</span>
| Built on <a href=//gohugo.io target=_blank>Hugo</a></p><p class=text-center><a href=https://github.com/PinkHello>GitHub</a></p></footer></body><link rel=stylesheet href=/css/bootstrap.css><link rel=stylesheet href=/css/bootstrap-responsive.css><link rel=stylesheet href=/css/style.css><script src=/js/jquery.js></script><script src=/js/bootstrap-386.js></script><script src=/js/bootstrap-transition.js></script><script src=/js/bootstrap-alert.js></script><script src=/js/bootstrap-modal.js></script><script src=/js/bootstrap-dropdown.js></script><script src=/js/bootstrap-scrollspy.js></script><script src=/js/bootstrap-tab.js></script><script src=/js/bootstrap-tooltip.js></script><script src=/js/bootstrap-popover.js></script><script src=/js/bootstrap-button.js></script><script src=/js/bootstrap-collapse.js></script><script src=/js/bootstrap-carousel.js></script><script src=/js/bootstrap-typeahead.js></script><script src=/js/bootstrap-affix.js></script><script>_386={fastLoad:false,onePass:false,speedFactor:1};function ThisYear(){document.getElementById('thisyear').innerHTML=new Date().getFullYear();};</script></html>