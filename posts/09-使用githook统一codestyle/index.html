<!doctype html><html lang=en><head><title>一杯哈希不加盐</title><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#000084"><link rel=icon href=https://pinkhello.github.io//favicon.ico><link rel=canonical href=https://pinkhello.github.io/></head><body><nav class="navbar navbar-inverse navbar-fixed-top"><div class=navbar-inner><div class=container><button type=button class="btn btn-navbar" data-toggle=collapse data-target=.nav-collapse></button>
<a class=brand href=https://pinkhello.github.io/>一杯哈希不加盐</a><div class="nav-collapse collapse"><ul class=nav><li><a href=/about/><span>About</span></a></li><li><a href=/posts/><span>Archive</span></a></li></ul></div></div></div></nav><div id=content class=container><div class="row-fluid navmargin"><div class=page-header><h1>09 使用githook统一codestyle - Wed, Feb 10, 2021</h1></div><p class=lead></p><h1 id=gradle-优化>gradle 优化</h1><ul><li>build 指定 -g cache 缓存</li></ul><h1 id=checkstyle-实践>checkstyle 实践</h1><ul><li>基础镜像包含 <code>checkstyle.xml</code> 或者 放到远程其他可被拉取到的存储介质 ，防止项目成员改动</li><li><code>gitlab-ci</code> <code>beforeScript</code> 标签执行命令 <code>copy /checkstyle.xml</code> 进入项目，(覆盖项目中存在的).</li><li><code>gradle</code> 编译的话 将 <code>maven-publish.gradle</code> <code>repos.gradle</code> <code>checkstyle.gradle</code>(<code>checkstyle</code> 插件配置 版本以及 <code>configFile</code>) 抽出放到公共的地方，防止项目团队成员改的.</li><li><code>maven</code> 的话，可以在公共的顶级继承 <code>pom</code> 里面指定变量<code>checkstyle.config.location</code>. <code>mvn checkstyle -Dcheckstyle.config.location=checkstyle.xml</code></li></ul><h1 id=git-hook-实践>git hook 实践</h1><p>每个项目里面 <code>.git/hooks</code> 里面有很多的 <code>hook</code> 模板</p><p>客户端钩子包括:<code>pre-commit</code>、<code>prepare-commit-msg</code>、<code>commit-msg</code>、<code>post-commit</code>等，主要用于控制客户端git的提交工作流。</p><p>服务端钩子：<code>pre-receive</code>、<code>post-receive</code>、<code>update</code>，主要在服务端接收提交对象时、推送到服务器之前调用。</p><p>今天实践的是 客户端钩子，优化减少不符合规范或者低质量代码进入 <code>gitflow</code> 流程.</p><p><code>pre-commit</code> 和 <code>commit-msg</code> 是今天的主角，<code>pre-commit</code> 执行与 <code>git add</code> 之后，在进行 <code>git commit</code> 之前进行的操作.
可以用来进行 <code>code check</code> <code>code lint</code> 等等, <code>commit-msg</code> 执行与 <code>git commit</code> 常用于补全 <code>git commit message</code> <code>check msg</code> 等等
当然还有其他骚操作的功能，可以通知，等等，做多种自动化</p><p>目录结构</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#ae81ff>project</span>
- <span style=color:#ae81ff>.git/..等等</span>
- <span style=color:#ae81ff>git_hooks</span>
 -- <span style=color:#ae81ff>pre-commit </span> <span style=color:#75715e># pre-commit action</span>
 -- <span style=color:#ae81ff>commit-msg </span> <span style=color:#75715e># commit-msg action</span>
 -- <span style=color:#ae81ff>init.sh    </span> <span style=color:#75715e># 初始化脚本</span>
</code></pre></div><ul><li>pre-commit</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>workPath<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>
CHECK_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>workPath<span style=color:#e6db74>}</span>/checks
<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -d $CHECK_DIR <span style=color:#f92672>]</span>
<span style=color:#66d9ef>then</span>
  mkdir $CHECK_DIR
<span style=color:#66d9ef>fi</span>
DOWNLOAD_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://{download.path}/checkstyle&#34;</span>
CONFIG_CHECK_JAR<span style=color:#f92672>=</span>$CHECK_DIR/checkstyle.jar;
CONFIG_CHECK_FILE<span style=color:#f92672>=</span>$CHECK_DIR/checkstyle.xml;
CONFIG_ERROR_FILE<span style=color:#f92672>=</span>$CHECK_DIR/checkstyle_errors.xml;
CONFIG_ERROR_REPORT_FILE<span style=color:#f92672>=</span>$CHECK_DIR/checkstyle_report.xml;

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -f $CONFIG_CHECK_JAR <span style=color:#f92672>]</span>
<span style=color:#66d9ef>then</span>
  curl -o $CONFIG_CHECK_JAR $DOWNLOAD_PATH/checkstyle-8.8-all.jar <span style=color:#f92672>||</span> true;
<span style=color:#66d9ef>fi</span>

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> ! -f $CONFIG_CHECK_FILE <span style=color:#f92672>]</span>
<span style=color:#66d9ef>then</span>
  curl -o $CONFIG_CHECK_FILE $DOWNLOAD_PATH/checkstyle.xml <span style=color:#f92672>||</span> true;
<span style=color:#66d9ef>fi</span>

javafiles<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>git diff --cached --name-only | grep <span style=color:#e6db74>&#39;\.java&#39;</span><span style=color:#e6db74>`</span>;
echo $javafiles;

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f $CONFIG_ERROR_FILE <span style=color:#f92672>]</span>
<span style=color:#66d9ef>then</span>
  rm $CONFIG_ERROR_FILE;
<span style=color:#66d9ef>fi</span>

CHECK_CMD<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;java -cp </span>$CONFIG_CHECK_JAR<span style=color:#e6db74> com.puppycrawl.tools.checkstyle.Main -c </span>$CONFIG_CHECK_FILE<span style=color:#e6db74> </span>$javafiles<span style=color:#e6db74> -f xml -o </span>$CONFIG_ERROR_FILE<span style=color:#e6db74>&#34;</span>;
echo <span style=color:#e6db74>&#34;</span>$CHECK_CMD<span style=color:#e6db74>&#34;</span>;
$CHECK_CMD;

<span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> -f $CONFIG_ERROR_FILE <span style=color:#f92672>]</span>
<span style=color:#66d9ef>then</span>
    errorResponse<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>cat $CONFIG_ERROR_FILE | grep <span style=color:#ae81ff>\&lt;</span>error|head -n 1<span style=color:#e6db74>`</span>;
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> $errorResponse <span style=color:#f92672>==</span> *<span style=color:#e6db74>&#34;error&#34;</span>* <span style=color:#f92672>]]</span>
    <span style=color:#66d9ef>then</span>
      awk <span style=color:#e6db74>&#39;{print;} NR == 1 { print &#34;&lt;?xml-stylesheet xmlns=\&#34;http://www.w3.org/1999/xhtml\&#34; href=\&#34;checkstyle-simple.xsl\&#34; type=\&#34;text/xsl\&#34;?&gt;&#34;}&#39;</span> $CONFIG_ERROR_FILE &gt; $CONFIG_ERROR_REPORT_FILE;
      echo -e <span style=color:#e6db74>&#34;Check your code. Open by Safari or Chrome ( --allow-file-access-from-files ): </span>$CONFIG_ERROR_REPORT_FILE<span style=color:#e6db74>&#34;</span>;
      open $CONFIG_ERROR_REPORT_FILE
      exit <span style=color:#ae81ff>1</span>
    <span style=color:#66d9ef>fi</span>
<span style=color:#66d9ef>fi</span>

echo <span style=color:#e6db74>&#34;check pass! pre_commit successfully!&#34;</span>;

</code></pre></div><ul><li>commit-msg</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e>#!/bin/sh
</span><span style=color:#75715e></span><span style=color:#75715e># append CL message 信息（加入作者 例子）</span>
<span style=color:#75715e>#name=[PinkHello]</span>
<span style=color:#75715e>#commit=&#34;$name $(cat $1)&#34;</span>
<span style=color:#75715e>#echo &#34;$commit&#34; &gt; &#34;$1&#34;</span>
echo $commit
commit<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>cat $1<span style=color:#e6db74>`</span>
echo <span style=color:#e6db74>&#34;</span>$commit<span style=color:#e6db74>&#34;</span> &gt; <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span>
<span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> $commit <span style=color:#f92672>=</span>~ ^<span style=color:#f92672>([</span>A-Z<span style=color:#f92672>]</span>+<span style=color:#f92672>)</span>-<span style=color:#f92672>([</span>0-9<span style=color:#f92672>]</span>+<span style=color:#f92672>)</span>:.*|<span style=color:#f92672>(</span>Merge.*<span style=color:#f92672>)</span>|<span style=color:#f92672>(</span>Revert.*<span style=color:#f92672>)</span>|<span style=color:#f92672>(</span>Other.*<span style=color:#f92672>)</span> <span style=color:#f92672>]]</span>
<span style=color:#66d9ef>then</span>
  echo <span style=color:#e6db74>&#34;commit successful!&#34;</span>
<span style=color:#66d9ef>else</span>
  echo <span style=color:#e6db74>&#34;\033 Error: the commit message must start with JIRA ticket number \033&#34;</span>
  exit <span style=color:#ae81ff>1</span>
<span style=color:#66d9ef>fi</span>

</code></pre></div><ul><li>init.sh</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e>#!/bin/sh
</span><span style=color:#75715e></span><span style=color:#75715e># 当前目录</span>
workPath<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>
echo <span style=color:#e6db74>&#34;当前初始化目录</span>$workPath<span style=color:#e6db74>&#34;</span>
<span style=color:#75715e># 链接到 .git hooks 目录里面</span>
ln -s -f $workPath/pre-commit $workPath/../.git/hooks/pre-commit
ln -s -f $workPath/commit-msg $workPath/../.git/hooks/commit-msg

echo <span style=color:#e6db74>&#34;ln pre-commit commit-msg.....success.&#34;</span>

</code></pre></div><h1 id=google-cr-mr-规范>google CR MR 规范</h1><p><a href=https://github.com/google/eng-practices>https://github.com/google/eng-practices</a></p><p><code>CL</code> 规范：</p><ul><li>提交新的 <code>subject</code> ，才有祈使句，一个命令的形式言简意赅的表达这次要改变的什么，如需要详细上下文，关联 <code>ticket</code>，在 <code>body</code> 中说明</li><li>简化 <code>cl</code> ，尽可能小，不要积攒一堆 <code>change</code> ，一次性提交，然后再一次性 <code>MR</code> ，加大了 <code>review</code> 风险。</li></ul><p><code>MR</code> 规范</p><ul><li>紧急 <code>MR</code> 适当放松</li><li><code>MR</code> 不能带有脾气，目的是基于问题讨论，解决问题</li><li>针对做的好的给予肯定和👍</li><li><code>LGTM means look good to me </code>= 朕知道了！</li><li><code>MR</code> 冲突，联系必要开发者一起参与决定避免出现代码丢失与错误.</li></ul><p><code>CR</code> 规范</p><ul><li>速度可以灭杀一切抱怨，不能让 <code>cr</code> 时间过长</li><li><code>CR</code> 发现问题一定要让开发者去修改，不要有以后再修改的想法，这种方式往往是让系统变得更差的原因.</li></ul><h4><a href=https://pinkhello.github.io/>Back to Home</a></h4></div></div><footer class=container><hr class=soften><p><a href=https://pinkhello.github.io/>hugo.386 theme</a> |
&copy;
<a href=https://pinkhello.github.io/ target=_blank>一杯哈希不加盐</a>
<span id=thisyear>2020</span>
| Built on <a href=//gohugo.io target=_blank>Hugo</a></p><p class=text-center><a href=https://github.com/PinkHello>GitHub</a></p></footer></body><link rel=stylesheet href=/css/bootstrap.css><link rel=stylesheet href=/css/bootstrap-responsive.css><link rel=stylesheet href=/css/style.css><script src=/js/jquery.js></script><script src=/js/bootstrap-386.js></script><script src=/js/bootstrap-transition.js></script><script src=/js/bootstrap-alert.js></script><script src=/js/bootstrap-modal.js></script><script src=/js/bootstrap-dropdown.js></script><script src=/js/bootstrap-scrollspy.js></script><script src=/js/bootstrap-tab.js></script><script src=/js/bootstrap-tooltip.js></script><script src=/js/bootstrap-popover.js></script><script src=/js/bootstrap-button.js></script><script src=/js/bootstrap-collapse.js></script><script src=/js/bootstrap-carousel.js></script><script src=/js/bootstrap-typeahead.js></script><script src=/js/bootstrap-affix.js></script><script>_386={fastLoad:false,onePass:false,speedFactor:1};function ThisYear(){document.getElementById('thisyear').innerHTML=new Date().getFullYear();};</script></html>