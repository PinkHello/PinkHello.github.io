<!doctype html><html lang=en><head><title>一杯哈希不加盐</title><meta charset=utf-8><meta content="utf-8" http-equiv=encoding><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#000084"><link rel=icon href=https://pinkhello.github.io//favicon.ico><link rel=canonical href=https://pinkhello.github.io/></head><body><nav class="navbar navbar-inverse navbar-fixed-top"><div class=navbar-inner><div class=container><button type=button class="btn btn-navbar" data-toggle=collapse data-target=.nav-collapse></button>
<a class=brand href=https://pinkhello.github.io/>一杯哈希不加盐</a><div class="nav-collapse collapse"><ul class=nav><li><a href=/about/><span>About</span></a></li><li><a href=/posts/><span>Archive</span></a></li></ul></div></div></div></nav><div id=content class=container><div class="row-fluid navmargin"><div class=page-header><h1>05 OAuth2.0 那点事 - Wed, Feb 10, 2021</h1></div><p class=lead></p><h2 id=oauth20-是什么><code>OAuth2.0</code> 是什么?</h2><p><code>OAuth2.0</code> Framework RFC 6749 [https://tools.ietf.org/html/rfc6749]</p><p><code>OAuth</code> 就是一种授权机制，它介于客户端与资源所有者的授权层，为了分离不同的角色。
在资源所有者同意并向客户端颁发令牌后，客户端携带令牌可以访问部分或全部资源。</p><p>OAuth2.0 是OAuth 协议的一个版本，为2.0版本。有意思的是 2.0 与 1.0 并不兼容。</p><h2 id=oauth20-授权方式><code>OAuth2.0</code> 授权方式</h2><p>获取授权的过程</p><ul><li>授权码(authorization-code)</li><li>隐藏式(implicit)</li><li>密码(password)</li><li>客户端凭证(client credentials)</li></ul><p>不管哪种方式，都需要在第三方应用申请令牌之前，需要在系统中申请身份唯一标识: 客户端ID Client ID 和 客户端秘钥 Client Secret.
这样能确保Token不被恶意使用。</p><p>授权重要的参数和指标:</p><ul><li>response_type 响应类型: code(要求返回授权码),token(要求返回授权Token)</li><li>client_id 客户端身份标识</li><li>client_secret 客户端秘钥</li><li>redirect_uri 重定向地址</li><li>scope 授权范围, read 只读权限, all 全部权限</li><li>grant_type 授权方式 authorization_code(授权码)、password(密码)、client_credentials
(凭证)、refresh_token(更新令牌)</li><li>state 应用程序传递的一个随机数，防止 CSRF 攻击</li></ul><h3 id=授权码httpswwwoauthcomoauth2-serversaccess-tokensauthorization-code-request-authorization-code-request><a href=https://www.oauth.com/oauth2-servers/access-tokens/authorization-code-request/ title=authorization-code-request>授权码</a></h3><p>在访问第三方应用先申请一个授权码，然后再用授权码获取令牌.这种方式也是最常用的流程，安全性也是最高的，适用于有后端的Web应用。授权码通过前端传送，令牌存储在后端。所有的和资源服务器的交互都在服务端完成，避免了令牌的泄露。
授权码和令牌的在 浏览器和客户端WEB应用以及资源服务器的交互流程大致如下:
<img src=/OAuth2-0%E9%82%A3%E7%82%B9%E4%BA%8B/auth_code.png alt=authorization-code></p><ul><li>1.2.3.4 用户选择 Google 登陆 yelp.com</li><li>3.4 Yelp.com 请求用户授权 Google 权限</li><li>5.6 用户同意后返回授权码</li><li>7.8 Yelp.com 通过授权码 会向 Google发起请求Token</li><li>9 验证必要参数，返回 Token</li><li>10.11 操作请求</li></ul><h3 id=隐藏式httpsauth0comblogoauth2-implicit-grant-and-spa-oauth2-implicit-grant-and-spa><a href=https://auth0.com/blog/oauth2-implicit-grant-and-spa/ title=oauth2-implicit-grant-and-spa>隐藏式</a></h3><p><img src=/OAuth2-0%E9%82%A3%E7%82%B9%E4%BA%8B/implicit.png alt=implicit></p><h3 id=密码式httpswwwoauthcomoauth2-serversaccess-tokenspassword-grant-password-grant><a href=https://www.oauth.com/oauth2-servers/access-tokens/password-grant/ title=password-grant>密码式</a></h3><p>顾名思议,在自己的系统输入第三方系统的账号密码,自己的系统拿账号密码去申请令牌，响应题里面返回token</p><h3 id=凭证式httpswwwoauthcomoauth2-serversaccess-tokensclient-credentials-client-credentials><a href=https://www.oauth.com/oauth2-servers/access-tokens/client-credentials/ title=client-credentials>凭证式</a></h3><p>凭证式和密码很相似，主要给没有前端输入的项目或者命令行</p><h2 id=令牌的使用和更新>令牌的使用和更新</h2><h3 id=令牌的使用><a href>令牌的使用</a></h3><p>令牌的拿到了，就可以调用Google的API进行请求数据了，
一般讲 Token 放入请求头 Authorization.</p><h3 id=令牌的更新httpswwwoauthcomoauth2-serversaccess-tokensrefreshing-access-tokens-refreshing-access-tokens><a href=https://www.oauth.com/oauth2-servers/access-tokens/refreshing-access-tokens/ title=refreshing-access-tokens>令牌的更新</a></h3><p>Token 是有时效性的，一旦过期就需要重新获取，但是重走一遍授权流程，不仅麻烦而且用户体验也不好，那如何让用户使用的优雅呢？</p><p>一般在颁发令牌的时候，颁发两个Token, 一个授权Token,一个Refresh Token,
在更新refresh_token时候,将grant_type指定为refresh_token,
参数refresh_token是用于更新Token的refresh_token</p><h1 id=总结>总结</h1><h1 id=安利>安利</h1><ul><li>Client<ul><li>Go <a href=https://godoc.org/golang.org/x/oauth2>https://godoc.org/golang.org/x/oauth2</a></li><li>Java<ul><li><a href=https://spring.io/projects/spring-social/>https://spring.io/projects/spring-social/</a></li><li><a href=https://spring.io/projects/spring-security/>https://spring.io/projects/spring-security/</a></li></ul></li></ul></li><li>Server<ul><li>Go<ul><li><a href=https://github.com/go-oauth2/oauth2>https://github.com/go-oauth2/oauth2</a></li><li><a href=https://github.com/zalando/gin-oauth2>https://github.com/zalando/gin-oauth2</a></li></ul></li><li>Java <a href=https://github.com/zalando/tokens>https://github.com/zalando/tokens</a></li></ul></li></ul><p>参考</p><ul><li>jsonwebtoken.io <a href=https://www.jsonwebtoken.io/>https://www.jsonwebtoken.io/</a></li><li>oauth.net <a href=https://oauth.net/2/>https://oauth.net/2/</a></li><li>aliyun.com<ul><li><a href="https://help.aliyun.com/document_detail/32144.html?spm=5176.87240.400427.53.32fa4614S88B0N">https://help.aliyun.com/document_detail/32144.html?spm=5176.87240.400427.53.32fa4614S88B0N</a></li><li><a href="https://help.aliyun.com/document_detail/32008.html?spm=a2c4g.11186623.6.780.40435837SXpbPT">https://help.aliyun.com/document_detail/32008.html?spm=a2c4g.11186623.6.780.40435837SXpbPT</a></li><li><a href="https://help.aliyun.com/document_detail/32026.html?spm=a2c4g.11186623.6.856.20b1c06dgVW6Ri">https://help.aliyun.com/document_detail/32026.html?spm=a2c4g.11186623.6.856.20b1c06dgVW6Ri</a></li></ul></li></ul><h4><a href=https://pinkhello.github.io/>Back to Home</a></h4></div></div><footer class=container><hr class=soften><p><a href=https://pinkhello.github.io/>hugo.386 theme</a> |
&copy;
<a href=https://pinkhello.github.io/ target=_blank>一杯哈希不加盐</a>
<span id=thisyear>2020</span>
| Built on <a href=//gohugo.io target=_blank>Hugo</a></p><p class=text-center><a href=https://github.com/PinkHello>GitHub</a></p></footer></body><link rel=stylesheet href=/css/bootstrap.css><link rel=stylesheet href=/css/bootstrap-responsive.css><link rel=stylesheet href=/css/style.css><script src=/js/jquery.js></script><script src=/js/bootstrap-386.js></script><script src=/js/bootstrap-transition.js></script><script src=/js/bootstrap-alert.js></script><script src=/js/bootstrap-modal.js></script><script src=/js/bootstrap-dropdown.js></script><script src=/js/bootstrap-scrollspy.js></script><script src=/js/bootstrap-tab.js></script><script src=/js/bootstrap-tooltip.js></script><script src=/js/bootstrap-popover.js></script><script src=/js/bootstrap-button.js></script><script src=/js/bootstrap-collapse.js></script><script src=/js/bootstrap-carousel.js></script><script src=/js/bootstrap-typeahead.js></script><script src=/js/bootstrap-affix.js></script><script>_386={fastLoad:false,onePass:false,speedFactor:1};function ThisYear(){document.getElementById('thisyear').innerHTML=new Date().getFullYear();};</script></html>